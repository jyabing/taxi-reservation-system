{% extends "staffbook/base_staffbook.html" %}
{% load widget_tweaks %}
{% load time_filters %}
{% load humanize %}
{% load custom_totals %}
{% load custom_tags %}


{% load static %}
{% load driver_extras %}

{% block extra_css %}



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
table.table tr.has-note,
table.table tr.has-note td {
  background-color: #fff3cd !important;
}
.auto-width-input {
  width: 2ch;
  min-width: 60px;
  max-width: 100px;
  box-sizing: content-box;
  transition: width 0.2s;
}
.mirror-span {
  position: absolute;
  visibility: hidden;
  white-space: pre;
  font: inherit;
}
.mark-checkbox {
  transform: scale(1.3);
  margin-top: 3px;
}
.scrollable-input {
  overflow-x: auto;
  white-space: nowrap;
  min-width: 50px;
  width: 100%;
  max-width: 100px;
}
#payment-summary-panel {
  font-size: 0.95rem;
}
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}
  /* 料金只读的外观（不影响提交） */
  .meter-fee-input[readonly],
  input[name$="-meter_fee"][readonly]{
    background:#eee !important;
    color:#666 !important;
    cursor:not-allowed;
  }
  /* （可选）如果你上面给 select 加了 locked-select，就一起加灰样式 */
  .locked-select{
    background:#f5f5f5 !important;
    color:#666 !important;
    pointer-events:none; /* 阻止点击但值仍会提交 */
  }
  /* === 强制显示数据区行；仅隐藏模板区 === */
  table.report-table tbody:not(#empty-form-template) tr {
    display: table-row !important; visibility: visible !important; opacity: 1 !important;
  }
  #empty-form-template tr { display: none !important; visibility: hidden !important; }

  /* 過不足 内訳样式 */
  .ob-line{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
  .ob-line+.ob-line{margin-top:.25rem}
  .ob-label{color:#6c757d}
  .ob-mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .ob-chip{display:inline-block;padding:0 .4rem;border-radius:.5rem;font-size:.75rem;line-height:1.4;background:#f1f3f5;color:#495057;border:1px solid #e9ecef}
  .ob-pos{color:#198754} /* 公司→司机（司机应收） */
  .ob-neg{color:#dc3545} /* 司机→公司（司机应付） */
  .ob-total{font-weight:600}
  /* === END === */

  /* 仅当 difference-breakdown 仍带 text-muted 时需要 */
  
  #difference-breakdown .ob-label { color: var(--bs-secondary-color, #6c757d); }
  #difference-breakdown .ob-mono { color: inherit; }

  .badge-etc{
  display:inline-block; padding:.1rem .45rem; border-radius:.5rem;
  font-size:.8rem; line-height:1.4; border:1px solid #e9ecef; background:#f8f9fa;
}
.badge-etc-pos{ color:#0d6efd; }  /* 公司→司机 */
.badge-etc-neg{ color:#dc3545; }  /* 司机→公司 */


</style>

{% endblock %}
{% block content %}
<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <h4>{% if report %}{{ report.driver.name }}{% else %}{{ driver.name }}{% endif %}- 乗務日報の編集</h4>
  {{ form.meter_fee|add_class:"form-control" }}
  <p class="text-muted">日付：{{ form.date.value|date:"Y年n月j日" }}</p>

  {% if report.pk %}
    {% if report.edited_by %}
      <div class="alert alert-light small mb-3">
        <strong>最終編集：</strong>
        {{ report.edited_by.get_full_name|default:report.edited_by.username }}
        {{ report.edited_at|date:"Y年n月j日 H:i" }} に保存
      </div>
    {% else %}
      <div class="alert alert-secondary small mb-3">編集履歴なし</div>
    {% endif %}
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>フォームエラー：</strong>
      <ul>
      {% for field, errs in form.errors.items %}
        <li>{{ field }}: {{ errs|join:", " }}</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>明細フォームのエラー：</strong>
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

    <!--缩进无影响，也可以写成单行形式-->
    <form method="post"
      {% if is_edit %}
        action="{% url 'dailyreport:driver_dailyreport_edit' driver_id=driver.id report_id=report.id %}"
      {% elif driver and driver.id %}
        action="{% url 'dailyreport:driver_dailyreport_direct_add' driver.id %}"
      {% else %}
        action="#"
      {% endif %}
      autocomplete="off">
    {% csrf_token %}
    {{ form.status.as_hidden }}
    {{ form.date.as_hidden }}

    <div class="mb-3">
      <label class="form-label">備考：</label>
      {{ form.note|add_class:"form-control form-control-sm"|attr:"rows:2"|attr:"style:width:100%; max-width:400px;" }}
    </div>

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th style="white-space: nowrap;"><strong>使用車両</strong></th>
          <th style="white-space: nowrap;">出勤</th>
          <th style="white-space: nowrap;">退勤</th>
          <th style="white-space: nowrap;">勤務時間</th>
          <th style="white-space: nowrap;">休憩時間</th>
          <th style="white-space: nowrap;"><span class="text-info">実働時間</span></th>
          <th class="text-danger" style="white-space: nowrap;">残業時間</th>
          <th style="white-space: nowrap;">給油 (L)</th>
          <th style="white-space: nowrap;">走行距離 (KM)</th>
        </tr>
      </thead>
      <tbody id="data-rows">
        <tr>
          <td>
            <span class="form-control-plaintext">
              {{ report.vehicle|default:"未選択" }}
            </span>

            {# 关键：把当前 vehicle 的 id 一起提交 #}
            {% if report.vehicle_id %}
              <input type="hidden" name="vehicle" value="{{ report.vehicle_id }}">
            {% endif %}
          </td>


          <!-- 出勤 -->
          <td style="max-width:110px;">
            <input type="text" name="clock_in" class="form-control form-control-sm time-input" value="{{ form.clock_in.value|default_if_none:'' }}">
          </td>

          <!-- 退勤（含“未完成入库手续”勾选） -->
          <td style="max-width:220px;">
            <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
              <!-- 退勤输入框 -->
              <input
                type="text"
                name="clock_out"
                id="id_clock_out"
                class="form-control form-control-sm time-input"
                style="min-width: 80px; max-width: 120px;"
                value="{{ form.clock_out.value|default_if_none:form.initial.clock_out|default_if_none:'' }}"
              >

              <!-- 勾选框（使用表单字段，便于 cleaned_data 解析为 bool） -->
              <label class="form-check d-inline-flex align-items-center m-0" style="gap:.25rem;">
                {{ form.unreturned_flag }}
                <span id="return-status-text">
                  {% if form.clock_out.value|default_if_none:form.initial.clock_out %}已完成{% else %}未完成入库手续{% endif %}
                </span>
              </label>
            </div>
          </td>
          <td id="work-duration">--:--</td> <!--勤務時間-->

          <!-- ✅ 休憩時間输入 -->
          <td id="break-time">
            <input type="text" name="break_time_input" id="break-time-input"
                class="form-control form-control-sm text-center"
                maxlength="5" pattern="^\d{1,2}:\d{2}$"
                style="max-width:90px;" placeholder="0:00"
                value="{{ break_time_h|default:'0' }}:{{ break_time_m|default:'00' }}">

            <!-- ✅ 显示「実休憩 +20分」 -->
            <div class="form-text mt-1 text-muted">
              実休憩: <span id="break-time-display">--:--</span>
            </div>

            <!-- ✅ 隐藏字段（自动填入 20分后时间） -->
            <input type="hidden" name="break_time_plus20" id="break-time-plus20">
          </td>

          <!-- 実働時間 -->
          <td class="text-center text-primary" id="actual-work-time">
            {% if form.instance.実働時間 %}
              {{ form.instance.実働時間 }}
            {% else %}
              --:--
            {% endif %}
          </td>

          <!-- 残業時間 -->
          <td class="text-danger text-center" id="overtime">{{ form.instance.残業時間|format_duration }}</td>
          
          <td style="max-width:90px;">{{ form.gas_volume|add_class:"form-control form-control-sm text-end" }}</td>
          <td >{{ form.mileage|add_class:"form-control form-control-sm text-end" }}</td>
        </tr>
      </tbody>
    </table>

    <div id="payment-summary-panel" class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      {% for key, label in summary_keys %}
        <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
          <div class="small text-muted">
            {% if key == "meter" %}
              <div class="small text-muted">売上合計</div>
              <div>
                <span id="total_meter">
                  {{ totals.meter_total|default:0|intcomma }}  {# ← 应该显示收入合计，如 17,800 #}
                </span>
                <div class="small text-muted">
                  <small>(メータのみ: <span id="total_meter_only">
                    {{ totals.meter_only_total|default:0|intcomma }}
                  </span>)</small>
                </div>
                <div class="small text-muted">
                  ※ 売上合計には、支払方法付きのデータのみが含まれます。
                </div>
              </div>
            {% else %}
              <div class="small text-muted">{{ label }} 合計</div>
              <div>
                <span id="total_{{ key }}">
                  {{ totals|get_item:key|get_item:"total"|default:0|floatformat:"0" }}
                </span>
                （<span id="bonus_{{ key }}">
                  {{ totals|get_item:key|get_item:"bonus"|default:0|floatformat:"0" }}
                </span>）
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- >>> 追加: Uber予約 / Uberチップ / Uberプロモーション 合計カード start -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">Uber予約 合計</div>
        <div>
          <span id="uber-reservation-total">0</span>
          <span class="text-muted small">（<span id="uber-reservation-count">0</span>）</span>
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">Uberチップ 合計</div>
        <div>
          <span id="uber-tip-total">0</span>
          <span class="text-muted small">（<span id="uber-tip-count">0</span>）</span>
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">Uberプロモーション 合計</div>
        <div>
          <span id="uber-promotion-total">0</span>
          <span class="text-muted small">（<span id="uber-promotion-count">0</span>）</span>
        </div>
      </div>
      <!-- <<< 追加 end -->

      <!-- ✅ 追加：貸切収入・売上合計・入金合計 -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">貸切現金</div>
        <div>
          <span id="charter-cash-total">
            {{ totals.charter_cash_total|default:0|intcomma }}
          </span> 円
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">貸切未収</div>
        <div>
          <span id="charter-uncollected-total">
            {{ totals.charter_uncollected_total|default:0|intcomma }}
          </span> 円
        </div>
      </div>
      
      <!-- ✅ 入金 + ETC 综合区域 -->
      <div class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      <!-- ✅ 入金/過不足 卡片 -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 80px;">
        <label class="small text-muted">入金額</label>
        {{ form.deposit_amount|add_class:"form-control form-control-sm text-end"|attr:"id:deposit-input"|attr:"style:min-width:80px;"|attr:"placeholder:0" }}

      <!-- ✅ ETC 包含判断提示（JS 动态修改） -->
      <div id="etc-included-warning" class="small mt-1"></div>

      <!-- ▼▼ 新增：実際ETC（会社 → 運転手）显示 + hidden ▼▼ -->
      <div class="small text-muted mt-1">
            実際ETC 会社 → 運転手：<span id="actual_etc_company_to_driver_view">0</span> 円
      </div>
          <input type="hidden" id="actual_etc_company_to_driver" name="actual_etc_company_to_driver" value="0">
          <!-- ▲▲ 新增结束 ▲▲ -->

          {% if report.etc_collected and report.deposit_amount %}
            {% if report.is_etc_included_in_deposit %}
              <div class="small text-success mt-1">✔️ 含 ETC</div>
            {% else %}
              <div class="small text-danger mt-1">⚠️ 未含 ETC，请确认</div>
            {% endif %}
          {% endif %}

          <label class="small text-muted mt-2 d-block">
            過不足（入金 − 現金(ながし) − 貸切現金 ＋ 実際ETC）
          </label>
          <div id="difference-output"
              class="form-control-plaintext text-end small"
              style="min-height: 1.5em;"
              title="基本過不足に実際ETC（会社⇄運転手の返還差引）を加味">
            {{ form.deposit_difference.value|default:"--" }}
          </div>
          <div id="difference-breakdown" class="form-text small"></div>
        </div>

        
        <!-- …其余卡片保持原样… -->
      </div>
      <!-- ✅ 入金 + ETC 综合区域 结束-->

      <!-- ======= BEGIN NEW: 右侧 ETC 分项小计（仅显示，不改口径） ======= -->
      <div class="border rounded px-3 py-2 text-start" style="min-width: 220px;">
        <div class="small text-muted mb-1">ETC 小計（行明細より集計）</div>
        <div class="d-flex flex-column gap-1 small">
          <div>乗車ETC 合計：<span id="ride-etc-total">0</span></div>
          <div>空車ETC 合計：<span id="empty-etc-total">0</span></div>
          <hr class="my-1">
          <div>ETC(客払 = 売上候補)：<span id="etc-customer-total">0</span></div>
          <div>ETC(会社負担)：<span id="etc-company-total">0</span></div>
          <div>ETC(ドライバー立替)：<span id="etc-driver-total" data-role="etc-paid-driver">0</span></div>
        </div>
        <div class="form-text mt-1">
          ※ 現在は表示のみ。売上や過不足の計算口径は従前どおりです。
        </div>
      </div>
      <!-- ======= END NEW ======= -->
      
      <!-- ======= BEGIN 折叠版：ETC 收取＝乗車合計（円） ======= -->
      <div class="border rounded mb-2" id="ride-etc-card" data-collapse-key="ride-etc">
        <!-- 头部行：标题 + 收起/展开按钮 -->
        <div class="d-flex align-items-center justify-content-between px-3 py-2">
          <div class="fw-semibold">ETC 收取＝乗車合計（円）</div>
          <button type="button"
                  class="btn btn-sm btn-outline-secondary js-collapse-toggle"
                  data-target="#ride-etc-body">收起/展开</button>
        </div>

        <!-- 可折叠的主体内容：把你原来的内容放在这里 -->
        <div id="ride-etc-body" class="px-3 pb-3">
          <!-- ✅ ETC 现金收区域（原样保留） -->
          <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
            <label class="small text-muted">ETC 收取=乗車合計（円）</label>
            {{ form.etc_collected|add_class:"form-control form-control-sm text-end"|attr:"data-role:etc-collected-passenger" }}

            <!-- ✅ 追加：乘車ETC の 支払者（単選） -->
            <label class="small text-muted mt-2 d-block">乗車ETC の支払者</label>
            {{ form.etc_rider_payer|add_class:"form-select form-select-sm js-etc-rider-payer" }}

            <div class="form-text small text-start mt-2">
              ・会社カード：ETC 应收合计に加算（空車ETCは従来どおりのロジック）<br>
              ・<span class="bg-warning px-1">自己カード：会社が下月工资で返す → 过不足に計上</span><br>
              ・お客様カード：会社の应收・过不足ともに影響なし（備查のみ）
            </div>

            <label class="small text-muted mt-2 d-block">支付方式</label>
            {{ form.etc_payment_method|add_class:"form-select form-select-sm" }}

            <label class="small text-muted mt-2 d-block">貸切の場合、お客様が乗って高速道路をご利用したので、</label>
            <label class="small text-muted mt-2 d-block">日計で空車合計でも、乗車合計に記入ください</label>
          </div>
        </div>
      </div>
      <!-- ======= END 折叠版 ======= -->

      <!-- === 追加：空車ETC（回程）明细，用于计算覆盖与司机负担 === -->
      <div id="empty-etc-card" class="border rounded px-3 py-2" style="min-width: 280px;">

        <div class="small text-muted mb-2">空車ETC（回程）詳細</div>
        <div class="small text-muted">🧾 メータ小票 記載用：</div>

        <div style="font-family:ui-monospace,Menlo,monospace;">空車ETC {{ report.etc_uncollected|default:0 }}円</div>
        <div class="row g-2 align-items-end">
          <!-- 空車ETC金额 -->
          <div class="col-6">
            <label for="id_etc_uncollected" class="form-label small">空車ETC 金額（円）</label>
            <input type="number" class="form-control form-control-sm text-end js-empty-etc-amount"
                  id="id_etc_uncollected" name="etc_uncollected" min="0" step="1"
                  value="{% firstof form.etc_uncollected.value report.etc_uncollected 0 %}" inputmode="numeric" pattern="[0-9]*">
          </div>
          <!-- 回程费受领额 -->
          <div class="col-6">
            <label for="id_etc_return_fee_claimed" class="form-label small">回程費 受領額（円）</label>
            <input type="number" class="form-control form-control-sm text-end js-return-fee-claimed"
                  id="id_etc_return_fee_claimed" name="etc_return_fee_claimed" min="0" step="1" value="">
          </div>
          <!-- 回程费支付方式 -->
          <div class="col-6">
            <label for="id_etc_return_fee_method" class="form-label small">回程費 支払方法</label>
            <select id="id_etc_return_fee_method" name="etc_return_fee_method"
                    class="form-select form-select-sm js-return-fee-method">
              <option value="none">— 個別（別払い/なし）—</option>
              <option value="app_ticket">アプリ/チケット 一体結算</option>
              <option value="cash_to_driver">現金（直接司机）</option>
            </select>
          </div>
          <!-- 空車ETC 使用卡 -->
          <div class="col-6">
            <label for="id_etc_empty_card" class="form-label small">空車ETC カード</label>
            {{ form.etc_empty_card|add_class:"form-select form-select-sm js-empty-etc-card" }}

          </div>
        </div>
        <div class="form-text mt-2">
          <small>
            覆盖规则：支払方法 = <strong>アプリ/チケット</strong> 时，回程費用于覆盖空車ETC；<br>
            覆盖不足 → <strong>司机負担</strong>；覆盖过多 → 記為 <strong>未收ETC</strong>（展示/統計用）。
          </small>
        </div>
      </div>
      <!-- === 追加结束 === -->

      <!-- ✅ ETC 不足额（保持你原逻辑，只读展示） -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <label for="{{ form.etc_shortage.id_for_label }}" class="small text-danger">ETC不足（円）</label>
        {{ form.etc_shortage|add_class:"form-control form-control-sm text-end text-danger"|attr:"readonly" }}
        <label class="small text-muted mt-2 d-block">应收合计 - 实收金额</label>
        <label class="small text-muted mt-2 d-block">“ETC 实际收回”不是一个单独填写的字段，</label>
        <label class="small text-muted mt-2 d-block">而是由日报明细的付款方式数据动态汇总出来的</label>
      </div>

      <!-- ETC 未收提醒区 -->
      <div id="etc-diff-display" class="alert alert-info small py-1 px-2 mt-1">
        未收 ETC：0 円（无需扣除）
      </div>
      
      <!-- ✅ 智能提示区（推荐放在 payment-summary-panel 结尾） -->
      <div id="smart-hint-panel" class="mt-2 w-100">
        {% if deposit_amt %}
          {% if deposit_amt < total_collected %}
            <div class="alert alert-danger py-1 px-2 small mb-2">
              ⚠️ 入金額が不足しています。請求額 (現金 + ETC) は <strong>{{ total_collected|floatformat:"0"|intcomma }}円</strong> ですが、入力された入金額は <strong>{{ deposit_amt|intcomma }}円</strong> です。
            </div>
          {% else %}
            <div class="alert alert-success py-1 px-2 small mb-2">
              ✔️ 入金額は現金 + ETC をカバーしています。
            </div>
          {% endif %}

          {% if report.etc_uncollected %}
            <div class="alert alert-info py-1 px-2 small mb-2">
              🚧 ETC 未收：<strong>{{ report.etc_uncollected|intcomma }}円</strong>。请确认司机是否已补收。
            </div>
          {% endif %}

          {% if deposit_amt < total_sales %}
            <div class="alert alert-warning py-1 px-2 small mb-2">
              ℹ️ 売上合計 <strong>{{ total_sales|intcomma }}円</strong> 大于入金 <strong>{{ deposit_amt|intcomma }}円</strong>，未收 ETC 或其他延迟结算项。
            </div>
          {% endif %}
        {% endif %}
      </div>

    </div>

    <!-- ====== BEGIN PATCH: ETC 显示开关（默认隐藏列） ====== -->
    <div class="d-flex align-items-center gap-2 mb-2">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggle-etc-cols">
        <label class="form-check-label" for="toggle-etc-cols">显示 ETC 明细（乗車/空車/負担）</label>
      </div>
      <a href="{% url 'dailyreport:etc_help' %}" class="btn btn-sm btn-outline-info" target="_blank" rel="noopener">
        查看填报指南
      </a>
    </div>

    <!-- ====== END PATCH ====== -->

    <table class="table table-bordered table-sm report-table">
      <thead class="table-light">
        <tr>
          <th class="row-number-header">#</th>
          <th style="white-space: nowrap;">時間</th>
          <th style="white-space: nowrap;">乗車地</th>
          <th style="white-space: nowrap;">料金</th>
          <th style="white-space: nowrap;">支付</th>
          <!-- ======= BEGIN FIXED: 行级ETC 表头三列（加 class，便于显隐） ======= -->
          <th class="text-center col-etc-riding"         style="white-space: nowrap;">乗車ETC</th>
          <!-- 乗車ETC負担 -->
          <th class="text-center col-etc-riding-charge" style="white-space: nowrap;">
            乗車ETC 立替者
            <button type="button"
                    class="btn btn-link p-0 ms-1 align-baseline help-popover"
                    data-bs-toggle="popover"
                    data-bs-title="乗車ETC負担とは"
                    data-bs-html="true"
                    data-bs-content="
                      <div style='max-width:260px'>
                        <div><b>含义：</b>本趟有客时，<u>谁先垫付</u>了高速费。</div>
                        <ul class='mb-1 ps-3'>
                          <li><b>ドライバー</b>：司机先垫；若本行方式为<b>公司侧</b>，公司<b>返还司机</b>。</li>
                          <li><b>会社</b>：公司承担，不返。</li>
                          <li><b>お客様</b>：客人承担（当场或平台结清），不返。</li>
                        </ul>
                        <div class='text-muted small'>返还是仅限 <b>乗車</b> 且 <b>ドライバー</b> 且 <b>会社側決済</b>。</div>
                      </div>
                    ">❓</button>
          </th>
          <th class="text-center col-etc-empty"          style="white-space: nowrap;">空車ETC</th>
          <!-- 空車ETC負担 -->
          <th class="text-center col-etc-empty-charge" style="white-space: nowrap;">
            空車ETC 立替者
            <button type="button"
                    class="btn btn-link p-0 ms-1 align-baseline help-popover"
                    data-bs-toggle="popover"
                    data-bs-title="空車ETC負担とは"
                    data-bs-html="true"
                    data-bs-content="
                      <div style='max-width:260px'>
                        <div><b>含义：</b>空车/回程/调车时的高速费先由谁垫付，用于成本报销口径。</div>
                        <ul class='mb-1 ps-3'>
                          <li><b>ドライバー</b>：司机自付；可按回程费策略覆盖/报销。</li>
                          <li><b>会社</b>：公司承担。</li>
                        </ul>
                        <div class='text-muted small'>此项不计入『実際ETC 会社→運転手』。</div>
                      </div>
                    ">❓</button>
          </th>
          <!-- ======= END FIXED ======= -->
          <th style="white-space: nowrap;">待入</th>
          <th style="white-space: nowrap;">強調</th>
          <th style="white-space: nowrap;">貸切</th>
          <th style="white-space: nowrap;">貸切金額</th>
          <th style="white-space: nowrap;">貸切支払</th>
          <th>注釈</th>
          <th style="white-space: nowrap;">操作</th>
        </tr>
      </thead>

  <tbody>
    {{ formset.management_form }}

    {% for form in formset.forms %}
      <tr class="report-item-row {% if form.instance.is_flagged %}has-note{% endif %}">
        {# ✅ 隐藏单元格：保证 id / DELETE 在本行 DOM 内 #}
        <td class="d-none">
          {{ form.id }}
          {{ form.DELETE|add_class:"delete-flag" }}
        </td>

        <td class="row-number">{{ forloop.counter }}</td>

        <td style="min-width: 70px;">
          {% if form.ride_time.errors %}
            <div class="text-danger small">{{ form.ride_time.errors.0 }}</div>
          {% endif %}
          {{ form.ride_time|add_class:"form-control form-control-sm time-input" }}
        </td>

        <td style="min-width: 70px;">
          {% if form.ride_from.errors %}
            <div class="text-danger small">{{ form.ride_from.errors.0 }}</div>
          {% endif %}
          {{ form.ride_from|add_class:"form-control form-control-sm" }}
        </td>

        <td style="min-width: 70px;">
          <input
            type="number"                                  {# ← 改成 number #}
            name="{{ form.meter_fee.html_name }}"
            id="{{ form.meter_fee.id_for_label }}"
            value="{{ form.meter_fee.value|floatformat:"-0" }}"
            class="form-control form-control-sm text-end meter-fee-input fee-input"  {# ← 多加 fee-input #}
            inputmode="numeric"                            {# ← 手机上用数字键盘 #}
            pattern="[0-9]*"                               {# ← 只要 0-9 #}
            min="0"
          >
        </td>

        <td style="min-width: 100px;">
          {% if form.payment_method.errors %}
            <div class="text-danger small">{{ form.payment_method.errors.0 }}</div>
          {% endif %}
          {{ form.payment_method|add_class:"form-select form-select-sm payment-method-select" }}
        </td>

        <!-- ======= BEGIN PATCH: 每行的 ETC 4格 ======= -->
        <td class="col-etc-riding" style="min-width: 80px;">
          {% if form.etc_riding.errors %}<div class="text-danger small">{{ form.etc_riding.errors.0 }}</div>{% endif %}
          {{ form.etc_riding|add_class:"form-control form-control-sm text-end etc-riding-input"|attr:"inputmode:numeric"|attr:"pattern:[0-9]*"|attr:"min:0"|attr:"step:1" }}
        </td>

        <td class="col-etc-riding-charge" style="min-width: 110px;">
          {% if form.etc_riding_charge_type.errors %}<div class="text-danger small">{{ form.etc_riding_charge_type.errors.0 }}</div>{% endif %}
          {{ form.etc_riding_charge_type|add_class:"form-select form-select-sm etc-riding-charge-select" }}
        </td>

        <td class="col-etc-empty" style="min-width: 80px;">
          {% if form.etc_empty.errors %}<div class="text-danger small">{{ form.etc_empty.errors.0 }}</div>{% endif %}
          {{ form.etc_empty|add_class:"form-control form-control-sm text-end etc-empty-input"|attr:"inputmode:numeric"|attr:"pattern:[0-9]*"|attr:"min:0"|attr:"step:1" }}
        </td>

        <td class="col-etc-empty-charge" style="min-width: 110px;">
          {% if form.etc_empty_charge_type.errors %}<div class="text-danger small">{{ form.etc_empty_charge_type.errors.0 }}</div>{% endif %}
          {{ form.etc_empty_charge_type|add_class:"form-select form-select-sm etc-empty-charge-select" }}
        </td>
        <!-- 兼容历史：旧字段保留（HiddenInput，不显示不占位） -->
        {{ form.etc_charge_type }}
        <!-- ======= END PATCH ======= -->


        {# ▼ 待入列 #}
        <td class="text-center">
          {% if form.is_pending.errors %}
            <div class="text-danger small">{{ form.is_pending.errors.0 }}</div>
          {% endif %}
          {{ form.is_pending }} {# widget 上已有 pending-checkbox class #}
        </td>
        {# ▲ #}

        <td class="text-center">
          {% if form.is_flagged.errors %}
            <div class="text-danger small">{{ form.is_flagged.errors.0 }}</div>
          {% endif %}
          {{ form.is_flagged }}
        </td>

        <td class="text-center">
          {% if form.is_charter.errors %}
            <div class="text-danger small">{{ form.is_charter.errors.0 }}</div>
          {% endif %}
          {{ form.is_charter }}
        </td>

        <td>
          {{ form.charter_amount_jpy|add_class:"form-control form-control-sm text-end auto-width-input charter-amount-input" }}
        </td>

        <td>
          {{ form.charter_payment_method|add_class:"form-control form-control-sm auto-width-input charter-payment-method-select" }}
        </td>

        <td>
          {% if form.note.value %}📝{% endif %}
          {% if form.note.errors %}
            <div class="text-danger small">{{ form.note.errors.0 }}</div>
          {% endif %}
          {{ form.note }}

          <div class="alert alert-warning py-1 px-2 small mt-1 pending-mini-hint d-none">
            這些明細暫不計入売上合計。入帳後取消勾選即可立即納入核算
          </div>
        </td>

        {# 每一行的操作列里：#}
        <td style="white-space: nowrap;">
          <div class="d-flex flex-row gap-1">
            {% if form.instance.pk %}
              <!-- 立即删除：用 data-delete-url 存路由 -->
              <button type="button"
                      class="btn btn-sm btn-danger js-delete-item"
                      data-delete-url="{% url 'dailyreport:report_item_delete' form.instance.pk %}">
                删除
              </button>
            {% else %}
              <!-- 还没保存到数据库的临时行：前端移除即可 -->
              <button type="button" class="btn btn-sm btn-outline-danger remove-row">移除</button>
            {% endif %}
            <button type="button" class="btn btn-sm btn-outline-primary insert-below">➕下に挿入</button>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>

  {# ✅ 空模板：同样把 id/DELETE 放进隐藏 <td>；并保持列结构一致 #}
  <tbody id="empty-form-template" class="d-none">
    <tr class="report-item-row">
      <td class="d-none">
        {{ formset.empty_form.id }}
        {{ formset.empty_form.DELETE|add_class:"delete-flag" }}
      </td>

      <td class="row-number">__num__</td>

      <td>
        {{ formset.empty_form.ride_time|add_class:"form-control form-control-sm time-input" }}
      </td>

      <td>
        {{ formset.empty_form.ride_from|add_class:"form-control form-control-sm" }}
      </td>

      <td>
        {{ formset.empty_form.meter_fee.as_widget(attrs={
          'type': 'number',
          'inputmode': 'numeric',
          'pattern': '[0-9]*',
          'min': '0',
          'class': 'form-control form-control-sm text-end meter-fee-input fee-input'
        }) }}
      </td>

      <td>
        {{ formset.empty_form.payment_method|add_class:"form-select form-select-sm payment-method-select" }}
      </td>

      <!-- ======= BEGIN PATCH: 空模板的 ETC 4格 ======= -->
      <td class="col-etc-riding">
        {{ formset.empty_form.etc_riding|add_class:"form-control form-control-sm text-end etc-riding-input"|attr:"inputmode:numeric"|attr:"pattern:[0-9]*"|attr:"min:0"|attr:"step:1" }}
      </td>
      <td class="col-etc-riding-charge">
        {{ formset.empty_form.etc_riding_charge_type|add_class:"form-select form-select-sm etc-riding-charge-select" }}
      </td>
      <td class="col-etc-empty">
        {{ formset.empty_form.etc_empty|add_class:"form-control form-control-sm text-end etc-empty-input"|attr:"inputmode:numeric"|attr:"pattern:[0-9]*"|attr:"min:0"|attr:"step:1" }}
      </td>
      <td class="col-etc-empty-charge">
        {{ formset.empty_form.etc_empty_charge_type|add_class:"form-select form-select-sm etc-empty-charge-select" }}
      </td>
      <!-- 兼容历史：旧字段保留（HiddenInput） -->
      {{ formset.empty_form.etc_charge_type }}
      <!-- ======= END PATCH ======= -->



      <td class="text-center">
        {{ formset.empty_form.is_pending|add_class:"pending-checkbox" }}
      </td>

      <td class="text-center">
        {{ formset.empty_form.is_flagged }}
      </td>

      <td class="text-center">
        {{ formset.empty_form.is_charter }}
      </td>

      <td>
        {{ formset.empty_form.charter_amount_jpy|add_class:"form-control form-control-sm text-end auto-width-input charter-amount-input" }}
      </td>

      <td>
        {{ formset.empty_form.charter_payment_method|add_class:"form-control form-control-sm auto-width-input charter-payment-method-select" }}
      </td>

      <td>
        {{ formset.empty_form.note|add_class:"form-control" }}
        <div class="alert alert-warning py-1 px-2 small mt-1 pending-mini-hint d-none">
          這些明細暫不計入売上合計。入帳後取消勾選即可立即納入核算
        </div>
      </td>

      <td style="white-space:nowrap;">
        <button type="button" class="btn btn-sm btn-outline-danger remove-row">移除</button>
        <button type="button" class="btn btn-sm btn-outline-primary insert-below">➕向下挿入</button>
      </td>
    </tr>
    
  </tbody>
</table>


    <button type="submit" class="btn btn-primary">💾 保存する</button>
  </form>

  <div class="text-center mt-2 d-flex justify-content-center gap-2">
    <div class="input-group" style="max-width: 260px;">
      <span class="input-group-text">行に挿入</span>
      <input type="number" min="1" class="form-control" id="insert-index-input" placeholder="例: 10">
      <button type="button" class="btn btn-outline-secondary" id="insert-at-btn">指定行に挿入</button>
    </div>
  </div>
  
</div>

{% endblock %}

{% block extra_js %}
  <!-- 费率注入：给 dailyreport.js 计算分成用 -->
  <script>
    window.PAYMENT_RATES = {{ payment_rates|safe }};
  </script>

  <!-- 只保留这一处外链脚本。加个版本号防缓存 -->
{% now 'U' as cache_bust %}
  <script src="{% static 'dailyreport/js/dailyreport.js' %}?v={{ cache_bust }}"></script>

  <!-- 可留的高亮样式（CSS 不会冲突） -->
  <style>
    table.table tr.has-note td,
    table.table tr.has-note {
      background-color: #fff8b3 !important;
    }

    /* === 强制显示数据区行；仅隐藏模板区 === */
    table.report-table tbody:not(#empty-form-template) tr {
      display: table-row !important; visibility: visible !important; opacity: 1 !important;
    }

    /* ======= BEGIN PATCH: 列显隐和宽度 ======= */
    table.report-table.etc-cols-hidden th.col-etc-riding,
    table.report-table.etc-cols-hidden td.col-etc-riding,
    table.report-table.etc-cols-hidden th.col-etc-riding-charge,
    table.report-table.etc-cols-hidden td.col-etc-riding-charge,
    table.report-table.etc-cols-hidden th.col-etc-empty,
    table.report-table.etc-cols-hidden td.col-etc-empty,
    table.report-table.etc-cols-hidden th.col-etc-empty-charge,
    table.report-table.etc-cols-hidden td.col-etc-empty-charge {
      display: none !important;
    }

    .etc-riding-input, .etc-empty-input { max-width: 90px; }
    .etc-riding-charge-select, .etc-empty-charge-select { max-width: 140px; }
    /* ======= END PATCH ======= */


    #empty-form-template tr { display: none !important; visibility: hidden !important; }
  </style>

  <script>
    (function(){
      var out = document.getElementById("id_clock_out");
      var chk = document.getElementById("id_unreturned_flag") || document.querySelector('input[name="unreturned_flag"]');
      var txt = document.getElementById("return-status-text");

      function sync() {
        var hasVal = out && out.value.trim() !== "";
        if (hasVal) {
          // 有退勤 => 视为“已完成”，自动取消勾选
          if (chk) chk.checked = false;
          if (txt) txt.textContent = "已完成";
        } else {
          // 没退勤 => 可勾选“未完成入库手续”
          if (txt) txt.textContent = "未完成入库手续";
        }
      }

      if (out) {
        out.addEventListener("input", sync);
        // 初始也同步一次
        window.addEventListener("load", sync);
      }
    })();
  </script>

  <script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.js-delete-item');
    if (!btn) return;

    // 确认
    if (!confirm('确定删除此行？')) return;

    // 删除接口地址
    const url = btn.dataset.deleteUrl;
    if (!url) return;

    // 取页面里已有的大表单里的 CSRF
    const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const token = tokenInput ? tokenInput.value : '';

    // 动态创建一个独立表单并提交
    const f = document.createElement('form');
    f.method = 'POST';
    f.action = url;

    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.value = token;
    f.appendChild(csrf);

    document.body.appendChild(f);
    f.submit();
  });
  </script>

  <!-- 放在 dailyreport.js 之后、Popover 初始化之前 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


  <!-- ✅ 初始化 Popover：让表头 ❓ 按钮可显示说明 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 如果 bootstrap 未加载，直接退出（防止报错）
      if (typeof window.bootstrap === 'undefined' || !bootstrap.Popover) return;
      // Bootstrap 5 Popover 初始化：hover + focus 都能触发，点击外部关闭
      document.querySelectorAll('.help-popover').forEach(function (el) {
        new bootstrap.Popover(el, {
          trigger: 'hover focus',
          placement: 'top',
          html: true,
          container: 'body'
        });
      });
    });
  </script>

  <style>
    /* 同一时间的“子行”缩进 + 颜色微弱化 */
    .same-time-child td { padding-left: 1.25rem; color:#6c757d; }
    .same-time-prefix { display:inline-block; width:1.25rem; margin-right:.25rem; color:#6c757d; }
  </style>

<script>
  // ===== Toggle ETC 三列显隐（持久化到 localStorage） =====
  (function(){
    const key = 'dr_toggle_etc_cols_visible';
    function getTable(){ return document.querySelector('table.report-table'); }
    function getSwitch(){ return document.getElementById('toggle-etc-cols'); }
    function applyState(show){
      const tb = getTable(); if (!tb) return;
      tb.classList.toggle('etc-cols-hidden', !show);
    }
    document.addEventListener('DOMContentLoaded', () => {
      const sw = getSwitch(); const tb = getTable();
      if (!sw || !tb) return;

      // 初始：默认隐藏；如有历史记录则按历史
      const saved = localStorage.getItem(key);
      const show = saved === null ? false : (saved === '1');
      sw.checked = show;
      applyState(show);

      // 绑定切换
      sw.addEventListener('change', () => {
        const on = !!sw.checked;
        applyState(on);
        localStorage.setItem(key, on ? '1' : '0');
      });
    });
  })();
</script>

<script>
/* 折叠控制（记住展开/收起状态） */
(function setupCollapsers(){
  const LS_KEY_PREFIX = 'dr_collapse:';
  const getKey = el => LS_KEY_PREFIX + (el?.dataset?.collapseKey || '');

  function saveOpenState(el, isOpen){
    try{ localStorage.setItem(getKey(el), isOpen?'1':'0'); }catch(e){}
  }
  function readOpenState(el){
    try{
      const v = localStorage.getItem(getKey(el));
      return v === null ? true : (v === '1');  // 默认展开
    }catch(e){ return true; }
  }

  [['ride-etc-card','#ride-etc-body']].forEach(([outerId, bodySel])=>{
    const outer = document.getElementById(outerId); if (!outer) return;
    const body  = outer.querySelector(bodySel);    if (!body)  return;

    // 初始：按记忆展开/收起
    body.style.display = readOpenState(outer) ? '' : 'none';

    // 按钮切换
    outer.querySelectorAll('.js-collapse-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const isOpen = body.style.display !== 'none';
        body.style.display = isOpen ? 'none' : '';
        saveOpenState(outer, !isOpen);
      });
    });
  });

  // 对外暴露一个“强制展开”的方法（其他逻辑需要时可调用）
  window.__openCollapseCard = function(outerId, bodySel){
    const outer = document.getElementById(outerId);
    const body  = outer?.querySelector(bodySel);
    if (body){ body.style.display=''; saveOpenState(outer, true); }
  };
})();
</script>

<script>
  // 料金栏只允许数字
  document.addEventListener('input', function (e) {
    // 专门盯「料金」这一列：fee-input
    if (e.target.classList && e.target.classList.contains('fee-input')) {
      // 删除所有非数字
      e.target.value = e.target.value.replace(/\D/g, '');
    }
  });
</script>


{% endblock %}
