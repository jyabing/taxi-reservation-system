{% extends "staffbook/base_staffbook.html" %}
{% load widget_tweaks %}
{% load time_filters %}
{% load humanize %}
{% load custom_totals %}
{% load custom_tags %}


{% load static %}
{% load driver_extras %}

{% block extra_css %}


{% endblock %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
table.table tr.has-note,
table.table tr.has-note td {
  background-color: #fff3cd !important;
}
.auto-width-input {
  width: 2ch;
  min-width: 60px;
  max-width: 100px;
  box-sizing: content-box;
  transition: width 0.2s;
}
.mirror-span {
  position: absolute;
  visibility: hidden;
  white-space: pre;
  font: inherit;
}
.mark-checkbox {
  transform: scale(1.3);
  margin-top: 3px;
}
.scrollable-input {
  overflow-x: auto;
  white-space: nowrap;
  min-width: 50px;
  width: 100%;
  max-width: 100px;
}
#payment-summary-panel {
  font-size: 0.95rem;
}
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}
</style>

{% block content %}
<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <h4>{% if report %}{{ report.driver.name }}{% else %}{{ driver.name }}{% endif %}- ä¹—å‹™æ—¥å ±ã®ç·¨é›†</h4>
  {{ form.meter_fee|add_class:"form-control" }}
  <p class="text-muted">æ—¥ä»˜ï¼š{{ form.date.value|date:"Yå¹´næœˆjæ—¥" }}</p>

  {% if report.pk %}
    {% if report.edited_by %}
      <div class="alert alert-light small mb-3">
        <strong>æœ€çµ‚ç·¨é›†ï¼š</strong>
        {{ report.edited_by.get_full_name|default:report.edited_by.username }}
        {{ report.edited_at|date:"Yå¹´næœˆjæ—¥ H:i" }} ã«ä¿å­˜
      </div>
    {% else %}
      <div class="alert alert-secondary small mb-3">ç·¨é›†å±¥æ­´ãªã—</div>
    {% endif %}
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ï¼š</strong>
      <ul>
      {% for field, errs in form.errors.items %}
        <li>{{ field }}: {{ errs|join:", " }}</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>æ˜ç´°ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¨ãƒ©ãƒ¼ï¼š</strong>
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

    <!--ç¼©è¿›æ— å½±å“ï¼Œä¹Ÿå¯ä»¥å†™æˆå•è¡Œå½¢å¼-->
    <form method="post"
      {% if is_edit %}
        action="{% url 'dailyreport:driver_dailyreport_edit' driver_id=driver.id report_id=report.id %}"
      {% elif driver and driver.id %}
        action="{% url 'dailyreport:driver_dailyreport_direct_add' driver.id %}"
      {% else %}
        action="#"
      {% endif %}
      autocomplete="off">
    {% csrf_token %}
    {{ form.status.as_hidden }}
    {{ form.date.as_hidden }}

    <div class="mb-3">
      <label class="form-label">å‚™è€ƒï¼š</label>
      {{ form.note|add_class:"form-control form-control-sm"|attr:"rows:2"|attr:"style:width:100%; max-width:400px;" }}
    </div>

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th style="white-space: nowrap;"><strong>ä½¿ç”¨è»Šä¸¡</strong></th>
          <th style="white-space: nowrap;">å‡ºå‹¤</th>
          <th style="white-space: nowrap;">é€€å‹¤</th>
          <th style="white-space: nowrap;">å‹¤å‹™æ™‚é–“</th>
          <th style="white-space: nowrap;">ä¼‘æ†©æ™‚é–“</th>
          <th style="white-space: nowrap;"><span class="text-info">å®Ÿåƒæ™‚é–“</span></th>
          <th class="text-danger" style="white-space: nowrap;">æ®‹æ¥­æ™‚é–“</th>
          <th style="white-space: nowrap;">çµ¦æ²¹ (L)</th>
          <th style="white-space: nowrap;">èµ°è¡Œè·é›¢ (KM)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            {% if form.instance.vehicle %}
              <span class="form-control-plaintext">{{ form.instance.vehicle }}</span>
            {% else %}
              <span class="text-muted">æœªé¸æŠ</span>
            {% endif %}
            {{ form.vehicle }}
          </td>

          <!-- å‡ºå‹¤ -->
          <td style="max-width:110px;">
            <input type="text" name="clock_in" class="form-control form-control-sm time-input" value="{{ form.clock_in.value|default_if_none:'' }}">
          </td>

          <!-- é€€å‹¤ -->
          <td style="max-width:110px;" >
            <input type="text" name="clock_out" class="form-control form-control-sm time-input" style="min-width: 60px; max-width: 200px; width: 100%; overflow-x: auto; white-space: nowrap;" value="{{ form.initial.clock_out|default_if_none:'' }}">
          </td>
          <td id="work-duration">--:--</td> <!--å‹¤å‹™æ™‚é–“-->

          <!-- âœ… ä¼‘æ†©æ™‚é–“è¾“å…¥ -->
          <td id="break-time">
            <input type="text" name="break_time_input" id="break-time-input"
                class="form-control form-control-sm text-center"
                maxlength="5" pattern="^\d{1,2}:\d{2}$"
                style="max-width:90px;" placeholder="0:00"
                value="{{ break_time_h }}:{{ break_time_m }}">

            <!-- âœ… æ˜¾ç¤ºã€Œå®Ÿä¼‘æ†© +20åˆ†ã€ -->
            <div class="form-text mt-1 text-muted">
              å®Ÿä¼‘æ†©: <span id="break-time-display">--:--</span>
            </div>

            <!-- âœ… éšè—å­—æ®µï¼ˆè‡ªåŠ¨å¡«å…¥ 20åˆ†åæ—¶é—´ï¼‰ -->
            <input type="hidden" name="break_time_plus20" id="break-time-plus20">
          </td>

          <!-- å®Ÿåƒæ™‚é–“ -->
          <td class="text-center text-primary" id="actual-work-time">
            {% if form.instance.å®Ÿåƒæ™‚é–“ %}
              {{ form.instance.å®Ÿåƒæ™‚é–“ }}
            {% else %}
              --:--
            {% endif %}
          </td>

          <!-- æ®‹æ¥­æ™‚é–“ -->
          <td class="text-danger text-center" id="overtime">{{ form.instance.æ®‹æ¥­æ™‚é–“|format_duration }}</td>
          
          <td style="max-width:90px;">{{ form.gas_volume|add_class:"form-control form-control-sm text-end" }}</td>
          <td >{{ form.mileage|add_class:"form-control form-control-sm text-end" }}</td>
        </tr>
      </tbody>
    </table>

    <div id="payment-summary-panel" class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      {% for key, label in summary_keys %}
        <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
          <div class="small text-muted">
            {% if key == "meter" %}
              <div class="small text-muted">å£²ä¸Šåˆè¨ˆ</div>
              <div>
                <span id="total_meter">
                  {{ totals.meter_total|default:0|intcomma }}  {# â† åº”è¯¥æ˜¾ç¤ºæ”¶å…¥åˆè®¡ï¼Œå¦‚ 17,800 #}
                </span>
                <div class="small text-muted">
                  <small>(ãƒ¡ãƒ¼ã‚¿ã®ã¿: <span id="total_meter_only">
                    {{ totals.meter_only_total|default:0|intcomma }}
                  </span>)</small>
                </div>
                <div class="small text-muted">
                  â€» å£²ä¸Šåˆè¨ˆã«ã¯ã€æ”¯æ‰•æ–¹æ³•ä»˜ãã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒå«ã¾ã‚Œã¾ã™ã€‚
                </div>
              </div>
            {% else %}
              <div class="small text-muted">{{ label }} åˆè¨ˆ</div>
              <div>
                <span id="total_{{ key }}">
                  {{ totals|get_item:key|get_item:"total"|default:0|floatformat:"0" }}
                </span>
                ï¼ˆ<span id="bonus_{{ key }}">
                  {{ totals|get_item:key|get_item:"bonus"|default:0|floatformat:"0" }}
                </span>ï¼‰
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- âœ… è¿½åŠ ï¼šè²¸åˆ‡åå…¥ãƒ»å£²ä¸Šåˆè¨ˆãƒ»å…¥é‡‘åˆè¨ˆ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">è²¸åˆ‡ç¾é‡‘</div>
        <div>
          <span id="charter-cash-total">
            {{ totals.charter_cash_total|default:0|intcomma }}
          </span> å††
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">è²¸åˆ‡æœªå</div>
        <div>
          <span id="charter-uncollected-total">
            {{ totals.charter_uncollected_total|default:0|intcomma }}
          </span> å††
        </div>
      </div>
      
      <!-- âœ… å…¥é‡‘ + ETC ç»¼åˆåŒºåŸŸ -->
      <div class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      <!-- âœ… æ–°å¢åŒºåŸŸå¼€å§‹ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 80px;">
        <label class="small text-muted">å…¥é‡‘é¡</label>
        {{ form.deposit_amount|add_class:"form-control form-control-sm text-end"|attr:"id:deposit-input"|attr:"style:min-width:80px;"|attr:"placeholder:0" }}

        <!-- âœ… ETC åŒ…å«åˆ¤æ–­æç¤ºï¼ˆJS åŠ¨æ€ä¿®æ”¹ï¼‰ -->
        <div id="etc-included-warning" class="small mt-1"></div>

        <!-- âœ… ETC åŒ…å«åˆ¤æ–­æç¤º -->
        {% if report.etc_collected and report.deposit_amount %}
          {% if report.is_etc_included_in_deposit %}
            <div class="small text-success mt-1">âœ”ï¸ å« ETC</div>
          {% else %}
            <div class="small text-danger mt-1">âš ï¸ æœªå« ETCï¼Œè¯·ç¡®è®¤</div>
          {% endif %}
        {% endif %}

        <label class="small text-muted mt-2 d-block">éä¸è¶³ï¼ˆå…¥é‡‘ - ç¾é‡‘(ãªãŒã—)  - è²¸åˆ‡ç¾é‡‘ï¼‰</label>
        <div id="difference-output" class="form-control-plaintext text-end small text-muted" style="min-height: 1.5em;">
          {{ form.deposit_difference.value|default:"--" }}
        </div>

        <!-- æ”¾è¿™é‡Œï¼ -->
        <div id="etc-included-warning" class="alert alert-info small py-1 px-2 mt-1">
          ETC æ”¶æ¬¾çŠ¶æ€åˆ¤æ–­ä¸­â€¦
        </div>
      </div>
      <!-- âœ… æ–°å¢åŒºåŸŸç»“æŸ -->

      
      <!-- âœ… ETC ç°é‡‘æ”¶åŒºåŸŸ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <label class="small text-muted">ETC æ”¶å–=ä¹—è»Šåˆè¨ˆï¼ˆå††ï¼‰</label>
        {{ form.etc_collected|add_class:"form-control form-control-sm text-end" }}

        <label class="small text-muted mt-2 d-block">æ”¯ä»˜æ–¹å¼</label>
        {{ form.etc_payment_method|add_class:"form-select form-select-sm" }}
      </div>

      <!-- ğŸ”’ éšè—â€œETC æœªæ”¶=ç©ºè»Šåˆè¨ˆï¼ˆå††ï¼‰â€ï¼›ä»å‚ä¸æäº¤ï¼ˆå€¼ç”± JS è‡ªåŠ¨å›å¡«ï¼‰ -->
      <div class="d-none">
        {{ form.etc_uncollected }}
      </div>


      <!-- === è¿½åŠ ï¼šç©ºè»ŠETCï¼ˆå›ç¨‹ï¼‰æ˜ç»†ï¼Œç”¨äºè®¡ç®—è¦†ç›–ä¸å¸æœºè´Ÿæ‹… === -->
      <div class="border rounded px-3 py-2" style="min-width: 280px;">
        <div class="small text-muted mb-2">ç©ºè»ŠETCï¼ˆå›ç¨‹ï¼‰è©³ç´°</div>
        <div class="row g-2 align-items-end">
          <!-- ç©ºè»ŠETCé‡‘é¢ -->
          <div class="col-6">
            <label for="id_etc_empty_amount" class="form-label small">ç©ºè»ŠETC é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" class="form-control form-control-sm text-end"
                   id="id_etc_uncollected" name="etc_uncollected" min="0" step="1" value="">
          </div>
          <!-- å›ç¨‹è´¹å—é¢†é¢ -->
          <div class="col-6">
            <label for="id_etc_return_fee_claimed" class="form-label small">å›ç¨‹è²» å—é ˜é¡ï¼ˆå††ï¼‰</label>
            <input type="number" class="form-control form-control-sm text-end"
                   id="id_etc_return_fee_claimed" name="etc_return_fee_claimed" min="0" step="1" value="">
          </div>
          <!-- å›ç¨‹è´¹æ”¯ä»˜æ–¹å¼ -->
          <div class="col-6">
            <label for="id_etc_return_fee_method" class="form-label small">å›ç¨‹è²» æ”¯æ‰•æ–¹æ³•</label>
            <select id="id_etc_return_fee_method" name="etc_return_fee_method" class="form-select form-select-sm">
              <option value="none">â€” å€‹åˆ¥ï¼ˆåˆ¥æ‰•ã„/ãªã—ï¼‰â€”</option>
              <option value="app_ticket">ã‚¢ãƒ—ãƒª/ãƒã‚±ãƒƒãƒˆ ä¸€ä½“çµç®—</option>
              <option value="cash_to_driver">ç¾é‡‘ï¼ˆç›´æ¥å¸æœºï¼‰</option>
            </select>
          </div>
          <!-- ç©ºè»ŠETC ä½¿ç”¨å¡ -->
          <div class="col-6">
            <label for="id_etc_empty_card" class="form-label small">ç©ºè»ŠETC ã‚«ãƒ¼ãƒ‰</label>
            <select id="id_etc_empty_card" name="etc_empty_card" class="form-select form-select-sm">
              <option value="company">ä¼šç¤¾ã‚«ãƒ¼ãƒ‰</option>
              <option value="own">è‡ªå·±ã‚«ãƒ¼ãƒ‰</option>
              <option value="guest">ãŠå®¢æ§˜ã‚«ãƒ¼ãƒ‰</option>
            </select>
          </div>
        </div>
        <div class="form-text mt-2">
          <small>
            è¦†ç›–è§„åˆ™ï¼šæ”¯æ‰•æ–¹æ³• = <strong>ã‚¢ãƒ—ãƒª/ãƒã‚±ãƒƒãƒˆ</strong> æ—¶ï¼Œå›ç¨‹è²»ç”¨äºè¦†ç›–ç©ºè»ŠETCï¼›<br>
            è¦†ç›–ä¸è¶³ â†’ <strong>å¸æœºè² æ‹…</strong>ï¼›è¦†ç›–è¿‡å¤š â†’ è¨˜ç‚º <strong>æœªæ”¶ETC</strong>ï¼ˆå±•ç¤º/çµ±è¨ˆç”¨ï¼‰ã€‚
          </small>
        </div>
      </div>
      <!-- === è¿½åŠ ç»“æŸ === -->

      <!-- âœ… ETC åº”æ”¶åˆè®¡ï¼ˆåªè¯»ï¼‰ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <label class="small text-muted">ETC åº”æ”¶åˆè®¡ï¼ˆå††ï¼‰</label>
        <input type="text" id="etc-expected-output" class="form-control form-control-sm text-end bg-light" readonly
              value="{{ report.etc_expected|default_if_none:'0' }}">
      </div>

      <!-- âœ… ETC ä¸è¶³é¢ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <label for="{{ form.etc_shortage.id_for_label }}" class="small text-danger">ETCä¸è¶³ï¼ˆå††ï¼‰</label>
        {{ form.etc_shortage|add_class:"form-control form-control-sm text-end text-danger"|attr:"readonly" }}
      </div>

      <!-- ETC æœªæ”¶æé†’åŒº -->
      <div id="etc-diff-display" class="alert alert-info small py-1 px-2 mt-1">
        æœªæ”¶ ETCï¼š0 å††ï¼ˆæ— éœ€æ‰£é™¤ï¼‰
      </div>
      
      <!-- âœ… æ™ºèƒ½æç¤ºåŒºï¼ˆæ¨èæ”¾åœ¨ payment-summary-panel ç»“å°¾ï¼‰ -->
      <div id="smart-hint-panel" class="mt-2 w-100">
        {% if deposit_amt %}
          {% if deposit_amt < total_collected %}
            <div class="alert alert-danger py-1 px-2 small mb-2">
              âš ï¸ å…¥é‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è«‹æ±‚é¡ (ç¾é‡‘ + ETC) ã¯ <strong>{{ total_collected|floatformat:"0"|intcomma }}å††</strong> ã§ã™ãŒã€å…¥åŠ›ã•ã‚ŒãŸå…¥é‡‘é¡ã¯ <strong>{{ deposit_amt|intcomma }}å††</strong> ã§ã™ã€‚
            </div>
          {% else %}
            <div class="alert alert-success py-1 px-2 small mb-2">
              âœ”ï¸ å…¥é‡‘é¡ã¯ç¾é‡‘ + ETC ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã¾ã™ã€‚
            </div>
          {% endif %}

          {% if report.etc_uncollected %}
            <div class="alert alert-info py-1 px-2 small mb-2">
              ğŸš§ ETC æœªæ”¶ï¼š<strong>{{ report.etc_uncollected|intcomma }}å††</strong>ã€‚è¯·ç¡®è®¤å¸æœºæ˜¯å¦å·²è¡¥æ”¶ã€‚
            </div>
          {% endif %}

          {% if deposit_amt < total_sales %}
            <div class="alert alert-warning py-1 px-2 small mb-2">
              â„¹ï¸ å£²ä¸Šåˆè¨ˆ <strong>{{ total_sales|intcomma }}å††</strong> å¤§äºå…¥é‡‘ <strong>{{ deposit_amt|intcomma }}å††</strong>ï¼Œæœªæ”¶ ETC æˆ–å…¶ä»–å»¶è¿Ÿç»“ç®—é¡¹ã€‚
            </div>
          {% endif %}
        {% endif %}
      </div>

    </div>

    <table class="table table-bordered table-sm report-table">
      <thead class="table-light">
        <tr>
          <th class="row-number-header">#</th>
          <th style="white-space: nowrap;">æ™‚é–“</th>
          <th style="white-space: nowrap;">ä¹—è»Šåœ°</th>
          <th style="white-space: nowrap;">æ–™é‡‘</th>
          <th style="white-space: nowrap;">æ”¯ä»˜</th>
          <th style="white-space: nowrap;">å¼·èª¿</th>
          <th style="white-space: nowrap;">è²¸åˆ‡</th>
          
          <th style="white-space: nowrap;">è²¸åˆ‡é‡‘é¡</th>
          <th style="white-space: nowrap;">å‡¦ç†</th>
          <th>æ³¨é‡ˆ</th>
          <th style="white-space: nowrap;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {{ formset.management_form }}
        {% for form in formset.forms %}
          <tr class="report-item-row {% if form.instance.is_flagged %}has-note{% endif %}">
            {{ form.id }}
            <td class="row-number">{{ forloop.counter }}</td>
            <td style="min-width: 70px;">
              {% if form.ride_time.errors %}
                <div class="text-danger small">{{ form.ride_time.errors.0 }}</div>
              {% endif %}
              {{ form.ride_time|add_class:"form-control form-control-sm time-input" }}
            </td>

            <td style="min-width: 70px;">
              {% if form.ride_from.errors %}
                <div class="text-danger small">{{ form.ride_from.errors.0 }}</div>
              {% endif %}
              {{ form.ride_from|add_class:"form-control form-control-sm" }}
            </td>

            <td style="min-width: 70px;">
              <input
                type="text"
                name="{{ form.meter_fee.html_name }}"
                id="{{ form.meter_fee.id_for_label }}"
                value="{{ form.meter_fee.value|floatformat:"-0" }}"
                class="form-control form-control-sm text-end meter-fee-input"
              >
            </td>

            <td style="min-width: 100px;">
              {% if form.payment_method.errors %}
                <div class="text-danger small">{{ form.payment_method.errors.0 }}</div>
              {% endif %}
              {{ form.payment_method|add_class:"form-select form-select-sm" }}
            </td>

            <td class="text-center">
              {% if form.is_flagged.errors %}
                <div class="text-danger small">{{ form.is_flagged.errors.0 }}</div>
              {% endif %}
              {{ form.is_flagged }}
            </td>

            <td class="text-center">
              {% if form.is_charter.errors %}
                <div class="text-danger small">{{ form.is_charter.errors.0 }}</div>
              {% endif %}
              {{ form.is_charter }}
            </td>

            <td>
              {{ form.charter_amount_jpy|add_class:"form-control form-control-sm text-end auto-width-input charter-amount-input" }}
            </td>
            <td>
              {{ form.charter_payment_method|add_class:"form-control form-control-sm auto-width-input charter-payment-method-select" }}
            </td>

            <td>
              {% if form.note.value %}ğŸ“{% endif %}
              {% if form.note.errors %}
                <div class="text-danger small">{{ form.note.errors.0 }}</div>
              {% endif %}
              {{ form.note }}
            </td>

            <!-- âœ… åˆ é™¤æŒ‰é’®åŒºåŸŸ -->
            <td style="white-space: nowrap;">
              <div class="d-flex flex-row gap-1">
                {% if form.instance.pk %}
                  {{ form.DELETE.as_hidden }}
                  {{ form.DELETE }}
                  <button type="button" class="btn btn-sm btn-danger delete-row">å‰Šé™¤</button>
                {% else %}
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row">ç§»é™¤</button>
                {% endif %}
                  <button type="button" class="btn btn-sm btn-outline-primary insert-below">â•ä¸‹ã«æŒ¿å…¥</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <!-- âœ… æ–°å¢ï¼šéšè—çš„ç©ºæ¨¡æ¿è¡Œä¾› JS å…‹éš† -->
      <tbody id="empty-form-template" class="d-none">
        <tr class="report-item-row">
          {{ formset.empty_form.id }}
          {{ formset.empty_form.DELETE }}

          <td class="row-number">__num__</td>
          <td>{{ formset.empty_form.ride_time|add_class:"form-control form-control-sm time-input" }}</td>
          <td>{{ formset.empty_form.ride_from|add_class:"form-control form-control-sm" }}</td>
          <td>{{ formset.empty_form.meter_fee|add_class:"form-control form-control-sm text-end meter-fee-input" }}</td>
          <td>{{ formset.empty_form.payment_method|add_class:"form-select form-select-sm" }}</td>
          <td class="text-center">{{ formset.empty_form.is_flagged }}</td>

          <td class="text-center">{{ formset.empty_form.is_charter }}</td>
          <td>{{ formset.empty_form.charter_amount_jpy|add_class:"form-control form-control-sm text-end auto-width-input charter-amount-input" }}</td>
          <td>{{ formset.empty_form.charter_payment_method|add_class:"form-control form-control-sm auto-width-input charter-payment-method-select" }}</td>

          <td>{{ formset.empty_form.note|add_class:"form-control" }}</td>
          <td style="white-space:nowrap;">
            <button type="button" class="btn btn-danger btn-sm delete-row">å‰Šé™¤</button>
            <button type="button" class="btn btn-sm btn-outline-primary insert-below">â•å‘ä¸‹æŒ¿å…¥</button>
          </td>
        </tr>
      </tbody>
      <!-- âœ… æ–°å¢ç»“æŸ -->

    </table>

    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
  </form>

  <div class="text-center mt-2 d-flex justify-content-center gap-2">
    <div class="input-group" style="max-width: 260px;">
      <span class="input-group-text">è¡Œã«æŒ¿å…¥</span>
      <input type="number" min="1" class="form-control" id="insert-index-input" placeholder="ä¾‹: 10">
      <button type="button" class="btn btn-outline-secondary" id="insert-at-btn">æŒ‡å®šè¡Œã«æŒ¿å…¥</button>
    </div>
  </div>
  
</div>

{% endblock %}

{% block extra_js %}
  <!-- âœ… å¼•å…¥ flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

  <!-- âœ… å¼•å…¥è‡ªå®šä¹‰è„šæœ¬ -->
  <script src="{% static 'dailyreport/js/dailyreport.js' %}"></script>

  <!-- âœ… ä¿ç•™é«˜äº®æ ·å¼ï¼ˆæ— éœ€å¤šä»½ JSï¼‰ -->
  <style>
    table.table tr.has-note td,
    table.table tr.has-note {
      background-color: #fff8b3 !important;
    }
  </style>



{% endblock %}