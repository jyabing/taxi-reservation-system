{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>车辆闲置分析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi { display:flex; gap:1rem; margin: 10px 0; }
    .kpi .card { padding:12px 16px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .table thead th { white-space: nowrap; }
    /* 给图表一个高度，避免高度为 0 */
    #idleBar { min-height: 320px; }
  </style>
</head>
<body class="container py-3">
  <h3 class="mb-3">车辆闲置分析</h3>

  <!-- 筛选 -->
  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-auto">
      <label class="form-label">开始日</label>
      <input type="date" name="from" value="{{ date_from }}" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <label class="form-label">结束日</label>
      <input type="date" name="to" value="{{ date_to }}" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary btn-sm" type="submit">应用</button>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'analysis:vehicle_idle_export_csv' %}?from={{date_from}}&to={{date_to}}">导出CSV</a>
    </div>
  </form>

  <!-- KPI -->
  <div class="kpi">
    <div class="card">
      <div class="small text-muted">统计区间</div>
      <div><strong>{{ date_from }}</strong> ~ <strong>{{ date_to }}</strong>（共 {{ total_days }} 天）</div>
    </div>
    <div class="card">
      <div class="small text-muted">样本车辆</div>
      <div><strong>{{ rows|length }}</strong> 台</div>
    </div>
  </div>

  <!-- 图表 -->
  <div class="card mb-3 p-3">
    <canvas id="idleBar"></canvas>
  </div>

  <!-- 表格 -->
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>车牌</th>
          <th class="text-end">可用天</th>
          <th class="text-end">出车天</th>
          <th class="text-end">总稼动时长(h)</th>
          <th class="text-end">稼动率</th>
          <th class="text-end">闲置率</th>
          <th class="text-end">出车日均时长(h)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.label }}</td>
          <td class="text-end">{{ r.available_days }}</td>
          <td class="text-end">{{ r.active_days }}</td>
          <td class="text-end">{{ r.total_hours }}</td>
          <td class="text-end">
            {% widthratio r.utilization 1 100 %}%
          </td>
          <td class="text-end">
            <strong>{% widthratio r.idle_rate 1 100 %}%</strong>
          </td>
          <td class="text-end">{{ r.avg_active_hours }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-center text-muted">暂无数据</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    (function() {
      // Chart 数据（后端给的是 0~1，这里乘 100 变成百分比）
      const labels = [{% for r in rows %}"{{ r.label }}",{% endfor %}];
      const idleRates = [{% for r in rows %}{{ r.idle_rate|floatformat:4 }}*100,{% endfor %}];
      const utilizations = [{% for r in rows %}{{ r.utilization|floatformat:4 }}*100,{% endfor %}];

      const ctx = document.getElementById('idleBar').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: '闲置率(%)', data: idleRates, borderWidth: 1 },
            { label: '稼动率(%)', data: utilizations, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '%';
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: true, max: 100, ticks: { callback: (v)=> v + '%' } },
            x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 0 } }
          }
        }
      });
    })();
  </script>
</body>
</html>
