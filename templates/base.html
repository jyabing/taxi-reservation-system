{% load static custom_filters %}
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}系统平台{% endblock %}</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'css/gantt.css' %}">
  <script src="{% static 'js/gantt.js' %}"></script>

  {% block extra_head %}{% endblock %}

  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      margin: 0;
      font-size: 16px;
    }

    .container {
      padding: 20px;
    }

    @media (max-width: 768px) {
      body {
        font-size: 15px;
        padding: 0.5em;
      }
      .container {
        padding: 10px;
      }
      h1, h2 {
        font-size: 1.2rem;
      }
      table {
        font-size: 0.9rem;
      }
      .thumbnail {
        width: 100% !important;
        height: auto !important;
      }
      .mobile-hidden {
        display: none !important;
      }
    }

    /* ======= responsive-cards ======= */
    @media (max-width: 991.98px){
      table.responsive-cards{
        width:100%;
        border-collapse:separate;
        border-spacing:0 10px;
      }
      table.responsive-cards thead{ display:none; }
      table.responsive-cards tbody{ display:block; }
      table.responsive-cards tr{
        display:block;
        background:#fff;
        border:1px solid #e5e7eb;
        border-radius:12px;
        box-shadow:0 6px 16px rgba(0,0,0,.05);
        padding:10px;
        margin:10px 0;
      }
      table.responsive-cards td{
        display:flex;
        justify-content:space-between;
        gap:12px;
        padding:8px 10px;
        border:none;
        border-bottom:1px dashed #f0f0f0;
      }
      table.responsive-cards td:last-child{ border-bottom:none; }
      table.responsive-cards td::before{
        content:attr(data-label);
        font-weight:600;
        color:#374151;
      }
      table.responsive-cards td[data-label=""]::before{ content:""; }
    }
  </style>
</head>

<body>
  {# ✅ 只保留这一条统一导航 #}
  {% include "partials/navbar.html" %}

  {# ------ 全局消息 ------ #}
  {% if messages %}
    <div class="container mt-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="container">
    {% block content %}{% endblock %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <script>
    flatpickr(".flat-date", {
      dateFormat: "Y-m-d",
      locale: "ja"
    });
    flatpickr(".flat-time", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
      locale: "ja"
    });
    const workDateInput = document.getElementById("work-date");
    if (workDateInput) {
      flatpickr(workDateInput, {
        dateFormat: "Y-m-d",
        locale: "ja",
        minDate: "today"
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 点击日志这段保留 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const nav = document.querySelector('nav');
      if (!nav) return;

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      nav.addEventListener('click', function (evt) {
        const a = evt.target.closest('a');
        if (!a || !nav.contains(a)) return;
        const link_name = (a.innerText || '').trim();
        const link_url  = a.getAttribute('href') || '';
        const csrftoken = getCookie('csrftoken');

        fetch("/log-link-click/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken
          },
          body: new URLSearchParams({ link_name, link_url })
        }).catch(err => console.error("点击记录失败", err));
      });
    });
  </script>

  <!-- responsive-cards JS -->
  <script>
    (function(){
      function enhance(table){
        if(table.dataset._cardsDone) return;
        const heads=[...table.querySelectorAll('thead th')].map(th=>th.textContent.trim());
        table.querySelectorAll('tbody tr').forEach(tr=>{
          [...tr.children].forEach((td,idx)=>{
            if(td.nodeName!=='TD') return;
            if(!td.hasAttribute('data-label')){
              const label=heads[idx]||'';
              td.setAttribute('data-label',label);
            }
          });
        });
        table.dataset._cardsDone="1";
      }
      function run(){
        document.querySelectorAll('table.responsive-cards').forEach(enhance);
      }
      document.addEventListener('DOMContentLoaded', run);
      window.applyResponsiveCards = run;
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
