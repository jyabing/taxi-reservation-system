{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>è½¦è¾†ä¸€å‘¨é¢„çº¦æ¦‚è§ˆ</h2>
<p>
  <a href="?offset={{ offset|add:"-1" }}">â† ä¸Šä¸€å‘¨</a> |
  <a href="?offset=0">æœ¬å‘¨</a> |
  <a href="?offset={{ offset|add:"1" }}">ä¸‹ä¸€å‘¨ â†’</a>
</p>

<table border="1">
  <thead>
    <tr>
      <th>è½¦ç‰Œå·</th>
      {% for date in week_dates %}
        <th>{{ date|date:"m/d (D)" }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in vehicle_data %}
      <tr>
        <td>
          <a href="{% url 'vehicle_monthly_gantt' row.vehicle.id %}">
            {{ row.vehicle.license_plate }}
          </a>
        </td>
        {% for cell in row.days %}
        <td style="vertical-align: top; {% if cell.is_past %}color: #aaa;{% endif %}">

          {% if cell.reservations %}
            {# åˆ—å‡ºè¿™ä¸€å¤©æ‰€æœ‰å·²æœ‰çš„é¢„çº¦ #}
            {% for res in cell.reservations %}
              <div>
                <a href="{% url 'reservation_detail' res.id %}">
                  {{ res.start_time|time:"H:i" }}â€“{{ res.end_time|time:"H:i" }} {{ res.driver.username }}
                </a>
              </div>

              {# å¦‚æœæ˜¯æœ€åä¸€æ¡é¢„çº¦ï¼Œå°±åœ¨å®ƒåé¢åˆ¤æ–­ç©ºç¼º #}
              {% if forloop.last %}
                {# å½“å¤©æœªè¿‡ ä¸” ç»“æŸæ—¶é—´ < 23:59 ä¸” (æ— å†·å´æœŸ OR å·²è¿‡å†·å´æœŸ) #}
                {% if not cell.is_past and res.end_time < "23:59"|time %} 
                  {# å†·å´æ£€æŸ¥ï¼ˆåªè¦ä¸æ˜¯å†·å´æˆ–å·²è¿‡å†·å´æœŸéƒ½èƒ½çº¦ï¼‰ #}
                  {% if not cooldown_end or now_dt > cooldown_end %}
                    <div style="margin-top:4px;">
                      {# æ‹¼æ¥ url å’ŒæŸ¥è¯¢å‚æ•° #}
                      <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:'Y-m-d' }}&start={{ res.end_time|time:'H:i' }}" style="font-size:0.9em;">ğŸ“ ç©ºç¼º</a>
                    </div>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            {# æ•´å¤©ç©ºç¼ºæ—¶ #}
            {% if not cell.is_past %}
              {% if cell.date == now_dt.date %}
                {% if not cooldown_end or now_dt > cooldown_end %}
                  <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:"Y-m-d" }}">ğŸ“ ç©ºç¼º</a>
                {% else %}
                  <span title="è·ç¦»ä¸Šæ¬¡é¢„çº¦ç»“æŸ+10hå‰ä»ä¸å¯å†çº¦">ğŸ”’ å†·å´ä¸­</span>
                {% endif %}
              {% else %}
                <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:"Y-m-d" }}">ğŸ“ ç©ºç¼º</a>
              {% endif %}
            {% else %}
              ç©ºç¼º
            {% endif %}
          {% endif %}

        </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<p><a href="{% url 'vehicle_status' %}">â† è¿”å›çŠ¶æ€é¡µ</a></p>
{% endblock %}