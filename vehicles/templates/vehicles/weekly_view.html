{# templates/vehicles/weekly_view.html #}
{% extends 'base.html' %}
{% load static %}
{% load dict_helpers %}
{% block content %}

<h2 class="mb-4">ğŸš— è»Šè¼Œ ä¸€é€±é–“äºˆç´„æ¦‚è¦§ï¼ˆ{{ today }}ã€œï¼‰</h2>
{% include 'partials/_messages.html' %}

{# === è½¦è¾†åˆ°æœŸæé†’ï¼ˆé¡¶ç«¯ï¼‰ === #}
{% if reminders %}
  <div class="mb-3">
    {% for car, reminder in reminders %}
      <div class="alert alert-warning py-1 px-2" style="font-size: 14px;">
        ğŸš— {{ car.license_plate }}ï¼š{{ reminder }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- ä»…æ¡Œé¢ç«¯æ˜¾ç¤ºçš„å‘¨è·³è½¬ + ç”˜ç‰¹å›¾ -->
<nav class="mb-3 d-none d-md-block">
  <a href="?date={{ today }}&offset={{ offset|add:"-1" }}">â† å‰é€±</a>
  <span class="mx-2">|</span>
  <a href="?date={{ today }}&offset=0" class="fw-bold">æœ¬é€±</a>
  <span class="mx-2">|</span>
  <a href="?date={{ today }}&offset={{ offset|add:"1" }}">æ¬¡é€± â†’</a>

  <span class="mx-2">|</span>
  <a class="btn btn-success btn-sm"
     href="{% url 'vehicles:vehicle_weekly_gantt' %}?start={{ today|date:'Y-m-d' }}">ğŸ“Š ç”˜ç‰¹å›¾
  </a>
</nav>

<style>
/* ====== æ¡Œé¢ç«¯è¡¨æ ¼æ ·å¼ï¼ˆä¿ç•™åŸæ ·ï¼‰ ====== */
.japanese-week-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #fefefe;
  border: 1px solid #dee2e6;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.japanese-week-table thead {
  background: #f6f8fb;
  color: #2c3e50;
  font-weight: 600;
}
.japanese-week-table th,
.japanese-week-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #dee2e6;
  font-size: 14px;
  vertical-align: top;
}
.japanese-week-table thead th { text-align: center; white-space: nowrap; }
.japanese-week-table tbody tr:hover { background: #f0f4fa; transition: background 0.2s; }
.japanese-week-table td a { display: inline-block; margin-bottom: 4px; }

/* ç»´ä¿®ä¸­ç½®ç° */
.maintenance { background:#eee; color:#888; }
.maintenance a { pointer-events:none; color:#888; text-decoration:none; }
.badge-maint { font-size:12px; padding:2px 6px; border:1px solid #bbb; border-radius:4px; margin-left:6px; }

/* ====== æ‰‹æœºç«¯å¡ç‰‡æ ·å¼ ====== */
.week-mobile .vehicle-card .card-header { padding: .6rem .75rem; }
.week-mobile .vehicle-card .card-body { padding: .75rem; }
.week-mobile .day-row {
  display:flex; align-items:flex-start; gap:.5rem;
  padding:.5rem .6rem; border:1px solid #e9ecef; border-radius:8px;
  margin-bottom:.5rem; background:#fff;
}
.week-mobile .day-date { min-width: 95px; font-weight:600; color:#2c3e50; }
.week-mobile .day-content { flex:1; font-size: 14px; }
.week-mobile .muted { color:#aaa; }
.week-mobile .badge-line { display:inline-block; margin:.125rem .25rem .125rem 0; }
</style>

{# ===================== æ¡Œé¢ç«¯ï¼šè¡¨æ ¼ï¼ˆâ‰¥ md æ˜¾ç¤ºï¼‰ ===================== #}
<div class="d-none d-md-block">
  <table class="japanese-week-table">
    <thead>
      <tr>
        <th style="width:120px;">ğŸ”¢ è½¦ç‰Œå·</th>
        {% for date in week_dates %}
          <th>{{ date|date:"n/jï¼ˆDï¼‰" }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in vehicle_data %}
        <tr class="{% if row.vehicle.is_maintenance %}maintenance{% endif %}">
          <td class="text-start">
            <a href="#" onclick="showCarDetailModal({{ row.vehicle.id }}); return false;" class="fw-bold">
              {{ row.vehicle.license_plate }}
            </a>

            {% if row.reminders %}
              <div class="mt-1 small">
                {% for r in row.reminders %}
                  <div class="px-2 py-1 rounded mb-1"
                       style="font-size:12px;
                              {% if r.is_today %} background:#fff3cd; color:#856404;
                              {% elif 'æ¨è¿Ÿ' in r.message or 'è¿‡æœŸ' in r.message %} background:#f8d7da; color:#721c24;
                              {% elif 'è¿˜æœ‰' in r.message %} background:#d1ecf1; color:#0c5460;
                              {% else %} background:#eee; color:#333;
                              {% endif %}">
                    {% if r.type == 'inspection' %}ğŸ§¾{% elif r.type == 'insurance' %}ğŸ›¡{% elif r.type == 'maintenance' %}ğŸ”§{% else %}ğŸ“Œ{% endif %}
                    {{ r.message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </td>

          {% for cell in row.days %}
            <td class="{% if row.vehicle.is_maintenance %}maintenance{% endif %}"
                style="{% if cell.is_past %}color:#aaa;{% endif %}">
              {% if row.vehicle.is_maintenance %}
                <span>ğŸ› ï¸ ç»´ä¿®ä¸­</span>

              {% elif cell.reservations %}
                {% for res in cell.reservations %}
                  <div>
                    {% if res.status == 'canceled' %}
                      <span style="color:#999;">âŒ
                        {% include 'partials/_time_range_snippet.html' with obj=res %}
                        {{ res.driver.username }}
                      </span>
                    {% else %}
                      <a href="{% url 'vehicles:reservation_detail' res.id %}">
                        {% include 'partials/_time_range_snippet.html' with obj=res %}
                        {{ res.driver.username }}
                      </a>
                    {% endif %}
                  </div>
                {% endfor %}

                {% if not cell.is_past %}
                  {% with row.vehicle.daily_reminders|get_item:cell.date as date_reminders %}
                    {% if date_reminders %}
                      <div class="mt-1" style="font-size:12px;">
                        {% for rmsg in date_reminders %}
                          <div style="font-size:12px;
                                      {% if 'è¿˜æœ‰' in rmsg.message %}color:#0c63e4;
                                      {% elif 'æœ¬æ—¥' in rmsg.message %}color:#d17700;
                                      {% elif 'æ¨è¿Ÿ' in rmsg.message or 'è¿‡æœŸ' in rmsg.message %}color:#c1121f;
                                      {% else %}color:#666;{% endif %}">
                            âš ï¸ {{ rmsg.message }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  {% endwith %}
                {% endif %}

                {% if not cell.is_past %}{% include 'vehicles/weekly_empty_after.html' %}{% endif %}

              {% else %}
                {% if not cell.is_past %}
                  {% if not row.vehicle.is_maintenance %}
                    <a href="{% url 'vehicles:make_reservation' row.vehicle.id %}?date={{ cell.date|date:'Y-m-d' }}">ğŸ“ ç”³è¯·é¢„çº¦</a>
                  {% else %}
                    <div>ğŸ› ï¸ ç»´ä¿®ä¸­</div>
                  {% endif %}

                  {% with row.vehicle.daily_reminders|get_item:cell.date as date_reminders %}
                    {% if date_reminders %}
                      <div class="mt-1" style="font-size:12px;">
                        {% for rmsg in date_reminders %}
                          <div style="font-size:12px;
                                      {% if 'è¿˜æœ‰' in rmsg.message %}color:#0c63e4;
                                      {% elif 'æœ¬æ—¥' in rmsg.message %}color:#d17700;
                                      {% elif 'æ¨è¿Ÿ' in rmsg.message or 'è¿‡æœŸ' in rmsg.message %}color:#c1121f;
                                      {% else %}color:#666;{% endif %}">
                            âš ï¸ {{ rmsg.message }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  <span>â€”</span>
                {% endif %}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



{# ===================== æ‰‹æœºç«¯ï¼šå¡ç‰‡ï¼ˆ< md æ˜¾ç¤ºï¼‰ ===================== #}

<style>
@media (max-width: 767.98px) {
  .mobile-sticky-nav {
    position: sticky; top: 0; z-index: 1030;
    background: rgba(255,255,255,.96);
    border-bottom: 1px solid #e9ecef;
    backdrop-filter: saturate(180%) blur(8px);
  }
  .mobile-sticky-nav .inner {
    display: flex; align-items: center; gap: .5rem;
    padding: .5rem .75rem; overflow-x: auto; white-space: nowrap;
  }
  .mobile-sticky-nav a { white-space: nowrap; }
  .mobile-sticky-nav .sep { color:#adb5bd; }
  .mobile-sticky-nav input[type="text"] { min-width: 10rem; }

  /* å€™é€‰ä¸‹æ‹‰ */
  .plate-suggest {
    position: absolute; left: .75rem; right: .75rem; top: calc(100% - .25rem);
    background: #fff; border: 1px solid #dee2e6; border-radius: .5rem;
    box-shadow: 0 8px 16px rgba(0,0,0,.08); overflow: hidden;
  }
  .plate-suggest-item {
    padding: .5rem .75rem; font-size: .95rem; cursor: pointer;
  }
  .plate-suggest-item:hover { background: #f6f8fb; }

  /* èšç„¦å¡ç‰‡é«˜äº® */
  .focus-glow { box-shadow: 0 0 0 3px rgba(13,110,253,.35) !important; transition: box-shadow .2s; }
}
</style>

<div class="mobile-sticky-nav d-md-none">
  <div class="inner position-relative">
    <a id="prevLink" class="link-primary" href="?date={{ today }}&offset={{ offset|add:'-1' }}">â† å‰é€±</a>
    <span class="sep">|</span>
    <a id="thisLink" class="link-primary" href="?date={{ today }}&offset=0">æœ¬é€±</a>
    <span class="sep">|</span>
    <a id="nextLink" class="link-primary" href="?date={{ today }}&offset={{ offset|add:'1' }}">æ¬¡é€± â†’</a>

    <input id="jumpInput" class="form-control form-control-sm" type="text" placeholder="è»Šç•ªã‚’å…¥åŠ›" />
    <button id="jumpBtn" class="btn btn-sm btn-primary">GO</button>

    {# å®æ—¶å€™é€‰åˆ—è¡¨ï¼ˆJS åŠ¨æ€å¡«å……ï¼‰ #}
    <div id="plateSuggest" class="plate-suggest d-none"></div>
  </div>
</div>

<div class="week-mobile d-md-none">
  {% for row in vehicle_data %}
  <div id="v-{{ row.vehicle.id }}" data-plate="{{ row.vehicle.license_plate }}"
      class="card vehicle-card mb-3 shadow-sm {% if row.vehicle.is_maintenance %}border-secondary{% endif %}">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <a href="#" onclick="showCarDetailModal({{ row.vehicle.id }}); return false;" class="fw-bold text-decoration-none">
          ğŸ”¢ {{ row.vehicle.license_plate }}
        </a>
        {% if row.vehicle.is_maintenance %}
          <span class="badge bg-secondary ms-2">ğŸ› ï¸ ç»´ä¿®ä¸­</span>
        {% endif %}
      </div>
      <small class="text-muted">{{ today|date:"n/jï¼ˆDï¼‰" }} èµ· 7æ—¥</small>
    </div>

    <div class="card-body">
      {# è¡Œçº§æé†’ï¼ˆä¸æ¡Œé¢ç«¯å·¦ä¾§ç›¸åŒï¼‰ #}
      {% if row.reminders %}
        <div class="mb-2">
          {% for r in row.reminders %}
            <span class="badge badge-line"
                  style="font-size:12px;
                         {% if r.is_today %} background:#fff3cd; color:#856404;
                         {% elif 'æ¨è¿Ÿ' in r.message or 'è¿‡æœŸ' in r.message %} background:#f8d7da; color:#721c24;
                         {% elif 'è¿˜æœ‰' in r.message %} background:#d1ecf1; color:#0c5460;
                         {% else %} background:#eee; color:#333;
                         {% endif %}">
              {% if r.type == 'inspection' %}ğŸ§¾{% elif r.type == 'insurance' %}ğŸ›¡{% elif r.type == 'maintenance' %}ğŸ”§{% else %}ğŸ“Œ{% endif %}
              {{ r.message }}
            </span>
          {% endfor %}
        </div>
      {% endif %}

      {# ä¸ƒå¤©é€é¡¹ #}
      {% for cell in row.days %}
        <div class="day-row {% if row.vehicle.is_maintenance %}maintenance{% endif %}">
          <div class="day-date {% if cell.is_past %}muted{% endif %}">
            {{ cell.date|date:"n/jï¼ˆDï¼‰" }}
          </div>
          <div class="day-content {% if cell.is_past %}muted{% endif %}">
            {% if row.vehicle.is_maintenance %}
              <div>ğŸ› ï¸ ç»´ä¿®ä¸­</div>

            {% elif cell.reservations %}
              {% for res in cell.reservations %}
                <div class="mb-1">
                  {% if res.status == 'canceled' %}
                    <span style="color:#999;">âŒ
                      {% include 'partials/_time_range_snippet.html' with obj=res %}
                      {{ res.driver.username }}
                    </span>
                  {% else %}
                    <a href="{% url 'vehicles:reservation_detail' res.id %}">
                      {% include 'partials/_time_range_snippet.html' with obj=res %}
                      {{ res.driver.username }}
                    </a>
                  {% endif %}
                </div>
              {% endfor %}

              {% if not cell.is_past %}
                {% with row.vehicle.daily_reminders|get_item:cell.date as date_reminders %}
                  {% if date_reminders %}
                    <div class="mt-1" style="font-size:12px;">
                      {% for rmsg in date_reminders %}
                        <div style="font-size:12px;
                                    {% if 'è¿˜æœ‰' in rmsg.message %}color:#0c63e4;
                                    {% elif 'æœ¬æ—¥' in rmsg.message %}color:#d17700;
                                    {% elif 'æ¨è¿Ÿ' in rmsg.message or 'è¿‡æœŸ' in rmsg.message %}color:#c1121f;
                                    {% else %}color:#666;{% endif %}">
                          âš ï¸ {{ rmsg.message }}
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endwith %}
              {% endif %}

              {% if not cell.is_past %}{% include 'vehicles/weekly_empty_after.html' %}{% endif %}

            {% else %}
              {% if not cell.is_past %}
                {% if not row.vehicle.is_maintenance %}
                  <a href="{% url 'vehicles:make_reservation' row.vehicle.id %}?date={{ cell.date|date:'Y-m-d' }}">ğŸ“ ç”³è¯·é¢„çº¦</a>
                {% else %}
                  <div>ğŸ› ï¸ ç»´ä¿®ä¸­</div>
                {% endif %}

                {% with row.vehicle.daily_reminders|get_item:cell.date as date_reminders %}
                  {% if date_reminders %}
                    <div class="mt-1" style="font-size:12px;">
                      {% for rmsg in date_reminders %}
                        <div style="font-size:12px;
                                    {% if 'è¿˜æœ‰' in rmsg.message %}color:#0c63e4;
                                    {% elif 'æœ¬æ—¥' in rmsg.message %}color:#d17700;
                                    {% elif 'æ¨è¿Ÿ' in rmsg.message or 'è¿‡æœŸ' in rmsg.message %}color:#c1121f;
                                    {% else %}color:#666;{% endif %}">
                          âš ï¸ {{ rmsg.message }}
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}
                <span>â€”</span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>

<p class="mt-4">
  <a href="{% url 'vehicles:vehicle_status' %}">â† è¿”å›è½¦è¾†çŠ¶æ€</a>
</p>

{% endblock %}

{% block extra_js %}
<script>
function showCarDetailModal(carId) {
  fetch(`/carinfo/modal/${carId}/`)
    .then(response => response.text())
    .then(html => {
      document.getElementById('carDetailModalBody').innerHTML = html;
      new bootstrap.Modal(document.getElementById('carDetailModal')).show();
    })
    .catch(error => {
      console.error('è½¦è¾†è¯¦æƒ…åŠ è½½å¤±è´¥:', error);
      alert('åŠ è½½è½¦è¾†è¯¦æƒ…å¤±è´¥');
    });
}
</script>

<script>
(function() {
  const qs = new URLSearchParams(location.search);
  let focusId = qs.get('focus') || '';
  const inputEl = document.getElementById('jumpInput');
  const btnEl   = document.getElementById('jumpBtn');
  const sugEl   = document.getElementById('plateSuggest');

  // === å»ºç«‹ plate -> id çš„ç´¢å¼•ï¼ˆä» DOM æå–ï¼‰ ===
  const cards = Array.from(document.querySelectorAll('[id^="v-"][data-plate]'));
  const index = cards.map(card => ({
    id: card.id.replace(/^v-/, ''),
    plateRaw: card.getAttribute('data-plate') || '',
    plateKey: normalize(card.getAttribute('data-plate') || ''),
    el: card
  }));

  // ======= å·¥å…·ï¼šå…¨è§’è½¬åŠè§’ + ç»Ÿä¸€å¤§å°å†™ + æ¸…ç†ç©ºç™½/è¿å­—ç¬¦/ç‚¹å· =======
  function toHalfWidth(str) {
    // ä»…å¤„ç†å¸¸è§å…¨è§’ ASCII èŒƒå›´ï¼šï¼åˆ°ï½ï¼ˆ65281-65374ï¼‰å’Œç©ºæ ¼ï¼ˆ12288ï¼‰
    return str.replace(/[\uFF01-\uFF5E]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
              .replace(/\u3000/g, ' ');
  }
  function normalize(str) {
    return toHalfWidth(String(str))
      .toUpperCase()
      .replace(/[\s\-._]/g, '')       // å»æ‰ç©ºæ ¼/è¿å­—ç¬¦/ç‚¹
      .replace(/[ï¼ˆï¼‰\(\)]/g, '');    // å»æ‰æ‹¬å·ï¼ˆæœ‰äº›è½¦ç‰Œå¯èƒ½å¸¦ï¼‰
  }

  // ======= æ¨¡ç³ŠåŒ¹é…ï¼šå¾—åˆ†è§„åˆ™ =======
  function fuzzyFind(query) {
    const key = normalize(query);
    if (!key) return [];
    const res = [];

    for (const it of index) {
      const plateKey = it.plateKey;
      if (!plateKey) continue;

      let score = 0;
      if (plateKey === key) score = 100;                 // å®Œå…¨åŒ¹é…
      else if (plateKey.startsWith(key)) score = 85;     // å‰ç¼€åŒ¹é…
      else if (plateKey.includes(key)) score = 70;       // åŒ…å«åŒ¹é…
      else {
        // ç®€æ˜“å­åºåˆ—åŒ¹é…ï¼ˆéè¿ç»­ï¼‰
        let i = 0, j = 0;
        while (i < plateKey.length && j < key.length) {
          if (plateKey[i] === key[j]) j++;
          i++;
        }
        if (j === key.length) score = 55;                // å­åºåˆ—å…¨åŒ¹é…
      }
      if (score > 0) {
        // è¶ŠçŸ­è¶Šä¼˜ + è¶Šé å‰è¶Šä¼˜
        const bonus = Math.max(0, 10 - Math.abs(plateKey.length - key.length));
        res.push({ ...it, score: score + bonus });
      }
    }
    // åˆ†æ•°é™åºï¼Œé•¿åº¦è¿‘çš„ä¼˜å…ˆï¼Œå­—é¢åºå…œåº•
    res.sort((a,b) => b.score - a.score || a.plateKey.length - b.plateKey.length || a.plateKey.localeCompare(b.plateKey));
    return res;
  }

  // ======= å®šä½ & é«˜äº® =======
  function scrollToCardById(id, smooth=true) {
    const card = document.getElementById('v-' + id);
    if (!card) return false;
    // æ»šåˆ°å¡ç‰‡é¡¶éƒ¨ï¼›sticky å¯¼èˆªæ¡é«˜åº¦é€šå¸¸ ~48-56pxï¼Œå¯å¾®è°ƒåç§»ï¼š
    const rect = card.getBoundingClientRect();
    const top = window.scrollY + rect.top - 64; // 64 = é¢„ç•™å¯¼èˆªé«˜åº¦
    window.scrollTo({ top, behavior: smooth ? 'smooth' : 'auto' });
    card.classList.add('focus-glow');
    setTimeout(() => card.classList.remove('focus-glow'), 2000);
    return true;
  }

  // ======= ç»™å‘¨å¯¼èˆªé“¾æ¥é™„å¸¦ focus å‚æ•°å’Œ hash =======
  function updateWeekLinks() {
    ['prevLink','thisLink','nextLink'].forEach(id => {
      const a = document.getElementById(id);
      if (!a) return;
      a.href = appendFocus(a.href, focusId);
    });
  }
  function appendFocus(url, id) {
    try {
      const u = new URL(url, location.href);
      if (id) {
        u.searchParams.set('focus', id);
        u.hash = 'v-' + id;
      } else {
        u.searchParams.delete('focus');
        u.hash = '';
      }
      return u.toString();
    } catch {
      const sep = url.includes('?') ? '&' : '?';
      return id ? `${url}${sep}focus=${encodeURIComponent(id)}#v-${id}` : url;
    }
  }
  function setFocusInUrl(id) {
    const u = new URL(location.href);
    if (id) {
      u.searchParams.set('focus', id);
      u.hash = 'v-' + id;
    } else {
      u.searchParams.delete('focus');
      u.hash = '';
    }
    history.replaceState(null, '', u.toString());
  }

  // ======= å®æ—¶å€™é€‰ UI =======
  let sugShown = false;
  function showSuggest(items) {
    if (!sugEl) return;
    if (!items || !items.length) { hideSuggest(); return; }
    const topN = items.slice(0, 8);
    sugEl.innerHTML = topN.map(it => `
      <div class="plate-suggest-item" data-id="${it.id}">
        ${escapeHtml(it.plateRaw)}
      </div>`).join('');
    sugEl.classList.remove('d-none');
    sugShown = true;
  }
  function hideSuggest() {
    if (!sugEl) return;
    sugEl.classList.add('d-none');
    sugEl.innerHTML = '';
    sugShown = false;
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ======= è¾“å…¥è”åŠ¨ï¼ˆå®æ—¶æ¨¡ç³Šï¼‰ =======
  let debounceTimer = null;
  inputEl?.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const q = inputEl.value.trim();
      if (!q) { hideSuggest(); return; }
      const list = fuzzyFind(q);
      showSuggest(list);
    }, 80);
  });

  // ç‚¹å‡»å€™é€‰é¡¹ -> å®šä½å¹¶æ›´æ–°å¯¼èˆª
  sugEl?.addEventListener('click', (e) => {
    const item = e.target.closest('.plate-suggest-item');
    if (!item) return;
    const id = item.getAttribute('data-id');
    focusId = id;
    hideSuggest();
    scrollToCardById(id, true);
    updateWeekLinks();
    setFocusInUrl(id);
  });

  // å¤±ç„¦æ—¶å…³é—­å€™é€‰ï¼ˆç•™ä¸€ç‚¹å»¶è¿Ÿç»™ clickï¼‰
  inputEl?.addEventListener('blur', () => setTimeout(hideSuggest, 120));

  // ======= GO/Enterï¼šé€‰æ‹©æœ€ä½³åŒ¹é… =======
  function goByInput() {
    const q = (inputEl?.value || '').trim();
    if (!q) { inputEl?.focus(); return; }
    const list = fuzzyFind(q);
    if (!list.length) { alert('æœªæ‰¾åˆ°åŒ¹é…çš„è»Šç•ª'); return; }
    const best = list[0];
    focusId = best.id;
    hideSuggest();
    scrollToCardById(best.id, true);
    updateWeekLinks();
    setFocusInUrl(best.id);
  }
  btnEl?.addEventListener('click', goByInput);
  inputEl?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); goByInput(); }
  });

  // ======= é¦–æ¬¡è½½å…¥ï¼šè‹¥ URL è‡ªå¸¦ focusï¼Œè‡ªåŠ¨å®šä½ =======
  if (focusId) {
    scrollToCardById(focusId, false);
    updateWeekLinks();
  }
})();
</script>


<!-- ğŸš— æ¨¡æ€æ¡†ç»“æ„ -->
<div class="modal fade" id="carDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">è½¦è¾†ä¿¡æ¯</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body" id="carDetailModalBody">
        <!-- Ajax åŠ è½½å†…å®¹æ’å…¥è¿™é‡Œ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
