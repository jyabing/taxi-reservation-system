{% extends "staffbook/base_staffbook.html" %}
{% load widget_tweaks %}
{% load time_filters %}
{% load custom_totals %}

{% load static %}
{% load driver_extras %}

{% block extra_css %}

{% endblock %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
/* å¼ºåŒ–ä¼˜å…ˆçº§ï¼štr + td éƒ½åŠ  */
table.table tr.has-note,
table.table tr.has-note td {
  background-color: #fff3cd !important;
}

  .auto-width-input {
    width: 2ch;
    min-width: 60px;
    max-width: 100px;
    box-sizing: content-box;
    transition: width 0.2s;
  }
  .mirror-span {
    position: absolute;
    visibility: hidden;
    white-space: pre;
    font: inherit;
  }
  .mark-checkbox {
    transform: scale(1.3);
    margin-top: 3px;
  }
  .scrollable-input {
    overflow-x: auto;
    white-space: nowrap;
    min-width: 50px;
    width: 100%;
    max-width: 100px;
  }
  #payment-summary-panel {
    font-size: 0.95rem;
  }
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
</style>

{% block content %}
<div class="container mt-4">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <h4><strong>{{ report.driver.name }}</strong>ï¼ˆ{{ report.driver.driver_code }}ï¼‰- ç·¨é›†ä¹—å‹™æ—¥å ±</h4>
  {{ form.meter_fee|add_class:"form-control" }}
  <p class="text-muted">æ—¥ä»˜ï¼š{{ form.date.value|date:"Yå¹´næœˆjæ—¥" }}</p>

  {% if report.pk %}
    {% if report.edited_by %}
      <div class="alert alert-light small mb-3">
        <strong>æœ€åç¼–è¾‘ï¼š</strong>
        {{ report.edited_by.get_full_name|default:report.edited_by.username }}
        äº {{ report.edited_at|date:"Yå¹´næœˆjæ—¥ H:i" }} ä¿å­˜
      </div>
    {% else %}
      <div class="alert alert-secondary small mb-3">å°šæœªè¢«ç¼–è¾‘è¿‡</div>
    {% endif %}
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>è¡¨å•é”™è¯¯ï¼š</strong>
      <ul>
      {% for field, errs in form.errors.items %}
        <li>{{ field }}: {{ errs|join:", " }}</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>æ˜ç»†è¡¨å•é”™è¯¯ï¼š</strong>
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  <form method="post" action="{% url 'staffbook:driver_dailyreport_edit' driver_id=driver_id report_id=report.id %}" autocomplete="off">
    {% csrf_token %}
    {{ form.status.as_hidden }}
    {{ form.date.as_hidden }}

    <div class="mb-3">
      <label class="form-label">å¤‡æ³¨:</label>
      {{ form.note|add_class:"form-control form-control-sm"|attr:"rows:2"|attr:"style:width:100%; max-width:400px;" }}
    </div>

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th style="white-space: nowrap;"><strong>ä½¿ç”¨è½¦è¾†</strong></th>
          <th style="white-space: nowrap;">å‡ºå‹¤</th>
          <th style="white-space: nowrap;">é€€å‹¤</th>
          <th style="white-space: nowrap;">å‹¤å‹™æ™‚é–“</th>
          <th style="white-space: nowrap;">ä¼‘æ†©æ™‚é–“</th>
          <th style="white-space: nowrap;"><span class="text-info">å®Ÿåƒæ™‚é–“</span></th>
          <th class="text-danger" style="white-space: nowrap;">æ®‹æ¥­æ™‚é–“</th>
          <th style="white-space: nowrap;">çµ¦æ²¹ (L)</th>
          <th style="white-space: nowrap;">èµ°è¡Œè·é›¢ (KM)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            {% if form.instance.vehicle %}
              <span class="form-control-plaintext">{{ form.instance.vehicle }}</span>
            {% else %}
              <span class="text-muted">æœªé¸æŠ</span>
            {% endif %}
            {{ form.vehicle }}
          </td>
          <td style="max-width:110px;">
            <input type="text" name="clock_in" class="form-control form-control-sm time-input" value="{{ form.clock_in.value|default_if_none:'' }}">
          </td>
          <td style="max-width:110px;" >
            <input type="text" name="clock_out" class="form-control form-control-sm time-input" style="min-width: 60px; max-width: 200px; width: 100%; overflow-x: auto; white-space: nowrap;" value="{{ form.initial.clock_out|default_if_none:'' }}">
          </td>
          <td id="work-duration">--:--</td> <!--å‹¤å‹™æ™‚é–“-->

          <!-- âœ… ä¿®æ”¹ä¼‘æ†©æ™‚é–“ -->
          <td>
              <input type="text" name="break_time_input" id="break-time-input"
                  class="form-control form-control-sm text-center"
                  maxlength="5" pattern="^\d{1,2}:\d{2}$"
                  style="max-width:90px;"
                  placeholder="0:00"
                  value="{{ break_time_h }}:{{ break_time_m }}">
                  <div class="form-text mt-1">+20åˆ†</div>

                  <!-- âœ… æ–°å¢éšè—å­—æ®µ -->
                  <input type="hidden" name="break_time_plus20" id="break-time-plus20">
          </td>

          <!-- å®Ÿåƒæ™‚é–“ -->
          <td class="text-center text-primary" id="actual-work-time">
            {% if form.instance.å®Ÿåƒæ™‚é–“ %}
              {{ form.instance.å®Ÿåƒæ™‚é–“ }}
            {% else %}
              --:--
            {% endif %}
          </td>

          <!-- æ®‹æ¥­æ™‚é–“ -->
          <td class="text-danger text-center">{{ form.instance.æ®‹æ¥­æ™‚é–“|format_duration }}</td>
          
          <td style="max-width:90px;">{{ form.gas_volume|add_class:"form-control form-control-sm text-end" }}</td>
          <td >{{ form.mileage|add_class:"form-control form-control-sm text-end" }}</td>
        </tr>
      </tbody>
    </table>

    <div id="payment-summary-panel" class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      {% for key, label in summary_keys %}
        <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
          <div class="small text-muted">{{ label }} åˆè¨ˆ</div>
          <div>
            <span id="total_{{ key }}">{{ totals|get_total:key|floatformat:"0" }}</span>
            ï¼ˆ<span id="bonus_{{ key }}">{{ totals|get_bonus:key|floatformat:"0" }}</span>ï¼‰
          </div>
        </div>
      {% endfor %}


      <!-- âœ… æ–°å¢åŒºåŸŸå¼€å§‹ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 80px;">
        <label class="small text-muted">å…¥é‡‘é¡</label>
        {{ form.deposit_amount|add_class:"form-control form-control-sm text-end"|attr:"id:deposit-input"|attr:"style:min-width:80px;"|attr:"placeholder:0" }}

        <label class="small text-muted mt-2 d-block">éä¸è¶³ï¼ˆå…¥é‡‘ - ç¾é‡‘ï¼‰</label>
          <div id="difference-output" class="form-control-plaintext text-end small text-muted" style="min-height: 1.5em;">
          {{ form.deposit_difference.value|default:"--" }}
          </div>
        </div>
      <!-- âœ… æ–°å¢åŒºåŸŸç»“æŸ -->

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th class="row-number-header">#</th>
          <th style="white-space: nowrap;">æ™‚é–“</th>
          <th style="white-space: nowrap;">ä¹—è»Šåœ°</th>
          <th class="d-none">çµŒç”±</th>
          <th class="d-none">é™è»Šåœ°</th>
          <th class="d-none">ç”·</th>
          <th class="d-none">å¥³</th>
          <th style="white-space: nowrap;">æ–™é‡‘</th>
          <th style="white-space: nowrap;">æ”¯ä»˜</th>
          <th style="white-space: nowrap;">åŠ äº®</th>
          <th>æ³¨é‡ˆ</th>
          <th style="white-space: nowrap;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {{ formset.management_form }}
        {% for form in formset.forms %}
          <tr class="report-item-row {% if form.instance.is_flagged %}has-note{% endif %}">
            {{ form.id }}
            <td class="row-number">{{ forloop.counter }}</td>
            <td style="min-width: 70px;">
              {% if form.ride_time.errors %}
                <div class="text-danger small">{{ form.ride_time.errors.0 }}</div>
              {% endif %}
              {{ form.ride_time|add_class:"form-control form-control-sm time-input" }}
            </td>

            <td style="min-width: 70px;">
              {% if form.ride_from.errors %}
                <div class="text-danger small">{{ form.ride_from.errors.0 }}</div>
              {% endif %}
              {{ form.ride_from|add_class:"form-control form-control-sm" }}
            </td>

            <td style="min-width: 70px;" class="d-none">
              {% if form.via.errors %}
                <div class="text-danger small">{{ form.via.errors.0 }}</div>
              {% endif %}
              {{ form.via|add_class:"form-control form-control-sm" }}
            </td>

            <td style="min-width: 120px;" class="d-none">
              {% if form.ride_to.errors %}
                <div class="text-danger small">{{ form.ride_to.errors.0 }}</div>
              {% endif %}
              {{ form.ride_to|add_class:"form-control form-control-sm" }}
            </td>

            <td class="d-none">
              {% if form.num_male.errors %}
                <div class="text-danger small">{{ form.num_male.errors.0 }}</div>
              {% endif %}
              {{ form.num_male|add_class:"form-control form-control-sm text-end" }}
            </td>

            <td class="d-none">
              {% if form.num_female.errors %}
                <div class="text-danger small">{{ form.num_female.errors.0 }}</div>
              {% endif %}
              {{ form.num_female|add_class:"form-control form-control-sm text-end" }}
            </td>

            <td style="min-width: 70px;">{{ form.meter_fee }}
            </td>

            <td style="min-width: 100px;">
              {% if form.payment_method.errors %}
                <div class="text-danger small">{{ form.payment_method.errors.0 }}</div>
              {% endif %}
              {{ form.payment_method|add_class:"form-select form-select-sm" }}
            </td>

            <td class="text-center">
              {% if form.is_flagged.errors %}
                <div class="text-danger small">{{ form.is_flagged.errors.0 }}</div>
              {% endif %}
              {{ form.is_flagged }}
            </td>

            <td>
              {% if form.note.value %}ğŸ“{% endif %}
              {% if form.note.errors %}
                <div class="text-danger small">{{ form.note.errors.0 }}</div>
              {% endif %}
              {{ form.note }}
            </td>

            <td style="white-space: nowrap;">
              <div class="d-flex flex-row gap-1">
                {% if form.instance.pk %}
                  {{ form.DELETE }}
                  <button type="button" class="btn btn-sm btn-danger confirm-delete">å‰Šé™¤</button>
                {% else %}
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row">ç§»é™¤</button>
                {% endif %}
                  <button type="button" class="btn btn-sm btn-outline-primary insert-below">â•å‘ä¸‹æ’å…¥è¡Œ</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
  </form>

  <div class="text-center mt-3">
    <button type="button" class="btn btn-outline-primary" id="add-row-btn">â• å¢—åŠ ä¸€è¡Œ</button>
  </div>
  
</div>
{% if form.errors %}
  <div class="alert alert-danger">ä¸»è¡¨å•éªŒè¯å¤±è´¥ï¼š{{ form.errors }}</div>
{% endif %}
{% if formset.non_form_errors %}
  <div class="alert alert-danger">æ˜ç»†éªŒè¯å¤±è´¥ï¼š{{ formset.non_form_errors }}</div>
{% endif %}

{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <script src="{% static 'staffbook/js/dailyreport.js' %}"></script>
  <style>
    table.table tr.has-note td,
    table.table tr.has-note {
      background-color: #fff8b3 !important;
    }
  </style>

{% endblock %}

