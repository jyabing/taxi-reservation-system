{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<h2>ğŸ“‹ æˆ‘çš„é¢„çº¦è®°å½•</h2>
{% include 'partials/_messages.html' %}

<table border="1">
  <tr>
    <th>è½¦è¾†</th>
    <th>æ—¶é—´æ®µ</th>
    <th>çŠ¶æ€</th>
    <th>æ“ä½œ</th>
  </tr>
  {% for r in reservations %}
  <tr>
    <td>{{ r.vehicle.license_plate }}</td>
    <td>
      {% include 'partials/_time_range_snippet.html' with obj=r %}
    </td>
    <td>{{ r.get_status_display }}</td>
    <td>
      {# 1. å¾…å®¡æ‰¹ æˆ– å·²é¢„çº¦ä½†æœªå‡ºåº“ï¼šå¯ç¼–è¾‘/å¯å–æ¶ˆ #}
      {% if r.status == 'pending' %}
        <a href="{% url 'edit_reservation' r.id %}">âœï¸ ä¿®æ”¹</a> |
        <a href="javascript:void(0);" onclick="confirmDelete('{{ r.id }}', '{{ r.vehicle.license_plate }}', '{{ r.date }}', '{{ r.start_time }}')">âŒ åˆ é™¤</a>
      {% elif r.status == 'reserved' and not r.actual_departure %}
        <a href="{% url 'edit_reservation' r.id %}">âœï¸ ä¿®æ”¹</a> |
        <a href="javascript:void(0);" onclick="confirmDelete('{{ r.id }}', '{{ r.vehicle.license_plate }}', '{{ r.date }}', '{{ r.start_time }}')">âŒ åˆ é™¤</a>
        {% if today == r.date %}
          <button onclick="openTimePopup('{{ r.id }}', 'departure')">
            ğŸš— å‡ºåº“
          </button><br>
          <span style="color:gray;">
            âš ï¸ æœªå‡ºåº“çš„é¢„çº¦å°†åœ¨å¼€å§‹åä¸€å°æ—¶è‡ªåŠ¨å–æ¶ˆ
          </span>
        {% else %}
          <span style="color:gray;">â³ ç­‰å¾…é¢„çº¦æ—¥æœŸ</span>
        {% endif %}
      {# 2. å·²é¢„çº¦ä¸”å·²å‡ºåº“æœªè¿˜è½¦ #}
      {% elif r.status == 'reserved' and r.actual_departure and not r.actual_return %}
        <button onclick="openTimePopup('{{ r.id }}', 'return')">
          ğŸ…¿ï¸ å…¥åº“
        </button><br>
        <span style="color:gray;">
          âš ï¸ è¶…è¿‡30åˆ†é’Ÿæœªå…¥åº“å°†è‡ªåŠ¨å»¶é•¿
        </span>
      {# 3. å·²å‡ºåº“æœªè¿˜è½¦ #}
      {% elif r.status == 'out' and not r.actual_return %}
        <button onclick="openTimePopup('{{ r.id }}', 'return')">
          ğŸ…¿ï¸ å…¥åº“
        </button>
      {# 4. å·²å–æ¶ˆ #}
      {% elif r.status == 'canceled' %}
        âŒ å·²å–æ¶ˆ
      {# 5. å…¶å®ƒï¼ˆå·²å®Œæˆç­‰ï¼‰ #}
      {% else %}
        âœ… å®Œæˆ
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="4">æš‚æ— é¢„çº¦è®°å½•</td>
  </tr>
  {% endfor %}
</table>

{# åˆ é™¤ç¡®è®¤å¼¹çª— #}
<div id="delete-confirm-modal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.35);z-index:9999;justify-content:center;align-items:center;">
  <div style="background:white;padding:32px 40px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.18);min-width:300px;text-align:center;">
    <div id="delete-confirm-msg" style="margin-bottom:22px;font-size:18px;"></div>
    <form id="delete-confirm-form" method="post" style="display:inline;">
      {% csrf_token %}
      <button type="submit" style="background:#d9534f;color:white;padding:6px 18px;border:none;border-radius:4px;font-size:16px;margin-right:14px;">ç¡®å®šåˆ é™¤</button>
      <button type="button" onclick="closeDeleteModal()" style="background:#eee;color:#333;padding:6px 16px;border:none;border-radius:4px;font-size:16px;">å–æ¶ˆ</button>
    </form>
  </div>
</div>

<script>
  function confirmDelete(reservationId, vehicle, date, start) {
    const modal = document.getElementById('delete-confirm-modal');
    const msg = document.getElementById('delete-confirm-msg');
    msg.innerHTML = `ç¡®å®šè¦å–æ¶ˆ <b>${vehicle}</b> ${date} ${start} çš„é¢„çº¦å—ï¼Ÿ<br>å–æ¶ˆåè¯¥æ—¶é—´æ®µè½¦è¾†å°†å¯è¢«ä»–äººé¢„çº¦ã€‚`;
    const form = document.getElementById('delete-confirm-form');
    form.action = "/vehicles/reservation/" + reservationId + "/delete/";
    modal.style.display = 'flex';
  }
  function closeDeleteModal() {
    document.getElementById('delete-confirm-modal').style.display = 'none';
  }
  // å…è®¸ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
  window.onclick = function(event) {
    if (event.target === document.getElementById('delete-confirm-modal')) {
      closeDeleteModal();
    }
  }
</script>

{# å‡ºåº“/å…¥åº“å¼¹çª—ï¼ŒæŒ‰ä½ å·²æœ‰ä»£ç æˆ– include #}
{% include 'partials/_check_io_popup.html' %}

<div class="pagination">
  <span class="step-links">
    {% if page_obj.has_previous %}
      <a href="?page=1">&laquo; ç¬¬ä¸€é¡µ</a>
      <a href="?page={{ page_obj.previous_page_number }}">ä¸Šä¸€é¡µ</a>
    {% endif %}
    <span class="current-page">ç¬¬ {{ page_obj.number }} é¡µ / å…± {{ page_obj.paginator.num_pages }} é¡µ</span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">ä¸‹ä¸€é¡µ</a>
      <a href="?page={{ page_obj.paginator.num_pages }}">æœ€åä¸€é¡µ &raquo;</a>
    {% endif %}
  </span>
</div>

<p><a href="{% url 'reservation_dashboard' %}">â† è¿”å›é¢„çº¦èœå•</a></p>
{% include 'partials/tip_box.html' %}
{% endblock %}
