{% load static %}
{% load static custom_filters %}

{# ====== NEW navbar (2025-09-15) â€”â€” æ¡Œé¢=å¸¸é©»å…¨éƒ¨ï¼›æ‰‹æœº=ä¸‰æ¨ªçº¿ä¸‹æ‹‰ ====== #}
<nav class="x-nav" role="navigation" aria-label="Main">
  <!-- â†“â†“â†“ æ–°å¢çš„å†…åŒ…è£…ï¼Œé™åˆ¶å®½åº¦å¹¶å±…ä¸­ â†“â†“â†“ -->
  <div class="x-nav__inner">
    <div class="x-nav__brand">
      {% if user.is_authenticated %}
        <span class="x-nav__hello">ğŸ‘‹ {{ user.username }} |</span>
      {% endif %}
    </div>

    {# æ‰‹æœºç«¯ä¸‰æ¨ªçº¿æŒ‰é’®ï¼ˆæ¡Œé¢ç«¯éšè—ï¼‰ #}
    <button id="xMenuToggle"
            class="x-nav__btn"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="xMainMenu"
            title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <span class="x-nav__icon" aria-hidden="true"></span>
      <span class="x-nav__label" aria-hidden="true">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
      <span class="x-sr-only">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
    </button>

    {# ç»Ÿä¸€èœå•ï¼šæ¡Œé¢ç«¯å¸¸é©»ï¼›æ‰‹æœºç«¯ä¸ºä¸‹æ‹‰æµ®å±‚ #}
    <ul id="xMainMenu" class="x-nav__list" role="menubar">
      {# â€”â€” å›ºå®šå¸¸ç”¨ â€”â€” #}
      {# æ™®é€šç”¨æˆ·ï¼šç³»ç»Ÿé¦–é¡µ â†’ æˆ‘çš„èµ„æ–™ï¼›ç®¡ç†å‘˜/staffï¼šç³»ç»Ÿé¦–é¡µ â†’ çœŸæ­£é¦–é¡µ #}
      {% if user.is_authenticated and not user.is_superuser and not user.is_staff %}
        <li><a role="menuitem" href="{% url 'profile' %}">ğŸ  ç³»ç»Ÿé¦–é¡µ</a></li>
      {% else %}
        <li><a role="menuitem" href="{% url 'home' %}">ğŸ  ç³»ç»Ÿé¦–é¡µ</a></li>
      {% endif %}

      <li><a role="menuitem" href="{% url 'my_profile' %}">ğŸ‘¤ æˆ‘çš„èµ„æ–™</a></li>
      <li><a role="menuitem" href="{% url 'vehicles:vehicle_status' %}">ğŸš— è»Šä¸¡çŠ¶æ…‹</a></li>

      {# â€”â€” åŸâ€œæ›´å¤šâ€é‡Œçš„å…¨éƒ¨é“¾æ¥ç›´æ¥å¹³é“ºåˆ°è¿™é‡Œ â€”â€” #}
      <li><a role="menuitem" href="{% url 'vehicles:weekly_overview' %}">ğŸ“… ä¸€å‘¨é¢„çº¦æ¦‚è§ˆ</a></li>
      <li><a role="menuitem" href="{% url 'vehicles:my_reservations' %}">ğŸ“‹ ç§ã®äºˆç´„</a></li>

      {# ===== BEGIN æ–°å¢ï¼šæ’ç­ï¼ˆå¸æœº + ç®¡ç†å‘˜ï¼‰ ===== #}
      {% if user.is_authenticated %}
        <li><a role="menuitem" href="{% url 'staffbook:schedule_form' %}">ğŸ—“ å‡ºå‹¤æ—¥ã‚’æå‡º</a></li>
        <li><a role="menuitem" href="{% url 'staffbook:my_reservations' %}">ğŸ“„ ç§ã®æå‡ºä¸€è¦§</a></li>
      {% endif %}

      {# åªæœ‰ç®¡ç†å‘˜/äººäº‹å¯ä»¥çœ‹åˆ°æ‰€æœ‰å¸æœºçš„åˆ—è¡¨ #}
      {% if user.is_superuser or user.is_staff or user.userprofile.is_staffbook_admin %}
        <li><a role="menuitem" href="{% url 'staffbook:schedule_list' %}">ğŸ“‘ æå‡ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</a></li>
      {% endif %}
      {# ===== END æ–°å¢ï¼šæ’ç­ï¼ˆå¸æœº + ç®¡ç†å‘˜ï¼‰ ===== #}

      {% if user.is_superuser or user.userprofile.is_vehicles_admin %}
        <li><a role="menuitem" href="{% url 'vehicles:reservation_approval_list' %}">ğŸ› ï¸ å®¡æ‰¹é¢æ¿</a></li>
        <li><a role="menuitem" href="{% url 'vehicles:admin_stats' %}">ğŸ“Š ç®¡ç†å‘˜ç»Ÿè®¡</a></li>
      {% endif %}

      <li><a role="menuitem" href="{% url 'vehicles:reservation_dashboard' %}">ğŸš– é…è½¦ç³»ç»Ÿ</a></li>

      {% if user.is_superuser or user.userprofile.is_staffbook_admin %}
        <li><a role="menuitem" href="{% url 'staffbook:driver_list' %}">ğŸ“’ ç¤¾å“¡å°å¸³</a></li>
      {% endif %}

      {% if user.is_superuser or user.userprofile.is_staffbook_admin %}
        <li><a role="menuitem" href="{% url 'dailyreport:dailyreport_overview' %}">ğŸ’¸ æ—¥å ±ä¸€è¦§</a></li>
      {% endif %}

      {% if user.is_superuser or user.userprofile.is_carinfo_admin %}
        <li><a role="menuitem" href="{% url 'carinfo:car_list' %}">ğŸš— è»Šä¸¡ç®¡ç†</a></li>
      {% endif %}

      {% if user.is_superuser %}
        <li><a role="menuitem" href="/admin/">âš™ï¸ åå°</a></li>
      {% endif %}

      <li class="x-nav__divider" aria-hidden="true"></li>

      {% if user.is_authenticated %}
        <li>
          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="x-nav__logout">ğŸšª é€€å‡º</button>
          </form>
        </li>
      {% else %}
        <li><a role="menuitem" href="{% url 'login' %}">ç™»å½•</a></li>
      {% endif %}
    </ul>
  </div>
</nav>

{# ====== scoped stylesï¼ˆåŸæ ·ä¿ç•™ï¼‰ ====== #}
<style>
  /* ... ä¸‹é¢è¿™ä¸€é•¿æ®µ CSS åŸæ ·ä¿ç•™ï¼Œä½ çš„å°±æ˜¯è¿™æ · ... */
  .x-nav{position:relative;background:#fff;border-bottom:1px solid #eee}
  .x-nav__inner{
    position:relative;
    max-width:2000px;
    margin:0 auto;
    padding:10px 14px;
    display:flex; align-items:center; gap:12px;
  }
  .x-nav__brand{font-weight:600;color:#111}
  .x-nav__hello{color:#111}
  .x-nav__list{list-style:none;margin:0;padding:0;display:flex;gap:8px;align-items:center}
  .x-nav__list>li>a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none;color:#111827}
  .x-nav__list>li>a:hover,.x-nav__list>li>a:focus{background:#f3f4f6}
  .x-nav__divider{width:1px;height:18px;background:#e5e7eb;margin:0 4px}
  .x-nav__btn{display:none;width:56px;height:56px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;margin-left:auto;
    display:flex; flex-direction:column;justify-content:center; align-items:center;gap:6px;padding:6px 8px; line-height:1;}
  .x-nav__label{font-size:11px; line-height:1; color:#444;}
  .x-nav__icon{position:relative;display:block; width:22px; height:14px; margin:0 auto;
    background: linear-gradient(#333,#333) 0 6px / 100% 2px no-repeat;border-radius:2px;}
  .x-nav__icon::before,.x-nav__icon::after{content:""; position:absolute; left:0; right:0; height:2px;
    background:#333; border-radius:2px;}
  .x-nav__icon::before{ top:0; }
  .x-nav__icon::after { bottom:0; }
  .x-nav__logout{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px}
  .x-nav__logout:hover{background:#f3f4f6;cursor:pointer}
  .x-sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  @media (min-width:992px){
    .x-nav{justify-content:flex-start}
    .x-nav__list{margin-left:auto;position:static;box-shadow:none;border:0;background:transparent}
    .x-nav__btn{display:none}
  }
  @media (max-width:999.98px){
    .x-nav__btn{display:inline-flex;align-items:center;justify-content:center;margin-left:auto}
    .x-nav__list{display:none;position:absolute;right:14px;top:calc(100% + 8px);flex-direction:column;align-items:stretch;gap:4px;min-width:220px;max-height:70vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:8px;z-index:1000}
    .x-nav__list.x-open{display:flex}
    .x-nav__divider{width:100%;height:1px}
    .x-nav__logout{width:100%;text-align:left}
  }
</style>

<script>
  /* ä½ çš„ JS ä¹ŸåŸæ ·ä¿ç•™ â†“â†“â†“ */
  (function(){
    const btn=document.getElementById('xMenuToggle');
    const menu=document.getElementById('xMainMenu');
    if(!btn||!menu) return;
    const DESKTOP=window.matchMedia('(min-width: 992px)');
    function openMenu(){ if(!menu.classList.contains('x-open')){ menu.classList.add('x-open'); btn.setAttribute('aria-expanded','true');
      const first=menu.querySelector('a,button,[tabindex]:not([tabindex="-1"])'); first&&first.focus({preventScroll:true}); } }
    function closeMenu(){ if(menu.classList.contains('x-open')){ menu.classList.remove('x-open'); btn.setAttribute('aria-expanded','false'); } }
    function toggle(){ menu.classList.contains('x-open')?closeMenu():openMenu(); }
    btn.addEventListener('click',e=>{ if(DESKTOP.matches) return; e.stopPropagation(); toggle(); });
    menu.addEventListener('click',e=>e.stopPropagation());
    document.addEventListener('click',()=>{ if(!DESKTOP.matches) closeMenu(); });
    document.addEventListener('keydown',e=>{ if(DESKTOP.matches) return;
      if(e.key==='Escape') closeMenu();
      if(menu.classList.contains('x-open')&&(e.key==='ArrowDown'||e.key==='ArrowUp')){
        const items=[...menu.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])')];
        const i=items.indexOf(document.activeElement);
        if(i>=0){ e.preventDefault(); const j=e.key==='ArrowDown'?(i+1)%items.length:(i-1+items.length)%items.length; items[j].focus(); }
      }
    });
    DESKTOP.addEventListener?.('change',closeMenu);
  })();
</script>
{# ====== /NEW navbar ====== #}
