{% extends "base.html" %}
{% load static %}
{% load dict_helpers %}
{% block content %}

<div class="container-fluid py-3">

  <!-- 标题 + 周切换 -->
  <div class="d-flex align-items-center mb-3">
    <div class="me-3 d-flex align-items-baseline gap-2">
      <span class="fs-5">🚗</span>
      <h6 class="mb-0 fw-semibold">一周预约甘特图</h6>
      <span class="text-muted small">（{{ week_start }} 〜 {{ week_end }}）</span>
    </div>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="?start={{ prev_week|date:'Y-m-d' }}">前週</a>
      <a class="btn btn-primary btn-sm" href="?start={{ this_week|date:'Y-m-d' }}">本週</a>
      <a class="btn btn-outline-secondary btn-sm" href="?start={{ next_week|date:'Y-m-d' }}">次週</a>
    </div>
  </div>

  <!-- Legend 样式（内联，确保立即生效；可移入 static/css/gantt.css） -->
  <style>
    .legend-box{display:inline-block;width:16px;height:12px;margin-right:4px;border-radius:3px;vertical-align:middle;}
    .sticky-col{
      position: sticky; left: 0; z-index: 2; background: #fff;
      min-width: 120px; border-right: 2px solid #e5e7eb; text-align: left; padding-left: 6px;
      white-space: nowrap;
    }
    /* 甘特色块里的字更易读 */
    .gantt-seg{ color:#fff; font-size:11px; text-align:center; vertical-align:middle; font-weight:600; }

    /* ====== 平板及以下 ====== */
    @media (max-width: 992px){
      .gantt-table{ font-size:11px; }
      .gantt-seg{ height:18px; font-size:10px; }
      .gantt-table thead th{ padding:2px 0; font-size:11px; }
      .sticky-col{ min-width:100px; padding-left:4px; }
    }
    /* ====== 手机（竖屏） ====== */
    @media (max-width: 576px){
      .gantt-wrapper{ overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:12px; }
      .gantt-table{ min-width: 900px; }
      .gantt-table thead th{ font-size:10px; padding:1px 0; }
      .sticky-col{ min-width:86px; border-right:1px solid #e5e7eb; padding-left:4px; }
      .gantt-seg{ height:16px; font-size:9px; border-radius:4px; }
      .legend{ gap:8px; flex-wrap: wrap; }
      .legend .label{ display:none; }
      .legend-box{ width:12px; height:10px; margin-right:2px; }
      .btn-sm{ padding:2px 6px; font-size:12px; }
    }
  </style>

  <!-- 凡例（状态说明） -->
  <div class="legend mb-2 small d-flex gap-3 align-items-center">
    <span class="legend-item" title="確定済み">
      <span class="legend-box gantt-reserved"></span><span class="label"> 確定済み</span>
    </span>
    <span class="legend-item" title="承認待ち">
      <span class="legend-box gantt-pending"></span><span class="label"> 承認待ち</span>
    </span>
    <span class="legend-item" title="外出中">
      <span class="legend-box gantt-out"></span><span class="label"> 出庫中</span>
    </span>
    <span class="legend-item" title="キャンセル">
      <span class="legend-box gantt-canceled"></span><span class="label"> キャンセル</span>
    </span>
  </div>

  <div class="gantt-wrapper">
    <!-- 叠加网格的画布（若需要，可由 static/js/gantt.js 读取 data-hours 来画竖线） -->
    <canvas id="gantt-grid-overlay"></canvas>

    <table class="gantt-table jp-compact">
      <thead>
        <tr>
          <th class="sticky-col">车辆</th>
          {# 表头按日分组，每天 24 小时列 #}
          {% for d in week_dates %}
            <th colspan="24" class="text-center">{{ d|date:"Y-m-d" }}（{{ d|ja_weekday }}）</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in vehicle_rows %}
        <tr>
          <td class="sticky-col">
            {{ row.vehicle_label }}
          </td>

          {# 逐段渲染：每段之前渲染 gap（空白），再渲染段；最后渲染尾部空白 #}
          {% for seg in row.segs %}
            {% if seg.gap > 0 %}
              <td colspan="{{ seg.gap }}" class="gantt-empty"></td>
            {% endif %}
            <td colspan="{{ seg.length }}"
                class="gantt-seg gantt-{{ seg.status }}"
                title="{{ seg.title }}">
              {% if seg.status == "reserved" %}確定
              {% elif seg.status == "pending" %}申請
              {% elif seg.status == "out" %}出庫
              {% elif seg.status == "canceled" %}取消
              {% endif %}
            </td>
          {% endfor %}

          {% if row.tail_gap > 0 %}
            <td colspan="{{ row.tail_gap }}" class="gantt-empty"></td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{{ 1|add:HOURS }}" class="text-center text-muted py-4">本周暂无预约</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // 可供网格脚本读取（总小时数 7*24 = 168）
  const tbl = document.querySelector('.gantt-table');
  if (tbl) tbl.setAttribute('data-hours', '{{ HOURS }}');
</script>
{% endblock %}
