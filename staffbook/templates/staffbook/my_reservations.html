{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h4 class="mb-3">ğŸš ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºèª</h4>

  <p class="text-muted small mb-3">
    {% if driver %}
      å¯¾è±¡ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼š<strong>{{ driver }}</strong>
    {% else %}
      å¯¾å¿œã™ã‚‹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
    {% endif %}
    {% if today and to_date %}
      ï¼ è¡¨ç¤ºæœŸé–“ï¼š{{ today|date:"Y-m-d" }} ã€œ {{ to_date|date:"Y-m-d" }}
    {% endif %}
  </p>

  <table class="table table-sm table-bordered align-middle responsive-cards">
    <thead class="table-light">
      <tr>
        <th style="width: 110px;">æ—¥ä»˜</th>
        <th style="width: 130px;">ã‚·ãƒ•ãƒˆ</th>
        <th>è»Šä¸¡å¸Œæœ›</th>
        <th>ä¼šç¤¾æ±ºå®š</th>
        <th>å‚™è€ƒ</th>
        <th style="width: 110px;">çŠ¶æ…‹</th>
        <th style="width: 130px;">æ“ä½œ</th>  {# â† æ–°å¢ #}
      </tr>
    </thead>
    <tbody>
      {% if schedules %}
        {% for s in schedules %}
          <tr>
            <td data-label="æ—¥ä»˜">{{ s.work_date|date:"Y-m-d (D)" }}</td>

            <td data-label="ã‚·ãƒ•ãƒˆ">
              {% if s.is_rest %}
                <span class="badge bg-secondary">ä¼‘ã¿</span>
              {% else %}
                <span class="badge bg-primary me-2">å‡ºå‹¤</span>

                {% if s.shift == "day" %}
                  æ˜¼å‹¤
                {% elif s.shift == "night" %}
                  å¤œå‹¤
                {% else %}
                  -
                {% endif %}
              {% endif %}
            </td>


            <td data-label="è»Šä¸¡å¸Œæœ›">
              {% if s.is_rest %}
                -
              {% else %}
                {% if s.any_car %}
                  ä»»æ„ã®è»Šä¸¡ã§å¯
                {% else %}
                  ç¬¬1:
                  {% if s.first_choice_car %}
                    {{ s.first_choice_car.license_plate|default:s.first_choice_car.registration_number }}
                    {{ s.first_choice_car.name }}
                  {% else %}-{% endif %}
                  <br>
                  ç¬¬2:
                  {% if s.second_choice_car %}
                    {{ s.second_choice_car.license_plate|default:s.second_choice_car.registration_number }}
                    {{ s.second_choice_car.name }}
                  {% else %}-{% endif %}
                {% endif %}
              {% endif %}
            </td>

            {# ==== BEGIN MS2: ä¼šç¤¾æ±ºå®šåˆ—ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‹å‚™è€ƒæŠ˜ã‚ŠãŸãŸã¿ï¼‰ ==== #}
            <td data-label="ä¼šç¤¾æ±ºå®š">

              <div class="car-cell-wrap">

                {% if s.assigned_car %}

                  {# è»Šä¸¡æƒ…å ±ã‚«ãƒ¼ãƒ‰ #}
                  <div class="car-info-card small">
                    <div class="car-info-card-header">
                      <div></div>
                      <span class="badge bg-success car-info-badge">
                        {{ s.assigned_car.license_plate|default:s.assigned_car.registration_number }}
                        {{ s.assigned_car.name }}
                      </span>
                    </div>

                    <div class="car-info-row mb-1">
                      <span class="ci-label">ğŸ›  ç‚¹æ¤œ</span>
                      <span class="car-due {{ s.car_info_ctx.tenken.css }}">
                        {{ s.car_info_ctx.tenken.label }}
                      </span>
                    </div>

                    <div class="car-info-row mb-1">
                      <span class="ci-label">ğŸ“… è»Šæ¤œ</span>
                      <span class="car-due {{ s.car_info_ctx.shaken.css }}">
                        {{ s.car_info_ctx.shaken.label }}
                      </span>
                    </div>

                    <div class="car-info-row">
                      <span class="ci-label">âš™ è¨­å‚™</span>
                      <span>
                        {% if s.car_info_ctx.equipment %}
                          {% for e in s.car_info_ctx.equipment %}
                            {{ e }}{% if not forloop.last %} ãƒ» {% endif %}
                          {% endfor %}
                        {% else %}
                          <span class="text-muted">ï¼ˆç™»éŒ²ãªã—ï¼‰</span>
                        {% endif %}
                      </span>
                    </div>
                  </div>

                  {# â˜… ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å‡ºã™ç®¡ç†ãƒ¡ãƒ¢ï¼ˆé•·ã„å ´åˆã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰ #}
                  {% if s.admin_note %}
                    {% with s.admin_note as note %}
                      <div class="car-admin-note" data-note-id="{{ s.id }}">
                        <span class="note-icon">ğŸ’¬</span>

                        {# çŸ­ã„ç‰ˆï¼ˆå…ˆé ­ 40 æ–‡å­—ï¼‰ #}
                        <span class="note-text note-short">
                          {{ note|truncatechars:40 }}
                        </span>

                        {# å…¨æ–‡ç‰ˆ #}
                        <span class="note-text note-full d-none">
                          {{ note }}
                        </span>

                        {# 40 æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã ã‘ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º #}
                        {% if note|length > 40 %}
                          <button type="button"
                                  class="note-toggle btn btn-link btn-sm p-0 ms-1">
                            ã‚‚ã£ã¨è¦‹ã‚‹
                          </button>
                        {% endif %}
                      </div>
                    {% endwith %}
                  {% endif %}

                {% elif s.status == "approved" %}
                  <span class="badge bg-info text-dark">ä¼šç¤¾æ±ºå®šæ¸ˆï¼ˆè»Šä¸¡æœªæŒ‡å®šï¼‰</span>

                {% elif s.status == "rejected" %}
                  <span class="badge bg-danger">å·®ã—æˆ»ã—</span>

                {% else %}
                  <span class="badge bg-secondary">ç¢ºèªä¸­</span>
                {% endif %}

              </div>  {# /car-cell-wrapï¼šä¸Šä¸‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ #}

            </td>
            {# ==== END MS2 ==== #}

            <td data-label="å‚™è€ƒ">{{ s.note|default:"-" }}</td>

            <td data-label="çŠ¶æ…‹">
              <span class="badge bg-light text-muted d-block mb-1">ä¿å­˜æ¸ˆã¿</span>
              <span class="text-muted small">{{ s.updated_at|date:"m/d H:i" }}</span>
            </td>

            {# â† æ–°å¢ï¼šæ“ä½œåˆ— #}
            <td data-label="æ“ä½œ">
              <div class="d-flex flex-wrap gap-2">
                <a
                  href="{% url 'staffbook:schedule_form' %}?work_date={{ s.work_date|date:'Y-m-d' }}"
                  class="btn btn-sm btn-outline-primary">
                  âœï¸ ç·¨é›†
                </a>

                <form method="post"
                      action="{% url 'staffbook:schedule_delete' s.id %}"
                      onsubmit="return confirm('ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    ğŸ—‘ å‰Šé™¤
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            ã¾ã ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{# ==== BEGIN REPLACE/INSERT MS-CSS-CARD: ä¼šç¤¾æ±ºå®š æƒ…å ±ã‚«ãƒ¼ãƒ‰ æ¨£å¼ ==== #}
<style>
/* ===== é…è»Šæ±ºå®šï¼šã‚»ãƒ«å†…ã‚’ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ ===== */
.car-cell-wrap{
  display:flex;
  flex-direction:column;  /* ã‚«ãƒ¼ãƒ‰ â†’ å‚™è€ƒ ã®é †ã§ç¸¦ä¸¦ã³ */
  gap:6px;
}

/* ===== é…è»Šæ±ºå®šï¼šè»Šä¸¡æƒ…å ±ã‚«ãƒ¼ãƒ‰ ===== */
.car-info-card{
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#f8fafc;
  padding:8px 10px;
  box-shadow:0 1px 3px rgba(15,23,42,.08);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆå³ä¸Šã«è»Šä¸¡ãƒãƒƒã‚¸ï¼‰ */
.car-info-card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

/* è»Šä¸¡ãƒãƒƒã‚¸ï¼ˆãƒŠãƒ³ãƒãƒ¼ï¼‹è»Šåï¼‰ */
.car-info-badge{
  font-weight:700;
}

/* ç‚¹æ¤œï¼è»Šæ¤œï¼è¨­å‚™ ã®å„è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.car-info-row{
  display:flex;
  gap:6px;
  align-items:baseline;
}

/* å·¦å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆğŸ›  ç‚¹æ¤œï¼ğŸ“… è»Šæ¤œï¼âš™ è¨­å‚™ï¼‰ */
.ci-label{
  min-width:4.2em;
  color:#6b7280;
}

/* ===== ç‚¹æ¤œãƒ»è»Šæ¤œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²åˆ†ã‘ ===== */
/* æœŸé™åˆ‡ã‚Œï¼ˆèµ¤ï¼‰ */
.car-due.due-expired{
  color:#d93025;
  font-weight:700;
}

/* æœ¬æ—¥ãŒæœŸé™ï¼ˆç·‘ï¼‰ */
.car-due.due-today{
  color:#0f9d58;
  font-weight:700;
}

/* 5æ—¥ä»¥å†…ã«æœŸé™ï¼ˆèŒ¶è‰²ï¼‰ */
.car-due.due-soon{
  color:#b36b00;
  font-weight:600;
}

/* é€šå¸¸ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */
.car-due.due-normal{
  color:#777;
}

/* ===== è»Šä¸¡ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å‡ºã™ç®¡ç†ãƒ¡ãƒ¢ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œï¼‰ ===== */
.car-admin-note{
  margin-top:2px;
  padding:4px 6px;
  border-left:3px solid #9ca3af;
  background:#f9fafb;
  font-size:.8rem;
  color:#4b5563;
  line-height:1.4;
}

.car-admin-note .note-icon{
  margin-right:4px;
  opacity:.8;
}

.car-admin-note .note-text{
  word-break:break-word;
}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆã‚‚ã£ã¨è¦‹ã‚‹ï¼é–‰ã˜ã‚‹ï¼‰ */
.note-toggle{
  font-size:.75rem;
}

/* ã‚·ãƒ³ãƒ—ãƒ«ãª .d-none äº’æ›ï¼ˆå¿µã®ãŸã‚ï¼‰ */
.d-none{
  display:none !important;
}
</style>

{# ==== END MS-CSS-CARD ==== #}

<script>
/* ç®¡ç†ãƒ¡ãƒ¢ã®ã€Œã‚‚ã£ã¨è¦‹ã‚‹ï¼é–‰ã˜ã‚‹ã€ãƒˆã‚°ãƒ« */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.note-toggle');
  if (!btn) return;

  const wrap = btn.closest('.car-admin-note');
  if (!wrap) return;

  const shortText = wrap.querySelector('.note-short');
  const fullText  = wrap.querySelector('.note-full');

  if (!shortText || !fullText) return;

  const isExpanded = !fullText.classList.contains('d-none');

  if (isExpanded) {
    // ä»Šã¯å…¨æ–‡è¡¨ç¤º â†’ çŸ­ãæˆ»ã™
    fullText.classList.add('d-none');
    shortText.classList.remove('d-none');
    btn.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
  } else {
    // ä»Šã¯çŸ­ã„ç‰ˆ â†’ å…¨æ–‡è¡¨ç¤º
    shortText.classList.add('d-none');
    fullText.classList.remove('d-none');
    btn.textContent = 'é–‰ã˜ã‚‹';
  }
});
</script>

{% endblock %}
