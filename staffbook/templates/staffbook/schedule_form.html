{% extends "base.html" %}
{% load static %}
{% block content %}

{% include "partials/_messages.html" %}
<div class="container mt-4">

  <h4 class="mb-3">ğŸ—“ï¸ ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æå‡º</h4>

  <p class="text-muted small mb-4">
    ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š
    <strong>
      {% if driver %}{{ driver }}{% else %}{{ request.user.username }}{% endif %}
    </strong>
    ï¼ æœ¬æ—¥ï¼š{{ today|date:"Yå¹´næœˆjæ—¥ (D)" }}
  </p>

  {# ================================ #}
  {# â‘  æ¡Œé¢ç«¯ï¼ˆmdä»¥ä¸Šï¼‰= è¡¨æ ¼å¸ƒå±€       #}
  {# ================================ #}
  <div class="row d-none d-md-flex">
    <div class="col-md-12 mb-3">
      <div class="card">
        <div class="card-header">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹</div>
        <div class="card-body">
          <form id="schedule-form-desktop" method="post" novalidate>
            {% csrf_token %}
            <table class="table table-sm align-middle mb-0">

              <tr>
                <th style="width: 25%;">æ—¥ä»˜ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</th>
                <td>
                  <input type="text"
                         class="form-control form-control-sm" required
                         id="work-dates"
                         name="work_dates"
                         placeholder="æ—¥ä»˜ã‚’è¤‡æ•°é¸æŠ"
                         autocomplete="off">
                  <small class="text-muted">
                    â€» å³ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯â€œè¡¨ç¤ºåˆ‡æ›¿â€ã€ã“ã“ã¯â€œæå‡ºã™ã‚‹æ—¥ä»˜â€ã€‚è¤‡æ•°æœˆã«ã¾ãŸãŒã£ã¦é¸ã¹ã¾ã™ã€‚
                    ï¼ˆé¸æŠä¸­ï¼š<span id="sel-count">0</span> æ—¥ï¼‰
                  </small>
                </td>
              </tr>

              <tr>
                <th>åŒºåˆ†</th>
                <td>
                  <div class="form-check">
                    <input class="form-check-input"
                           type="radio"
                           name="mode"
                           id="mode-rest"
                           value="rest"
                           {% if existing and existing.is_rest %}checked{% elif not existing %}checked{% endif %}>
                    <label class="form-check-label" for="mode-rest">â‘  ä¼‘ã¿</label>
                  </div>
                  <div class="form-check mt-1">
                    <input class="form-check-input"
                           type="radio"
                           name="mode"
                           id="mode-wish"
                           value="wish"
                           {% if existing and not existing.is_rest %}checked{% endif %}>
                    <label class="form-check-label" for="mode-wish">â‘¡ å¸Œæœ›è»Šä¸¡ã‚’æå‡º</label>
                  </div>
                </td>
              </tr>

              <tr id="shift-row">
                <th>ã‚·ãƒ•ãƒˆ</th>
                <td>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input"
                           type="radio"
                           name="shift"
                           id="shift-day"
                           value="day"
                           {% if existing and existing.shift == "day" %}checked{% endif %}>
                    <label class="form-check-label" for="shift-day">ç™½ç­</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input"
                           type="radio"
                           name="shift"
                           id="shift-night"
                           value="night"
                           {% if existing and existing.shift == "night" %}checked{% endif %}>
                    <label class="form-check-label" for="shift-night">å¤œç­</label>
                  </div>
                  <small class="text-muted d-block mt-1">â€» â‘¡ã‚’é¸ã‚“ã å ´åˆã¯ã©ã¡ã‚‰ã‹å¿…é ˆ</small>
                </td>
              </tr>

              <tr id="wish-row">
                <th>è»Šä¸¡å¸Œæœ›</th>
                <td>
                  <div class="form-check mb-2">
                    <input class="form-check-input"
                           type="checkbox"
                           id="any-car"
                           name="any_car"
                           value="1"
                           {% if existing and existing.any_car %}checked{% endif %}>
                    <label class="form-check-label" for="any-car">ä»»æ„ã®è»Šä¸¡ã§ã‚‚ã‚ˆã„</label>
                  </div>

                  <div class="row g-2" id="wish-cars">
                    <div class="col">
                      <label class="form-label small">ç¬¬1å¸Œæœ›ã®è»Šä¸¡ <span class="text-danger">*</span></label>
                      <select class="form-select form-select-sm" id="first-car" name="first_car">
                        <option value="">-- é¸æŠ --</option>
                        {% for car in cars %}
                          <option value="{{ car.id }}"
                                  {% if existing and existing.first_choice_car and existing.first_choice_car.id == car.id %}selected{% endif %}
                                  {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                            {{ car.label }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col">
                      <label class="form-label small">ç¬¬2å¸Œæœ›ã®è»Šä¸¡ <span class="text-danger">*</span></label>
                      <select class="form-select form-select-sm" id="second-car" name="second_car">
                        <option value="">-- é¸æŠ --</option>
                        {% for car in cars %}
                          <option value="{{ car.id }}"
                                  {% if existing and existing.second_choice_car and existing.second_choice_car.id == car.id %}selected{% endif %}
                                  {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                            {{ car.label }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <small class="text-danger d-block mt-1" id="car-dup-msg" style="display:none;">
                    â€» ç¬¬1å¸Œæœ›ã¨ç¬¬2å¸Œæœ›ã¯åŒã˜è»Šä¸¡ã«ã§ãã¾ã›ã‚“ã€‚
                  </small>
                </td>
              </tr>

              <tr id="note-row">
                <th>å‚™è€ƒ</th>
                <td>
                  <input type="text"
                         class="form-control form-control-sm"
                         name="note"
                         placeholder="ä¾‹ï¼‰9æ™‚ä»¥é™ã§ãŠé¡˜ã„ã—ã¾ã™"
                         value="{% if existing %}{{ existing.note }}{% endif %}">
                </td>
              </tr>
            </table>

            <button type="submit" class="btn btn-primary btn-sm mt-3" id="btn-submit">
              ã“ã®å†…å®¹ã§æå‡º
            </button>
            <p class="text-muted small mt-2 mb-0">â€» å…¥åŠ›å†…å®¹ã¯é€ä¿¡å¾Œã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# ================================ #}
  {# â‘¡ æ‰‹æœºç«¯ï¼ˆmdä»¥ä¸‹ï¼‰= å¡ç‰‡å¸ƒå±€       #}
  {# ================================ #}
  <div class="d-md-none">
    <form id="schedule-form-mobile" method="post" novalidate>
      {% csrf_token %}
      <div class="card mb-3">
        <div class="card-header">æ—¥ä»˜</div>
        <div class="card-body">
          <input
            type="text"
            id="m-dates"
            name="work_dates"
            class="form-control form-control-sm mb-2" required
            placeholder="æ—¥ä»˜ã‚’è¤‡æ•°é¸æŠ"
            autocomplete="off">
          <small class="text-muted">â€» è¤‡æ•°æ—¥ãƒ»è¤‡æ•°æœˆã®é¸æŠãŒã§ãã¾ã™ã€‚</small>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label d-block">åŒºåˆ†</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="mode" id="m-mode-rest" value="rest" checked>
              <label class="form-check-label" for="m-mode-rest">â‘  ä¼‘ã¿</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="mode" id="m-mode-wish" value="wish">
              <label class="form-check-label" for="m-mode-wish">â‘¡ å¸Œæœ›æå‡º</label>
            </div>
          </div>

          <div class="mb-3" id="m-shift-block">
            <label class="form-label d-block">ã‚·ãƒ•ãƒˆ</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="shift" id="m-shift-day" value="day">
              <label class="form-check-label" for="m-shift-day">ç™½</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="shift" id="m-shift-night" value="night">
              <label class="form-check-label" for="m-shift-night">å¤œ</label>
            </div>
          </div>

          <div class="mb-3" id="m-wish-block">
            <label class="form-label d-block">è»Šä¸¡å¸Œæœ›</label>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="m-any-car" name="any_car" value="1">
              <label class="form-check-label" for="m-any-car">ä»»æ„ã®è»Šä¸¡</label>
            </div>
            <label class="form-label small">ç¬¬1å¸Œæœ›</label>
            <select class="form-select form-select-sm mb-2" id="m-first-car" name="first_car">
              <option value="">-- é¸æŠ --</option>
              {% for car in cars %}
                <option value="{{ car.id }}"
                        {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                  {{ car.label }}
                </option>
              {% endfor %}
            </select>

            <label class="form-label small">ç¬¬2å¸Œæœ›</label>
            <select class="form-select form-select-sm" id="m-second-car" name="second_car">
              <option value="">-- é¸æŠ --</option>
              {% for car in cars %}
                <option value="{{ car.id }}"
                        {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                  {{ car.label }}
                </option>
              {% endfor %}
            </select>

            <small class="text-danger d-block mt-1" id="m-car-dup-msg" style="display:none;">â€» åŒã˜è»Šä¸¡ã¯é¸ã¹ã¾ã›ã‚“ã€‚</small>
          </div>

          <div class="mb-3">
            <label class="form-label">å‚™è€ƒ</label>
            <input type="text" class="form-control form-control-sm" name="note" placeholder="ãƒ¡ãƒ¢">
          </div>

          <button type="submit" class="btn btn-primary btn-sm" id="m-btn-submit">
            æå‡º
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{# ===== flatpickr ä¾èµ– ===== #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

{# æŠŠåç«¯å–‚ç»™å‰ç«¯çš„â€œæ—¢å­˜æå‡º(æœ€è¿‘åŒºé—´)â€å¡è¿›æ¥ï¼š[{date:'YYYY-MM-DD',is_rest:true|false}, ...] #}
<script id="my-existing" type="application/json">{{ my_existing_json|default:"[]" }}</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ====== å…±é€šï¼šå·¥å…·å‡½æ•° ======
  function addError(container, msg) {
    if (!container) return;
    const div = document.createElement("div");
    div.className = "validation-error text-danger small mt-1";
    div.textContent = msg;
    container.appendChild(div);
  }
  function clearErrors(scope) {
    (scope ? scope : document).querySelectorAll(".validation-error").forEach(e => e.remove());
  }
  function scrollToFirstError() {
    const e = document.querySelector(".validation-error");
    if (e) e.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  // ====== æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ â†’ { "2025-11-09": true(ä¼‘) / false(å¸Œæœ›) } ======
  const EXISTING_MAP = (() => {
    try {
      const raw = document.getElementById("my-existing")?.textContent || "[]";
      const arr = JSON.parse(raw);
      const m = {};
      arr.forEach(r => { if (r?.date) m[r.date] = !!r.is_rest; });
      return m;
    } catch { return {}; }
  })();
  function parseDates(raw) {
    if (!raw) return [];
    return raw.replace(/ï¼Œ/g, ",").split(/[,\s]+/).map(s => s.trim()).filter(Boolean);
  }
  function findConflicts(dates, wantRest) {
    const bad = [];
    for (const d of dates) {
      if (!(d in EXISTING_MAP)) continue;
      const alreadyRest = EXISTING_MAP[d]; // true=ä¼‘, false=å¸Œæœ›
      if (alreadyRest !== wantRest) bad.push(d);
    }
    return bad;
  }

  // ====== 1) æ¡Œé¢ç«¯ï¼šæ—¥æœŸå¤šé€‰ ======
  const desktopDatesInput = document.getElementById("work-dates");
  if (desktopDatesInput) {
    const fp = flatpickr(desktopDatesInput, {
      locale: "ja",
      dateFormat: "Y-m-d",
      mode: "multiple",
      conjunction: ",",
      minDate: "today",
      showMonths: 2,
      onChange(selectedDates) {
        const cnt = document.getElementById("sel-count");
        if (cnt) cnt.textContent = selectedDates.length;
        validateDesktop(false);
      }
    });
    const cnt = document.getElementById("sel-count");
    if (cnt) cnt.textContent = fp.selectedDates.length;
    desktopDatesInput.addEventListener("change", () => validateDesktop(false));
  }

  // ====== 2) æ‰‹æœºç«¯ï¼šæ—¥æœŸå¤šé€‰ ======
  const mDates = document.getElementById("m-dates");
  if (mDates) {
    flatpickr(mDates, {
      locale: "ja",
      dateFormat: "Y-m-d",
      mode: "multiple",
      conjunction: ",",
      minDate: "today",
      showMonths: 2,
      onChange() { validateMobile(false); }
    });
    mDates.addEventListener("change", () => validateMobile(false));
  }

  // ====== 3) æ¡Œé¢ç«¯æ ¡éªŒä¸è”åŠ¨ ======
  const modeRest   = document.getElementById("mode-rest");
  const modeWish   = document.getElementById("mode-wish");
  const shiftRow   = document.getElementById("shift-row");
  const wishRow    = document.getElementById("wish-row");
  const anyCar     = document.getElementById("any-car");
  const firstCar   = document.getElementById("first-car");
  const secondCar  = document.getElementById("second-car");
  const dupMsg     = document.getElementById("car-dup-msg");
  const btnSubmit  = document.getElementById("btn-submit");
  const desktopForm= document.getElementById("schedule-form-desktop");

  function setDesktopMode() {
    const isRest = modeRest && modeRest.checked;
    if (shiftRow) shiftRow.style.display = isRest ? "none" : "";
    if (wishRow)  wishRow.style.display  = isRest ? "none" : "";
    if (btnSubmit) btnSubmit.disabled = false;
    clearErrors(desktopForm);
    if (!isRest) validateDesktop(false);
  }

  function validateDesktop(showTip = true) {
    if (!desktopForm) return true;
    clearErrors(desktopForm);
    if (dupMsg) dupMsg.style.display = "none";

    let valid = true;

    // æ—¥ä»˜
    const datesStr = (desktopDatesInput && desktopDatesInput.value || "").trim();
    if (!datesStr) {
      valid = false;
      addError(desktopForm.querySelector('tr:nth-child(1) td') || desktopForm, "â€» æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }

    // åŒºåˆ†
    if (modeWish && modeWish.checked) {
      const shiftChosen = desktopForm.querySelector('input[name="shift"]:checked');
      if (!shiftChosen) {
        valid = false;
        addError(document.querySelector("#shift-row td"), "â€» ã‚·ãƒ•ãƒˆï¼ˆç™½ or å¤œï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      }

      if (!anyCar || !anyCar.checked) {
        const f = firstCar ? firstCar.value : "";
        const s = secondCar ? secondCar.value : "";
        if (!f || !s) {
          valid = false;
          addError(document.querySelector("#wish-row td"), "â€» ç¬¬1å¸Œæœ›ã¨ç¬¬2å¸Œæœ›ã‚’ä¸¡æ–¹é¸æŠã—ã¦ãã ã•ã„ã€‚");
        } else if (f === s) {
          valid = false;
          if (dupMsg) dupMsg.style.display = "";
          addError(document.querySelector("#wish-row td"), "â€» ç¬¬1å¸Œæœ›ã¨ç¬¬2å¸Œæœ›ã¯åŒã˜è»Šä¸¡ã«ã§ãã¾ã›ã‚“ã€‚");
        }
      }
    }

    // === åŒºåˆ†ã®è¡çªãƒã‚§ãƒƒã‚¯ ===
    if (datesStr) {
      const selectedDates = parseDates(datesStr);
      const wantRest = !!(modeRest && modeRest.checked);
      const conflicts = findConflicts(selectedDates, wantRest);
      if (conflicts.length) {
        valid = false;
        const where = desktopForm.querySelector('tr:nth-child(1) td') || desktopForm;
        const tip = wantRest
          ? "â€» ãã®æ—¥ä»˜ã¯ã€å¸Œæœ›æå‡ºã€ã§ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ã¾ãšæ—¢å­˜ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
          : "â€» ãã®æ—¥ä»˜ã¯ã€ä¼‘ã¿ã€ã§ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ã¾ãšæ—¢å­˜ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚";
        addError(where, `${tip}ï¼ˆ${conflicts.join("ã€")}ï¼‰`);
      }
    }

    if (btnSubmit) btnSubmit.disabled = !valid;
    if (!valid && showTip) scrollToFirstError();
    return valid;
  }

  function toggleDesktopAnyCar() {
    const dis = !!(anyCar && anyCar.checked);
    if (firstCar) firstCar.disabled = dis;
    if (secondCar) secondCar.disabled = dis;
    validateDesktop(false);
  }

  if (modeRest)   modeRest.addEventListener("change", setDesktopMode);
  if (modeWish)   modeWish.addEventListener("change", setDesktopMode);
  if (anyCar)     anyCar.addEventListener("change", toggleDesktopAnyCar);
  if (firstCar)   firstCar.addEventListener("change", () => validateDesktop());
  if (secondCar)  secondCar.addEventListener("change", () => validateDesktop());
  document.querySelectorAll('#schedule-form-desktop input[name="shift"]').forEach(el => {
    el.addEventListener("change", () => validateDesktop());
  });

  if (desktopForm) {
    setDesktopMode();
    toggleDesktopAnyCar();
    desktopForm.addEventListener("submit", function (e) {
      if (!validateDesktop(true)) { e.preventDefault(); return; }
      if (btnSubmit) { btnSubmit.disabled = true; btnSubmit.textContent = "é€ä¿¡ä¸­â€¦"; }
    });
  }

  // ====== 4) æ‰‹æœºç«¯æ ¡éªŒä¸è”åŠ¨ ======
  const mForm      = document.getElementById("schedule-form-mobile");
  const mModeRest  = document.getElementById("m-mode-rest");
  const mModeWish  = document.getElementById("m-mode-wish");
  const mShiftBlk  = document.getElementById("m-shift-block");
  const mWishBlk   = document.getElementById("m-wish-block");
  const mAnyCar    = document.getElementById("m-any-car");
  const mFirstCar  = document.getElementById("m-first-car");
  const mSecondCar = document.getElementById("m-second-car");
  const mDupMsg    = document.getElementById("m-car-dup-msg");
  const mBtnSubmit = document.getElementById("m-btn-submit");

  function setDisabledIn(container, disabled) {
    if (!container) return;
    container.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = !!disabled);
  }

  function setMobileMode() {
    const isRest = mModeRest && mModeRest.checked;
    if (mShiftBlk) mShiftBlk.style.display = isRest ? "none" : "";
    if (mWishBlk)  mWishBlk.style.display  = isRest ? "none" : "";
    setDisabledIn(mShiftBlk, isRest);
    setDisabledIn(mWishBlk,  isRest);
    clearErrors(mForm);
    if (mBtnSubmit) mBtnSubmit.disabled = false;
    if (!isRest) validateMobile(false);
  }

  function validateMobile(showTip = true) {
    if (!mForm) return true;
    clearErrors(mForm);
    if (mDupMsg) mDupMsg.style.display = "none";

    let valid = true;

    const datesStr = (mDates && mDates.value || "").trim();
    if (!datesStr) {
      valid = false;
      addError(mForm.querySelector(".card:nth-of-type(1) .card-body") || mForm, "â€» æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }

    if (mModeWish && mModeWish.checked) {
      const shiftChosen = mForm.querySelector('input[name="shift"]:checked');
      if (!shiftChosen) {
        valid = false;
        addError(mShiftBlk, "â€» ã‚·ãƒ•ãƒˆï¼ˆç™½ or å¤œï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      }
      if (!mAnyCar || !mAnyCar.checked) {
        const f = mFirstCar ? mFirstCar.value : "";
        const s = mSecondCar ? mSecondCar.value : "";
        if (!f || !s) {
          valid = false;
          addError(mWishBlk, "â€» ç¬¬1å¸Œæœ›ã¨ç¬¬2å¸Œæœ›ã‚’ä¸¡æ–¹é¸æŠã—ã¦ãã ã•ã„ã€‚");
        } else if (f === s) {
          valid = false;
          if (mDupMsg) mDupMsg.style.display = "";
          addError(mWishBlk, "â€» åŒã˜è»Šä¸¡ã¯é¸ã¹ã¾ã›ã‚“ã€‚");
        }
      }
    }

    // === åŒºåˆ†ã®è¡çªãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰ ===
    if (datesStr) {
      const selectedDatesM = parseDates(datesStr);
      const wantRestM = !!(mModeRest && mModeRest.checked);
      const conflictsM = findConflicts(selectedDatesM, wantRestM);
      if (conflictsM.length) {
        valid = false;
        const tip = wantRestM
          ? "â€» ãã®æ—¥ä»˜ã¯ã€å¸Œæœ›æå‡ºã€ã§ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ã¾ãšæ—¢å­˜ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
          : "â€» ãã®æ—¥ä»˜ã¯ã€ä¼‘ã¿ã€ã§ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ã¾ãšæ—¢å­˜ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚";
        addError(mForm.querySelector(".card:nth-of-type(1) .card-body") || mForm,
                 `${tip}ï¼ˆ${conflictsM.join("ã€")}ï¼‰`);
      }
    }

    if (mBtnSubmit) mBtnSubmit.disabled = !valid;
    if (!valid && showTip) scrollToFirstError();
    return valid;
  }

  function toggleMobileAnyCar() {
    const dis = !!(mAnyCar && mAnyCar.checked);
    if (mFirstCar) mFirstCar.disabled = dis;
    if (mSecondCar) mSecondCar.disabled = dis;
    validateMobile(false);
  }

  if (mModeRest)  mModeRest.addEventListener("change", setMobileMode);
  if (mModeWish)  mModeWish.addEventListener("change", setMobileMode);
  if (mAnyCar)    mAnyCar.addEventListener("change", toggleMobileAnyCar);
  if (mFirstCar)  mFirstCar.addEventListener("change", () => validateMobile());
  if (mSecondCar) mSecondCar.addEventListener("change", () => validateMobile());
  document.querySelectorAll('#schedule-form-mobile input[name="shift"]').forEach(el => {
    el.addEventListener("change", () => validateMobile());
  });

  if (mForm) {
    setMobileMode();
    toggleMobileAnyCar();
    mForm.addEventListener("submit", function (e) {
      if (!validateMobile(true)) { e.preventDefault(); return; }
      if (mBtnSubmit) { mBtnSubmit.disabled = true; mBtnSubmit.textContent = "é€ä¿¡ä¸­â€¦"; }
    });
  }
});
</script>

<style>
.validation-error { font-size: .85rem; color: #d9534f; }
select option[disabled][data-unavailable="1"] {
  color: #999; background: #f3f3f3; font-style: italic;
}
</style>

{% endblock %}
