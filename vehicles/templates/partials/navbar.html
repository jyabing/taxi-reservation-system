<nav>
  {% if user.is_authenticated %}
    ğŸ‘‹ {{ user.username }} |

    <!-- ğŸšª ç³»ç»Ÿé¦–é¡µ -->
    <a href="{% url 'home' %}">ğŸ  ç³»ç»Ÿé¦–é¡µ</a>

    <!-- âœ… æ‰€æœ‰äººå¯è§ -->
    <a href="{% url 'profile' %}">ğŸ‘¤ æˆ‘çš„èµ„æ–™</a>

    {% with request.session.nav_clicks as clicks %}
      {% if clicks %}
        {% with clicks.vehicle_status|default_if_none:0 as click_vehicle_status %}
        {% with clicks.weekly_overview|default_if_none:0 as click_weekly %}
        {% with clicks.my_reservations|default_if_none:0 as click_my_res %}
        {% with clicks.staffbook_dashboard|default_if_none:0 as click_staffbook %}
        {% with clicks.carinfo_car_list|default_if_none:0 as click_carinfo %}
        {% with 10 as common_threshold %}

          <!-- âœ… ä¸»å¯¼èˆªæ˜¾ç¤ºå¸¸ç”¨é¡¹ -->
          {% if click_vehicle_status >= common_threshold %}
            <a href="{% url 'vehicle_status' %}">ğŸš— è»Šä¸¡çŠ¶æ…‹</a>
          {% endif %}
          {% if click_weekly >= common_threshold %}
            <a href="{% url 'weekly_overview' %}">ğŸ“… ä¸€å‘¨é¢„çº¦æ¦‚è§ˆ</a>
          {% endif %}
          {% if click_my_res >= common_threshold %}
            <a href="{% url 'my_reservations' %}">ğŸ“‹ ç§ã®äºˆç´„</a>
          {% endif %}

          <!-- âœ… ç®¡ç†èœå• -->
          {% if user.is_superuser or user.userprofile.is_vehicles_admin %}
            <a href="{% url 'reservation_dashboard' %}">ğŸš– é…è½¦ç³»ç»Ÿ</a>
            <a href="{% url 'reservation_approval_list' %}">ğŸ› ï¸ </a>
            <a href="{% url 'admin_stats' %}" style="color:purple;">ğŸ“Š ç®¡ç†å‘˜ç»Ÿè®¡</a>
          {% endif %}

          <!-- âœ… æ›´å¤šèœå• -->
          <div class="dropdown d-inline-block">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              â‹¯ æ›´å¤š
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              {% if click_vehicle_status < common_threshold %}
                <li><a class="dropdown-item" href="{% url 'vehicle_status' %}">ğŸš— è»Šä¸¡çŠ¶æ…‹</a></li>
              {% endif %}
              {% if click_weekly < common_threshold %}
                <li><a class="dropdown-item" href="{% url 'weekly_overview' %}">ğŸ“… ä¸€å‘¨é¢„çº¦æ¦‚è§ˆ</a></li>
              {% endif %}
              {% if click_my_res < common_threshold %}
                <li><a class="dropdown-item" href="{% url 'my_reservations' %}">ğŸ“‹ ç§ã®äºˆç´„</a></li>
              {% endif %}
              {% if user.is_superuser or user.userprofile.is_staffbook_admin %}
                <li><a class="dropdown-item" href="{% url 'staffbook:dashboard' %}">ğŸ“’ ç¤¾å“¡å°å¸³</a></li>
              {% endif %}
              {% if user.is_superuser or user.userprofile.is_staffbook_admin %}
                <li><a class="dropdown-item" href="{% url 'dailyreport:dailyreport_overview' %}">ğŸ’¸ æ—¥å ±ä¸€è¦§</a></li>
              {% endif %}
              {% if user.is_superuser or user.userprofile.is_carinfo_admin %}
                <li><a class="dropdown-item" href="{% url 'carinfo:car_list' %}">ğŸš— è»Šä¸¡ç®¡ç†</a></li>
              {% endif %}
              {% if user.is_superuser %}
                <li><a class="dropdown-item" href="/admin/">âš™ï¸ åå°</a></li>
              {% endif %}
            </ul>
          </div>

        {% endwith %}{% endwith %}{% endwith %}{% endwith %}{% endwith %}{% endwith %}
      {% endif %}
    {% endwith %}

    <!-- âœ… é€€å‡ºç™»å½• -->
    <form method="post" action="{% url 'logout' %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit">ğŸšª é€€å‡º</button>
    </form>

  {% else %}
    <a href="{% url 'login' %}">ç™»å½•</a>
  {% endif %}
</nav>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const nav = document.querySelector("nav");
    if (!nav) return;

    nav.querySelectorAll("a[href]").forEach(link => {
      link.addEventListener("click", function (event) {
        const name = link.innerText.trim();
        const url = link.getAttribute("href");

        fetch("/common/log-link-click/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: new URLSearchParams({
            name: name,
            url: url,
          })
        }).catch(err => {
          console.warn("é“¾æ¥ç‚¹å‡»è®°å½•å¤±è´¥", err);
        });
      });
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });å®¡æ‰¹é¢æ¿
</script>
