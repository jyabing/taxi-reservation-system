{% extends "staffbook/base_staffbook.html" %}
{% load widget_tweaks %}
{% load time_filters %}
{% load humanize %}
{% load custom_totals %}
{% load custom_tags %}


{% load static %}
{% load driver_extras %}

{% block extra_css %}



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
table.table tr.has-note,
table.table tr.has-note td {
  background-color: #fff3cd !important;
}
.auto-width-input {
  width: 2ch;
  min-width: 60px;
  max-width: 100px;
  box-sizing: content-box;
  transition: width 0.2s;
}
.mirror-span {
  position: absolute;
  visibility: hidden;
  white-space: pre;
  font: inherit;
}
.mark-checkbox {
  transform: scale(1.3);
  margin-top: 3px;
}
.scrollable-input {
  overflow-x: auto;
  white-space: nowrap;
  min-width: 50px;
  width: 100%;
  max-width: 100px;
}
#payment-summary-panel {
  font-size: 0.95rem;
}
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}
  /* æ–™é‡‘åªè¯»çš„å¤–è§‚ï¼ˆä¸å½±å“æäº¤ï¼‰ */
  .meter-fee-input[readonly],
  input[name$="-meter_fee"][readonly]{
    background:#eee !important;
    color:#666 !important;
    cursor:not-allowed;
  }
  /* ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ ä¸Šé¢ç»™ select åŠ äº† locked-selectï¼Œå°±ä¸€èµ·åŠ ç°æ ·å¼ */
  .locked-select{
    background:#f5f5f5 !important;
    color:#666 !important;
    pointer-events:none; /* é˜»æ­¢ç‚¹å‡»ä½†å€¼ä»ä¼šæäº¤ */
  }
  /* === å¼ºåˆ¶æ˜¾ç¤ºæ•°æ®åŒºè¡Œï¼›ä»…éšè—æ¨¡æ¿åŒº === */
  table.report-table tbody:not(#empty-form-template) tr {
    display: table-row !important; visibility: visible !important; opacity: 1 !important;
  }
  #empty-form-template tr { display: none !important; visibility: hidden !important; }

  /* éä¸è¶³ å†…è¨³æ ·å¼ */
  .ob-line{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
  .ob-line+.ob-line{margin-top:.25rem}
  .ob-label{color:#6c757d}
  .ob-mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .ob-chip{display:inline-block;padding:0 .4rem;border-radius:.5rem;font-size:.75rem;line-height:1.4;background:#f1f3f5;color:#495057;border:1px solid #e9ecef}
  .ob-pos{color:#198754} /* å…¬å¸â†’å¸æœºï¼ˆå¸æœºåº”æ”¶ï¼‰ */
  .ob-neg{color:#dc3545} /* å¸æœºâ†’å…¬å¸ï¼ˆå¸æœºåº”ä»˜ï¼‰ */
  .ob-total{font-weight:600}
  /* === END === */

  /* ä»…å½“ difference-breakdown ä»å¸¦ text-muted æ—¶éœ€è¦ */
  
  #difference-breakdown .ob-label { color: var(--bs-secondary-color, #6c757d); }
  #difference-breakdown .ob-mono { color: inherit; }

  .badge-etc{
  display:inline-block; padding:.1rem .45rem; border-radius:.5rem;
  font-size:.8rem; line-height:1.4; border:1px solid #e9ecef; background:#f8f9fa;
}
.badge-etc-pos{ color:#0d6efd; }  /* å…¬å¸â†’å¸æœº */
.badge-etc-neg{ color:#dc3545; }  /* å¸æœºâ†’å…¬å¸ */


</style>

{% endblock %}
{% block content %}
<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <h4>{% if report %}{{ report.driver.name }}{% else %}{{ driver.name }}{% endif %}- ä¹—å‹™æ—¥å ±ã®ç·¨é›†</h4>

  <p class="text-muted">æ—¥ä»˜ï¼š{{ form.date.value|date:"Yå¹´næœˆjæ—¥" }}</p>

  {% if report.pk %}
    {% if report.edited_by %}
      <div class="alert alert-light small mb-3">
        <strong>æœ€çµ‚ç·¨é›†ï¼š</strong>
        {{ report.edited_by.get_full_name|default:report.edited_by.username }}
        {{ report.edited_at|date:"Yå¹´næœˆjæ—¥ H:i" }} ã«ä¿å­˜
      </div>
    {% else %}
      <div class="alert alert-secondary small mb-3">ç·¨é›†å±¥æ­´ãªã—</div>
    {% endif %}
  {% endif %}

  

  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ï¼š</strong>
      <ul>
      {% for field, errs in form.errors.items %}
        <li>{{ field }}: {{ errs|join:", " }}</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>æ˜ç´°ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¨ãƒ©ãƒ¼ï¼š</strong>
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  {# ==== DEBUG: æ¯ä¸€è¡Œæ˜ç»†çš„æ‰€æœ‰é”™è¯¯éƒ½æ‰“å°å‡ºæ¥ ==== #}
  {# åªæœ‰â€œçœŸçš„æœ‰é”™è¯¯â€æ—¶æ‰æ˜¾ç¤ºè¿™ä¸ªå¤§é»„å—ï¼Œé¿å…é¡µé¢ä¸€ç›´è¢«æ’‘å¾—å¾ˆé«˜ #}
  {% if formset.errors or formset.non_form_errors %}
    <div class="alert alert-warning small" style="white-space: normal; white-space-collapse: discard;">
      <strong>DEBUG: æ˜ç´°è¡Œã‚¨ãƒ©ãƒ¼ä¸€è¦§</strong>
      <ul class="mb-0">
        {% for f in formset.forms %}
          {% if f.errors or f.non_field_errors %}
            <li>
              <strong>è¡Œ {{ forloop.counter }}:</strong>
              {{ f.non_field_errors }}
              {{ f.errors }}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  {# ==== DEBUG ã“ã“ã¾ã§ ==== #}

    <!--ç¼©è¿›æ— å½±å“ï¼Œä¹Ÿå¯ä»¥å†™æˆå•è¡Œå½¢å¼-->
    <form method="post"
      {% if is_edit %}
        action="{% url 'dailyreport:driver_dailyreport_edit' driver_id=driver.id report_id=report.id %}"
      {% elif driver and driver.id %}
        action="{% url 'dailyreport:driver_dailyreport_direct_add' driver.id %}"
      {% else %}
        action="#"
      {% endif %}
      autocomplete="off">
    {% csrf_token %}
    {{ form.status.as_hidden }}
    {{ form.date.as_hidden }}

    <div class="mb-3">
      <label class="form-label">å‚™è€ƒï¼š</label>
      {{ form.note|add_class:"form-control form-control-sm"|attr:"rows:2"|attr:"style:width:100%; max-width:400px;" }}
    </div>

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th style="white-space: nowrap;"><strong>ä½¿ç”¨è»Šä¸¡</strong></th>
          <th style="white-space: nowrap;">å‡ºå‹¤</th>
          <th style="white-space: nowrap;">é€€å‹¤</th>
          <th style="white-space: nowrap;">å‹¤å‹™æ™‚é–“</th>
          <th style="white-space: nowrap;">ä¼‘æ†©æ™‚é–“</th>
          <th style="white-space: nowrap;"><span class="text-info">å®Ÿåƒæ™‚é–“</span></th>
          <th class="text-danger" style="white-space: nowrap;">æ®‹æ¥­æ™‚é–“</th>
          <th style="white-space: nowrap;">çµ¦æ²¹ (L)</th>
          <th style="white-space: nowrap;">èµ°è¡Œè·é›¢ (KM)</th>
        </tr>
      </thead>
      <tbody id="data-rows">
        <tr>
          <td>
            <span class="form-control-plaintext">
              {{ report.vehicle|default:"æœªé¸æŠ" }}
            </span>

            {# å…³é”®ï¼šæŠŠå½“å‰ vehicle çš„ id ä¸€èµ·æäº¤ #}
            {% if report.vehicle_id %}
              <input type="hidden" name="vehicle" value="{{ report.vehicle_id }}">
            {% endif %}
          </td>


          <!-- å‡ºå‹¤ -->
          <td style="max-width:110px;">
            <input type="text" name="clock_in" class="form-control form-control-sm time-input" value="{{ form.clock_in.value|default_if_none:'' }}">
          </td>

          <!-- é€€å‹¤ï¼ˆå«â€œæœªå®Œæˆå…¥åº“æ‰‹ç»­â€å‹¾é€‰ï¼‰ -->
          <td style="max-width:220px;">
            <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
              <!-- é€€å‹¤è¾“å…¥æ¡† -->
              <input
                type="text"
                name="clock_out"
                id="id_clock_out"
                class="form-control form-control-sm time-input"
                style="min-width: 80px; max-width: 120px;"
                value="{{ form.clock_out.value|default_if_none:form.initial.clock_out|default_if_none:'' }}"
              >

              <!-- å‹¾é€‰æ¡†ï¼ˆä½¿ç”¨è¡¨å•å­—æ®µï¼Œä¾¿äº cleaned_data è§£æä¸º boolï¼‰ -->
              <label class="form-check d-inline-flex align-items-center m-0" style="gap:.25rem;">
                {{ form.unreturned_flag }}
                <span id="return-status-text">
                  {% if form.clock_out.value|default_if_none:form.initial.clock_out %}å·²å®Œæˆ{% else %}æœªå®Œæˆå…¥åº“æ‰‹ç»­{% endif %}
                </span>
              </label>
            </div>
          </td>
          <td id="work-duration">--:--</td> <!--å‹¤å‹™æ™‚é–“-->

          <!-- âœ… ä¼‘æ†©æ™‚é–“è¾“å…¥ -->
          <td id="break-time">
            <input type="text" name="break_time_input" id="break-time-input"
                class="form-control form-control-sm text-center"
                maxlength="5" pattern="^\d{1,2}:\d{2}$"
                style="max-width:90px;" placeholder="0:00"
                value="{{ break_time_h|default:'0' }}:{{ break_time_m|default:'00' }}">

            <!-- âœ… æ˜¾ç¤ºã€Œå®Ÿä¼‘æ†© +20åˆ†ã€ -->
            <div class="form-text mt-1 text-muted">
              å®Ÿä¼‘æ†©: <span id="break-time-display">--:--</span>
            </div>

            <!-- âœ… éšè—å­—æ®µï¼ˆè‡ªåŠ¨å¡«å…¥ 20åˆ†åæ—¶é—´ï¼‰ -->
            <input type="hidden" name="break_time_plus20" id="break-time-plus20">
          </td>

          <!-- å®Ÿåƒæ™‚é–“ -->
          <td class="text-center text-primary" id="actual-work-time">
            {% if form.instance.å®Ÿåƒæ™‚é–“ %}
              {{ form.instance.å®Ÿåƒæ™‚é–“ }}
            {% else %}
              --:--
            {% endif %}
          </td>

          <!-- æ®‹æ¥­æ™‚é–“ -->
          <td class="text-danger text-center" id="overtime">{{ form.instance.æ®‹æ¥­æ™‚é–“|format_duration }}</td>
          
          <td style="max-width:90px;">{{ form.gas_volume|add_class:"form-control form-control-sm text-end" }}</td>
          <td >{{ form.mileage|add_class:"form-control form-control-sm text-end" }}</td>
        </tr>
      </tbody>
    </table>

    <div id="payment-summary-panel" class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      {% for key, label in summary_keys %}
        <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
          <div class="small text-muted">
            {% if key == "meter" %}
              <div class="small text-muted">å£²ä¸Šåˆè¨ˆ</div>
              <div>
                <span id="total_meter">
                  {{ totals.meter_total|default:0|intcomma }}  {# â† åº”è¯¥æ˜¾ç¤ºæ”¶å…¥åˆè®¡ï¼Œå¦‚ 17,800 #}
                </span>
                <div class="small text-muted">
                  <small>(ãƒ¡ãƒ¼ã‚¿ã®ã¿: <span id="total_meter_only">
                    {{ totals.meter_only_total|default:0|intcomma }}
                  </span>)</small>
                </div>
                <div class="small text-muted">
                  â€» å£²ä¸Šåˆè¨ˆã«ã¯ã€æ”¯æ‰•æ–¹æ³•ä»˜ãã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒå«ã¾ã‚Œã¾ã™ã€‚
                </div>
              </div>
            {% else %}
              <div class="small text-muted">{{ label }} åˆè¨ˆ</div>
              <div>
                <span id="total_{{ key }}">
                  {{ totals|get_item:key|get_item:"total"|default:0|floatformat:"0" }}
                </span>
                ï¼ˆ<span id="bonus_{{ key }}">
                  {{ totals|get_item:key|get_item:"bonus"|default:0|floatformat:"0" }}
                </span>ï¼‰
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- >>> è¿½åŠ : Uberäºˆç´„ / Uberãƒãƒƒãƒ— / Uberãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ åˆè¨ˆã‚«ãƒ¼ãƒ‰ start -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">Uberäºˆç´„ åˆè¨ˆ</div>
        <div>
          <span id="uber-reservation-total">0</span>
          <span class="text-muted small">ï¼ˆ<span id="uber-reservation-count">0</span>ï¼‰</span>
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">Uberãƒãƒƒãƒ— åˆè¨ˆ</div>
        <div>
          <span id="uber-tip-total">0</span>
          <span class="text-muted small">ï¼ˆ<span id="uber-tip-count">0</span>ï¼‰</span>
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">Uberãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ åˆè¨ˆ</div>
        <div>
          <span id="uber-promotion-total">0</span>
          <span class="text-muted small">ï¼ˆ<span id="uber-promotion-count">0</span>ï¼‰</span>
        </div>
      </div>
      <!-- <<< è¿½åŠ  end -->

      <!-- âœ… è¿½åŠ ï¼šè²¸åˆ‡åå…¥ãƒ»å£²ä¸Šåˆè¨ˆãƒ»å…¥é‡‘åˆè¨ˆ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">è²¸åˆ‡ç¾é‡‘</div>
        <div>
          <span id="charter-cash-total">
            {{ totals.charter_cash_total|default:0|intcomma }}
          </span> å††
        </div>
      </div>

      <div class="border rounded px-3 py-2 text-center" style="min-width: 140px;">
        <div class="small text-muted">è²¸åˆ‡æœªå</div>
        <div>
          <span id="charter-uncollected-total">
            {{ totals.charter_uncollected_total|default:0|intcomma }}
          </span> å††
        </div>
      </div>
      
      <!-- âœ… å…¥é‡‘ + ETC ç»¼åˆåŒºåŸŸ -->
      <div class="d-flex flex-wrap gap-2 mb-3" style="justify-content: start;">
      <!-- âœ… å…¥é‡‘/éä¸è¶³ å¡ç‰‡ -->
      <div class="border rounded px-3 py-2 text-center" style="min-width: 80px;">
        <label class="small text-muted">å…¥é‡‘é¡</label>
        {{ form.deposit_amount|add_class:"form-control form-control-sm text-end"|attr:"id:deposit-input"|attr:"style:min-width:80px;"|attr:"placeholder:0" }}

      <!-- âœ… ETC åŒ…å«åˆ¤æ–­æç¤ºï¼ˆJS åŠ¨æ€ä¿®æ”¹ï¼‰ -->
      <div id="etc-included-warning" class="small mt-1"></div>

          {% if report.etc_collected and report.deposit_amount %}
            {% if report.is_etc_included_in_deposit %}
              <div class="small text-success mt-1">âœ”ï¸ å« ETC</div>
            {% else %}
              <div class="small text-danger mt-1">âš ï¸ æœªå« ETCï¼Œè¯·ç¡®è®¤</div>
            {% endif %}
          {% endif %}

          <label class="small text-muted mt-2 d-block">
            éä¸è¶³ï¼ˆå…¥é‡‘ âˆ’ ç¾é‡‘(ãªãŒã—) âˆ’ è²¸åˆ‡ç¾é‡‘ ï¼‹ å®Ÿéš›ETCï¼‰
          </label>
          <div id="difference-output"
              class="form-control-plaintext text-end small"
              style="min-height: 1.5em;"
              title="åŸºæœ¬éä¸è¶³ã«å®Ÿéš›ETCï¼ˆä¼šç¤¾â‡„é‹è»¢æ‰‹ã®è¿”é‚„å·®å¼•ï¼‰ã‚’åŠ å‘³">
            {{ form.deposit_difference.value|default:"--" }}
          </div>
          <div id="difference-breakdown" class="form-text small"></div>
        </div>

        
        <!-- â€¦å…¶ä½™å¡ç‰‡ä¿æŒåŸæ ·â€¦ -->
      </div>
      <!-- âœ… å…¥é‡‘ + ETC ç»¼åˆåŒºåŸŸ ç»“æŸ-->

      <!-- ======= BEGIN: ETC æ¦‚è¦ï¼ˆè¡Œæ˜ç´°ã‚ˆã‚Šé›†è¨ˆï¼‹å·¥èµ„æ‰£é™¤ï¼‰ ======= -->
      <div class="border rounded px-3 py-2 text-start" style="min-width: 220px;">
        <div class="small text-muted mb-1">ETC æ¦‚è¦ï¼ˆè¡Œæ˜ç´°ã‚ˆã‚Šé›†è¨ˆï¼‰</div>

        <div class="d-flex flex-column gap-1 small">
          <!-- â‘  è¡Œæ˜ç»†æ±‡æ€» -->
          <div>ä¹—è»ŠETC åˆè¨ˆï¼š<span id="ride-etc-total">0</span></div>
          <div>ç©ºè»ŠETC åˆè¨ˆï¼š<span id="empty-etc-total">0</span></div>

          <hr class="my-1">

          <!-- â‘¡ è´Ÿæ‹…åŒºåˆ† -->
          <div>ETC(å®¢æ‰• = å£²ä¸Šå€™è£œ)ï¼š<span id="etc-customer-total">0</span></div>
          <div>ETC(ä¼šç¤¾è² æ‹…)ï¼š<span id="etc-company-total">0</span></div>
          <div>ETC(ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç«‹æ›¿)ï¼š<span id="etc-driver-total" data-role="etc-paid-driver">0</span></div>

          <hr class="my-1">

          <!-- â‘¢ å¸æœºè´Ÿæ‹…ï¼ˆå·¥èµ„æ‰£é™¤äºˆå®šï¼‰ -->
          <div class="d-flex justify-content-between align-items-center">
            <span>å¸æœºè² æ‹…ETCï¼ˆå·¥èµ„æ‰£é™¤äºˆå®šï¼‰</span>
            <span class="fw-bold">
              <span id="etc-driver-cost">
                {{ form.instance.etc_driver_cost|default:0 }}
              </span> å††
            </span>
          </div>

          <!-- â‘£ ETC ä¸è¶³ï¼ˆåªè¯»ï¼‰ -->
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="small text-danger">ETCä¸è¶³ï¼ˆå††ï¼‰</span>
            <div style="width: 110px;">
              {{ form.etc_shortage|add_class:"form-control form-control-sm text-end text-danger"|attr:"readonly" }}
            </div>
          </div>

          <!-- â‘¤ æœªæ”¶ ETC æç¤ºï¼ˆç”± JS/åå°æ›´æ–°æ–‡æ¡ˆï¼‰ -->
          <div id="etc-diff-display" class="alert alert-info small py-1 px-2 mt-1 mb-0">
            æœªæ”¶ ETCï¼š0 å††ï¼ˆæ— éœ€æ‰£é™¤ï¼‰
          </div>
        </div>

        {# HiddenInputï¼šæäº¤åˆ°åç«¯ã€‚widget å·²åœ¨ forms.py è®¾ä¸º HiddenInput #}
        {{ form.etc_driver_cost }}

        <div class="form-text mt-1">
          ãƒ»ä¸Šè¨˜ 3 åŒºåˆ†ã¯ã€è¡Œæ˜ç´°ã® ETC(ä¹—è»Š/ç©ºè»Š, è´Ÿæ‹…) åˆè¨ˆã®å†…è¨³ã§ã™ã€‚<br>
          ãƒ»å¸æœºè² æ‹…ETC = ä¼šç¤¾ã‚«ãƒ¼ãƒ‰ç­‰ã§æ”¯æ‰•ã£ãŸã†ã¡ã€Œãƒ‰ãƒ©ã‚¤ãƒãƒ¼è² æ‹…ã€ã¨ã—ãŸé‡‘é¡ã§ã€
            æœˆæ¬¡ã®çµ¦ä¸ã‹ã‚‰æ§é™¤ã•ã‚Œã¾ã™ã€‚<br>
          ãƒ»ETCä¸è¶³ï¼ˆå††ï¼‰= åº”æ”¶åˆè®¡ âˆ’ å®æ”¶é‡‘é¢ã€‚<br>
          ãƒ»â€œETC å®é™…æ”¶å›â€ä¸æ˜¯ä¸€ä¸ªå•ç‹¬å¡«å†™çš„å­—æ®µï¼Œè€Œæ˜¯ç”±æ—¥æŠ¥æ˜ç»†çš„ä»˜æ¬¾æ–¹å¼æ•°æ®åŠ¨æ€æ±‡æ€»å‡ºæ¥çš„ã€‚
        </div>
      </div>
      <div class="mt-2">
          <div class="small text-muted mb-1">ETC è¡Œåˆ¥æ˜ç´°ï¼ˆæ™‚é–“ãƒ»æ”¯ä»˜æ–¹å¼ã‚’ç¢ºèªï¼‰</div>
          <table class="table table-sm table-bordered mb-0">
            <thead class="table-light">
              <tr class="small text-center">
                <th style="white-space: nowrap;">æ™‚é–“</th>
                <th style="white-space: nowrap;">æ”¯ä»˜</th>
                <th style="white-space: nowrap;">ä¹—è»ŠETC</th>
                <th style="white-space: nowrap;">ç©ºè»ŠETC</th>
                <th style="white-space: nowrap;">åˆè¨ˆ</th>
              </tr>
            </thead>
            <tbody id="etc-detail-body" class="small">
              {# JS ã§ tr ã‚’æŒ¿å…¥ã™ã‚‹ã€‚åˆæœŸã¯ç©º #}
            </tbody>
          </table>
        </div>
      <!-- ======= END: ETC æ¦‚è¦ ======= -->


      
      <!-- ======= BEGIN: ETC æ˜ç»†æŠ˜å åŒºåŸŸï¼ˆä¹˜è½¦ï¼‹å›ç¨‹ï¼‰ ======= -->
      <div class="mt-2">

        <!-- ç»Ÿä¸€æ ‡é¢˜ -->
        <div class="small text-muted mb-1">
          ETC æ˜ç»†ï¼ˆéœ€è¦æ—¶å±•å¼€å¡«å†™ï¼‰
        </div>

        <!-- â–¼ æŠ˜å 1ï¼šETC æ”¶å–ï¼ˆï¼ä¹—è»Šåˆè¨ˆï¼‰ -->
        <!-- ======= BEGIN MOD: ç²¾ç®€ç‰ˆï½œETC æ”¶å–ï¼ˆä¹—è»Šåˆè¨ˆï¼‰ ======= -->
        <button class="btn btn-outline-secondary btn-sm w-100 text-start mb-1"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse-etc-collected"
                aria-expanded="false">
          ETC æ”¶å–ï¼ˆï¼ä¹—è»Šåˆè¨ˆï¼‰
        </button>

        <div class="collapse" id="collapse-etc-collected">
          <div class="border rounded px-3 py-2 text-start small" style="min-width: 220px;">

            <!-- â–¼ 1. æ”¶å–é‡‘é¢ -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>ETC æ”¶å–é‡‘é¢ï¼ˆå††ï¼‰</span>
              {{ form.etc_collected|add_class:"form-control form-control-sm text-end"|attr:"style:width:90px;" }}
            </div>

            <!-- â–¼ 2. æ”¶æ¬¾æ–¹å¼ -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>æ”¶æ¬¾æ–¹å¼</span>
              {{ form.etc_payment_method|add_class:"form-select form-select-sm"|attr:"style:width:120px;" }}
            </div>

            <!-- â–¼ 3. ä¹—è»ŠETC æ”¯æ‰•è€… -->
            <div class="d-flex justify-content-between align-items-center">
              <span>ä¹—è»ŠETC æ”¯æ‰•è€…</span>
              {{ form.etc_rider_payer|add_class:"form-select form-select-sm"|attr:"style:width:140px;" }}
            </div>

          </div>
        </div>
        <!-- ======= END MOD: ç²¾ç®€ç‰ˆï½œETC æ”¶å–ï¼ˆä¹—è»Šåˆè¨ˆï¼‰ ======= -->

        <!-- â–¼ æŠ˜å 2ï¼šç©ºè»ŠETCï¼ˆå›ç¨‹ï¼‰è©³ç´° -->
        <!-- === è¿½åŠ ï¼šç©ºè»ŠETCï¼ˆå›ç¨‹ï¼‰æ˜ç»†ï¼Œç”¨äºè®¡ç®—è¦†ç›–ä¸å¸æœºè´Ÿæ‹… === -->
        <button class="btn btn-outline-secondary btn-sm w-100 text-start mb-1"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse-empty-etc-detail"
                aria-expanded="false">
          ç©ºè»ŠETCï¼ˆå›ç¨‹ï¼‰è©³ç´°
        </button>

        <div class="collapse" id="collapse-empty-etc-detail">

          <div id="empty-etc-card" class="border rounded px-3 py-2" style="min-width: 280px;">

            <div class="small text-muted mb-2">ç©ºè»ŠETCï¼ˆå›ç¨‹ï¼‰è©³ç´°</div>
            <div class="small text-muted">ğŸ§¾ ãƒ¡ãƒ¼ã‚¿å°ç¥¨ è¨˜è¼‰ç”¨ï¼š</div>

            <div style="font-family:ui-monospace,Menlo,monospace;">ç©ºè»ŠETC {{ report.etc_uncollected|default:0 }}å††</div>
            <div class="row g-2 align-items-end">
              <!-- ç©ºè»ŠETCé‡‘é¢ -->
              <div class="col-6">
                <label for="id_etc_uncollected" class="form-label small">ç©ºè»ŠETC é‡‘é¡ï¼ˆå††ï¼‰</label>
                <input type="number" class="form-control form-control-sm text-end js-empty-etc-amount"
                      id="id_etc_uncollected" name="etc_uncollected" min="0" step="1"
                      value="{% firstof form.etc_uncollected.value report.etc_uncollected 0 %}" inputmode="numeric" pattern="[0-9]*">
              </div>
              <!-- å›ç¨‹è´¹å—é¢†é¡ -->
              <div class="col-6">
                <label for="{{ form.etc_return_fee_claimed.id_for_label }}" class="form-label small">
                  å›ç¨‹è²» å—é ˜é¡ï¼ˆå††ï¼‰
                </label>
                {{ form.etc_return_fee_claimed }}
              </div>

              <!-- å›ç¨‹è´¹æ”¯ä»˜æ–¹å¼ -->
              <div class="col-6">
                <label for="{{ form.etc_return_fee_method.id_for_label }}" class="form-label small">
                  å›ç¨‹è²» æ”¯æ‰•æ–¹æ³•
                </label>
                {{ form.etc_return_fee_method }}
              </div>
              <!-- ç©ºè»ŠETC ä½¿ç”¨å¡ -->
              <div class="col-6">
                <label for="id_etc_empty_card" class="form-label small">ç©ºè»ŠETC ã‚«ãƒ¼ãƒ‰</label>
                {{ form.etc_empty_card|add_class:"form-select form-select-sm js-empty-etc-card" }}

              </div>
            </div>
            <div class="form-text mt-2">
              <small>
                è¦†ç›–è§„åˆ™ï¼šæ”¯æ‰•æ–¹æ³• = <strong>ã‚¢ãƒ—ãƒª/ãƒã‚±ãƒƒãƒˆ</strong> æ—¶ï¼Œå›ç¨‹è²»ç”¨äºè¦†ç›–ç©ºè»ŠETCï¼›<br>
                è¦†ç›–ä¸è¶³ â†’ <strong>å¸æœºè² æ‹…</strong>ï¼›è¦†ç›–è¿‡å¤š â†’ è¨˜ç‚º <strong>æœªæ”¶ETC</strong>ï¼ˆå±•ç¤º/çµ±è¨ˆç”¨ï¼‰ã€‚
              </small>
            </div>
          </div>

        </div>
        <!-- === è¿½åŠ ç»“æŸ === -->

      </div>
      <!-- ======= END: ETC æ˜ç»†æŠ˜å åŒºåŸŸ ======= -->
      
      <!-- âœ… æ™ºèƒ½æç¤ºåŒºï¼ˆæ¨èæ”¾åœ¨ payment-summary-panel ç»“å°¾ï¼‰ -->
      <div id="smart-hint-panel" class="mt-2 w-100">
        {% if deposit_amt %}
          {% if deposit_amt < total_collected %}
            <div class="alert alert-danger py-1 px-2 small mb-2">
              âš ï¸ å…¥é‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è«‹æ±‚é¡ (ç¾é‡‘ + ETC) ã¯ <strong>{{ total_collected|floatformat:"0"|intcomma }}å††</strong> ã§ã™ãŒã€å…¥åŠ›ã•ã‚ŒãŸå…¥é‡‘é¡ã¯ <strong>{{ deposit_amt|intcomma }}å††</strong> ã§ã™ã€‚
            </div>
          {% else %}
            <div class="alert alert-success py-1 px-2 small mb-2">
              âœ”ï¸ å…¥é‡‘é¡ã¯ç¾é‡‘ + ETC ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã¾ã™ã€‚
            </div>
          {% endif %}

          {% if report.etc_uncollected %}
            <div class="alert alert-info py-1 px-2 small mb-2">
              ğŸš§ ETC æœªæ”¶ï¼š<strong>{{ report.etc_uncollected|intcomma }}å††</strong>ã€‚è¯·ç¡®è®¤å¸æœºæ˜¯å¦å·²è¡¥æ”¶ã€‚
            </div>
          {% endif %}

          {% if deposit_amt < total_sales %}
            <div class="alert alert-warning py-1 px-2 small mb-2">
              â„¹ï¸ å£²ä¸Šåˆè¨ˆ <strong>{{ total_sales|intcomma }}å††</strong> å¤§äºå…¥é‡‘ <strong>{{ deposit_amt|intcomma }}å††</strong>ï¼Œæœªæ”¶ ETC æˆ–å…¶ä»–å»¶è¿Ÿç»“ç®—é¡¹ã€‚
            </div>
          {% endif %}
        {% endif %}
      </div>

    </div>

    <!-- ====== BEGIN PATCH: ETC æ˜¾ç¤ºå¼€å…³ï¼ˆé»˜è®¤éšè—åˆ—ï¼‰ ====== -->
    <div class="d-flex align-items-center gap-2 mb-2">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggle-etc-cols">
        <label class="form-check-label" for="toggle-etc-cols">æ˜¾ç¤º ETC æ˜ç»†ï¼ˆä¹—è»Š/ç©ºè»Š/è² æ‹…ï¼‰</label>
      </div>
      <a href="{% url 'dailyreport:etc_help' %}" class="btn btn-sm btn-outline-info" target="_blank" rel="noopener">
        æŸ¥çœ‹å¡«æŠ¥æŒ‡å—
      </a>
    </div>

    <!-- ====== END PATCH ====== -->

    <table class="table table-bordered table-sm report-table">
      <thead class="table-light">
        <tr>
          <th class="row-number-header">#</th>
          <th style="white-space: nowrap;">æ™‚é–“</th>
          <th style="white-space: nowrap;">ä¹—è»Šåœ°</th>
          <th style="white-space: nowrap;">æ–™é‡‘</th>
          <th style="white-space: nowrap;">æ”¯ä»˜</th>
          <!-- ======= BEGIN FIXED: è¡Œçº§ETC è¡¨å¤´ä¸‰åˆ—ï¼ˆåŠ  classï¼Œä¾¿äºæ˜¾éšï¼‰ ======= -->
          <th class="text-center col-etc-riding"         style="white-space: nowrap;">ä¹—è»ŠETC</th>
          <!-- ä¹—è»ŠETCè² æ‹… -->
          <th class="text-center col-etc-riding-charge" style="white-space: nowrap;">
            ä¹—è»ŠETC ç«‹æ›¿è€…
            <button type="button"
                    class="btn btn-link p-0 ms-1 align-baseline help-popover"
                    data-bs-toggle="popover"
                    data-bs-title="ä¹—è»ŠETCè² æ‹…ã¨ã¯"
                    data-bs-html="true"
                    data-bs-content="
                      <div style='max-width:260px'>
                        <div><b>å«ä¹‰ï¼š</b>æœ¬è¶Ÿæœ‰å®¢æ—¶ï¼Œ<u>è°å…ˆå«ä»˜</u>äº†é«˜é€Ÿè´¹ã€‚</div>
                        <ul class='mb-1 ps-3'>
                          <li><b>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</b>ï¼šå¸æœºå…ˆå«ï¼›è‹¥æœ¬è¡Œæ–¹å¼ä¸º<b>å…¬å¸ä¾§</b>ï¼Œå…¬å¸<b>è¿”è¿˜å¸æœº</b>ã€‚</li>
                          <li><b>ä¼šç¤¾</b>ï¼šå…¬å¸æ‰¿æ‹…ï¼Œä¸è¿”ã€‚</li>
                          <li><b>ãŠå®¢æ§˜</b>ï¼šå®¢äººæ‰¿æ‹…ï¼ˆå½“åœºæˆ–å¹³å°ç»“æ¸…ï¼‰ï¼Œä¸è¿”ã€‚</li>
                        </ul>
                        <div class='text-muted small'>è¿”è¿˜æ˜¯ä»…é™ <b>ä¹—è»Š</b> ä¸” <b>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</b> ä¸” <b>ä¼šç¤¾å´æ±ºæ¸ˆ</b>ã€‚</div>
                      </div>
                    ">â“</button>
          </th>
          <th class="text-center col-etc-empty"          style="white-space: nowrap;">ç©ºè»ŠETC</th>
          <!-- ç©ºè»ŠETCè² æ‹… -->
          <th class="text-center col-etc-empty-charge" style="white-space: nowrap;">
            ç©ºè»ŠETC ç«‹æ›¿è€…
            <button type="button"
                    class="btn btn-link p-0 ms-1 align-baseline help-popover"
                    data-bs-toggle="popover"
                    data-bs-title="ç©ºè»ŠETCè² æ‹…ã¨ã¯"
                    data-bs-html="true"
                    data-bs-content="
                      <div style='max-width:260px'>
                        <div><b>å«ä¹‰ï¼š</b>ç©ºè½¦/å›ç¨‹/è°ƒè½¦æ—¶çš„é«˜é€Ÿè´¹å…ˆç”±è°å«ä»˜ï¼Œç”¨äºæˆæœ¬æŠ¥é”€å£å¾„ã€‚</div>
                        <ul class='mb-1 ps-3'>
                          <li><b>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</b>ï¼šå¸æœºè‡ªä»˜ï¼›å¯æŒ‰å›ç¨‹è´¹ç­–ç•¥è¦†ç›–/æŠ¥é”€ã€‚</li>
                          <li><b>ä¼šç¤¾</b>ï¼šå…¬å¸æ‰¿æ‹…ã€‚</li>
                        </ul>
                        <div class='text-muted small'>æ­¤é¡¹ä¸è®¡å…¥ã€å®Ÿéš›ETC ä¼šç¤¾â†’é‹è»¢æ‰‹ã€ã€‚</div>
                      </div>
                    ">â“</button>
          </th>
          <!-- ======= END FIXED ======= -->
          <th style="white-space: nowrap;">å¾…å…¥</th>
          <th style="white-space: nowrap;">å¼·èª¿</th>
          <th style="white-space: nowrap;">è²¸åˆ‡</th>
          <th style="white-space: nowrap;">è²¸åˆ‡é‡‘é¡</th>
          <th style="white-space: nowrap;">è²¸åˆ‡æ”¯æ‰•</th>
          <th>æ³¨é‡ˆ</th>
          <th style="white-space: nowrap;">æ“ä½œ</th>
        </tr>
      </thead>

  <tbody>
    {{ formset.management_form }}

    {% for form in formset.forms %}
      <tr class="report-item-row {% if form.instance.is_flagged %}has-note{% endif %}">
        {# âœ… éšè—å•å…ƒæ ¼ï¼šä¿è¯ id / DELETE åœ¨æœ¬è¡Œ DOM å†… #}
        <td class="d-none">
          {{ form.id }}
          {{ form.DELETE|add_class:"delete-flag" }}
        </td>

        <td class="row-number">{{ forloop.counter }}</td>

        <td style="min-width: 70px;">
          {% if form.ride_time.errors %}
            <div class="text-danger small">{{ form.ride_time.errors.0 }}</div>
          {% endif %}
          {{ form.ride_time|add_class:"form-control form-control-sm time-input" }}
        </td>

        <td style="min-width: 70px;">
          {% if form.ride_from.errors %}
            <div class="text-danger small">{{ form.ride_from.errors.0 }}</div>
          {% endif %}
          {{ form.ride_from|add_class:"form-control form-control-sm" }}
        </td>

        <td style="min-width: 70px;">
          <input
            type="number"                                  {# â† æ”¹æˆ number #}
            name="{{ form.meter_fee.html_name }}"
            id="{{ form.meter_fee.id_for_label }}"
            value="{{ form.meter_fee.value|floatformat:"-0" }}"
            class="form-control form-control-sm text-end meter-fee-input fee-input"  {# â† å¤šåŠ  fee-input #}
            inputmode="numeric"                            {# â† æ‰‹æœºä¸Šç”¨æ•°å­—é”®ç›˜ #}
            pattern="[0-9]*"                               {# â† åªè¦ 0-9 #}
            min="0"
          >
        </td>

        <td style="min-width: 100px;">
          {% if form.payment_method.errors %}
            <div class="text-danger small">{{ form.payment_method.errors.0 }}</div>
          {% endif %}
          {{ form.payment_method|add_class:"form-select form-select-sm payment-method-select" }}
        </td>

        <!-- ======= BEGIN PATCH: æ¯è¡Œçš„ ETC 4æ ¼ ======= -->
        <td class="col-etc-riding" style="min-width: 80px;">
          {% if form.etc_riding.errors %}<div class="text-danger small">{{ form.etc_riding.errors.0 }}</div>{% endif %}
          {{ form.etc_riding|add_class:"form-control form-control-sm text-end etc-riding-input"|attr:"inputmode:numeric"|attr:"pattern:[0-9]*"|attr:"min:0"|attr:"step:1" }}
        </td>

        <td class="col-etc-riding-charge" style="min-width: 110px;">
          {% if form.etc_riding_charge_type.errors %}<div class="text-danger small">{{ form.etc_riding_charge_type.errors.0 }}</div>{% endif %}
          {{ form.etc_riding_charge_type|add_class:"form-select form-select-sm etc-riding-charge-select js-ride-etc-charge" }}
        </td>

        <td class="col-etc-empty" style="min-width: 80px;">
          {% if form.etc_empty.errors %}<div class="text-danger small">{{ form.etc_empty.errors.0 }}</div>{% endif %}
          {{ form.etc_empty|add_class:"form-control form-control-sm text-end etc-empty-input"|attr:"inputmode:numeric"|attr:"pattern:[0-9]*"|attr:"min:0"|attr:"step:1" }}
        </td>

        <td class="col-etc-empty-charge" style="min-width: 110px;">
          {% if form.etc_empty_charge_type.errors %}<div class="text-danger small">{{ form.etc_empty_charge_type.errors.0 }}</div>{% endif %}
          {{ form.etc_empty_charge_type|add_class:"form-select form-select-sm etc-empty-charge-select js-empty-etc-charge" }}
        </td>
        <!-- å…¼å®¹å†å²ï¼šæ—§å­—æ®µä¿ç•™ï¼ˆHiddenInputï¼Œä¸æ˜¾ç¤ºä¸å ä½ï¼‰ -->
        {{ form.etc_charge_type }}
        <!-- ======= END PATCH ======= -->


        {# â–¼ å¾…å…¥åˆ— #}
        <td class="text-center">
          {% if form.is_pending.errors %}
            <div class="text-danger small">{{ form.is_pending.errors.0 }}</div>
          {% endif %}
          {{ form.is_pending }} {# widget ä¸Šå·²æœ‰ pending-checkbox class #}
        </td>
        {# â–² #}

        <td class="text-center">
          {% if form.is_flagged.errors %}
            <div class="text-danger small">{{ form.is_flagged.errors.0 }}</div>
          {% endif %}
          {{ form.is_flagged }}
        </td>

        <td class="text-center">
          {% if form.is_charter.errors %}
            <div class="text-danger small">{{ form.is_charter.errors.0 }}</div>
          {% endif %}
          {{ form.is_charter }}
        </td>

        <td>
          {{ form.charter_amount_jpy|add_class:"form-control form-control-sm text-end auto-width-input charter-amount-input" }}
        </td>

        <td>
          {{ form.charter_payment_method|add_class:"form-control form-control-sm auto-width-input charter-payment-method-select" }}
        </td>

        <!-- ===== [PATCH C1] å¤‡æ³¨åˆ—åŠ ä¸Š note-cellï¼Œä¾›æ™ºèƒ½æç¤ºæ’å…¥ ===== -->
        <td class="note-cell">
          {% if form.note.value %}ğŸ“{% endif %}
          {% if form.note.errors %}
            <div class="text-danger small">{{ form.note.errors.0 }}</div>
          {% endif %}
          {{ form.note }}

          <div class="alert alert-warning py-1 px-2 small mt-1 pending-mini-hint d-none">
            é€™äº›æ˜ç´°æš«ä¸è¨ˆå…¥å£²ä¸Šåˆè¨ˆã€‚å…¥å¸³å¾Œå–æ¶ˆå‹¾é¸å³å¯ç«‹å³ç´å…¥æ ¸ç®—
          </div>
        </td>
        <!-- ===== [PATCH C1 END] ===== -->

        {# æ¯ä¸€è¡Œçš„æ“ä½œåˆ—é‡Œï¼š#}
        <td style="white-space: nowrap;">
          <div class="d-flex flex-row gap-1">
            {% if form.instance.pk %}
              <!-- ç«‹å³åˆ é™¤ï¼šç”¨ data-delete-url å­˜è·¯ç”± -->
              <button type="button"
                      class="btn btn-sm btn-danger js-delete-item"
                      data-delete-url="{% url 'dailyreport:report_item_delete' form.instance.pk %}">
                åˆ é™¤
              </button>
            {% else %}
              <!-- è¿˜æ²¡ä¿å­˜åˆ°æ•°æ®åº“çš„ä¸´æ—¶è¡Œï¼šå‰ç«¯ç§»é™¤å³å¯ -->
              <button type="button" class="btn btn-sm btn-outline-danger remove-row">ç§»é™¤</button>
            {% endif %}
            <button type="button" class="btn btn-sm btn-outline-primary insert-below">â•ä¸‹ã«æŒ¿å…¥</button>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>

    {# âœ… ç©ºæ¨¡æ¿ï¼šåŒæ ·æŠŠ id/DELETE æ”¾è¿›éšè— <td>ï¼›å¹¶ä¿æŒåˆ—ç»“æ„ä¸€è‡´ #}
    <tbody id="empty-form-template" class="d-none">
      <tr class="report-item-row">
        <!-- éšè—ï¼šid + DELETE -->
        <td class="d-none">
          <input type="hidden"
                name="form-__prefix__-id"
                id="id_form-__prefix__-id">
          <input type="checkbox"
                name="form-__prefix__-DELETE"
                id="id_form-__prefix__-DELETE"
                class="delete-flag">
        </td>

        <td class="row-number">__num__</td>

        <!-- æ™‚é–“ -->
        <td>
          <input type="text"
                name="form-__prefix__-ride_time"
                id="id_form-__prefix__-ride_time"
                class="form-control form-control-sm time-input">
        </td>

        <!-- ä¹—è»Šåœ° -->
        <td>
          <input type="text"
                name="form-__prefix__-ride_from"
                id="id_form-__prefix__-ride_from"
                class="form-control form-control-sm">
        </td>

        <!-- æ–™é‡‘ -->
        <td>
          <input
            type="number"
            name="form-__prefix__-meter_fee"
            id="id_form-__prefix__-meter_fee"
            class="form-control form-control-sm text-end meter-fee-input fee-input"
            inputmode="numeric"
            pattern="[0-9]*"
            min="0"
            value="0"
          >
        </td>

        <!-- æ”¯ä»˜æ–¹å¼ï¼ˆé€‰é¡¹ç¨åç”¨ JS ä»ç¬¬ä¸€è¡Œå¤åˆ¶ï¼‰ -->
        <td>
          <select
            name="form-__prefix__-payment_method"
            id="id_form-__prefix__-payment_method"
            class="form-select form-select-sm payment-method-select">
          </select>
        </td>

        <!-- ======= ç©ºæ¨¡æ¿çš„ ETC 4æ ¼ï¼ˆé€‰é¡¹ä¹Ÿç”¨ JS å¤åˆ¶ï¼‰ ======= -->
        <td class="col-etc-riding">
          <input type="number"
                name="form-__prefix__-etc_riding"
                id="id_form-__prefix__-etc_riding"
                class="form-control form-control-sm text-end etc-riding-input"
                inputmode="numeric"
                pattern="[0-9]*"
                min="0"
                step="1"
                value="0">
        </td>

        <td class="col-etc-riding-charge">
          <select
            name="form-__prefix__-etc_riding_charge_type"
            id="id_form-__prefix__-etc_riding_charge_type"
            class="form-select form-select-sm etc-riding-charge-select js-ride-etc-charge">
          </select>
        </td>

        <td class="col-etc-empty">
          <input type="number"
                name="form-__prefix__-etc_empty"
                id="id_form-__prefix__-etc_empty"
                class="form-control form-control-sm text-end etc-empty-input"
                inputmode="numeric"
                pattern="[0-9]*"
                min="0"
                step="1"
                value="0">
        </td>

        <td class="col-etc-empty-charge">
          <select
            name="form-__prefix__-etc_empty_charge_type"
            id="id_form-__prefix__-etc_empty_charge_type"
            class="form-select form-select-sm etc-empty-charge-select js-empty-etc-charge">
          </select>
        </td>
        <!-- ======= END: ETC 4æ ¼ ======= -->

        <!-- å¾…å…¥ -->
        <td class="text-center">
          <input type="checkbox"
                name="form-__prefix__-is_pending"
                id="id_form-__prefix__-is_pending"
                class="pending-checkbox">
        </td>

        <!-- å¼·èª¿ -->
        <td class="text-center">
          <input type="checkbox"
                name="form-__prefix__-is_flagged"
                id="id_form-__prefix__-is_flagged">
        </td>

        <!-- è²¸åˆ‡ -->
        <td class="text-center">
          <input type="checkbox"
                name="form-__prefix__-is_charter"
                id="id_form-__prefix__-is_charter">
        </td>

        <!-- è²¸åˆ‡é‡‘é¡ -->
        <td>
          <input type="number"
                name="form-__prefix__-charter_amount_jpy"
                id="id_form-__prefix__-charter_amount_jpy"
                class="form-control form-control-sm text-end auto-width-input charter-amount-input"
                inputmode="numeric"
                pattern="[0-9]*"
                min="0"
                value="0">
        </td>

        <!-- è²¸åˆ‡æ”¯æ‰•ï¼ˆé€‰é¡¹ç”¨ JS å¤åˆ¶ï¼‰ -->
        <td>
          <select
            name="form-__prefix__-charter_payment_method"
            id="id_form-__prefix__-charter_payment_method"
            class="form-control form-control-sm auto-width-input charter-payment-method-select">
          </select>
        </td>

        <!-- æ³¨é‡ˆ -->
        <td class="note-cell">
          <input type="text"
                name="form-__prefix__-note"
                id="id_form-__prefix__-note"
                class="form-control">
          <div class="alert alert-warning py-1 px-2 small mt-1 pending-mini-hint d-none">
            é€™äº›æ˜ç´°æš«ä¸è¨ˆå…¥å£²ä¸Šåˆè¨ˆã€‚å…¥å¸³å¾Œå–æ¶ˆå‹¾é¸å³å¯ç«‹å³ç´å…¥æ ¸ç®—
          </div>
        </td>

        <!-- æ“ä½œ -->
        <td style="white-space:nowrap;">
          <button type="button" class="btn btn-sm btn-outline-danger remove-row">ç§»é™¤</button>
          <button type="button" class="btn btn-sm btn-outline-primary insert-below">â•å‘ä¸‹æŒ¿å…¥</button>
        </td>
      </tr>
    </tbody>
  </table>



    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
  </form>

  <div class="text-center mt-2 d-flex justify-content-center gap-2">
    <div class="input-group" style="max-width: 260px;">
      <span class="input-group-text">è¡Œã«æŒ¿å…¥</span>
      <input type="number" min="1" class="form-control" id="insert-index-input" placeholder="ä¾‹: 10">
      <button type="button" class="btn btn-outline-secondary" id="insert-at-btn">æŒ‡å®šè¡Œã«æŒ¿å…¥</button>
    </div>
  </div>
  
</div>

{% endblock %}

{% block extra_js %}
  <!-- è´¹ç‡æ³¨å…¥ï¼šç»™ dailyreport.js è®¡ç®—åˆ†æˆç”¨ -->
  <script>
    window.PAYMENT_RATES = {{ payment_rates|safe }};
  </script>

  <!-- åªä¿ç•™è¿™ä¸€å¤„å¤–é“¾è„šæœ¬ã€‚åŠ ä¸ªç‰ˆæœ¬å·é˜²ç¼“å­˜ -->
{% now 'U' as cache_bust %}
  <script src="{% static 'dailyreport/js/dailyreport.js' %}?v={{ cache_bust }}"></script>

  <!-- å¯ç•™çš„é«˜äº®æ ·å¼ï¼ˆCSS ä¸ä¼šå†²çªï¼‰ -->
  <style>
    table.table tr.has-note td,
    table.table tr.has-note {
      background-color: #fff8b3 !important;
    }

    /* === å¼ºåˆ¶æ˜¾ç¤ºæ•°æ®åŒºè¡Œï¼›ä»…éšè—æ¨¡æ¿åŒº === */
    table.report-table tbody:not(#empty-form-template) tr {
      display: table-row !important; visibility: visible !important; opacity: 1 !important;
    }

    /* ======= BEGIN PATCH: åˆ—æ˜¾éšå’Œå®½åº¦ ======= */
    table.report-table.etc-cols-hidden th.col-etc-riding,
    table.report-table.etc-cols-hidden td.col-etc-riding,
    table.report-table.etc-cols-hidden th.col-etc-riding-charge,
    table.report-table.etc-cols-hidden td.col-etc-riding-charge,
    table.report-table.etc-cols-hidden th.col-etc-empty,
    table.report-table.etc-cols-hidden td.col-etc-empty,
    table.report-table.etc-cols-hidden th.col-etc-empty-charge,
    table.report-table.etc-cols-hidden td.col-etc-empty-charge {
      display: none !important;
    }

    .etc-riding-input, .etc-empty-input { max-width: 90px; }
    .etc-riding-charge-select, .etc-empty-charge-select { max-width: 140px; }
    /* ======= END PATCH ======= */


    #empty-form-template tr { display: none !important; visibility: hidden !important; }
  </style>

  <script>
    (function(){
      var out = document.getElementById("id_clock_out");
      var chk = document.getElementById("id_unreturned_flag") || document.querySelector('input[name="unreturned_flag"]');
      var txt = document.getElementById("return-status-text");

      function sync() {
        var hasVal = out && out.value.trim() !== "";
        if (hasVal) {
          // æœ‰é€€å‹¤ => è§†ä¸ºâ€œå·²å®Œæˆâ€ï¼Œè‡ªåŠ¨å–æ¶ˆå‹¾é€‰
          if (chk) chk.checked = false;
          if (txt) txt.textContent = "å·²å®Œæˆ";
        } else {
          // æ²¡é€€å‹¤ => å¯å‹¾é€‰â€œæœªå®Œæˆå…¥åº“æ‰‹ç»­â€
          if (txt) txt.textContent = "æœªå®Œæˆå…¥åº“æ‰‹ç»­";
        }
      }

      if (out) {
        out.addEventListener("input", sync);
        // åˆå§‹ä¹ŸåŒæ­¥ä¸€æ¬¡
        window.addEventListener("load", sync);
      }
    })();
  </script>

  <script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.js-delete-item');
    if (!btn) return;

    // ç¡®è®¤
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤è¡Œï¼Ÿ')) return;

    // åˆ é™¤æ¥å£åœ°å€
    const url = btn.dataset.deleteUrl;
    if (!url) return;

    // å–é¡µé¢é‡Œå·²æœ‰çš„å¤§è¡¨å•é‡Œçš„ CSRF
    const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const token = tokenInput ? tokenInput.value : '';

    // åŠ¨æ€åˆ›å»ºä¸€ä¸ªç‹¬ç«‹è¡¨å•å¹¶æäº¤
    const f = document.createElement('form');
    f.method = 'POST';
    f.action = url;

    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.value = token;
    f.appendChild(csrf);

    document.body.appendChild(f);
    f.submit();
  });
  </script>

  <!-- æ”¾åœ¨ dailyreport.js ä¹‹åã€Popover åˆå§‹åŒ–ä¹‹å‰ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- âœ… åˆå§‹åŒ– Popoverï¼šè®©è¡¨å¤´ â“ æŒ‰é’®å¯æ˜¾ç¤ºè¯´æ˜ -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // å¦‚æœ bootstrap æœªåŠ è½½ï¼Œç›´æ¥é€€å‡ºï¼ˆé˜²æ­¢æŠ¥é”™ï¼‰
      if (typeof window.bootstrap === 'undefined' || !bootstrap.Popover) return;
      // Bootstrap 5 Popover åˆå§‹åŒ–ï¼šhover + focus éƒ½èƒ½è§¦å‘ï¼Œç‚¹å‡»å¤–éƒ¨å…³é—­
      document.querySelectorAll('.help-popover').forEach(function (el) {
        new bootstrap.Popover(el, {
          trigger: 'hover focus',
          placement: 'top',
          html: true,
          container: 'body'
        });
      });
    });
  </script>

  <style>
    /* åŒä¸€æ—¶é—´çš„â€œå­è¡Œâ€ç¼©è¿› + é¢œè‰²å¾®å¼±åŒ– */
    .same-time-child td { padding-left: 1.25rem; color:#6c757d; }
    .same-time-prefix { display:inline-block; width:1.25rem; margin-right:.25rem; color:#6c757d; }
  </style>

<script>
  // ===== Toggle ETC ä¸‰åˆ—æ˜¾éšï¼ˆæŒä¹…åŒ–åˆ° localStorageï¼‰ =====
  (function(){
    const key = 'dr_toggle_etc_cols_visible';
    function getTable(){ return document.querySelector('table.report-table'); }
    function getSwitch(){ return document.getElementById('toggle-etc-cols'); }
    function applyState(show){
      const tb = getTable(); if (!tb) return;
      tb.classList.toggle('etc-cols-hidden', !show);
    }
    document.addEventListener('DOMContentLoaded', () => {
      const sw = getSwitch(); const tb = getTable();
      if (!sw || !tb) return;

      // åˆå§‹ï¼šé»˜è®¤éšè—ï¼›å¦‚æœ‰å†å²è®°å½•åˆ™æŒ‰å†å²
      const saved = localStorage.getItem(key);
      const show = saved === null ? false : (saved === '1');
      sw.checked = show;
      applyState(show);

      // ç»‘å®šåˆ‡æ¢
      sw.addEventListener('change', () => {
        const on = !!sw.checked;
        applyState(on);
        localStorage.setItem(key, on ? '1' : '0');
      });
    });
  })();
</script>

<script>
/* æŠ˜å æ§åˆ¶ï¼ˆè®°ä½å±•å¼€/æ”¶èµ·çŠ¶æ€ï¼‰ */
(function setupCollapsers(){
  const LS_KEY_PREFIX = 'dr_collapse:';
  const getKey = el => LS_KEY_PREFIX + (el?.dataset?.collapseKey || '');

  function saveOpenState(el, isOpen){
    try{ localStorage.setItem(getKey(el), isOpen?'1':'0'); }catch(e){}
  }
  function readOpenState(el){
    try{
      const v = localStorage.getItem(getKey(el));
      return v === null ? true : (v === '1');  // é»˜è®¤å±•å¼€
    }catch(e){ return true; }
  }

  [['ride-etc-card','#ride-etc-body']].forEach(([outerId, bodySel])=>{
    const outer = document.getElementById(outerId); if (!outer) return;
    const body  = outer.querySelector(bodySel);    if (!body)  return;

    // åˆå§‹ï¼šæŒ‰è®°å¿†å±•å¼€/æ”¶èµ·
    body.style.display = readOpenState(outer) ? '' : 'none';

    // æŒ‰é’®åˆ‡æ¢
    outer.querySelectorAll('.js-collapse-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const isOpen = body.style.display !== 'none';
        body.style.display = isOpen ? 'none' : '';
        saveOpenState(outer, !isOpen);
      });
    });
  });

  // å¯¹å¤–æš´éœ²ä¸€ä¸ªâ€œå¼ºåˆ¶å±•å¼€â€çš„æ–¹æ³•ï¼ˆå…¶ä»–é€»è¾‘éœ€è¦æ—¶å¯è°ƒç”¨ï¼‰
  window.__openCollapseCard = function(outerId, bodySel){
    const outer = document.getElementById(outerId);
    const body  = outer?.querySelector(bodySel);
    if (body){ body.style.display=''; saveOpenState(outer, true); }
  };
})();
</script>

<script>
  // æ–™é‡‘æ åªå…è®¸æ•°å­—
  document.addEventListener('input', function (e) {
    // ä¸“é—¨ç›¯ã€Œæ–™é‡‘ã€è¿™ä¸€åˆ—ï¼šfee-input
    if (e.target.classList && e.target.classList.contains('fee-input')) {
      // åˆ é™¤æ‰€æœ‰éæ•°å­—
      e.target.value = e.target.value.replace(/\D/g, '');
    }
  });
</script>


{% endblock %}
