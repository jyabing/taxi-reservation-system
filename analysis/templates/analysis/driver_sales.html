{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>司机売上分析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi { display:flex; gap:1rem; margin: 10px 0; }
    .kpi .card { padding:12px 16px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    #salesBar { min-height: 320px; }
  </style>
</head>
<body class="container py-3">
  <h3 class="mb-3">司机売上分析</h3>
  {% include "analysis/_analysis_nav.html"
   with active_tab="driver"
        date_from=date_from
        date_to=date_to
        back_url=request.GET.next|default:request.get_full_path %}

  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-auto">
      <label class="form-label">开始日</label>
      <input type="date" name="from" value="{{ date_from }}" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <label class="form-label">结束日</label>
      <input type="date" name="to" value="{{ date_to }}" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary btn-sm" type="submit">应用</button>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'analysis:driver_sales_export_csv' %}?from={{date_from}}&to={{date_to}}">导出CSV</a>
      <a class="btn btn-link btn-sm" href="{% url 'analysis:vehicle_idle' %}?from={{date_from}}&to={{date_to}}">车辆闲置</a>
      <a class="btn btn-link btn-sm" href="{% url 'analysis:efficiency' %}?from={{date_from}}&to={{date_to}}">高效利用率</a>
    </div>
  </form>

  <div class="card mb-3 p-3">
    <canvas id="salesBar"></canvas>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>司机</th>
          <th class="text-end">出勤天</th>
          <th class="text-end">工时(h)</th>
          <th class="text-end">计程売上</th>
          <th class="text-end">包车売上</th>
          <th class="text-end">总売上</th>
          <th class="text-end">日均売上</th>
          <th class="text-end">円/小时</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.label }}</td>
          <td class="text-end">{{ r.work_days }}</td>
          <td class="text-end">{{ r.work_hours }}</td>
          <td class="text-end">{{ r.meter_sales|floatformat:0 }}</td>
          <td class="text-end">{{ r.charter_sales|floatformat:0 }}</td>
          <td class="text-end"><strong>{{ r.total_sales|floatformat:0 }}</strong></td>
          <td class="text-end">{{ r.avg_sales_per_day|floatformat:0 }}</td>
          <td class="text-end">{{ r.sales_per_hour|floatformat:0 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center text-muted">暂无数据</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    (function() {
      const labels = [{% for r in rows %}"{{ r.label }}",{% endfor %}];
      const totals = [{% for r in rows %}{{ r.total_sales|floatformat:0 }},{% endfor %}];
      const perHour = [{% for r in rows %}{{ r.sales_per_hour|floatformat:0 }},{% endfor %}];

      const ctx = document.getElementById('salesBar').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: '总売上(円)', data: totals, borderWidth: 1 },
            { label: '円/小时', data: perHour, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    })();
  </script>
</body>
</html>
