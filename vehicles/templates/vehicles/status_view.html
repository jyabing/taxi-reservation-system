{% extends 'base.html' %}
{% load static %}
{% block content %}

<h2 class="mb-4">ğŸš— è½¦è¾†é¢„çº¦çŠ¶å†µï¼ˆ{{ selected_date }}ï¼‰</h2>

{% include 'partials/_messages.html' %}

<form method="get" class="mb-4 d-flex align-items-center gap-2">
  <label for="date">ğŸ“… é€‰æ‹©æ—¥æœŸï¼š</label>
  <input type="date" name="date" id="date" class="form-control" style="max-width: 200px;" value="{{ selected_date }}">
  <button type="submit" class="btn btn-primary">æŸ¥è¯¢</button>
</form>

<table class="table table-bordered table-hover align-middle shadow-sm">
  <thead class="table-light text-center">
    <tr>
      <th style="width: 120px;">ğŸ”¢ è½¦ç‰Œå·</th>
      <th style="width: 140px;">ğŸš˜ è½¦å‹</th>
      <th style="min-width: 220px;">ğŸ“Œ çŠ¶æ€ / æ“ä½œ</th>
      <th style="min-width: 180px;">ğŸ‘¤ é¢„çº¦è€…</th>
      <th style="min-width: 240px;">ğŸ“ å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    {% for vehicle, info in status_map.items %}
    <tr>
      <td>
        <a href="{% url 'vehicles:vehicle_detail' vehicle.id %}">{{ vehicle.license_plate }}</a>
        <button class="btn btn-sm btn-outline-info ms-2" onclick="openCarModal({{ vehicle.id }})">æœ€è¿‘é¢„çº¦</button>
      </td>
      <td>{{ vehicle.model }}</td>
      
      <td class="text-start">
        <!-- âœ… è½¦è¾†çŠ¶æ€å¾½ç«  -->
        {% if info.is_repair %}
          <span class="badge bg-warning text-dark mb-1">ğŸ›  ç»´ä¿®ä¸­</span><br>
        {% elif info.is_admin_only %}
          <span class="badge bg-info text-dark mb-1">âš™ï¸ èª¿é…ç”¨è»Š</span><br>
        {% elif info.reservable %}
          <span class="badge bg-success mb-1">âœ… ä½¿ç”¨å¯</span><br>
        {% endif %}


        {% include 'partials/_reservation_status.html' with vehicle=vehicle info=info selected_date=selected_date today=today %}
        {% include 'partials/_my_reservation_controls.html' with user_reservation=info.user_reservation %}



        {% if info.user_reservation %}
            {% include 'partials/_user_reservation_notice.html' with user_reservation=info.user_reservation %}

            {% if info.user_reservation.status == 'reserved' and not info.user_reservation.actual_departure %}
              <button type="button" class="btn btn-success btn-sm mt-2"
                      onclick="openTimePopup({{ info.user_reservation.id }}, 'departure')">ğŸš— å‡ºåº«</button>
            {% elif info.user_reservation.status == 'reserved' and info.user_reservation.actual_departure and not info.user_reservation.actual_return %}
              <button type="button" class="btn btn-warning btn-sm mt-2"
                      onclick="openTimePopup({{ info.user_reservation.id }}, 'return')">ğŸ…¿ï¸ å…¥åº«</button>
            {% endif %}
        {% endif %}
      </td>

      <td style="white-space: pre-wrap;">
        {% if info.reserver_name %}
          {{ info.reserver_name|safe }}
        {% else %}
          <span class="text-muted">â€”</span>
        {% endif %}
      </td>
      <td style="white-space: pre-wrap; word-break: break-word;">{% include 'partials/_inspection_reminder.html' with car=vehicle %}{{ vehicle.notes|default:"â€”" }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- âœ… å…±ç”¨æ¨¡æ€æ¡†åŒºåŸŸï¼šè½¦è¾†è¯¦æƒ… Ajax å¼¹çª— -->
<div class="modal fade" id="carModal" tabindex="-1" aria-labelledby="carModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" id="carModalContent">
      <!-- Ajax åŠ è½½å†…å®¹å°†æ’å…¥æ­¤å¤„ -->
    </div>
  </div>
</div>

<script>
  function openCarModal(carId) {
    fetch(`/carinfo/modal/${carId}/`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('carModalContent').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('carModal'));
        modal.show();
      })
      .catch(error => {
        console.error('è½¦è¾†è¯¦æƒ…åŠ è½½å¤±è´¥:', error);
        alert("è½¦è¾†è¯¦æƒ…åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
      });
  }
</script>

{% include 'partials/_check_io_popup.html' %}
<script src="{% static 'vehicles/js/check_io.js' %}"></script>
{% endblock %}
