{% extends "base.html" %}
{% load static %}
{% block content %}

{% include "partials/_messages.html" %}

<div class="container mt-2 compact" id="page-root">

  <div class="d-flex justify-content-between align-items-center mb-2 sticky-filters">
    <div class="small text-muted">
      è§„åˆ™ v1.0ï¼šå…¥ç¤¾æ—©â†’äº‹æ•…ç‡ä½â†’å‡ºå‹¤ç‡é«˜â†’ä¸Šæœˆå£²ä¸Šé«˜â†’æ¯çº¦ç‡ä½â†’driver_idæ˜‡é †
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="form-check form-switch m-0 small">
        <input class="form-check-input" type="checkbox" id="toggle-compact" checked>
        <span class="form-check-label">ç´§å‡‘</span>
      </label>
    </div>
  </div>

  {# é¡¶éƒ¨ç­›é€‰ï¼ˆæ²¿ç”¨ä½ åŸæ¥çš„è¡¨å•/é“¾æ¥ï¼Œç¤ºä¾‹ä»…å ä½ï¼‰ #}
  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-6 col-md-3">
      <label class="form-label small mb-1">æœŸé–“</label>
      <select class="form-select form-select-sm" name="work_date">
        <option value="">ä»Šé€±</option>
        {% for d in date_choices %}
          <option value="{{ d|date:'Y-m-d' }}"
                  {% if selected_work_date and selected_work_date == d %}selected{% endif %}>
            {{ d|date:"Y-m-d (D)" }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small mb-1">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</label>
      <select class="form-select form-select-sm" name="driver">
        <option value="">ã™ã¹ã¦</option>
        {% for d in all_drivers %}
        <option value="{{ d.id }}" {% if selected_driver == d.id %}selected{% endif %}>
          {{ d.driver_code }} {{ d.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-auto">
      <label class="form-label small mb-1 d-none d-md-block">&nbsp;</label>
      <button class="btn btn-primary btn-sm w-100">ã“ã®æ¡ä»¶ã§è¡¨ç¤º</button>
    </div>
  </form>

  

  {# ===== ç›®æ ‡ç¤ºä¾‹ï¼šæœ¬æ—¥ã®é…è»Š / æ•´å‚™ä¸­ / ç©ºãè»Šä¸¡ï¼ˆç³»ç»Ÿè¾“å‡ºï¼‰ ===== #}
  {% if selected_work_date %}
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2">
        <div>ğŸ—“ {{ selected_work_date|date:"Y-m-d (D)" }} ã®ã‚·ã‚¹ãƒ†ãƒ é…è»Šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>

        <form method="post" class="ms-auto d-flex gap-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="auto_assign">
          <input type="hidden" name="auto_work_date" value="{{ selected_work_date|date:'Y-m-d' }}">
          <button class="btn btn-outline-secondary btn-sm" formaction="?dryrun=1">äºˆæ¼”ã ã‘</button>
          <button class="btn btn-primary btn-sm">ã“ã®å†…å®¹ã§ç¢ºå®š</button>
        </form>
      </div>

      <div class="list-group list-group-flush">
        {% for sec in dispatch_sections %}
          <div class="list-group-item">
            <div class="fw-bold mb-2">{{ sec.title }}</div>

            {% if sec.rows %}
              <div class="row g-2 small">
                {% for r in sec.rows %}
                  <div class="col-12 col-md-6">
                    {% if r.car %}
                      <span class="badge bg-light text-dark">
                        {{ r.car.label|default:r.car }}
                      </span>
                    {% else %}
                      <span class="badge bg-outline text-muted border">è»Šä¸¡ãªã—</span>
                    {% endif %}

                    {% if r.driver %}
                      <span class="ms-2">
                        {{ r.driver.driver_code }} {{ r.driver.name }}
                      </span>
                    {% else %}
                      <span class="ms-2 text-muted">æœªä½¿ç”¨</span>
                    {% endif %}

                    {% if r.is_rest %}<span class="badge bg-secondary ms-1">ä¼‘</span>{% endif %}
                    {% if r.shift == 'day' %}<span class="badge bg-info ms-1">ç™½</span>{% endif %}
                    {% if r.shift == 'night' %}<span class="badge bg-dark ms-1">å¤œ</span>{% endif %}

                    {% if r.admin_note %}
                      <span class="ms-2 text-muted">ï¼ˆ{{ r.admin_note }}ï¼‰</span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted small">è©²å½“ãªã—</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if selected_work_date and auto_schedule_groups %}
  <div class="green-board mt-3">
    <div class="gb-head">
      {{ selected_work_date|date:"Yå¹´næœˆjæ—¥ï¼ˆlï¼‰" }}
    </div>

    {% for sec_title, items in auto_schedule_groups %}
      <div class="gb-section">
        <div class="gb-sec-title">{{ sec_title }}</div>
        <ul class="gb-list">
          {% for it in items %}
            <li class="gb-row">
              <span class="gb-car">ğŸš– {{ it.num }}</span>
              {% if it.state == "assigned" %}
                <span class="gb-name">{{ it.driver }}</span>
                {% if it.shift == "day" %}
                  <span class="gb-badge">ç™½</span>
                {% elif it.shift == "night" %}
                  <span class="gb-badge gb-dark">å¤œ</span>
                {% endif %}
              {% elif it.state == "maint" %}
                <span class="gb-name">ğŸ› ï¸ ç»´ä¿®ä¸­</span>
              {% else %}
                <span class="gb-name text-muted">æœªä½¿ç”¨</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  </div>
  {% endif %}




  {# ===== åˆ†ç»„æ¸²æŸ“ ===== #}
  {% for key, rows in grouped.items %}
    <h6 class="text-muted mt-3 mb-2">
      {% if group == 'driver' %}
        ğŸ‘¤ {{ key }}
      {% else %}
        ğŸ“… {{ key|date:"Y-m-d (D)" }}
      {% endif %}
    </h6>

    <div class="vstack gap-2">
      {% for row in rows %}
      <details class="sched-acc card p-0"
              {% if forloop.first %}open{% endif %}
              data-id="{{ row.id }}"
              data-rest="{% if row.is_rest %}1{% else %}0{% endif %}">
        <summary class="summary-line">
          <div class="d-flex w-100 justify-content-between align-items-center">
            <div class="summary-main">
              <strong class="me-2">
                {% if group == 'driver' %}
                  {{ row.work_date|date:"n/j (D)" }}
                {% else %}
                  {{ row.driver.driver_code }} {{ row.driver.name }}
                {% endif %}
              </strong>

              {% if row.is_rest %}
                <span class="badge bg-secondary">ä¼‘</span>
              {% else %}
                {% if row.shift == 'day' %}<span class="badge bg-info">ç™½</span>{% endif %}
                {% if row.shift == 'night' %}<span class="badge bg-dark">å¤œ</span>{% endif %}
                {% if row.assigned_car %}
                  <span class="badge bg-success ms-1">{{ row.assigned_car.label|default:row.assigned_car }}</span>
                {% else %}
                  <span class="badge bg-outline ms-1 text-muted border">æœªé…è»Š</span>
                {% endif %}
              {% endif %}

              {# å¸Œæœ›ç®€è¿° #}
              {% if not row.is_rest %}
                <span class="small text-muted ms-2">
                  å¸Œæœ›: 
                  {% if row.first_choice_car %}ç¬¬1={{ row.first_choice_car.label|default:row.first_choice_car }}{% endif %}
                  {% if row.second_choice_car %} / ç¬¬2={{ row.second_choice_car.label|default:row.second_choice_car }}{% endif %}
                </span>
              {% endif %}
            </div>

            <div class="summary-side small text-muted">
              {{ row.updated_at|default:row.created_at|date:"m/d H:i" }}
            </div>
          </div>
        </summary>

        <div class="card-body pt-2 pb-3">
          {# ======= è¡Œå†…ç¼–è¾‘è¡¨å•ï¼šæ²¿ç”¨ä½ åŸ POST æ¥å£ ======= #}
          <form method="post" class="row g-2 align-items-center">
            {% csrf_token %}
            <input type="hidden" name="action" value="inline_save">
            <input type="hidden" name="sched_id" value="{{ row.id }}">
            <input type="hidden" name="group" value="{{ group }}">
            <input type="hidden" name="driver" value="{{ selected_driver|default:'' }}">
            <input type="hidden" name="work_date" value="{{ selected_work_date|date:'Y-m-d' }}">

            <div class="col-12 col-md-3">
              <label class="form-label small mb-1">ä¼šç¤¾æ±ºå®šï¼ˆè»Šä¸¡ï¼‰</label>
              <select class="form-select form-select-sm" name="assigned_car"
                    {% if row.is_rest %}disabled data-rest="1" title="ä¼‘ã®ãŸã‚é¸æŠä¸å¯"{% endif %}>
                <option value="">-- æœªæ±ºå®š --</option>
                {% for c in cars %}
                  <option value="{{ c.id }}"
                    {% if row.assigned_car and row.assigned_car.id == c.id %}selected{% endif %}
                    {% if c.is_bad %}disabled data-unavailable="1"{% endif %}
                  >{{ c.label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-6 col-md-2">
              <label class="form-label small mb-1">ä¼šç¤¾æ±ºå®šï¼ˆçŠ¶æ…‹ï¼‰</label>
              <select class="form-select form-select-sm" name="status">
                <option value="pending"  {% if row.status == 'pending' %}selected{% endif %}>æœªå®š</option>
                <option value="approved" {% if row.status == 'approved' %}selected{% endif %}>ç¢ºå®š</option>
                <option value="manual"   {% if row.status == 'manual' %}selected{% endif %}>Manual</option>
                <option value="rejected" {% if row.status == 'rejected' %}selected{% endif %}>æ‹’å¦</option>
              </select>
            </div>

            <div class="col-12 col-md">
              <label class="form-label small mb-1">ç®¡ç†ãƒ¡ãƒ¢</label>
              <input class="form-control form-control-sm" name="admin_note" value="{{ row.admin_note|default:'' }}" placeholder="ç¤¾å†…ç”¨ãƒ¡ãƒ¢">
            </div>

            <div class="col-12 col-md-auto d-grid">
              <label class="form-label small mb-1 d-none d-md-block">&nbsp;</label>
              <button class="btn btn-primary btn-sm">ä¿å­˜</button>
            </div>

            {# åªè¯»ä¿¡æ¯ï¼šå¸æœºå¤‡æ³¨ç­‰ #}
            {% if row.note %}
            <div class="col-12">
              <div class="small text-muted">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å‚™è€ƒï¼š{{ row.note }}</div>
            </div>
            {% endif %}
          </form>
        </div>
      </details>
      {% endfor %}
    </div>
  {% empty %}
    <div class="alert alert-light">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
  {% endfor %}

</div>

<style>
/* ===== ç´§å‡‘æ¨¡å¼ ===== */
.compact .card        { margin-bottom: .5rem; }
.compact .card-body   { padding: .5rem .75rem; }
.compact .form-label  { font-size: .9rem; }
.compact .form-select,
.compact .form-control,
.compact .btn         { padding: .25rem .5rem; font-size: .9rem; height: 2rem; }
.compact .small, .compact small { font-size: .8rem; }

/* æ‘˜è¦è¡Œï¼ˆsummaryï¼‰ */
.sched-acc > summary { list-style: none; cursor: pointer; padding: .5rem .75rem; border-bottom: 1px solid #f0f0f0; }
.sched-acc > summary::-webkit-details-marker { display: none; }
.sched-acc[open] > summary { background: #f8f9fa; }
.summary-main .badge { vertical-align: middle; }
.badge.bg-outline { background: transparent; border: 1px solid #dee2e6; }

/* ç¦ç”¨è½¦ï¼ˆæ•´å‚™ä¸­ï¼‰å¼±åŒ–æ˜¾ç¤º */
select option[disabled][data-unavailable="1"] {
  color: #999; background: #f3f3f3; font-style: italic;
}

/* é¡¶éƒ¨ç­›é€‰å¸é¡¶ */
.sticky-filters { position: sticky; top: 0; background: #fff; z-index: 1020; padding: .25rem 0; }

/* ç§»åŠ¨ç«¯ï¼šsummary è¡Œæ›´ç´§å‡‘ */
@media (max-width: 767.98px) {
  .summary-line { padding-right: .25rem; }
}
</style>

<script>
/** åªå±•å¼€ä¸€ä¸ªï¼šæ‰“å¼€æ–°çš„è‡ªåŠ¨æ”¶èµ·å…¶ä»– */
document.addEventListener('click', function (e) {
  const d = e.target.closest('details.sched-acc');
  if (!d) return;
  document.querySelectorAll('details.sched-acc[open]').forEach(x => { if (x !== d) x.removeAttribute('open'); });
}, true);

/** ç´§å‡‘å¼€å…³ */
document.getElementById('toggle-compact')?.addEventListener('change', function(){
  const root = document.getElementById('page-root');
  if (!root) return;
  if (this.checked) root.classList.add('compact');
  else root.classList.remove('compact');
});
</script>

<style>
/* Green board */
.green-board {
  background: #25b35a;      /* ç»¿è‰²åº• */
  color: #111;
  border-radius: 10px;
  padding: 12px 14px;
}
.green-board .gb-head {
  font-weight: 700;
  font-size: 1.1rem;
  color: #fff;
  margin-bottom: .5rem;
}
.gb-section { margin-top: .5rem; }
.gb-sec-title {
  color: #f9fff9;
  font-weight: 700;
  margin: .25rem 0 .25rem;
}
.gb-list { list-style: none; margin: 0; padding: 0; }
.gb-row { display: flex; align-items: center; gap: .75rem; padding: 2px 0; }
.gb-car  { min-width: 72px; font-variant-numeric: tabular-nums; }
.gb-name { flex: 1; }
.gb-badge {
  display: inline-block;
  padding: 0 .4rem;
  border-radius: .35rem;
  background: rgba(255,255,255,.85);
  font-weight: 700;
  line-height: 1.2;
}
.gb-badge.gb-dark { background: rgba(20,20,20,.85); color: #fff; }
</style>

<script>
/** å…œåº•ï¼šæŠŠ data-rest="1" çš„è¡Œè½¦è¾†ä¸‹æ‹‰å§‹ç»ˆç¦ç”¨ */
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('details.sched-acc[data-rest="1"]').forEach(function (box) {
    const sel = box.querySelector('select[name="assigned_car"]');
    if (sel) {
      sel.disabled = true;
      sel.setAttribute('title', 'ä¼‘ã®ãŸã‚é¸æŠä¸å¯');
    }
  });
});
</script>

{% endblock %}
