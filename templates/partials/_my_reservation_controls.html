{# ✅ 部分模板：显示我的预约按钮与状态 #}

{% if user_reservation %}
  <div style="margin-top:5px;">
    <span style="color:blue;">🧍 我的预约</span><br>
    🕒 {{ user_reservation.start_time|time:"H:i" }} ~ {{ user_reservation.end_time|time:"H:i" }}

    {% if user_reservation.status == 'canceled' %}
      <br><span style="color:gray;">⚠️ 你的预约已因超时未出库被系统自动取消，请重新预约</span>

    {% elif not user_reservation.actual_departure %}
      <button onclick="confirmDeparture('{{ user_reservation.id }}')">🚗 出库</button>

    {% elif not user_reservation.actual_return %}
      <button onclick="confirmReturn('{{ user_reservation.id }}')">🅿️ 入库</button>

      {# ✅ 管理员：可撤销出库 #}
      {% if request.user.is_staff %}
        <br><a href="{% url 'admin_reset_departure' user_reservation.id %}">🔁 撤销出库</a>
      {% endif %}

    {% else %}
      <br>✅ 已完成出入库

      {# ✅ 管理员：可撤销入库 #}
      {% if request.user.is_staff %}
        <br><a href="{% url 'admin_reset_return' user_reservation.id %}">🔁 撤销入库</a>
      {% endif %}
    {% endif %}
  </div>
{% endif %}

<script>
function confirmDeparture(reservationId) {
  const confirmed = confirm("🚗 确定现在就登记“出库”吗？请确认你已准备好发车。");
  if (confirmed) {
    openTimePopup(reservationId, 'departure');
  }
}

function confirmReturn(reservationId) {
  const confirmed = confirm("🅿️ 确定现在就登记“入库”吗？请确认你已完成归还车辆。");
  if (confirmed) {
    openTimePopup(reservationId, 'return');
  }
}
</script>
