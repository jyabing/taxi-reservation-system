{% extends "staffbook/base_staffbook.html" %}
{% load driver_extras %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow" style="max-width: 950px; margin:0 auto;">
    <div class="card-header bg-white d-flex align-items-center">
      <i class="fa fa-user me-2"></i>
      <b>基本情報編集</b>
      <span class="badge bg-primary ms-2">No.{{ driver.driver_code }}</span>
      <span class="ms-auto small text-muted">
        事業者名: {{ driver.company }}　営業所名: {{ driver.workplace }}／国籍は必須
      </span>
    </div>

    {% include "staffbook/driver_tab_nav.html" with main_tab="basic" tab="basic" driver=driver %}

    <div class="card-body pt-4">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {# ---- 错误提示块：把具体错误列出来 ---- #}
        {% if form.errors or form.non_field_errors %}
          <div class="alert alert-danger mb-3">
            {{ form.non_field_errors }}
            <ul class="mb-0">
              {% for f in form %}
                {% for e in f.errors %}
                  <li><b>{{ f.label }}：</b>{{ e }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="row">
          <!-- 左侧布局 -->
          <div class="col-md-8">
            <div class="row g-2">

              <!-- 従業員番号隐藏字段 -->
              <input type="hidden" name="driver_code" value="{{ driver.driver_code }}">

              <div class="col-md-6">
                <label class="form-label">氏名 <span class="badge bg-danger">必須</span></label>
                {{ form.name }}
                {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">フリガナ <span class="badge bg-danger">必須</span></label>
                {{ form.kana }}
                {% if form.kana.errors %}<div class="text-danger small">{{ form.kana.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">別名</label>
                {{ form.alt_name }}
                {% if form.alt_name.errors %}<div class="text-danger small">{{ form.alt_name.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">別名フリガナ</label>
                {{ form.alt_kana }}
                {% if form.alt_kana.errors %}<div class="text-danger small">{{ form.alt_kana.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">事業者名 <span class="badge bg-danger">必須</span></label>
                {{ form.company }}
                {% if form.company.errors %}<div class="text-danger small">{{ form.company.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">営業所 <span class="badge bg-danger">必須</span></label>
                {{ form.workplace }}
                {% if form.workplace.errors %}<div class="text-danger small">{{ form.workplace.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">国籍 <span class="badge bg-danger">必須</span></label>
                {{ form.nationality }}
                {% if form.nationality.errors %}<div class="text-danger small">{{ form.nationality.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">部門</label>
                {{ form.department }}
                {% if form.department.errors %}<div class="text-danger small">{{ form.department.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">職種 <span class="badge bg-danger">必須</span></label>
                {{ form.position }}
                {% if form.position.errors %}<div class="text-danger small">{{ form.position.errors }}</div>{% endif %}
              </div>
              {# ▼▼ 在職類型 + 退職日（并排） ▼▼ #}
              <div class="col-md-6">
                <label class="form-label">在職類型 <span class="badge bg-danger">必須</span></label>
                {{ form.employ_type }}
                {% if form.employ_type.errors %}<div class="text-danger small">{{ form.employ_type.errors }}</div>{% endif %}
              </div>

              <div class="col-md-6 resigned-date-group d-none">
                <label class="form-label">退職日 <span class="badge bg-danger">必須</span></label>
                {{ form.resigned_date }}
                {% if form.resigned_date.errors %}<div class="text-danger small">{{ form.resigned_date.errors }}</div>{% endif %}
              </div>
              {# ▲▲ 在職類型 + 退職日（并排） ▲▲ #}
              <div class="col-md-6">
                <label class="form-label">性別 <span class="badge bg-danger">必須</span></label>
                {{ form.gender }}
                {% if form.gender.errors %}<div class="text-danger small">{{ form.gender.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">血液型</label>
                {{ form.blood_type }}
                {% if form.blood_type.errors %}<div class="text-danger small">{{ form.blood_type.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">生年月日</label>
                {{ form.birth_date }}
                {% if form.birth_date.errors %}<div class="text-danger small">{{ form.birth_date.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">年齢</label>
                <div class="form-control-plaintext">{% if form.birth_date.value %}{{ form.birth_date.value|age }}歳{% endif %}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">入社年月日</label>
                {{ form.hire_date }}
                {% if form.hire_date.errors %}<div class="text-danger small">{{ form.hire_date.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">選任年月日</label>
                {{ form.appointment_date }}
                {% if form.appointment_date.errors %}<div class="text-danger small">{{ form.appointment_date.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">作成年月日</label>
                {{ form.create_date }}
                {% if form.create_date.errors %}<div class="text-danger small">{{ form.create_date.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">郵便番号</label>
                {{ form.postal_code }}
                {% if form.postal_code.errors %}<div class="text-danger small">{{ form.postal_code.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">住所</label>
                {{ form.address }}
                {% if form.address.errors %}<div class="text-danger small">{{ form.address.errors }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">電話番号</label>
                {{ form.phone_number }}
                {% if form.phone_number.errors %}<div class="text-danger small">{{ form.phone_number.errors }}</div>{% endif %}
              </div>
            </div>
          </div>

          <!-- 右侧：照片和备注 -->
          <div class="col-md-4">
            <div class="mb-3 text-center">
              <label class="form-label">写真</label><br>
              {% if driver.photo %}
                <img src="{{ driver.photo.url }}" alt="写真" class="rounded-circle mb-2" style="width:110px;height:110px;object-fit:cover;">
              {% else %}
                <img src="/static/default_avatar.png" alt="写真" class="rounded-circle mb-2" style="width:110px;height:110px;object-fit:cover;">
              {% endif %}
              {{ form.photo }}
              {% if form.photo.errors %}<div class="text-danger small">{{ form.photo.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label">写真撮影日</label>
              {{ form.photo_date }}
              {% if form.photo_date.errors %}<div class="text-danger small">{{ form.photo_date.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label">特記事項</label>
              {{ form.remark }}
              {% if form.remark.errors %}<div class="text-danger small">{{ form.remark.errors }}</div>{% endif %}
            </div>
          </div>
        </div>

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success">保存</button>
          <a class="btn btn-secondary ms-2" href="{% url 'staffbook:driver_basic_info' driver.id %}">取消</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  function isRetired(val, text) {
    val = String(val || '');
    text = String(text || '');
    return val === '3' || text.indexOf('退職') !== -1;  // employ_type=3 是退職者
  }
  function toggleResignedDate() {
    const sel = document.querySelector('select[name="employ_type"]');
    const grp = document.querySelector('.resigned-date-group');
    const input = document.querySelector('#id_resigned_date');
    if (!sel || !grp) return;
    const txt = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';
    if (isRetired(sel.value, txt)) {
      grp.classList.remove('d-none');
      if (input) input.required = true;
    } else {
      grp.classList.add('d-none');
      if (input) input.required = false;
      // 不清空 input.value，避免误判时把已选日期抹掉
    }
  }
  document.addEventListener('change', function(e){
    if (e.target && e.target.matches('select[name="employ_type"]')) toggleResignedDate();
  });
  document.addEventListener('DOMContentLoaded', toggleResignedDate);
})();
</script>

<script>
/**
 * 郵便番号 → 住所 自動補完（zipcloud）
 * - 触发时机：邮编输入框 blur / Enter / 点击查找按钮（可选）
 * - 允许输入全角数字与连字符，内部会自动规范化为半角7位数字
 * - 若返回多结果，取第一条；无结果则不改动现有地址
 */
document.addEventListener("DOMContentLoaded", function () {
  const postalInput  = document.getElementById("id_postal_code");
  const addressInput = document.getElementById("id_address");

  if (!postalInput || !addressInput) return;

  // 将输入规范化为半角且仅数字
  function normalizeZip(v) {
    if (!v) return "";
    // 全角转半角
    v = v.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    // 去除非数字
    v = v.replace(/\D/g, "");
    return v;
  }

  // 在输入框中显示为 123-4567 的格式（仅展示，不影响查询）
  function prettyZip(v7) {
    if (v7.length !== 7) return v7;
    return v7.slice(0,3) + "-" + v7.slice(3);
  }

  async function fetchAddressByZip(zip7) {
    try {
      const url = `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zip7}`;
      const resp = await fetch(url, { cache: "no-store" });
      const data = await resp.json();
      if (data && data.status === 200 && Array.isArray(data.results) && data.results[0]) {
        const r = data.results[0];
        // 拼接：都道府県 + 市区町村 + 町域
        return (r.address1 || "") + (r.address2 || "") + (r.address3 || "");
      }
    } catch (e) {
      console.warn("郵便番号APIエラー:", e);
    }
    return ""; // 无结果
  }

  async function handleZipBlur() {
    // 1) 规范化并显示为 123-4567
    let raw = postalInput.value || "";
    const zip7 = normalizeZip(raw);
    if (zip7.length === 7) {
      postalInput.value = prettyZip(zip7);
      // 2) 查询地址
      const addr = await fetchAddressByZip(zip7);
      if (addr) {
        // 仅当当前地址为空或与新地址前缀一致时覆盖；否则不打扰用户
        if (!addressInput.value || addressInput.value.trim() === "-" || addressInput.value.startsWith(addr.slice(0, 3))) {
          addressInput.value = addr;
        }
      }
    }
  }

  // 触发时机：离开输入框、按下 Enter
  postalInput.addEventListener("blur", handleZipBlur);
  postalInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      handleZipBlur();
    }
  });
});
</script>

{% endblock %}
