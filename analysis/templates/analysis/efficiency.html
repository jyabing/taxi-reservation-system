{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>高效利用率分析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi { display:flex; gap:1rem; margin: 10px 0; }
    .kpi .card { padding:12px 16px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    .grid .card { padding: 12px; }
    #vehEff, #drvEff { min-height: 320px; }
  </style>
</head>
<body class="container py-3">
  <h3 class="mb-3">高效利用率分析（円/小时）</h3>
  {% include "analysis/_analysis_nav.html"
   with efficiency="driver" date_from=date_from date_to=date_to back_url=back_url %}

  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-auto">
      <label class="form-label">开始日</label>
      <input type="date" name="from" value="{{ date_from }}" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <label class="form-label">结束日</label>
      <input type="date" name="to" value="{{ date_to }}" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary btn-sm" type="submit">应用</button>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'analysis:efficiency_export_csv' %}?from={{date_from}}&to={{date_to}}">导出CSV</a>
      <a class="btn btn-link btn-sm" href="{% url 'analysis:vehicle_idle' %}?from={{date_from}}&to={{date_to}}">车辆闲置</a>
      <a class="btn btn-link btn-sm" href="{% url 'analysis:driver_sales' %}?from={{date_from}}&to={{date_to}}">司机売上</a>
    </div>
  </form>

  <div class="grid">
    <div class="card">
      <h6>车辆效率（円/小时）</h6>
      <canvas id="vehEff"></canvas>
    </div>
    <div class="card">
      <h6>司机效率（円/小时）</h6>
      <canvas id="drvEff"></canvas>
    </div>
  </div>

  <div class="card mt-3 p-3">
    <h6>司机 × 车辆 组合效率（Top 50）</h6>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>司机</th>
            <th>车辆</th>
            <th class="text-end">工时(h)</th>
            <th class="text-end">売上(円)</th>
            <th class="text-end">円/小时</th>
          </tr>
        </thead>
        <tbody>
          {% for r in pairs|slice:":50" %}
          <tr>
            <td>{{ r.driver_label }}</td>
            <td>{{ r.vehicle_label }}</td>
            <td class="text-end">{{ r.hours }}</td>
            <td class="text-end">{{ r.sales|floatformat:0 }}</td>
            <td class="text-end"><strong>{{ r.yen_per_hour|floatformat:0 }}</strong></td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center text-muted">暂无数据</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function() {
      // 车辆效率
      const vLabels = [{% for r in vehicles %}"{{ r.label }}",{% endfor %}];
      const vEff = [{% for r in vehicles %}{{ r.yen_per_hour|floatformat:0 }},{% endfor %}];

      const ctxV = document.getElementById('vehEff').getContext('2d');
      new Chart(ctxV, {
        type: 'bar',
        data: { labels: vLabels, datasets: [{ label: '円/小时', data: vEff, borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });

      // 司机效率
      const dLabels = [{% for r in drivers %}"{{ r.label }}",{% endfor %}];
      const dEff = [{% for r in drivers %}{{ r.yen_per_hour|floatformat:0 }},{% endfor %}];

      const ctxD = document.getElementById('drvEff').getContext('2d');
      new Chart(ctxD, {
        type: 'bar',
        data: { labels: dLabels, datasets: [{ label: '円/小时', data: dEff, borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    })();
  </script>
</body>
</html>
