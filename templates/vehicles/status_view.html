{% extends 'base.html' %}
{% load static %}
{% block content %}

{% include 'vehicles/status_tab_navigation.html' %}

<h2>车辆预约状态一览（{{ selected_date }}）</h2>

<form method="get">
  选择日期：<input type="date" name="date" value="{{ selected_date }}">
  <button type="submit">查询</button>
</form>

<table border="1">
  <tr>
    <th>车牌号</th>
    <th>车型</th>
    <th>状态</th>
  </tr>
  {% for vehicle, info in status_map.items %}
  <tr>
    <td>
      <a href="{% url 'vehicle_detail' vehicle.id %}">
        {{ vehicle.license_plate }}
      </a>
    </td>
    <td>{{ vehicle.model }}</td>
    <td style="color:
      {% if info.status == 'available' %}red
      {% elif info.status == 'reserved'  %}blue
      {% elif info.status == 'out'       %}orange
      {% elif info.status == 'canceled'  %}gray
      {% elif info.status == 'maintenance'  %}purple
      {% endif %}
    ">

      {# 1. 车辆本身维护中优先拦截 #}
      {% if vehicle.status == 'maintenance' %}
        <span style="color:purple;">🛠️ 维修中</span>

      {% else %}
      {# 2. 再根据“当天预约状态”info.status 来显示 #}
      {% if info.status == 'available' %}
        <a href="{% url 'make_reservation' vehicle.id %}?date={{ selected_date }}">
          🟥 空缺（点此预约）
        </a>

      {% elif info.status == 'maintenance' %}
        <span>🛠️ 维修中</span>

      {% else %}
        {% if info.status == 'out' %}
          <span style="color:orange; font-weight:bold;">🟧 出库中</span>
        {% else %}
          {{ vehicle.get_status_display }}
        {% endif %}

        {% if info.user_reservation %}
        <div style="margin-top:5px;">
          <span style="color:blue;">🧍 我的预约</span><br>
          🕒 {{ info.user_reservation.start_time|time:"H:i" }}
            ~ {{ info.user_reservation.end_time|time:"H:i" }}

          {% if not info.user_reservation.actual_departure %}
            <br>
            <button onclick="openTimePopup('{{ info.user_reservation.id }}','departure')">
              🚗 出库
            </button>
          {% elif not info.user_reservation.actual_return %}
            <br>
            <button onclick="openTimePopup('{{ info.user_reservation.id }}','return')">
              🅿️ 入库
            </button>
          {% else %}
            <br>✅ 已完成出入库
          {% endif %}
        </div>
        {% endif %}
      {% endif %}
    {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

{# 只在页面底部 include 弹窗模板 #}
{% include 'partials/_check_io_popup.html' %}

{% endblock %}
