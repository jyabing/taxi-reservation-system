{% extends 'base.html' %}
{% load static %}
{% block content %}

{% include 'vehicles/status_tab_navigation.html' %}

<h2>车辆预约状态一览（{{ selected_date }}）</h2>

<form method="get">
  选择日期：<input type="date" name="date" value="{{ selected_date }}">
  <button type="submit">查询</button>
</form>

<table border="1">
  <tr>
    <th>车牌号</th>
    <th>车型</th>
    <th>状态</th>
  </tr>
  {% for vehicle, info in status_map.items %}
  <tr>
    <td>
      <a href="{% url 'vehicle_detail' vehicle.id %}">
        {{ vehicle.license_plate }}
      </a>
    </td>
    <td>{{ vehicle.model }}</td>
<td>
  {# 1. 车辆状态为维修中，直接显示，无需看预约 #}
  {% if vehicle.status == 'maintenance' %}
    <span style="color:purple; font-weight:bold;">🛠️ 维修中</span>

  {# 2. 空缺状态可预约 #}
  {% elif info.status == 'available' %}
    <a href="{% url 'make_reservation' vehicle.id %}?date={{ selected_date }}" style="color:red; font-weight:bold;">
      🟥 可预约（点击预约）
    </a>

  {# 3. 出库中 #}
  {% elif info.status == 'out' %}
    <span style="color:orange; font-weight:bold;">🟧 出库中</span>

  {# 4. 有预约（但未出库） #}
  {% elif info.status == 'reserved' %}
    <span style="color:blue; font-weight:bold;">🟦 有预约（但未出库）</span>

  {% elif info.status == 'canceled' %}
  <span style="color:gray;">❌ 已自动取消</span>

  {# 5. 其他（备用） #}
  {% else %}
    <span style="color:gray;">-</span>
  {% endif %}

  {# 6. 如果当前用户有预约，显示详情与出入库按钮 #}
  {% if info.user_reservation %}
    <div style="margin-top:5px;">
      <span style="color:blue;">🧍 我的预约</span><br>
      🕒 {{ info.user_reservation.start_time|time:"H:i" }}
         ~ {{ info.user_reservation.end_time|time:"H:i" }}

      {% if not info.user_reservation.actual_departure %}
        <br>
        <button onclick="openTimePopup('{{ info.user_reservation.id }}','departure')">
          🚗 出库
        </button>
      {% elif not info.user_reservation.actual_return %}
        <br>
        <button onclick="openTimePopup('{{ info.user_reservation.id }}','return')">
          🅿️ 入库
        </button>
      {% else %}
        <br>✅ 已完成出入库
      {% endif %}
    </div>
  {% endif %}
</td>

  </tr>
  {% endfor %}
</table>

{# 只在页面底部 include 弹窗模板 #}
{% include 'partials/_check_io_popup.html' %}

{% endblock %}
