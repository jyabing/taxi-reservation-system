{# templates/vehicles/weekly_view.html #}
{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>è½¦è¾†ä¸€å‘¨é¢„çº¦æ¦‚è§ˆ</h2>
<p>
  <a href="?date={{ selected_date }}&offset={{ offset|add:"-1" }}">â† ä¸Šä¸€å‘¨</a> |
  <a href="?date={{ selected_date }}&offset=0">æœ¬å‘¨</a> |
  <a href="?date={{ selected_date }}&offset={{ offset|add:"1" }}">ä¸‹ä¸€å‘¨ â†’</a>
</p>
<table border="1">
  <thead>
    <tr>
      <th>è½¦ç‰Œå·</th>
      {% for date in week_dates %}
        <th>{{ date|date:"m/d (D)" }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in vehicle_data %}
      <tr>
        <td>{{ row.vehicle.license_plate }}</td>
        {% for cell in row.days %}
          <td style="vertical-align:top; {% if cell.is_past %}color:#aaa;{% endif %}">

            {# â€”â€” 1. å…¨å±€çŠ¶æ€ï¼šç»´ä¿®ä¸­ ğŸ”§ â€”â€” #}
            {% if row.vehicle.status == 'maintenance' %}
              <span>ğŸ› ï¸ ç»´ä¿®ä¸­</span>

            {# â€”â€” 2. å·²æœ‰é¢„çº¦ â€”â€” #}
            {% elif cell.reservations %}
              {% for res in cell.reservations %}
                <div>
                  <a href="{% url 'reservation_detail' res.id %}">
                    {{ res.start_time|time:"H:i" }}â€“{{ res.end_time|time:"H:i" }}
                    {{ res.driver.username }}
                  </a>
                </div>
                {% if forloop.last %}
                  {# åªæœ‰å½“å¤©æœªè¿‡æ‰å¯èƒ½ç»§ç»­å¼€ç©ºç¼º #}
                  {% if not cell.is_past %}
                    {% if cell.date == now_dt.date %}
                      {# ä»Šå¤©ï¼šæ£€æŸ¥å†·å´ç»“æŸåæ‰èƒ½çº¦ #}
                      {% if not cooldown_end or now_dt > cooldown_end %}
                        {% include 'vehicles/weekly_empty_after.html' %}
                      {% endif %}
                    {% else %}
                      {# æœªæ¥ä»»ä¸€å¤©ï¼šç›´æ¥æ˜¾ç¤ºç©ºç¼º #}
                      {% include 'vehicles/weekly_empty_after.html' %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}

            {# â€”â€” 3. æ•´å¤©ç©ºç¼º â€”â€” #}
            {% else %}
              {% if not cell.is_past %}
                {% if cell.date == now_dt.date %}
                  {# ä»Šå¤©ï¼šå…ˆçœ‹å†·å´ #}
                  {% if not cooldown_end or now_dt > cooldown_end %}
                    <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:"Y-m-d" }}">
                      ğŸ“ ç©ºç¼º
                    </a>
                  {% else %}
                    <span title="ä¸Šæ¬¡å…¥åº“å10hå†…ä¸å¯å†çº¦">ğŸ”’ å†·å´ä¸­</span>
                  {% endif %}
                {% else %}
                  {# æ˜å¤©åŠä»¥åï¼šç›´æ¥å¯çº¦ #}
                  <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:"Y-m-d" }}">
                    ğŸ“ ç©ºç¼º
                  </a>
                {% endif %}
              {% else %}
                ç©ºç¼º
              {% endif %}
            {% endif %}

          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>
<p><a href="{% url 'vehicle_status' %}">â† è¿”å›çŠ¶æ€é¡µ</a></p>
{% endblock %}
