{% extends 'base.html' %}
{% load time_filters %}
{% load humanize %}
{% block content %}
<h4 class="mb-4">ğŸ“ {{ report.date }} æ—¥æŠ¥è¯¦æƒ…</h4>

<!-- å¤‡æ³¨åŒº -->
<div class="alert alert-warning small rounded shadow-sm">
  <strong>å¤‡æ³¨ï¼š</strong>{{ report.note|default:"æ— " }}
</div>

<!-- è½¦è¾†å¡ç‰‡ + å‡ºé€€å‹¤å¡ç‰‡åŒºåŸŸ -->
<div class="d-flex flex-wrap gap-3 my-4">
  <!-- æœ¬æ—¥ä½¿ç”¨è½¦è¾† -->
  <div class="card border-start border-4 border-dark shadow-sm" style="min-width: 160px;">
    <div class="card-body py-2 px-3">
      <div class="small text-muted">æœ¬æ—¥ä½¿ç”¨è½¦è¾†</div>
      <div class="fw-bold">{{ report.vehicle|default:"æœªé€‰æ‹©" }}</div>
    </div>
  </div>

  <!-- å‡ºå‹¤æ™‚é–“ -->
  <div class="card border-start border-4 border-primary shadow-sm" style="min-width: 160px;">
    <div class="card-body py-2 px-3">
      <div class="small text-muted">å‡ºå‹¤æ™‚é–“</div>
      <div class="fw-bold">{{ start_time|time:"H:i"|default:"--:--" }}</div>
    </div>
  </div>

  <!-- é€€å‹¤æ™‚é–“ -->
  <div class="card border-start border-4 border-danger shadow-sm" style="min-width: 160px;">
    <div class="card-body py-2 px-3">
      <div class="small text-muted">é€€å‹¤æ™‚é–“</div>
      <div class="fw-bold">{{ end_time|time:"H:i"|default:"--:--" }}</div>
    </div>
  </div>

  <!-- ç·æ™‚é•· -->
  <div class="card border-start border-4 border-success shadow-sm" style="min-width: 160px;">
    <div class="card-body py-2 px-3">
      <div class="small text-muted">ç·æ™‚é•·</div>
      <div class="fw-bold text-primary">{{ duration|time_length|default:"--:--" }}</div>
    </div>
  </div>

  <!-- æ²¹é‡ -->
  <div class="card border-start border-4 border-warning shadow-sm" style="min-width: 160px;">
    <div class="card-body py-2 px-3">
      <div class="small text-muted">æ²¹é‡ (L)</div>
      <div class="fw-bold">{{ report.gas_volume|default:"--" }}</div>
    </div>
  </div>

  <!-- é‡Œç¨‹ -->
  <div class="card border-start border-4 border-info shadow-sm" style="min-width: 160px;">
    <div class="card-body py-2 px-3">
      <div class="small text-muted">é‡Œç¨‹ (KM)</div>
      <div class="fw-bold">{{ report.mileage|default:"--" }}</div>
    </div>
  </div>
</div>

<!-- ğŸ’´ æœ¬æ—¥å£²ä¸Š -->
<div class="card border-start border-4 border-secondary shadow-sm" style="min-width: 160px;">
  <div class="card-body py-2 px-3">
    <div class="small text-muted">æœ¬æ—¥å£²ä¸Šåˆè¨ˆ</div>
    <div class="fw-bold">{{ total_sales|floatformat:0 }} å††</div>
    <div class="small text-muted">ï¼ˆãƒ¡ãƒ¼ã‚¿ã®ã¿: ï¿¥{{ meter_only_total|default:0|intcomma }}ï¼‰</div>
    <div class="small text-muted">â€» å£²ä¸Šåˆè¨ˆ = ãƒ¡ãƒ¼ã‚¿ã®ã¿ ï¼‹ è²¸åˆ‡ç¾é‡‘ ï¼‹ è²¸åˆ‡æœªå ï¼‹ Uberäºˆç´„/ãƒãƒƒãƒ—/ãƒ—ãƒ­ãƒ¢</div>
  </div>
</div>

{% if deposit_summary %}
<!-- å…¥é‡‘ï¼ˆç»Ÿä¸€å£å¾„ï¼‰ = ãªãŒã—ç¾é‡‘ + è²¸åˆ‡ç¾é‡‘ -->
<div class="card border-start border-4 border-success shadow-sm mt-3" style="min-width: 160px;">
  <div class="card-body py-2 px-3">
    <div class="small text-muted">å…¥é‡‘ï¼ˆç»Ÿä¸€å£å¾„ï¼‰</div>

    <div class="small">
      <div>ãªãŒã—ç¾é‡‘ï¼šÂ¥{{ deposit_summary.nagashi_cash|floatformat:0|intcomma }}</div>
      <div>è²¸åˆ‡ç¾é‡‘ã€€ï¼šÂ¥{{ deposit_summary.charter_cash|floatformat:0|intcomma }}</div>
      <div class="mt-1 border-top pt-1">
        <span class="text-muted">åº”å…¥é‡‘ï¼š</span>
        <span class="fw-bold">Â¥{{ deposit_summary.expected_deposit|floatformat:0|intcomma }}</span>
      </div>
      <div>å®Ÿå…¥é‡‘ã€€ã€€ï¼šÂ¥{{ deposit_summary.deposit_amount|floatformat:0|intcomma }}</div>
      <div>
        å·®é¡ã€€ã€€ã€€ï¼š
        {% with d=deposit_summary.deposit_difference %}
          {% if d > 0 %}
            <span class="fw-bold text-primary">+Â¥{{ d|floatformat:0|intcomma }}</span>
          {% elif d < 0 %}
            <span class="fw-bold text-danger">Â¥{{ d|floatformat:0|intcomma }}</span>
          {% else %}
            <span class="fw-bold text-success">Â¥0</span>
          {% endif %}
        {% endwith %}
      </div>

      <div class="mt-1">
        å®Ÿéš›ETC ä¼šç¤¾ â†’ é‹è»¢æ‰‹ï¼š
        <span class="fw-bold">
          Â¥{{ report.actual_etc_company_to_driver|default:0|floatformat:0|intcomma }}
        </span>
      </div>
      <div>
        å¸æœºè² æ‹…ETCï¼ˆçµ¦ä¸æ§é™¤äºˆå®šï¼‰ï¼š
        <span class="fw-bold text-danger">
          Â¥-{{ report.etc_driver_cost|default:0|floatformat:0|intcomma }}
        </span>
      </div>
    </div>

    <div class="small text-muted mt-2">
      â€» åº”å…¥é‡‘ ï¼ ãªãŒã—ç¾é‡‘ï¼ˆå«å¹³å°ç°é‡‘åˆ«åï¼‰ï¼‹ è²¸åˆ‡ç¾é‡‘
    </div>
  </div>
</div>

{% else %}
<div class="card border-start border-4 border-success shadow-sm mt-3" style="min-width: 160px;">
  <div class="card-body py-2 px-3">
    <div class="small text-muted">å…¥é‡‘é‡‘é¡</div>
    <div class="fw-bold">Â¥{{ deposit|floatformat:0|intcomma }}</div>
    <div class="small text-muted mt-1">
      ï¼ˆå…¥é‡‘ âˆ’ ç¾é‡‘ï¼‰ =
      {% if is_deposit_exact %}
        Â¥0
      {% elif deposit_diff > 0 %}
        +Â¥{{ deposit_diff|floatformat:0|intcomma }}
      {% else %}
        Â¥{{ deposit_diff|floatformat:0|intcomma }}
      {% endif %}
    </div>

    <div class="mt-1 small">
      å®Ÿéš›ETC ä¼šç¤¾ â†’ é‹è»¢æ‰‹ï¼š
      <span class="fw-bold">
        Â¥{{ report.actual_etc_company_to_driver|default:0|floatformat:0|intcomma }}
      </span>
    </div>
    <div class="small">
      å¸æœºè² æ‹…ETCï¼ˆçµ¦ä¸æ§é™¤äºˆå®šï¼‰ï¼š
      <span class="fw-bold">
        Â¥-{{ report.etc_driver_cost|default:0|floatformat:0|intcomma }}
      </span>
    </div>
  </div>
</div>
{% endif %}

<!-- æ˜ç»†è¡¨ -->
{% if items %}
  <div class="card shadow-sm mt-4">
    <div class="card-body p-0">
      <table class="table table-bordered table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>æ—¶é—´</th>
            <th>èµ·ç‚¹</th>
            <th>é‡‘é¢</th>
            <th>æ”¯ä»˜æ–¹å¼</th>
            <th>æ³¨é‡Š</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr class="{% if item.note or item.is_flagged %}table-warning{% endif %}">
              <td class="{% if item.is_same_time_child %}same-time-child{% endif %}">
                {% if item.is_same_time_child %}
                  <span class="same-time-prefix">â†³</span> {{ item.ride_time }}
                {% else %}
                  {{ item.ride_time }}
                {% endif %}
              </td>
              <td>{{ item.ride_from }}</td>
              <td>{{ item.meter_fee }}</td>
              <td>{{ item.get_payment_method_display }}</td>
              <td>
                {{ item.note|default:"" }}
                {% if item.note %}<span title="æœ‰æ³¨é‡Š">ğŸ“</span>{% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="text-muted mt-3">æ— è¡Œç¨‹æ˜ç»†</div>
{% endif %}

<!-- ===== æ–°å¢ï¼šæœ¬æœˆè·‘æ³•ç»“æ„ï¼ˆç¯å½¢å›¾ï¼‰ ===== -->
{% if month_structure_data.values %}
  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h5 class="card-title mb-3">æœ¬æœˆè·‘æ³•ç»“æ„ï¼ˆ{{ report.date|date:"Yå¹´mæœˆ" }}ï¼‰</h5>
      <div class="row">
        <div class="col-md-6">
          <canvas id="monthStructureChart" height="220"></canvas>
        </div>
        <div class="col-md-6 small">
          <ul class="list-unstyled mb-0">
            {% for item in month_structure %}
              <li>
                <span class="fw-bold">{{ item.label }}</span>ï¼š
                Â¥{{ item.value|floatformat:0|intcomma }}
              </li>
            {% endfor %}
          </ul>
          <div class="mt-2 text-muted">
            â€» ä»¥æœ¬æœˆå…¨éƒ¨è®¢å•é‡‘é¢ä¸ºåŸºå‡†ï¼ŒæŸ¥çœ‹â€œè·¯ä¸Š / è²¸åˆ‡ / å¹³å° / ã‚«ãƒ¼ãƒ‰ãƒ»QR / ç¤¾åˆ¸â€ç»“æ„ï¼Œ
            å¸®ä½ åˆ¤æ–­ä»Šå¤©çš„è·‘æ³•æ˜¯ä¸æ˜¯åå‘â€œæŒ£é’±è·‘æ³•â€ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  {# æŠŠç»“æ„æ•°æ®å¡è¿›éšè— JSON scriptï¼Œä¾› Chart.js ä½¿ç”¨ #}
  {{ month_structure_data|json_script:"month-structure-data" }}
{% endif %}
<!-- ===== æ–°å¢ç»“æŸ ===== -->

<p class="mt-4">
  <a href="{% url 'vehicles:my_dailyreports' %}" class="btn btn-outline-secondary btn-sm">â† è¿”å›æ—¥æŠ¥åˆ—è¡¨</a>
</p>

<style>
  .same-time-child { color: #555; }
  .same-time-prefix { display:inline-block; width:1.25em; margin-right:.25em; color:#6c757d; }
</style>

<!-- Chart.js & ç»˜å›¾è„šæœ¬ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
  const dataEl = document.getElementById('month-structure-data');
  if (!dataEl) return;

  const data = JSON.parse(dataEl.textContent || '{}');
  if (!data.values || !data.values.length) return;

  const ctx = document.getElementById('monthStructureChart');
  if (!ctx) return;

  const total = data.values.reduce(function(a, b) { return a + b; }, 0);

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.values,
      }]
    },
    options: {
      cutout: '60%',
      plugins: {
        legend: {
          position: 'right',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const pct = total ? (value / total * 100).toFixed(1) : 0;
              return label + ': Â¥' + value.toLocaleString() + ' (' + pct + '%)';
            }
          }
        }
      }
    }
  });
})();
</script>

{% endblock %}
