{% extends "base.html" %}
{% load static %}
{% block content %}

{% include "partials/_messages.html" %}
<div class="container mt-4">

  <h4 class="mb-3">ğŸ—“ï¸ ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æå‡º</h4>

  <p class="text-muted small mb-4">
    ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š
    <strong>
      {% if driver %}{{ driver }}{% else %}{{ request.user.username }}{% endif %}
    </strong>
    ï¼ æœ¬æ—¥ï¼š{{ today|date:"Yå¹´næœˆjæ—¥ (D)" }}
  </p>

  {# ================================ #}
  {# â‘  æ¡Œé¢ç«¯ï¼ˆmdä»¥ä¸Šï¼‰= è¡¨æ ¼å¸ƒå±€       #}
  {# ================================ #}
  <div class="row d-none d-md-flex">
    <!-- å·¦å´ï¼šæœ¬ç‰©ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-header">æ—¥ä»˜ã‚’é¸æŠ</div>
        <div class="card-body">
          <input
            type="text"
            id="sidebar-date"
            class="form-control form-control-sm mb-3"
            value="{{ work_date|date:'Y-m-d' }}"
            placeholder="æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„">
          <p class="small text-muted mb-2">â€» æ—¥ä»˜ã‚’é¸ã¶ã¨å³å´ã®å†…å®¹ãŒãã®æ—¥ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>

          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" id="btn-today">æœ¬æ—¥</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-add-days="1">+1æ—¥</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-add-days="2">+2æ—¥</button>
          </div>
        </div>
      </div>
    </div>


    <!-- å³ä¾§ï¼šå¡«å†™åŒºåŸŸ -->
    <div class="col-md-8 mb-3">
      <div class="card">
        <div class="card-header">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹</div>
        <div class="card-body">
          <form id="schedule-form-desktop" method="post" novalidate>
            {% csrf_token %}
            <table class="table table-sm align-middle mb-0">


             <tr>
              <th style="width: 25%;">æ—¥ä»˜</th>
              <td>
                <input type="text"
                      class="form-control form-control-sm"
                      id="work-date"
                      name="work_date"
                      value="{{ work_date|date:'Y-m-d' }}"
                      placeholder="é¸æŠã—ã¦ãã ã•ã„">
                <small class="text-muted">â€» æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¾ã™ã€‚</small>
              </td>
            </tr>



              <tr>
                <th style="width: 25%;">åŒºåˆ†</th>
                <td>
                  <!-- BEGIN: â‘ ä¼‘ã¿ -->
                  <div class="form-check">
                    <input class="form-check-input"
                          type="radio"
                          name="mode"
                          id="mode-rest"
                          value="rest"
                          {% if existing and existing.is_rest %}checked{% elif not existing %}checked{% endif %}>
                    <label class="form-check-label" for="mode-rest">â‘  ä¼‘ã¿</label>
                  </div>
                  <!-- END: â‘ ä¼‘ã¿ -->

                  <!-- BEGIN: â‘¡å¸Œæœ›æå‡º -->
                  <div class="form-check mt-1">
                    <input class="form-check-input"
                          type="radio"
                          name="mode"
                          id="mode-wish"
                          value="wish"
                          {% if existing and not existing.is_rest %}checked{% endif %}>
                    <label class="form-check-label" for="mode-wish">â‘¡ å¸Œæœ›è»Šä¸¡ã‚’æå‡º</label>
                  </div>
                  <!-- END: â‘¡å¸Œæœ›æå‡º -->
                </td>
              </tr>
              <tr id="shift-row">
                <th>ã‚·ãƒ•ãƒˆ</th>
                <td>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input"
                          type="radio"
                          name="shift"
                          id="shift-day"
                          value="day"
                          {% if existing and existing.shift == "day" %}checked{% endif %}>
                    <label class="form-check-label" for="shift-day">ç™½ç­</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input"
                          type="radio"
                          name="shift"
                          id="shift-night"
                          value="night"
                          {% if existing and existing.shift == "night" %}checked{% endif %}>
                    <label class="form-check-label" for="shift-night">å¤œç­</label>
                  </div>
                  <small class="text-muted d-block mt-1">â€» â‘¡ã‚’é¸ã‚“ã å ´åˆã¯ã©ã¡ã‚‰ã‹å¿…é ˆ</small>
                </td>
              </tr>


              <tr id="wish-row">
                <th>è»Šä¸¡å¸Œæœ›</th>
                <td>
                  <div class="form-check mb-2">
                    <input class="form-check-input"
                          type="checkbox"
                          id="any-car"
                          name="any_car"
                          value="1"
                          {% if existing and existing.any_car %}checked{% endif %}>
                    <label class="form-check-label" for="any-car">ä»»æ„ã®è»Šä¸¡ã§ã‚‚ã‚ˆã„</label>
                  </div>

                  <div class="row g-2" id="wish-cars">
                    <div class="col">
                      <label class="form-label small">ç¬¬1å¸Œæœ›ã®è»Šä¸¡ <span class="text-danger">*</span></label>
                      <select class="form-select form-select-sm" id="first-car" name="first_car">
                        <option value="">-- é¸æŠ --</option>
                        {% for car in cars %}
                          <option value="{{ car.id }}"
                                  {% if existing and existing.first_choice_car and existing.first_choice_car.id == car.id %}selected{% endif %}
                                  {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                            {{ car.label }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col">
                      <label class="form-label small">ç¬¬2å¸Œæœ›ã®è»Šä¸¡ <span class="text-danger">*</span></label>
                      <select class="form-select form-select-sm" id="second-car" name="second_car">
                        <option value="">-- é¸æŠ --</option>
                        {% for car in cars %}
                          <option value="{{ car.id }}"
                                  {% if existing and existing.second_choice_car and existing.second_choice_car.id == car.id %}selected{% endif %}
                                  {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                            {{ car.label }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <small class="text-danger d-block mt-1" id="car-dup-msg" style="display:none;">
                    â€» ç¬¬1å¸Œæœ›ã¨ç¬¬2å¸Œæœ›ã¯åŒã˜è»Šä¸¡ã«ã§ãã¾ã›ã‚“ã€‚
                  </small>
                </td>
              </tr>

              <tr id="note-row">
                <th>å‚™è€ƒ</th>
                <td>
                  <input type="text"
                        class="form-control form-control-sm"
                        name="note"
                        placeholder="ä¾‹ï¼‰9æ™‚ä»¥é™ã§ãŠé¡˜ã„ã—ã¾ã™"
                        value="{% if existing %}{{ existing.note }}{% endif %}">
                </td>
              </tr>
            </table>

            <button type="submit" class="btn btn-primary btn-sm mt-3" id="btn-submit" disabled>
              ã“ã®å†…å®¹ã§æå‡º
            </button>
            <p class="text-muted small mt-2 mb-0">â€» ã“ã®ãƒšãƒ¼ã‚¸ã¯â€œå…¥åŠ›ãƒ«ãƒ¼ãƒ«ç¢ºèªç”¨â€ã§ã™ã€‚ä¿å­˜ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å…¥ã‚Œã¾ã™ã€‚</p>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# ================================ #}
  {# â‘¡ æ‰‹æœºç«¯ï¼ˆmdä»¥ä¸‹ï¼‰= å¡ç‰‡å¸ƒå±€       #}
  {# ================================ #}
  <div class="d-md-none">
    <form id="schedule-form-mobile" method="post">
      {% csrf_token %}
      <div class="card mb-3">
        <div class="card-header">æ—¥ä»˜</div>
        <div class="card-body">
          <input
            type="text"
            id="m-date"
            class="form-control form-control-sm mb-2"
            value="{{ work_date|date:'Y-m-d' }}"
            placeholder="æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" id="m-today">æœ¬æ—¥</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-add-days="1">+1æ—¥</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-add-days="2">+2æ—¥</button>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label d-block">åŒºåˆ†</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="m-mode" id="m-mode-rest" value="rest" checked>
              <label class="form-check-label" for="m-mode-rest">â‘  ä¼‘ã¿</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="m-mode" id="m-mode-wish" value="wish">
              <label class="form-check-label" for="m-mode-wish">â‘¡ å¸Œæœ›æå‡º</label>
            </div>
          </div>

          <div class="mb-3" id="m-shift-block">
            <label class="form-label d-block">ã‚·ãƒ•ãƒˆ</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="m-shift" id="m-shift-day" value="day">
              <label class="form-check-label" for="m-shift-day">ç™½</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="m-shift" id="m-shift-night" value="night">
              <label class="form-check-label" for="m-shift-night">å¤œ</label>
            </div>
          </div>

          <div class="mb-3" id="m-wish-block">
            <label class="form-label d-block">è»Šä¸¡å¸Œæœ›</label>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="m-any-car" name="m_any_car" value="1">
              <label class="form-check-label" for="m-any-car">ä»»æ„ã®è»Šä¸¡</label>
            </div>
            <label class="form-label small">ç¬¬1å¸Œæœ›</label>
            <select class="form-select form-select-sm mb-2" id="m-first-car" name="m_first_car">
              <option value="">-- é¸æŠ --</option>
              {% for car in cars %}
                <option value="{{ car.id }}"
                        {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                  {{ car.label }}
                </option>
              {% endfor %}
            </select>

            <label class="form-label small">ç¬¬2å¸Œæœ›</label>
            <select class="form-select form-select-sm" id="m-second-car" name="m_second_car">
              <option value="">-- é¸æŠ --</option>
              {% for car in cars %}
                <option value="{{ car.id }}"
                        {% if car.is_bad %}disabled data-unavailable="1"{% endif %}>
                  {{ car.label }}
                </option>
              {% endfor %}
            </select>

            <small class="text-danger d-block mt-1" id="m-car-dup-msg" style="display:none;">â€» åŒã˜è»Šä¸¡ã¯é¸ã¹ã¾ã›ã‚“ã€‚</small>
          </div>

          <div class="mb-3">
            <label class="form-label">å‚™è€ƒ</label>
            <input type="text" class="form-control form-control-sm" name="m_note" placeholder="ãƒ¡ãƒ¢">
          </div>

          <button type="submit" class="btn btn-primary btn-sm" id="m-btn-submit" disabled>
            æå‡º
          </button>

        </div>
      </div>
    </form>
  </div>

</div>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

{# ================================ #}
{# â‘¢ å‰ç«¯è”åŠ¨è„šæœ¬ï¼ˆå¾ˆçŸ­ï¼‰             #}
{# ================================ #}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // ====== å…±é€šå‡½æ•° ======
  function gotoDate(dateStr) {
    const url = new URL(window.location.href);
    url.searchParams.set("work_date", dateStr);
    window.location.href = url.toString();
  }

  // ====== å·¦ä¾§ flatpickr ======
  flatpickr("#sidebar-date", {
    locale: "ja",
    dateFormat: "Y-m-d",
    minDate: "today",
    defaultDate: "{{ work_date|date:'Y-m-d' }}",
    onChange: function(_, dateStr) {
      if (dateStr) gotoDate(dateStr);
    }
  });

  // ====== â€œæœ¬æ—¥ / +1æ—¥ / +2æ—¥â€ æŒ‰é’®åŒæ­¥ ======
  document.querySelectorAll("[data-add-days], #btn-today").forEach(function(btn) {
    btn.addEventListener("click", function() {
      let baseDate = new Date("{{ work_date|date:'Y-m-d' }}");
      const add = parseInt(btn.getAttribute("data-add-days") || "0", 10);
      baseDate.setDate(baseDate.getDate() + add);
      const y = baseDate.getFullYear();
      const m = ("0" + (baseDate.getMonth() + 1)).slice(-2);
      const d = ("0" + baseDate.getDate()).slice(-2);
      gotoDate(`${y}-${m}-${d}`);
    });
  });

  // ====== å³ä¾§ flatpickr åŒæ­¥ ======
  flatpickr("#work-date", {
    locale: "ja",
    dateFormat: "Y-m-d",
    minDate: "today",
    defaultDate: "{{ work_date|date:'Y-m-d' }}",
    onChange: function(_, dateStr) {
      if (dateStr) gotoDate(dateStr);
    }
  });

  // ====== æ‰‹æœºç«¯æ—¥æœŸ flatpickrï¼ˆæ–°å¢ï¼‰=====
  const mInput = document.getElementById("m-date");
  if (mInput) {
    flatpickr("#m-date", {
      locale: "ja",
      dateFormat: "Y-m-d",
      minDate: "today",
      defaultDate: "{{ work_date|date:'Y-m-d' }}",
      onChange: function(_, dateStr) {
        if (dateStr) gotoDate(dateStr);
      }
    });

    const mToday = document.getElementById("m-today");
    if (mToday) {
      mToday.addEventListener("click", function () {
        gotoDate("{{ today|date:'Y-m-d' }}");
      });
    }
  }


  // ====== ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†ï¼ˆä¿æŒåŸæ¥çš„éªŒè¯åŠŸèƒ½ï¼‰ ======
  const modeRest = document.getElementById("mode-rest");
  const modeWish = document.getElementById("mode-wish");
  const shiftRow = document.getElementById("shift-row");
  const wishRow  = document.getElementById("wish-row");
  const anyCar   = document.getElementById("any-car");
  const firstCar = document.getElementById("first-car");
  const secondCar= document.getElementById("second-car");
  const dupMsg   = document.getElementById("car-dup-msg");
  const btnSubmit= document.getElementById("btn-submit");

  function setMode(mode) {
    if (mode === "rest") {
      shiftRow.style.display = "none";
      wishRow.style.display  = "none";
      btnSubmit.disabled = false;
    } else {
      shiftRow.style.display = "";
      wishRow.style.display  = "";
      validateDesktop();
    }
  }

  function validateDesktop() {
    if (!modeWish.checked) { btnSubmit.disabled = false; return; }
    const shiftSelected = document.querySelector('input[name="shift"]:checked');
    let carOK = true;
    if (!anyCar.checked) {
      const f = firstCar.value;
      const s = secondCar.value;
      if (!f || !s) carOK = false;
      if (f && s && f === s) { carOK = false; dupMsg.style.display = ""; }
      else { dupMsg.style.display = "none"; }
    } else { dupMsg.style.display = "none"; }
    btnSubmit.disabled = !(shiftSelected && carOK);
  }

  modeRest.addEventListener("change", () => setMode("rest"));
  modeWish.addEventListener("change", () => setMode("wish"));
  anyCar.addEventListener("change", validateDesktop);
  firstCar.addEventListener("change", validateDesktop);
  secondCar.addEventListener("change", validateDesktop);
  document.querySelectorAll('input[name="shift"]').forEach(el => {
    el.addEventListener("change", validateDesktop);
  });
  setMode(modeRest.checked ? "rest" : "wish");
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  // ====== æ‰‹æœºç«¯å…ƒç´ ï¼ˆéœ€è¦æ¨¡æ¿é‡Œæœ‰è¿™äº› idï¼‰======
  const mModeRest   = document.getElementById("m-mode-rest");
  const mModeWish   = document.getElementById("m-mode-wish");
  const mShiftBlock = document.getElementById("m-shift-block");
  const mWishBlock  = document.getElementById("m-wish-block");
  const mAnyCar     = document.getElementById("m-any-car");
  const mFirstCar   = document.getElementById("m-first-car");
  const mSecondCar  = document.getElementById("m-second-car");
  const mDupMsg     = document.getElementById("m-car-dup-msg"); // å¯é€‰
  const mBtnSubmit  = document.getElementById("m-btn-submit");

  // å°å·¥å…·ï¼šå¯/ç¦ä¸€æ•´ä¸ªå®¹å™¨ä¸­çš„æ§ä»¶ï¼Œé¿å…è¯¯æäº¤
  function setDisabledIn(container, disabled) {
    if (!container) return;
    container.querySelectorAll("input,select,textarea,button").forEach(el => {
      el.disabled = !!disabled;
    });
  }

  // æ‰‹æœºä¸Šæ ¡éªŒè§„åˆ™ï¼šä¼‘ã¿å¯ç›´æ¥æäº¤ï¼›å¸Œæœ›æå‡º=ï¼ˆç™½/å¤œå…¶ä¸€ + (ä»»æ„è½¦ æˆ– ç¬¬1/ç¬¬2éƒ½é€‰ä¸”ä¸åŒ)ï¼‰
  function validateMobile() {
    if (!mBtnSubmit) return;

    if (mModeRest && mModeRest.checked) {
      if (mDupMsg) mDupMsg.style.display = "none";
      mBtnSubmit.disabled = false;
      return;
    }

    let ok = true;
    const shiftChosen = document.querySelector('input[name="m-shift"]:checked');
    if (!shiftChosen) ok = false;

    if (!mAnyCar.checked) {
      const f = mFirstCar.value;
      const s = mSecondCar.value;
      if (!f || !s) ok = false;
      if (f && s && f === s) ok = false;
      if (mDupMsg) mDupMsg.style.display = (f && s && f === s) ? "" : "none";
    } else {
      if (mDupMsg) mDupMsg.style.display = "none";
    }

    mBtnSubmit.disabled = !ok;
  }

  // åˆ‡æ¢æ‰‹æœºç«¯æ¨¡å¼ï¼šä¼‘ã¿ â†” å¸Œæœ›æå‡º
  function setMobileMode() {
    const isRest = mModeRest && mModeRest.checked;
    if (mShiftBlock) mShiftBlock.style.display = isRest ? "none" : "";
    if (mWishBlock)  mWishBlock.style.display  = isRest ? "none" : "";

    // éšè—æ—¶ç¦ç”¨å†…éƒ¨æ§ä»¶ï¼Œé¿å…è¢«æäº¤
    setDisabledIn(mShiftBlock, isRest);
    setDisabledIn(mWishBlock,  isRest);

    if (isRest) {
      if (mBtnSubmit) mBtnSubmit.disabled = false;
      if (mDupMsg) mDupMsg.style.display = "none";
    } else {
      validateMobile();
    }
  }

  // ä»»æ„è½¦å‹¾é€‰æ—¶ç¦ç”¨ç¬¬1/ç¬¬2å¸Œæœ›
  function toggleMobileAnyCar() {
    const dis = !!mAnyCar.checked;
    if (mFirstCar) mFirstCar.disabled = dis;
    if (mSecondCar) mSecondCar.disabled = dis;
    validateMobile();
  }

  // äº‹ä»¶ç»‘å®šï¼ˆå­˜åœ¨å†ç»‘å®šï¼Œä¸ä¼šæŠ¥é”™ï¼‰
  if (mModeRest) mModeRest.addEventListener("change", setMobileMode);
  if (mModeWish) mModeWish.addEventListener("change", setMobileMode);
  if (mAnyCar)   mAnyCar.addEventListener("change", toggleMobileAnyCar);
  if (mFirstCar) mFirstCar.addEventListener("change", validateMobile);
  if (mSecondCar)mSecondCar.addEventListener("change", validateMobile);
  document.querySelectorAll('input[name="m-shift"]').forEach(el => {
    el.addEventListener("change", validateMobile);
  });

  // åˆå§‹åŒ–ä¸€æ¬¡ï¼ˆé¡µé¢è½½å…¥æ—¶å°±æŒ‰é€‰é¡¹éšè—/ç¦ç”¨ï¼‰
  setMobileMode();
  toggleMobileAnyCar();
});
</script>



<style>
  select option[disabled][data-unavailable="1"] {
    color: #999;
    background: #f3f3f3;
    font-style: italic;
  }
</style>

{% endblock %}
