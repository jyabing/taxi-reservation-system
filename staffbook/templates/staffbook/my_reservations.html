{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h4 class="mb-3">ğŸš ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºèª</h4>

  <p class="text-muted small mb-3">
    {% if driver %}
      å¯¾è±¡ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼š<strong>{{ driver }}</strong>
    {% else %}
      å¯¾å¿œã™ã‚‹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
    {% endif %}
    {% if today and to_date %}
      ï¼ è¡¨ç¤ºæœŸé–“ï¼š{{ today|date:"Y-m-d" }} ã€œ {{ to_date|date:"Y-m-d" }}
    {% endif %}
  </p>

  <table class="table table-sm table-bordered align-middle responsive-cards">
    <thead class="table-light">
      <tr>
        <th style="width: 110px;">æ—¥ä»˜</th>
        <th style="width: 130px;">ã‚·ãƒ•ãƒˆ</th>
        <th>è»Šä¸¡å¸Œæœ›</th>
        <th>ä¼šç¤¾æ±ºå®š</th>
        <th>å‚™è€ƒ</th>
        <th style="width: 110px;">çŠ¶æ…‹</th>
        <th style="width: 130px;">æ“ä½œ</th>  {# â† æ–°å¢ #}
      </tr>
    </thead>
    <tbody>
      {% if schedules %}
        {% for s in schedules %}
          <tr class="my-sched-row" data-date="{{ s.work_date|date:'Y-m-d' }}">
            <td data-label="æ—¥ä»˜" class="sched-date-cell">
              <div class="sched-date-inner">
                <span class="sched-toggle-icon">â–¼</span>
                <span class="sched-date-text">
                  {{ s.work_date|date:"Y-m-d (D)" }}
                </span>
              </div>
            </td>

            <td data-label="ã‚·ãƒ•ãƒˆ">
              {% if s.is_rest %}
                <span class="badge bg-secondary">ä¼‘ã¿</span>
              {% else %}
                <span class="badge bg-primary me-2">å‡ºå‹¤</span>

                {% if s.shift == "day" %}
                  æ˜¼å‹¤
                {% elif s.shift == "night" %}
                  å¤œå‹¤
                {% else %}
                  -
                {% endif %}
              {% endif %}
            </td>


            <td data-label="è»Šä¸¡å¸Œæœ›">
              {% if s.is_rest %}
                -
              {% else %}
                {% if s.any_car %}
                  ä»»æ„ã®è»Šä¸¡ã§å¯
                {% else %}
                  ç¬¬1:
                  {% if s.first_choice_car %}
                    {{ s.first_choice_car.license_plate|default:s.first_choice_car.registration_number }}
                    {{ s.first_choice_car.name }}
                  {% else %}-{% endif %}
                  <br>
                  ç¬¬2:
                  {% if s.second_choice_car %}
                    {{ s.second_choice_car.license_plate|default:s.second_choice_car.registration_number }}
                    {{ s.second_choice_car.name }}
                  {% else %}-{% endif %}
                {% endif %}
              {% endif %}
            </td>

            {# ==== BEGIN MS2: ä¼šç¤¾æ±ºå®šåˆ—ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‹å‚™è€ƒæŠ˜ã‚ŠãŸãŸã¿ï¼‰ ==== #}
            <td data-label="ä¼šç¤¾æ±ºå®š">

              <div class="car-cell-wrap">

                {% if s.assigned_car %}

                  {# è»Šä¸¡æƒ…å ±ã‚«ãƒ¼ãƒ‰ #}
                  <div class="car-info-card small">
                    <div class="car-info-card-header">
                      <div class="car-header-right">
                        <span class="car-number-pill"
                              data-brand="{{ s.assigned_car.brand|default:'' }}">
                          {{ s.assigned_car.license_plate|default:s.assigned_car.registration_number }}
                        </span>
                        {% if s.assigned_car.name %}
                          <span class="car-model-text">
                            {{ s.assigned_car.name }}
                          </span>
                        {% endif %}
                      </div>
                    </div>

                    <div class="car-info-row mb-1">
                      <span class="ci-label">ğŸ›  ç‚¹æ¤œ</span>
                      <span class="car-due {{ s.car_info_ctx.tenken.css }}">
                        {{ s.car_info_ctx.tenken.label }}
                      </span>
                    </div>

                    <div class="car-info-row mb-1">
                      <span class="ci-label">ğŸ“… è»Šæ¤œ</span>
                      <span class="car-due {{ s.car_info_ctx.shaken.css }}">
                        {{ s.car_info_ctx.shaken.label }}
                      </span>
                    </div>

                    <div class="car-info-row">
                      <span class="ci-label">âš™ è¨­å‚™</span>
                      <span>
                        {% if s.car_info_ctx.equipment %}
                          {% for e in s.car_info_ctx.equipment %}
                            {{ e }}{% if not forloop.last %} ãƒ» {% endif %}
                          {% endfor %}
                        {% else %}
                          <span class="text-muted">ï¼ˆç™»éŒ²ãªã—ï¼‰</span>
                        {% endif %}
                      </span>
                    </div>
                  </div>

                  {# â˜… ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å‡ºã™ç®¡ç†ãƒ¡ãƒ¢ï¼ˆé•·ã„å ´åˆã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰ #}
                  {% if s.admin_note %}
                    {% with s.admin_note as note %}
                      <div class="car-admin-note" data-note-id="{{ s.id }}">
                        <span class="note-icon">ğŸ’¬</span>

                        {# çŸ­ã„ç‰ˆï¼ˆå…ˆé ­ 40 æ–‡å­—ï¼‰ #}
                        <span class="note-text note-short">
                          {{ note|truncatechars:40 }}
                        </span>

                        {# å…¨æ–‡ç‰ˆ #}
                        <span class="note-text note-full d-none">
                          {{ note }}
                        </span>

                        {# 40 æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã ã‘ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º #}
                        {% if note|length > 40 %}
                          <button type="button"
                                  class="note-toggle btn btn-link btn-sm p-0 ms-1">
                            ã‚‚ã£ã¨è¦‹ã‚‹
                          </button>
                        {% endif %}
                      </div>
                    {% endwith %}
                  {% endif %}

                {% elif s.status == "approved" %}
                  <span class="badge bg-info text-dark">ä¼šç¤¾æ±ºå®šæ¸ˆï¼ˆè»Šä¸¡æœªæŒ‡å®šï¼‰</span>

                {% elif s.status == "rejected" %}
                  <span class="badge bg-danger">å·®ã—æˆ»ã—</span>

                {% else %}
                  <span class="badge bg-secondary">ç¢ºèªä¸­</span>
                {% endif %}

              </div>  {# /car-cell-wrapï¼šä¸Šä¸‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ #}

            </td>
            {# ==== END MS2 ==== #}

            <td data-label="å‚™è€ƒ">{{ s.note|default:"-" }}</td>

            <td data-label="çŠ¶æ…‹">
              <span class="badge bg-light text-muted d-block mb-1">ä¿å­˜æ¸ˆã¿</span>
              <span class="text-muted small">{{ s.updated_at|date:"m/d H:i" }}</span>
            </td>

            {# â† æ–°å¢ï¼šæ“ä½œåˆ— #}
            <td data-label="æ“ä½œ">
              <div class="d-flex flex-wrap gap-2">
                <a
                  href="{% url 'staffbook:schedule_form' %}?work_date={{ s.work_date|date:'Y-m-d' }}"
                  class="btn btn-sm btn-outline-primary">
                  âœï¸ ç·¨é›†
                </a>

                <form method="post"
                      action="{% url 'staffbook:schedule_delete' s.id %}"
                      onsubmit="return confirm('ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    ğŸ—‘ å‰Šé™¤
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            ã¾ã ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{# ==== BEGIN REPLACE/INSERT MS-CSS-CARD: ä¼šç¤¾æ±ºå®š æƒ…å ±ã‚«ãƒ¼ãƒ‰ æ¨£å¼ ==== #}
<style>
/* é€šç”¨å¾½ç« åŸºç¡€æ ·å¼ */
.car-no-badge {
  padding: 4px 12px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 0.95rem;
  display: inline-block;
  white-space: nowrap;
  border: 1px solid transparent;
}

/* ======== Toyota (ãƒˆãƒ¨ã‚¿) ======== */
.brand-toyota.car-no-badge {
  background: #e6f4ea;
  color: #137333;
  border-color: #c9e6d4;
}

/* ======== Nissan (æ—¥ç”£) ======== */
.brand-nissan.car-no-badge {
  background: #e7f0fd;
  color: #0b57d0;
  border-color: #c7daf8;
}

/* ======== Honda (ãƒ›ãƒ³ãƒ€) ======== */
.brand-honda.car-no-badge {
  background: #fde8e8;
  color: #b42318;
  border-color: #f5c2c2;
}

/* ======== Suzuki (ã‚¹ã‚ºã‚­) ======== */
.brand-suzuki.car-no-badge {
  background: #f0f9ff;
  color: #0369a1;
  border-color: #bae6fd;
}

/* ======== Daihatsu (ãƒ€ã‚¤ãƒãƒ„) ======== */
.brand-daihatsu.car-no-badge {
  background: #fff4e5;
  color: #8a4d00;
  border-color: #f5d9b8;
}

/* ======== Toyota ãƒã‚¤ã‚¨ãƒ¼ã‚¹ ç”¨ã®åˆ¥è‰²ï¼ˆå¯é€‰ï¼‰ ======== */
/*
.brand-hiace.car-no-badge {
  background: #eef6ff;
  color: #1e40af;
  border-color: #cbdffb;
}
*/

/* ======== é»˜è®¤ï¼ˆæ— æ³•åˆ¤æ–­å“ç‰Œï¼‰ ======== */
.car-no-badge:not([class*="brand-"]) {
  background: #f3f4f6;
  color: #374151;
  border-color: #e5e7eb;
}


/* ===== ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼šè¡ŒæŠ˜ã‚ŠãŸãŸã¿ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ ===== */

/* æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã®è¡Œï¼š1åˆ—ç›®ï¼ˆæ—¥ä»˜ï¼‰ä»¥å¤–ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
.my-sched-row.my-collapsed td:not(:first-child) {
  display: none;
}

/* æ—¥ä»˜ã‚»ãƒ«å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ */
.sched-date-cell {
  cursor: pointer;
  white-space: nowrap;
}

/* æ—¥ä»˜ã®ä¸­èº«ï¼šã‚¢ã‚¤ã‚³ãƒ³ï¼‹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¨ªä¸¦ã³ */
.sched-date-inner {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* å±•é–‹ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆâ–¶ / â–¼ï¼‰ */
.sched-toggle-icon {
  font-size: .8rem;
  color: #6b7280;
  width: 1em;
  text-align: center;
}

/* å±•é–‹ä¸­ã¯å°‘ã—å¼·èª¿ï¼ˆé¢œè‰²ç¨æ·±ï¼‰ */
.my-sched-row:not(.my-collapsed) .sched-toggle-icon {
  color: #111827;
}
/* ===== é…è»Šæ±ºå®šï¼šã‚»ãƒ«å†…ã‚’ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ ===== */
.car-cell-wrap{
  display:flex;
  flex-direction:column;  /* ã‚«ãƒ¼ãƒ‰ â†’ å‚™è€ƒ ã®é †ã§ç¸¦ä¸¦ã³ */
  gap:6px;
}

/* ===== é…è»Šæ±ºå®šï¼šè»Šä¸¡æƒ…å ±ã‚«ãƒ¼ãƒ‰ ===== */
.car-info-card{
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#f8fafc;
  padding:8px 10px;
  box-shadow:0 1px 3px rgba(15,23,42,.08);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆå³ä¸Šã«è»Šä¸¡ãƒãƒƒã‚¸ï¼‰ */
.car-info-card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

/* ===== æŸ”å’Œæµ…ç»¿ pill é£è½¦ç‰Œå¾½ç«  ===== */
.car-info-badge{
  background: #e6f4ea !important;     /* æŸ”å’Œæµ…ç»¿èƒŒæ™¯ */
  color: #137333 !important;           /* æ·±ç»¿å­—ä½“ */
  padding: 3px 10px;
  border-radius: 999px;                /* ä¸¸ã¿æœ€å¤§çš„ pill é£æ ¼ */
  font-weight: 700;
  font-size: .85rem;
  display: inline-block;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
  border: 1px solid #d2e9d7;
}

/* ==== è»Šä¸¡ãƒãƒƒã‚¸ï¼ˆãƒŠãƒ³ãƒãƒ¼ï¼‹è»Šåã‚’åˆ†é›¢ï¼‰ ==== */

/* å³å´ã‚³ãƒ³ãƒ†ãƒŠï¼šãƒŠãƒ³ãƒãƒ¼ï¼‹è»Šåã‚’æ¨ªä¸¦ã³ã§ã€å…¨ä½“ã‚’å³å¯„ã› */
.car-header-right{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:6px;
}

/* ãƒŠãƒ³ãƒãƒ¼ã®æ¥•å††ãƒãƒƒã‚¸ */
.car-number-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:3px 12px;          /* â† æ¯”ä»¥å‰ç¨å¤§ä¸€ç‚¹ */
  border-radius:999px;
  font-weight:700;
  font-size:.9rem;           /* â† ç•¥å¤§ãã‚ */
  letter-spacing:.03em;
  background:#e5f3ff;        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆéãƒˆãƒ¨ã‚¿ï¼‰ */
  color:#1d4ed8;
}

/* è»Šåãƒ†ã‚­ã‚¹ãƒˆ */
.car-model-text{
  font-size:.9rem;
  color:#374151;
}

/* ==== ãƒ¡ãƒ¼ã‚«ãƒ¼åˆ¥è‰²ï¼ˆToyota ç³»ã ã‘ç‰¹åˆ¥è‰²ï¼‰ ==== */
/* brand ãŒã€Œãƒˆãƒ¨ã‚¿ã€ã€ŒToyotaã€ã€ŒTOYOTAã€ã§å§‹ã¾ã‚‹å ´åˆ */
.car-number-pill[data-brand^="ãƒˆãƒ¨ã‚¿"],
.car-number-pill[data-brand^="Toyota"],
.car-number-pill[data-brand^="TOYOTA"]{
  background:#e6f4ea;  /* Google ã® â€œæˆåŠŸâ€ ç³»ã‚°ãƒªãƒ¼ãƒ³èƒŒæ™¯ã«è¿‘ã„è‰² */
  color:#137333;       /* æ¿ƒã„ã‚°ãƒªãƒ¼ãƒ³æ–‡å­— */
}

/* ==== ã‚¹ãƒãƒ›æ™‚ã¯ãƒãƒƒã‚¸ã‚’ã‚ˆã‚Šå³å¯„ã›ï¼ˆå¿µã®ãŸã‚ï¼‰ ==== */
@media (max-width: 767.98px){
  .car-info-card-header{
    justify-content:flex-end;
  }
}

/* ç‚¹æ¤œï¼è»Šæ¤œï¼è¨­å‚™ ã®å„è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.car-info-row{
  display:flex;
  gap:6px;
  align-items:baseline;
}

/* å·¦å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆğŸ›  ç‚¹æ¤œï¼ğŸ“… è»Šæ¤œï¼âš™ è¨­å‚™ï¼‰ */
.ci-label{
  min-width:4.2em;
  color:#6b7280;
}

/* ===== ç‚¹æ¤œãƒ»è»Šæ¤œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²åˆ†ã‘ ===== */
/* æœŸé™åˆ‡ã‚Œï¼ˆèµ¤ï¼‰ */
.car-due.due-expired{
  color:#d93025;
  font-weight:700;
}

/* æœ¬æ—¥ãŒæœŸé™ï¼ˆç·‘ï¼‰ */
.car-due.due-today{
  color:#0f9d58;
  font-weight:700;
}

/* 5æ—¥ä»¥å†…ã«æœŸé™ï¼ˆèŒ¶è‰²ï¼‰ */
.car-due.due-soon{
  color:#b36b00;
  font-weight:600;
}

/* é€šå¸¸ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */
.car-due.due-normal{
  color:#777;
}

/* ===== è»Šä¸¡ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å‡ºã™ç®¡ç†ãƒ¡ãƒ¢ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œï¼‰ ===== */
.car-admin-note{
  margin-top:2px;
  padding:4px 6px;
  border-left:3px solid #9ca3af;
  background:#f9fafb;
  font-size:.8rem;
  color:#4b5563;
  line-height:1.4;
}

.car-admin-note .note-icon{
  margin-right:4px;
  opacity:.8;
}

.car-admin-note .note-text{
  word-break:break-word;
}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆã‚‚ã£ã¨è¦‹ã‚‹ï¼é–‰ã˜ã‚‹ï¼‰ */
.note-toggle{
  font-size:.75rem;
}

/* ã‚·ãƒ³ãƒ—ãƒ«ãª .d-none äº’æ›ï¼ˆå¿µã®ãŸã‚ï¼‰ */
.d-none{
  display:none !important;
}

/* ============================
   æŠ˜ã‚ŠãŸãŸã¿è¡Œã®èƒŒæ™¯è‰²ï¼†ä»Šæ—¥ãƒã‚¤ãƒ©ã‚¤ãƒˆ
============================ */

/* æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ï¼šè–„ã„ã‚°ãƒ¬ãƒ¼ */
.my-sched-row.my-collapsed {
  background: #f8f9fa !important;
}

/* å±•é–‹ä¸­ï¼šç™½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
.my-sched-row:not(.my-collapsed) {
  background: #ffffff !important;
}

/* ä»Šæ—¥ã®è¡Œï¼ˆå±•é–‹ä¸­ã®ã¿ï¼‰ï¼šæ·¡ã„é’ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.my-sched-row[data-date="{{ today|date:'Y-m-d' }}"]:not(.my-collapsed) {
  background: #e8f3ff !important;
}

/* ============================
   ã‚¹ãƒãƒ›ç”¨ï¼šæŠ˜ã‚ŠãŸãŸã¿è¡Œã®è¦‹ãŸç›®ã‚’å°‘ã—å¤§ãã
============================ */
@media (max-width: 768px) {

  /* æŠ˜ã‚ŠãŸãŸã¿æ™‚ï¼šæ—¥ä»˜ã‚»ãƒ«ã®é«˜ã•ã¨æ–‡å­—ã‚’å°‘ã—å¤§ãã */
  .my-sched-row.my-collapsed .sched-date-cell {
    padding-top: 12px;
    padding-bottom: 12px;
    font-size: 1rem;
    font-weight: 600;
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³ã¨æ—¥ä»˜ã‚’å°‘ã—å¼·èª¿ */
  .my-sched-row.my-collapsed .sched-toggle-icon {
    font-size: 0.95rem;
  }
  .my-sched-row.my-collapsed .sched-date-text {
    font-size: 1rem;
  }
}
</style>

{# ==== END MS-CSS-CARD ==== #}

<script>
/* ç®¡ç†ãƒ¡ãƒ¢ã®ã€Œã‚‚ã£ã¨è¦‹ã‚‹ï¼é–‰ã˜ã‚‹ã€ãƒˆã‚°ãƒ« */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.note-toggle');
  if (!btn) return;

  const wrap = btn.closest('.car-admin-note');
  if (!wrap) return;

  const shortText = wrap.querySelector('.note-short');
  const fullText  = wrap.querySelector('.note-full');

  if (!shortText || !fullText) return;

  const isExpanded = !fullText.classList.contains('d-none');

  if (isExpanded) {
    // ä»Šã¯å…¨æ–‡è¡¨ç¤º â†’ çŸ­ãæˆ»ã™
    fullText.classList.add('d-none');
    shortText.classList.remove('d-none');
    btn.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
  } else {
    // ä»Šã¯çŸ­ã„ç‰ˆ â†’ å…¨æ–‡è¡¨ç¤º
    shortText.classList.add('d-none');
    fullText.classList.remove('d-none');
    btn.textContent = 'é–‰ã˜ã‚‹';
  }
});
</script>

<script>
/* ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼šã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆä»Šæ—¥ä»¥å¤–ã¯åˆæœŸæŠ˜ã‚ŠãŸãŸã¿ï¼‰ */
document.addEventListener('DOMContentLoaded', function () {
  const todayStr = '{{ today|date:"Y-m-d" }}';  // ä¾‹: 2025-11-13

  // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡Œã®çŠ¶æ…‹ã«åˆã‚ã›ã¦æ›´æ–°
  function updateRowIcon(row) {
    const icon = row.querySelector('.sched-toggle-icon');
    if (!icon) return;
    if (row.classList.contains('my-collapsed')) {
      icon.textContent = 'â–¶';  // æŠ˜ã‚ŠãŸãŸã¿
    } else {
      icon.textContent = 'â–¼';  // å±•é–‹ä¸­
    }
  }

  const rows = document.querySelectorAll('.my-sched-row');

  rows.forEach(function (row) {
    const rowDate = row.getAttribute('data-date');

    // ä»Šæ—¥ä»¥å¤– â†’ åˆæœŸçŠ¶æ…‹ã§æŠ˜ã‚ŠãŸãŸã¿
    if (rowDate !== todayStr) {
      row.classList.add('my-collapsed');
    }

    // åˆæœŸã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
    updateRowIcon(row);

    // è¡Œã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å‹•ä½œ
    row.addEventListener('click', function (e) {
      // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã¯ç„¡è¦–
      if (e.target.closest('a, button, form')) {
        return;
      }

      const isCollapsed = row.classList.contains('my-collapsed');

      if (isCollapsed) {
        // ä»Šã‚¯ãƒªãƒƒã‚¯ã—ãŸè¡Œã‚’ã€Œå±•é–‹ã€ã€ä»–ã®è¡Œã¯å…¨éƒ¨ã€ŒæŠ˜ã‚ŠãŸãŸã¿ã€
        rows.forEach(function (r) {
          r.classList.add('my-collapsed');
          updateRowIcon(r);
        });
        row.classList.remove('my-collapsed');
        updateRowIcon(row);
      } else {
        // æ—¢ã«å±•é–‹ä¸­ã®è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸ â†’ æŠ˜ã‚ŠãŸãŸã‚€ï¼ˆå…¨éƒ¨æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚‚å¯ï¼‰
        row.classList.add('my-collapsed');
        updateRowIcon(row);
      }
    });
  });
});
</script>


{% endblock %}
