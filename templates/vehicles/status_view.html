{% extends 'base.html' %}
{% load static %}
{% block content %}

{% include 'vehicles/status_tab_navigation.html' %}  {# æ’å…¥ Tab æŒ‰é’® #}

<h2>è½¦è¾†é¢„çº¦çŠ¶æ€ä¸€è§ˆ({{ selected_date }})</h2>

<form method="get">
    é€‰æ‹©æ—¥æœŸï¼š<input type="date" name="date" value="{{ selected_date }}">
    <button type="submit">æŸ¥è¯¢</button>
</form>

<table border="1">
<tr>
    <th>è½¦ç‰Œå·</th><th>è½¦å‹</th><th>çŠ¶æ€</th>
</tr>
{% for vehicle, info in status_map.items %}
<tr>
  <td><a href="{% url 'vehicle_detail' vehicle.id %}">{{ vehicle.license_plate }}</a></td>
  <td>{{ vehicle.model }}</td>
  <td style="color:
  {% if info.status == 'available' %}red
  {% elif info.status == 'reserved' %}blue
  {% elif info.status == 'out' %}orange
  {% elif info.status == 'canceled' %}gray
  {% endif %}
">
  {% if info.status == 'available' %}
    <a href="{% url 'make_reservation' vehicle.id %}?date={{ selected_date }}">
      ğŸŸ¥ ç©ºç¼ºï¼ˆç‚¹æ­¤é¢„çº¦ï¼‰
    </a>
  {% else %}
    {% if info.status == 'out' %}
      <span style="color: orange; font-weight: bold;">ğŸŸ§ å‡ºåº“ä¸­</span>
    {% else %}
      {{ vehicle.get_status_display }}
    {% endif %}
    
  {% if info.status == 'reserved' and info.user_reservation %}
    <div style="margin-top: 5px;">
      <span style="color: blue;">ğŸ§ æˆ‘çš„é¢„çº¦</span><br>
      ğŸ•’ {{ info.user_reservation.start_time|time:"H:i" }} ~ {{ info.user_reservation.end_time|time:"H:i" }}
      {% if not info.user_reservation.actual_departure %}
        <br><button onclick="openTimePopup('{{ info.user_reservation.id }}', 'departure')">ğŸš— å‡ºåº“</button>
      {% elif not info.user_reservation.actual_return %}
        <br><button onclick="openTimePopup('{{ info.user_reservation.id }}', 'return')">ğŸ…¿ï¸ å…¥åº“</button>
      {% else %}
        <br>âœ… å·²å®Œæˆå‡ºå…¥åº“
      {% endif %}
    </div>
    {% endif %}
  {% endif %}
</td>
</tr>
{% endfor %}
</table>
{% endblock %}

<!-- å‡ºå…¥åº“æ—¶é—´å¼¹çª— -->
<div id="popup" style="display:none; position:fixed; top:30%; left:35%; background:#fff; border:1px solid #ccc; padding:20px;">
  <form method="post" action="{% url 'confirm_check_io' %}">
    {% csrf_token %}
    <input type="hidden" name="reservation_id" id="popup_reservation_id">
    <input type="hidden" name="action_type" id="popup_action_type">
    <label>é€‰æ‹©å®é™…æ—¶é—´ï¼š</label>
    <input type="datetime-local" name="actual_time" required>
    <br><br>
    <button type="submit">ç¡®è®¤</button>
    <button type="button" onclick="document.getElementById('popup').style.display='none'">å–æ¶ˆ</button>
  </form>
</div>