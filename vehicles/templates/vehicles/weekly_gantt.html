{% extends "base.html" %}
{% load static %}
{% load dict_helpers %}
{% block content %}

<div class="container-fluid py-3">

  <!-- æ ‡é¢˜ + å‘¨åˆ‡æ¢ -->
  <div class="d-flex align-items-center mb-3">
    <div class="me-3 d-flex align-items-baseline gap-2">
      <span class="fs-5">ğŸš—</span>
      <h6 class="mb-0 fw-semibold">ä¸€å‘¨é¢„çº¦ç”˜ç‰¹å›¾</h6>
      <span class="text-muted small">ï¼ˆ{{ week_start }} ã€œ {{ week_end }}ï¼‰</span>
    </div>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="?start={{ prev_week|date:'Y-m-d' }}">å‰é€±</a>
      <a class="btn btn-primary btn-sm" href="?start={{ this_week|date:'Y-m-d' }}">æœ¬é€±</a>
      <a class="btn btn-outline-secondary btn-sm" href="?start={{ next_week|date:'Y-m-d' }}">æ¬¡é€±</a>
    </div>
  </div>

  <!-- Legend æ ·å¼ï¼ˆå†…è”ï¼Œç¡®ä¿ç«‹å³ç”Ÿæ•ˆï¼›å¯ç§»å…¥ static/css/gantt.cssï¼‰ -->
  <style>
    .legend-box{display:inline-block;width:16px;height:12px;margin-right:4px;border-radius:3px;vertical-align:middle;}
    .sticky-col{
      position: sticky; left: 0; z-index: 2; background: #fff;
      min-width: 120px; border-right: 2px solid #e5e7eb; text-align: left; padding-left: 6px;
      white-space: nowrap;
    }
    /* ç”˜ç‰¹è‰²å—é‡Œçš„å­—æ›´æ˜“è¯» */
    .gantt-seg{ color:#fff; font-size:11px; text-align:center; vertical-align:middle; font-weight:600; }

    /* ====== å¹³æ¿åŠä»¥ä¸‹ ====== */
    @media (max-width: 992px){
      .gantt-table{ font-size:11px; }
      .gantt-seg{ height:18px; font-size:10px; }
      .gantt-table thead th{ padding:2px 0; font-size:11px; }
      .sticky-col{ min-width:100px; padding-left:4px; }
    }
    /* ====== æ‰‹æœºï¼ˆç«–å±ï¼‰ ====== */
    @media (max-width: 576px){
      .gantt-wrapper{ overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:12px; }
      .gantt-table{ min-width: 900px; }
      .gantt-table thead th{ font-size:10px; padding:1px 0; }
      .sticky-col{ min-width:86px; border-right:1px solid #e5e7eb; padding-left:4px; }
      .gantt-seg{ height:16px; font-size:9px; border-radius:4px; }
      .legend{ gap:8px; flex-wrap: wrap; }
      .legend .label{ display:none; }
      .legend-box{ width:12px; height:10px; margin-right:2px; }
      .btn-sm{ padding:2px 6px; font-size:12px; }
    }
  </style>

  <!-- å‡¡ä¾‹ï¼ˆçŠ¶æ€è¯´æ˜ï¼‰ -->
  <div class="legend mb-2 small d-flex gap-3 align-items-center">
    <span class="legend-item" title="ç¢ºå®šæ¸ˆã¿">
      <span class="legend-box gantt-reserved"></span><span class="label"> ç¢ºå®šæ¸ˆã¿</span>
    </span>
    <span class="legend-item" title="æ‰¿èªå¾…ã¡">
      <span class="legend-box gantt-pending"></span><span class="label"> æ‰¿èªå¾…ã¡</span>
    </span>
    <span class="legend-item" title="å¤–å‡ºä¸­">
      <span class="legend-box gantt-out"></span><span class="label"> å‡ºåº«ä¸­</span>
    </span>
    <span class="legend-item" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
      <span class="legend-box gantt-canceled"></span><span class="label"> ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
    </span>
  </div>

  <div class="gantt-wrapper">
    <!-- å åŠ ç½‘æ ¼çš„ç”»å¸ƒï¼ˆè‹¥éœ€è¦ï¼Œå¯ç”± static/js/gantt.js è¯»å– data-hours æ¥ç”»ç«–çº¿ï¼‰ -->
    <canvas id="gantt-grid-overlay"></canvas>

    <table class="gantt-table jp-compact">
      <thead>
        <tr>
          <th class="sticky-col">è½¦è¾†</th>
          {# è¡¨å¤´æŒ‰æ—¥åˆ†ç»„ï¼Œæ¯å¤© 24 å°æ—¶åˆ— #}
          {% for d in week_dates %}
            <th colspan="24" class="text-center">{{ d|date:"Y-m-d" }}ï¼ˆ{{ d|ja_weekday }}ï¼‰</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in vehicle_rows %}
        <tr>
          <td class="sticky-col">
            {{ row.vehicle_label }}
          </td>

          {# é€æ®µæ¸²æŸ“ï¼šæ¯æ®µä¹‹å‰æ¸²æŸ“ gapï¼ˆç©ºç™½ï¼‰ï¼Œå†æ¸²æŸ“æ®µï¼›æœ€åæ¸²æŸ“å°¾éƒ¨ç©ºç™½ #}
          {% for seg in row.segs %}
            {% if seg.gap > 0 %}
              <td colspan="{{ seg.gap }}" class="gantt-empty"></td>
            {% endif %}
            <td colspan="{{ seg.length }}"
                class="gantt-seg gantt-{{ seg.status }}"
                title="{{ seg.title }}">
              {% if seg.status == "reserved" %}ç¢ºå®š
              {% elif seg.status == "pending" %}ç”³è«‹
              {% elif seg.status == "out" %}å‡ºåº«
              {% elif seg.status == "canceled" %}å–æ¶ˆ
              {% endif %}
            </td>
          {% endfor %}

          {% if row.tail_gap > 0 %}
            <td colspan="{{ row.tail_gap }}" class="gantt-empty"></td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{{ 1|add:HOURS }}" class="text-center text-muted py-4">æœ¬å‘¨æš‚æ— é¢„çº¦</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // å¯ä¾›ç½‘æ ¼è„šæœ¬è¯»å–ï¼ˆæ€»å°æ—¶æ•° 7*24 = 168ï¼‰
  const tbl = document.querySelector('.gantt-table');
  if (tbl) tbl.setAttribute('data-hours', '{{ HOURS }}');
</script>
{% endblock %}
