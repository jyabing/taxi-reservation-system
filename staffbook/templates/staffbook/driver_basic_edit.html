{% extends "staffbook/base_staffbook.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow" style="width:90vw;max-width:1200px;margin:0 auto;">
    <div class="card-header bg-white d-flex align-items-center" style="font-size:1.2em;">
      <i class="fa fa-edit me-2"></i> 基本データ編集
      <span class="badge bg-primary ms-2">No.{{ driver.driver_code }}</span>
      <span class="ms-auto text-muted">事業者名/営業所名・国籍・別名は必須</span>
    </div>

    <div class="card-body">
      <form method="post" action="{% url 'staffbook:driver_basic_edit' driver.id %}">
        {% csrf_token %}

        {# ---- 错误提示块：把具体错误列出来 ---- #}
        {% if form.errors or form.non_field_errors %}
          <div class="alert alert-danger mb-3">
            {{ form.non_field_errors }}
            <ul class="mb-0">
              {% for f in form %}
                {% for e in f.errors %}
                  <li><b>{{ f.label }}：</b>{{ e }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="row">
          <!-- 左列 -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">氏名（首選）</label>
              <input type="text" name="name" value="{{ driver.name }}" class="form-control" required>
              <div class="form-text">画面显示时将按「氏名（国籍）」显示。</div>
            </div>

            <div class="mb-3">
              <label class="form-label">フリガナ（首選）</label>
              <input type="text" name="kana" value="{{ driver.kana }}" class="form-control" required>
            </div>

            <!-- 别名（可选） -->
            <div class="mb-3">
              <label class="form-label">別名（可选）</label>
              <input type="text" name="alt_name" value="{{ driver.alt_name }}" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">別名フリガナ（可选）</label>
              <input type="text" name="alt_kana" value="{{ driver.alt_kana }}" class="form-control">
            </div>

            <!-- 国籍 -->
            <div class="mb-3">
              <label class="form-label">国籍（必須）</label>
              <select name="nationality" class="form-select" required>
                <option value="">--選択してください--</option>
                {% for n in nationality_choices %}
                  <option value="{{ n }}" {% if driver.nationality == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">性別</label>
                <select name="gender" class="form-select" required>
                  <option value="">--選択--</option>
                  {% for val,label in gender_choices %}
                    <option value="{{ val }}" {% if driver.gender == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">血液型</label>
                <select name="blood_type" class="form-select">
                  <option value="">--選択--</option>
                  {% for val,label in blood_choices %}
                    <option value="{{ val }}" {% if driver.blood_type == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">生年月日</label>
                <input type="date" name="birth_date" value="{{ driver.birth_date|date:'Y-m-d' }}" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">入社年月日</label>
                <input type="date" name="hire_date" value="{{ driver.hire_date|date:'Y-m-d' }}" class="form-control">
              </div>
            </div>
          </div>

          <!-- 右列 -->
          <div class="col-md-6">
            <!-- 事业者 -->
            <div class="mb-3">
              <label class="form-label">事業者名（必須）</label>
              <select name="company" class="form-select" required id="companySelect">
                <option value="">--選択してください--</option>
                {% for c in companies %}
                  <option value="{{ c.id }}"
                          {% if selected_company_id == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- 营业所（按公司过滤） -->
            <div class="mb-3">
              <label class="form-label">営業所名（必須）</label>
              <select name="workplace" class="form-select" required id="workplaceSelect">
                <option value="">--選択してください--</option>
                {% for w in workplaces %}
                  <option value="{{ w.id }}" data-company="{{ w.company_id }}"
                          {% if selected_workplace_id == w.id|stringformat:"s" %}selected{% endif %}>
                    {{ w.name }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">事業者選択で営業所を絞り込みます。</div>
            </div>

            <div class="mb-3">
              <label class="form-label">部門</label>
              <input type="text" name="department" value="{{ driver.department }}" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">職種</label>
              <select name="position" class="form-select" required>
                <option value="">--選択してください--</option>
                {% for val,label in driver_position_choices %}
                  {% if val %}
                    <option value="{{ val }}" {% if driver.position == val %}selected{% endif %}>{{ label }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">在職類型（必須）</label>
              <select name="employ_type" class="form-select" required>
                <option value="">--選択してください--</option>
                {% for val, label in employ_type_choices %}
                  {% if val %}
                    <option value="{{ val }}"
                      {% if selected_employ_type|stringformat:"s" == val|stringformat:"s" %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">特記事項</label>
              <textarea name="remark" rows="4" class="form-control">{{ driver.remark }}</textarea>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <a href="{% url 'staffbook:driver_basic_info' driver.id %}" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left"></i> 戻る
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> 保存
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const companySel   = document.getElementById('companySelect');
  const workplaceSel = document.getElementById('workplaceSelect');
  if (!companySel || !workplaceSel) return;

  function filterWorkplaces() {
    const cid = companySel.value;
    for (let i = 0; i < workplaceSel.options.length; i++) {
      const opt = workplaceSel.options[i];
      if (!opt.value) continue;               // 占位项
      const match = (opt.dataset.company === cid);
      opt.hidden = !match;
      if (!match && opt.selected) opt.selected = false;
    }
    if (!workplaceSel.value) {
      const first = Array.from(workplaceSel.options).find(o => !o.hidden && o.value);
      workplaceSel.value = first ? first.value : '';
    }
  }

  document.addEventListener('DOMContentLoaded', filterWorkplaces);
  companySel.addEventListener('change', filterWorkplaces);
})();
</script>
{% endblock %}
