{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h4 class="mb-3">ğŸš ç§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºèª</h4>

  <p class="text-muted small mb-3">
    {% if driver %}
      å¯¾è±¡ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼š<strong>{{ driver }}</strong>
    {% else %}
      å¯¾å¿œã™ã‚‹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
    {% endif %}
    {% if today and to_date %}
      ï¼ è¡¨ç¤ºæœŸé–“ï¼š{{ today|date:"Y-m-d" }} ã€œ {{ to_date|date:"Y-m-d" }}
    {% endif %}
  </p>

  <table class="table table-sm table-bordered align-middle responsive-cards">
    <thead class="table-light">
      <tr>
        <th style="width: 110px;">æ—¥ä»˜</th>
        <th style="width: 90px;">åŒºåˆ†</th>
        <th style="width: 90px;">ã‚·ãƒ•ãƒˆ</th>
        <th>è»Šä¸¡å¸Œæœ›</th>
        <th>ä¼šç¤¾æ±ºå®š</th>
        <th>å‚™è€ƒ</th>
        <th style="width: 110px;">çŠ¶æ…‹</th>
        <th style="width: 130px;">æ“ä½œ</th>  {# â† æ–°å¢ #}
      </tr>
    </thead>
    <tbody>
      {% if schedules %}
        {% for s in schedules %}
          <tr>
            <td data-label="æ—¥ä»˜">{{ s.work_date|date:"Y-m-d (D)" }}</td>
            <td data-label="åŒºåˆ†">
              {% if s.is_rest %}
                <span class="badge bg-secondary">ä¼‘ã¿</span>
              {% else %}
                <span class="badge bg-primary">å¸Œæœ›</span>
              {% endif %}
            </td>
            <td data-label="ã‚·ãƒ•ãƒˆ">
              {% if not s.is_rest %}
                {% if s.shift == "day" %}ç™½{% elif s.shift == "night" %}å¤œ{% else %}-{% endif %}
              {% else %}-{% endif %}
            </td>

            <td data-label="è»Šä¸¡å¸Œæœ›">
              {% if s.is_rest %}
                -
              {% else %}
                {% if s.any_car %}
                  ä»»æ„ã®è»Šä¸¡ã§å¯
                {% else %}
                  ç¬¬1:
                  {% if s.first_choice_car %}
                    {{ s.first_choice_car.license_plate|default:s.first_choice_car.registration_number }}
                    {{ s.first_choice_car.name }}
                  {% else %}-{% endif %}
                  <br>
                  ç¬¬2:
                  {% if s.second_choice_car %}
                    {{ s.second_choice_car.license_plate|default:s.second_choice_car.registration_number }}
                    {{ s.second_choice_car.name }}
                  {% else %}-{% endif %}
                {% endif %}
              {% endif %}
            </td>

            {# ==== BEGIN MS2 (Final Clean Version) ==== #}
            <td data-label="ä¼šç¤¾æ±ºå®š">

              {% if s.assigned_car %}
                <div class="car-info-card small">

                  <!-- é¡¶éƒ¨ï¼šè½¦ç‰Œå¾½ç« é å³ -->
                  <div class="car-info-card-header">
                    <div></div>  <!-- å·¦ä¾§ç•™ç©ºï¼Œä½¿å¾½ç« é å³ -->
                    <span class="badge bg-success car-info-badge">
                      {{ s.assigned_car.license_plate|default:s.assigned_car.registration_number }}
                      {{ s.assigned_car.name }}
                    </span>
                  </div>

                  <!-- ç‚¹æ£€ -->
                  <div class="car-info-row mb-1">
                    <span class="ci-label">ğŸ›  ç‚¹æ¤œ</span>
                    <span class="car-due {{ s.car_info_ctx.tenken.css }}">
                      {{ s.car_info_ctx.tenken.label }}
                    </span>
                  </div>

                  <!-- å¹´æ£€ -->
                  <div class="car-info-row mb-1">
                    <span class="ci-label">ğŸ“… å¹´æ¤œ</span>
                    <span class="car-due {{ s.car_info_ctx.shaken.css }}">
                      {{ s.car_info_ctx.shaken.label }}
                    </span>
                  </div>

                  <!-- è®¾å¤‡ -->
                  <div class="car-info-row">
                    <span class="ci-label">âš™ è¨­å‚™</span>
                    <span>
                      {% if s.car_info_ctx.equipment %}
                        {% for e in s.car_info_ctx.equipment %}
                          {{ e }}{% if not forloop.last %} ãƒ» {% endif %}
                        {% endfor %}
                      {% else %}
                        <span class="text-muted">ï¼ˆæœªç™»éŒ²ï¼‰</span>
                      {% endif %}
                    </span>
                  </div>

                </div>

              {% elif s.status == "approved" %}
                <span class="badge bg-info text-dark">ä¼šç¤¾æ±ºå®šæ¸ˆï¼ˆè»Šä¸¡æœªæŒ‡å®šï¼‰</span>

              {% elif s.status == "rejected" %}
                <span class="badge bg-danger">å·®ã—æˆ»ã—</span>

              {% else %}
                <span class="badge bg-secondary">ç¢ºèªä¸­</span>
              {% endif %}

              {% if s.admin_note %}
                <div class="small text-muted mt-1">{{ s.admin_note }}</div>
              {% endif %}
            </td>
            {# ==== END MS2 ==== #}

            <td data-label="å‚™è€ƒ">{{ s.note|default:"-" }}</td>

            <td data-label="çŠ¶æ…‹">
              <span class="badge bg-light text-muted d-block mb-1">ä¿å­˜æ¸ˆã¿</span>
              <span class="text-muted small">{{ s.updated_at|date:"m/d H:i" }}</span>
            </td>

            {# â† æ–°å¢ï¼šæ“ä½œåˆ— #}
            <td data-label="æ“ä½œ">
              <div class="d-flex flex-wrap gap-2">
                <a
                  href="{% url 'staffbook:schedule_form' %}?work_date={{ s.work_date|date:'Y-m-d' }}"
                  class="btn btn-sm btn-outline-primary">
                  âœï¸ ç·¨é›†
                </a>

                <form method="post"
                      action="{% url 'staffbook:schedule_delete' s.id %}"
                      onsubmit="return confirm('ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    ğŸ—‘ å‰Šé™¤
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            ã¾ã ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<style>
.car-info-box{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fafafa;margin-top:8px;}
.car-info-head{font-weight:600;margin-bottom:6px;display:flex;gap:8px;align-items:center;}
.car-no-badge{background:#e6f4ea;color:#137333;border-radius:999px;padding:2px 8px;font-weight:700;}
.car-name{color:#555;}
.car-info-line{display:flex;gap:10px;padding:6px 0;align-items:baseline;border-top:1px dashed #eee;}
.car-info-line:first-of-type{border-top:none;}
.car-info-line .label{width:56px;color:#666;font-size:.92rem;}
.car-info-line .text{flex:1;}
.due-soon{box-shadow:inset 0 0 0 9999px rgba(255,193,7,.12);}
.due-today .text{font-weight:800;color:#0f9d58;}
.due-expired .text{color:#d93025;font-weight:700;}
.due-unknown .text{color:#9aa0a6;}
.equipment .equip-chip{display:inline-block;padding:2px 8px;margin:2px 4px 0 0;border-radius:999px;border:1px solid #d0d5db;font-size:12px;color:#374151;background:#fff;}
@media (min-width: 992px){
  .car-info-box{background:#fff;border:1px solid #dfe1e5;}
  .car-info-grid{display:grid;grid-template-columns:120px 1fr 120px 1fr;gap:8px 12px;align-items:center;}
  .car-info-grid .k{color:#666;}
  .car-info-grid .v{padding:4px 0;}
  .car-info-grid .v.due-soon{box-shadow:inset 0 0 0 9999px rgba(255,193,7,.12);}
  .car-info-grid .v.due-today{font-weight:800;color:#0f9d58;}
  .car-info-grid .v.due-expired{color:#d93025;font-weight:700;}
}
</style>
{# ==== BEGIN REPLACE/INSERT MS-CSS-CARD: ä¼šç¤¾æ±ºå®š æƒ…å ±ã‚«ãƒ¼ãƒ‰ æ¨£å¼ ==== #}
<style>
.car-info-card{
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#f8fafc;
  padding:8px 10px;
  box-shadow:0 1px 3px rgba(15,23,42,.08);
}

.car-info-card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

.car-info-badge{
  font-weight:700;
}

.car-info-row{
  display:flex;
  gap:6px;
  align-items:baseline;
}

.ci-label{
  min-width:4.2em;
  color:#6b7280;
}

.car-due.due-expired{color:#d93025;font-weight:700;}
.car-due.due-today{color:#0f9d58;font-weight:700;}
.car-due.due-soon{color:#b36b00;font-weight:600;}
.car-due.due-normal{color:#777;}
</style>
{# ==== END MS-CSS-CARD ==== #}

{% endblock %}
