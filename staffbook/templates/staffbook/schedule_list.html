{# taxi_project/staffbook/templates/staffbook/schedule_list.html #}
{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h4 class="mb-3">ğŸ“‹ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æå‡ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§</h4>

  <p class="text-muted small mb-2">
    è¡¨ç¤ºæœŸé–“ï¼š{{ date_from|date:"Y-m-d" }} ã€œ {{ date_to|date:"Y-m-d" }}
  </p>

  {# ==== åˆ†ç»„åˆ‡æ¢ tabs ==== #}
  <div class="mb-3">
    <a href="?group=date" class="btn btn-sm {% if group == 'date' %}btn-primary{% else %}btn-outline-primary{% endif %}">
      æ—¥ä»˜ã”ã¨ã«è¡¨ç¤º
    </a>
    <a href="?group=driver" class="btn btn-sm {% if group == 'driver' %}btn-primary{% else %}btn-outline-primary{% endif %}">
      ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã”ã¨ã«è¡¨ç¤º
    </a>
  </div>

  {# ====== æ—¥æœŸ + å¸æœºç­›é€‰ ====== #}
  <form method="get" class="d-flex gap-2 ms-auto" style="max-width: 520px;">
    <input type="hidden" name="group" value="{{ group }}">
    {% if selected_driver %}
      <input type="hidden" name="driver" value="{{ selected_driver }}">
    {% endif %}

    <select name="work_date" class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="">ã™ã¹ã¦ã®æ—¥ä»˜</option>
      {% for d in date_choices %}
        <option value="{{ d|date:'Y-m-d' }}" {% if selected_work_date and d == selected_work_date %}selected{% endif %}>
          {{ d|date:"Y-m-d (D)" }}
        </option>
      {% endfor %}
    </select>

    <select name="driver" class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="">ã™ã¹ã¦ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
      {% for d in all_drivers %}
        <option value="{{ d.id }}" {% if selected_driver == d.id %}selected{% endif %}>
          {{ d.driver_code }} {{ d.name }}
        </option>
      {% endfor %}
    </select>

    <noscript><button class="btn btn-sm btn-secondary">è¡¨ç¤º</button></noscript>
  </form>

  {# ========== â‘  æŒ‰æ—¥æœŸåˆ†ç»„ ========== #}
  {% if group == 'date' %}
    {% for d, rows in grouped.items %}
      <h6 class="mt-4 mb-2">{{ d|date:"Y-m-d (D)" }}</h6>
      <table class="table table-sm table-bordered align-middle responsive-cards">
        <thead class="table-light">
          <tr>
            <th>æ—¥ä»˜</th>
            <th>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</th>
            <th>åŒºåˆ†</th>
            <th>ã‚·ãƒ•ãƒˆ</th>
            <th>å¸Œæœ›è»Šä¸¡</th>
            <th>ä¼šç¤¾æ±ºå®š</th>
            <th>å‚™è€ƒ</th>
            <th>æ›´æ–°</th>
          </tr>
        </thead>
        <tbody>
          {% for s in rows %}
            <tr>
              <td data-label="æ—¥ä»˜">{{ s.work_date|date:"Y-m-d (D)" }}</td>
              <td data-label="ãƒ‰ãƒ©ã‚¤ãƒãƒ¼">
                {{ s.driver.driver_code }} {{ s.driver.name }}
              </td>
              <td data-label="åŒºåˆ†">
                {% if s.is_rest %}
                  <span class="badge bg-secondary">ä¼‘ã¿</span>
                {% else %}
                  <span class="badge bg-primary">å¸Œæœ›</span>
                {% endif %}
              </td>
              <td data-label="ã‚·ãƒ•ãƒˆ">
                {% if not s.is_rest %}
                  {% if s.shift == "day" %}ç™½ç­{% elif s.shift == "night" %}å¤œç­{% else %}-{% endif %}
                {% endif %}
              </td>
              <td data-label="å¸Œæœ›è»Šä¸¡">
                {% if s.is_rest %}
                  -
                {% else %}
                  {% if s.any_car %}
                    ä»»æ„ã®è»Šä¸¡ã§å¯
                  {% else %}
                    ç¬¬1:
                    {% if s.first_choice_car %}
                      {{ s.first_choice_car.license_plate|default:s.first_choice_car.registration_number|default:s.first_choice_car.name }}
                    {% else %}-{% endif %}
                    <br>
                    ç¬¬2:
                    {% if s.second_choice_car %}
                      {{ s.second_choice_car.license_plate|default:s.second_choice_car.registration_number|default:s.second_choice_car.name }}
                    {% else %}-{% endif %}
                  {% endif %}
                {% endif %}
              </td>
              <td data-label="ä¼šç¤¾æ±ºå®š">
                <form method="post" class="d-flex flex-column gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="sched_id" value="{{ s.id }}">
                  <select name="assigned_car" class="form-select form-select-sm">
                    <option value="">-- æœªæ±ºå®š --</option>
                    {% for car in cars %}
                      <option value="{{ car.id }}" {% if s.assigned_car_id == car.id %}selected{% endif %}>
                        {{ car.license_plate|default:car.name }}
                      </option>
                    {% endfor %}
                  </select>
                  <select name="status" class="form-select form-select-sm mt-1">
                    <option value="pending"  {% if s.status == "pending" %}selected{% endif %}>æœªç¢ºå®š</option>
                    <option value="approved" {% if s.status == "approved" %}selected{% endif %}>ç¢ºå®š</option>
                    <option value="rejected" {% if s.status == "rejected" %}selected{% endif %}>å·®ã—æˆ»ã—</option>
                  </select>
                  <input type="text" name="admin_note" class="form-control form-control-sm mt-1"
                         value="{{ s.admin_note }}" placeholder="ç®¡ç†ãƒ¡ãƒ¢">
                  <button type="submit" class="btn btn-primary btn-sm mt-1">ä¿å­˜</button>
                </form>
              </td>
              <td data-label="å‚™è€ƒ">{{ s.note|default:"-" }}</td>
              <td data-label="æ›´æ–°">
                <span class="text-muted small">{{ s.updated_at|date:"m/d H:i" }}</span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% empty %}
      <p class="text-muted">ã¾ã æå‡ºã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}

  {% else %}
  {# ========== â‘¡ æŒ‰å¸æœºåˆ†ç»„ ========== #}
    {% for driver_label, rows in grouped.items %}
      <h6 class="mt-4 mb-2">{{ driver_label }}</h6>
      <table class="table table-sm table-bordered align-middle responsive-cards">
        <thead class="table-light">
          <tr>
            <th>æ—¥ä»˜</th>
            <th>åŒºåˆ†</th>
            <th>ã‚·ãƒ•ãƒˆ</th>
            <th>å¸Œæœ›è»Šä¸¡</th>
            <th>ä¼šç¤¾æ±ºå®š</th>
            <th>å‚™è€ƒ</th>
            <th>æ›´æ–°</th>
          </tr>
        </thead>
        <tbody>
          {% for s in rows %}
            <tr>
              <td data-label="æ—¥ä»˜">{{ s.work_date|date:"Y-m-d (D)" }}</td>
              <td data-label="åŒºåˆ†">
                {% if s.is_rest %}
                  <span class="badge bg-secondary">ä¼‘ã¿</span>
                {% else %}
                  <span class="badge bg-primary">å¸Œæœ›</span>
                {% endif %}
              </td>
              <td data-label="ã‚·ãƒ•ãƒˆ">
                {% if not s.is_rest %}
                  {% if s.shift == "day" %}ç™½ç­{% elif s.shift == "night" %}å¤œç­{% else %}-{% endif %}
                {% endif %}
              </td>
              <td data-label="å¸Œæœ›è»Šä¸¡">
                {% if s.is_rest %}
                  -
                {% else %}
                  {% if s.any_car %}
                    ä»»æ„ã®è»Šä¸¡ã§å¯
                  {% else %}
                    ç¬¬1:
                    {% if s.first_choice_car %}
                      {{ s.first_choice_car.license_plate|default:s.first_choice_car.registration_number|default:s.first_choice_car.name }}
                    {% else %}-{% endif %}
                    <br>
                    ç¬¬2:
                    {% if s.second_choice_car %}
                      {{ s.second_choice_car.license_plate|default:s.second_choice_car.registration_number|default:s.second_choice_car.name }}
                    {% else %}-{% endif %}
                  {% endif %}
                {% endif %}
              </td>
              <td data-label="ä¼šç¤¾æ±ºå®š">
                <form method="post" class="d-flex flex-column gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="sched_id" value="{{ s.id }}">
                  <select name="assigned_car" class="form-select form-select-sm">
                    <option value="">-- æœªæ±ºå®š --</option>
                    {% for car in cars %}
                      <option value="{{ car.id }}" {% if s.assigned_car_id == car.id %}selected{% endif %}>
                        {{ car.license_plate|default:car.name }}
                      </option>
                    {% endfor %}
                  </select>
                  <select name="status" class="form-select form-select-sm mt-1">
                    <option value="pending"  {% if s.status == "pending" %}selected{% endif %}>æœªç¢ºå®š</option>
                    <option value="approved" {% if s.status == "approved" %}selected{% endif %}>ç¢ºå®š</option>
                    <option value="rejected" {% if s.status == "rejected" %}selected{% endif %}>å·®ã—æˆ»ã—</option>
                  </select>
                  <input type="text" name="admin_note" class="form-control form-control-sm mt-1"
                         value="{{ s.admin_note }}" placeholder="ç®¡ç†ãƒ¡ãƒ¢">
                  <button type="submit" class="btn btn-primary btn-sm mt-1">ä¿å­˜</button>
                </form>
              </td>
              <td data-label="å‚™è€ƒ">{{ s.note|default:"-" }}</td>
              <td data-label="æ›´æ–°">
                <span class="text-muted small">{{ s.updated_at|date:"m/d H:i" }}</span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% empty %}
      <p class="text-muted">ã¾ã æå‡ºã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}
  {% endif %}

  {# ===== åªè¯»é…è½¦è¡¨ï¼šé€‰äº†æ—¥æœŸæ‰æ˜¾ç¤º ===== #}
  {% if selected_work_date %}
    <div class="dispatch-board mt-4">
      <div class="dispatch-board__header">
        {{ selected_work_date|date:"Yå¹´næœˆjæ—¥ (l)" }}
      </div>

      {% for sec in dispatch_sections %}
        {% if sec.rows %}
          <div class="dispatch-board__section">
            <div class="dispatch-board__title">{{ sec.title }}</div>

            {% for r in sec.rows %}
              <div class="dispatch-board__row">
                {% if r.car %}
                  <span class="dispatch-board__car">
                    ğŸš• {{ r.car.license_plate|default:r.car.registration_number|default:r.car.name }}
                  </span>
                {% else %}
                  <span class="dispatch-board__car">ğŸš• ãƒ¼</span>
                {% endif %}

                <span class="dispatch-board__driver">
                  {% if r.driver %}
                    {{ r.driver.driver_code }}ã€€{{ r.driver.name }}
                  {% else %}
                    ï¼ˆç©ºç½®ä¸­ï¼‰
                  {% endif %}
                </span>

                {% if r.is_rest %}
                  <span class="dispatch-board__badge dispatch-board__badge--rest">ä¼‘</span>
                {% else %}
                  {% if r.shift == "day" %}
                    <span class="dispatch-board__badge">ç™½</span>
                  {% elif r.shift == "night" %}
                    <span class="dispatch-board__badge dispatch-board__badge--night">å¤œ</span>
                  {% endif %}
                {% endif %}

                {# è½¦çš„çŠ¶æ€ï¼šç»´ä¿®ä¸­ / ç©ºç½®ä¸­ #}
                {% if r.car %}
                  {% if r.car.status == "maintenance" or r.car.is_maintaining %}
                    <span class="dispatch-board__maint">ğŸ›  ä¿®ç†ä¸­</span>
                  {% elif not r.driver %}
                    <span class="dispatch-board__maint">ç©ºç½®ä¸­</span>
                  {% endif %}
                {% endif %}

                {% if r.admin_note %}
                  <span class="dispatch-board__note text-muted">{{ r.admin_note }}</span>
                {% elif r.driver_note %}
                  <span class="dispatch-board__note text-muted">{{ r.driver_note }}</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

</div>  {# â† è¿™é‡Œæ‰æ˜¯çœŸæ­£å…³ container #}

<style>
.dispatch-board{
  background:#19a953;
  border-radius:16px;
  padding:18px 18px 10px 18px;
  color:#000;
  max-width:480px;
}
.dispatch-board__header{
  font-size:1.3rem;
  font-weight:600;
  margin-bottom:14px;
}
.dispatch-board__section{ margin-bottom:16px; }
.dispatch-board__title{ font-size:1.1rem; font-weight:600; margin-bottom:6px; }
.dispatch-board__row{
  display:flex;
  align-items:center;
  gap:10px;
  padding:3px 0;
  flex-wrap:wrap;
}
.dispatch-board__car{ min-width:85px; font-size:1.05rem; }
.dispatch-board__driver{ min-width:120px; font-size:1.05rem; }
.dispatch-board__badge{
  background:#fff;
  color:#000;
  border-radius:999px;
  padding:2px 10px;
  font-size:.7rem;
  font-weight:600;
}
.dispatch-board__badge--night{ background:#212529; color:#fff; }
.dispatch-board__badge--rest{ background:#6c757d; color:#fff; }
.dispatch-board__maint{ font-size:.8rem; }
.dispatch-board__note{ font-size:.75rem; }
@media (max-width: 576px){
  .dispatch-board{max-width:100%;}
  .dispatch-board__row{flex-direction:row;}
}
</style>

{% endblock %}
