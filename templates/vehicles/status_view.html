{% extends 'base.html' %}
{% load static %}
{% block content %}

{% include 'vehicles/status_tab_navigation.html' %}

<h2>è½¦è¾†é¢„çº¦çŠ¶æ€ä¸€è§ˆï¼ˆ{{ selected_date }}ï¼‰</h2>

<form method="get">
  é€‰æ‹©æ—¥æœŸï¼š<input type="date" name="date" value="{{ selected_date }}">
  <button type="submit">æŸ¥è¯¢</button>
</form>

<table border="1">
  <tr>
    <th>è½¦ç‰Œå·</th>
    <th>è½¦å‹</th>
    <th>çŠ¶æ€</th>
  </tr>
  {% for vehicle, info in status_map.items %}
  <tr>
    <td>
      <a href="{% url 'vehicle_detail' vehicle.id %}">
        {{ vehicle.license_plate }}
      </a>
    </td>
    <td>{{ vehicle.model }}</td>
    <td style="color:
      {% if info.status == 'available' %}red
      {% elif info.status == 'reserved'  %}blue
      {% elif info.status == 'out'       %}orange
      {% elif info.status == 'canceled'  %}gray
      {% elif info.status == 'maintenance'  %}purple
      {% endif %}
    ">

      {# 1. è½¦è¾†æœ¬èº«ç»´æŠ¤ä¸­ä¼˜å…ˆæ‹¦æˆª #}
      {% if vehicle.status == 'maintenance' %}
        <span style="color:purple;">ğŸ› ï¸ ç»´ä¿®ä¸­</span>

      {% else %}
      {# 2. å†æ ¹æ®â€œå½“å¤©é¢„çº¦çŠ¶æ€â€info.status æ¥æ˜¾ç¤º #}
      {% if info.status == 'available' %}
        <a href="{% url 'make_reservation' vehicle.id %}?date={{ selected_date }}">
          ğŸŸ¥ ç©ºç¼ºï¼ˆç‚¹æ­¤é¢„çº¦ï¼‰
        </a>

      {% elif info.status == 'maintenance' %}
        <span>ğŸ› ï¸ ç»´ä¿®ä¸­</span>

      {% else %}
        {% if info.status == 'out' %}
          <span style="color:orange; font-weight:bold;">ğŸŸ§ å‡ºåº“ä¸­</span>
        {% else %}
          {{ vehicle.get_status_display }}
        {% endif %}

        {% if info.user_reservation %}
        <div style="margin-top:5px;">
          <span style="color:blue;">ğŸ§ æˆ‘çš„é¢„çº¦</span><br>
          ğŸ•’ {{ info.user_reservation.start_time|time:"H:i" }}
            ~ {{ info.user_reservation.end_time|time:"H:i" }}

          {% if not info.user_reservation.actual_departure %}
            <br>
            <button onclick="openTimePopup('{{ info.user_reservation.id }}','departure')">
              ğŸš— å‡ºåº“
            </button>
          {% elif not info.user_reservation.actual_return %}
            <br>
            <button onclick="openTimePopup('{{ info.user_reservation.id }}','return')">
              ğŸ…¿ï¸ å…¥åº“
            </button>
          {% else %}
            <br>âœ… å·²å®Œæˆå‡ºå…¥åº“
          {% endif %}
        </div>
        {% endif %}
      {% endif %}
    {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

{# åªåœ¨é¡µé¢åº•éƒ¨ include å¼¹çª—æ¨¡æ¿ #}
{% include 'partials/_check_io_popup.html' %}

{% endblock %}
