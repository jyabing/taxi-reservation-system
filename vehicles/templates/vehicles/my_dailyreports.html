{# vehicles/templates/vehicles/my_dailyreports.html #}
{% extends 'base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block content %}

<style>
  .debug-tag{
    position:absolute; top:10px; right:14px; font-size:.8rem; color:#999;
    font-family:ui-monospace, Menlo, Consolas, monospace;
  }
  .page-container{ position:relative; }

  /* 桌面端表格样式 */
  .page-title{ font-weight:800; letter-spacing:.02em; }
  .card{ border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.04); }
  .table thead th{ position:sticky; top:0; background:#f8f9fa; z-index:2; vertical-align:middle; }
  .table tbody tr:hover{ background:#fcfcfd; }
  .td-date{ white-space:nowrap; width:11rem; }
  .td-money{ white-space:nowrap; text-align:right; width:16rem; }
  .td-ops{ width:7rem; text-align:center; }
  .mono{ font-family:ui-monospace, Menlo, Consolas, monospace; }
  .subtext{ font-size:.84rem; color:#6c757d; }
  .muted-rule{ border-color:#eee; }
  .totals{ font-weight:700; font-size:1.1rem; }

  /* 移动端细节微调 */
  @media (max-width: 768px) {
    .debug-tag{ display:none; }
    .subtext{ font-size:.75rem; }
    .totals{ font-size:1rem; }
    .mobile-card .mono{ font-size:.95rem; }
    .mobile-card .title{ font-weight:700; }
  }
</style>

<div class="page-container">

  <div class="debug-tag d-none d-md-block">
    DEBUG: qs_count={{ debug_text|default_if_none:'' }} ｜ reports_len={{ reports|length }}
  </div>

  <h2 class="page-title mb-3">{{ selected_year }}年{{ selected_month }}月 的日報明細</h2>

  <!-- 年月筛选 -->
  <div class="d-flex align-items-center gap-2 mb-3">
    <form method="get" class="d-flex align-items-center gap-2">
      <div class="d-flex align-items-center gap-2">
        <label class="mb-0">按年月：</label>
        <select name="year" class="form-select form-select-sm" style="width:auto;">
          {% for y in 2023|to:2031 %}
            <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}年</option>
          {% endfor %}
        </select>
        <select name="month" class="form-select form-select-sm" style="width:auto;">
          {% for m in 1|to:13 %}
            <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}月</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn btn-outline-secondary btn-sm">查询</button>
    </form>
  </div>

  {# ---------- 桌面端：表格 ---------- #}
  <div class="card mb-3 d-none d-md-block">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr class="text-muted">
              <th class="td-date">日期</th>
              <th class="td-money">
                売上合計
                <div class="subtext">※ 売上合計 = メータのみ ＋ 貸切現金 ＋ 貸切未収 ＋ Uber予約/チップ/プロモ</div>
              </th>
              <th class="td-ops">操作</th>
              <th>備注</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
              <tr>
                <td class="td-date">{{ report.date|date:"Y年n月j日" }}</td>
                <td class="td-money">
                  <div class="fw-bold mono">￥&thinsp;{{ report.sales_total|default:0|intcomma }}</div>
                  <div class="subtext mono">（メータのみ: ￥&thinsp;{{ report.meter_only_total|default:0|intcomma }}）</div>
                </td>
                <td class="td-ops">
                  <a class="btn btn-link p-0" href="{% url 'vehicles:my_daily_report_detail' report.id %}">查看明細</a>
                </td>
                <td>{{ report.note|default:"" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center subtext py-4">暂无日报</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# ---------- 移动端：卡片 ---------- #}
  <div class="d-md-none">
    {% for report in reports %}
      <div class="card mb-2 mobile-card">
        <div class="card-body py-2">
          <div class="title mb-1">{{ report.date|date:"Y年n月j日" }}</div>
          <div class="mono">売上合計：￥{{ report.sales_total|default:0|intcomma }}</div>
          <div class="subtext mono">メータのみ：￥{{ report.meter_only_total|default:0|intcomma }}</div>
          {% if report.note %}
            <div class="text-muted small mt-1">備注：{{ report.note }}</div>
          {% endif %}
          <a class="btn btn-sm btn-outline-primary mt-2" href="{% url 'vehicles:my_daily_report_detail' report.id %}">查看明細</a>
        </div>
      </div>
    {% empty %}
      <div class="card">
        <div class="card-body text-center subtext">暂无日报</div>
      </div>
    {% endfor %}
  </div>

  {# ---------- 月度汇总 ---------- #}
  <div class="card mt-3">
    <div class="card-body">
      <div class="mb-2 mono">
        <strong>本月売上合計：</strong> ￥{{ monthly_sales_total|default:0|intcomma }} 円
      </div>

      <div class="mb-2 mono">
        <strong>本月メータのみ合計：</strong> ￥{{ monthly_meter_only_total|default:0|intcomma }} 円
        <span class="text-muted small">
          （原始メータ料金合計：￥{{ total_raw|floatformat:0|intcomma }} ｜ 分成後：￥{{ total_split|floatformat:0|intcomma }}）
        </span>
      </div>

      <div class="fw-semibold">出勤日数：{{ attendance_days }} 日</div>
      <div class="text-muted small mt-2">※ 有日报明细的日期计 1 天</div>
    </div>
  </div>

  <p class="mt-3"><a href="{% url 'profile' %}">← 返回我的资料</a></p>
</div>
{% endblock %}