{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}

<h2>ğŸ“‹ æˆ‘çš„é¢„çº¦è®°å½•</h2>

<table border="1">
  <tr>
    <th>è½¦è¾†</th>
    <th>æ—¶é—´æ®µ</th>
    <th>çŠ¶æ€</th>
    <th>æ“ä½œ</th>
  </tr>

  {% for r in reservations %}
  <tr>
    <td>{{ r.vehicle.license_plate }}</td>
    <td>
      {% include 'partials/_time_range_snippet.html' with obj=r %}
    </td>
    <td>{{ r.get_status_display }}</td>
    <td>
      {% if r.status == 'pending' %}
        <a href="{% url 'edit_reservation' r.id %}">âœï¸ ä¿®æ”¹</a> |
        <a href="{% url 'delete_reservation' r.id %}">âŒ åˆ é™¤</a>

      {% elif r.status == 'reserved' %}
        {% if not r.actual_departure %}
          {% if today == r.date and now.time >= r.start_time %}
            <button onclick="openTimePopup('{{ r.id }}', 'departure')">ğŸš— å‡ºåº“</button><br>
            <span style="color:gray;">âš ï¸ ä¸€å°æ—¶å†…ä¸ç‚¹å‡»å°†è‡ªåŠ¨å–æ¶ˆ</span>
          {% else %}
            <span style="color:gray;">â³ ç­‰å¾…å‡ºè½¦æ—¶é—´</span>
          {% endif %}
        {% elif not r.actual_return %}
          <button onclick="openTimePopup('{{ r.id }}', 'return')">ğŸ…¿ï¸ å…¥åº“</button><br>
          <span style="color:gray;">âš ï¸ è¶…è¿‡30åˆ†é’Ÿæœªå…¥åº“å°†è‡ªåŠ¨å»¶é•¿</span>
        {% else %}
          âœ… å‡ºå…¥åº“å®Œæˆ
        {% endif %}

      {% elif r.status == 'out' %}
        {% if not r.actual_return %}
          <button onclick="openTimePopup('{{ r.id }}', 'return')">ğŸ…¿ï¸ å…¥åº“</button>
        {% else %}
          âœ… å®Œæˆ
        {% endif %}

      {% elif r.status == 'canceled' %}
        âŒ å·²å–æ¶ˆ

      {% else %}
        -
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="4">æš‚æ— é¢„çº¦è®°å½•</td>
  </tr>
  {% endfor %}
</table>

<p><a href="{% url 'reservation_dashboard' %}">â† è¿”å›é¢„çº¦èœå•</a></p>

<!-- å¼¹çª—ï¼šå‡ºå…¥åº“æ—¶é—´ç¡®è®¤ -->
<div id="popup" style="display:none; position:fixed; top:30%; left:35%; background:#fff; border:1px solid #ccc; padding:20px; z-index:1000;">
  <form method="post" action="{% url 'confirm_check_io' %}">
    {% csrf_token %}
    <input type="hidden" name="reservation_id" id="popup_reservation_id">
    <input type="hidden" name="action_type" id="popup_action_type">
    <label>å®é™…æ—¶é—´ï¼š</label>
    <input type="datetime-local" name="actual_time" required>
    <br><br>
    <button type="submit">ç¡®è®¤</button>
    <button type="button" onclick="document.getElementById('popup').style.display='none'">å–æ¶ˆ</button>
  </form>
</div>

<script>
function openTimePopup(reservationId, actionType) {
  document.getElementById('popup_reservation_id').value = reservationId;
  document.getElementById('popup_action_type').value = actionType;
  document.getElementById('popup').style.display = 'block';
}
</script>

{% endblock %}
