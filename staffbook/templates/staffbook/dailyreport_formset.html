{% extends "staffbook/base_staffbook.html" %}
{% block extra_css %}
<style>
  .table tbody tr.has-note {
    background-color: #ffef9f !important;
  }
</style>
{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    .table tbody tr.has-note {
    background-color: #ffef9f !important;
  }

    td.has-note {
    background-color: #fff3cd;
    color: #000;
  }
  .auto-width-input {
    width: 2ch;
    min-width: 60px;
    max-width: 360px;
    box-sizing: content-box;
    transition: width 0.2s;
  }
  .mirror-span {
    position: absolute;
    visibility: hidden;
    white-space: pre;
    font: inherit;
  }
</style>

<div class="container">
  <h4><strong>{{ driver.name }}</strong>（{{ driver.driver_code }}）- 編集乗務日報</h4>
  <p class="text-muted">日付：{{ form.date.value }}</p>

  <form method="post" autocomplete="off">{% csrf_token %}
    {{ form.date.as_hidden }}
    <div class="mb-3">{{ form.note }}</div>

    <div class="row g-2 mb-3">
      <div class="col"><input class="form-control" id="total_meter" readonly placeholder="メータ合計"></div>
      <div class="col"><input class="form-control" id="total_uber" readonly placeholder="Uber合計"></div>
      <div class="col"><input class="form-control" id="total_cash" readonly placeholder="現金合計"></div>
      <div class="col"><input class="form-control" id="total_didi" readonly placeholder="Didi合計"></div>
      <div class="col"><input class="form-control" id="total_card" readonly placeholder="信用卡合計"></div>
      <div class="col"><input class="form-control" id="total_ticket" readonly placeholder="乘车券合計"></div>
      <div class="col"><input class="form-control" id="total_qr" readonly placeholder="扫码合計"></div>
    </div>

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>#</th><th>时间</th><th>乗車地</th><th>経由</th><th>降車地</th>
          <th>男</th><th>女</th><th>料金</th><th>支付</th><th>注释</th><th>操作</th>
        </tr>
      </thead>
     <tbody>
  {{ formset.management_form }}
  {% for form in formset.forms %}
    <tr class="report-item-row{% if form.note.value|stringformat:'s'|length > 0 %} has-note{% endif %}">
      {{ form.id }}
      <td>{{ forloop.counter }}</td>
      <td>{{ form.ride_time }}</td>
      <td>{{ form.ride_from }}</td>
      <td>{{ form.via }}</td>
      <td>{{ form.ride_to }}</td>
      <td>{{ form.num_male }}</td>
      <td>{{ form.num_female }}</td>
      <td>{{ form.meter_fee }}</td>
      <td>{{ form.payment_method }}</td>
      <td class="{% if form.note.value|stringformat:'s'|length > 0 %}has-note{% endif %}">
        {{ form.note }}
        {% if form.note.value|stringformat:'s'|length > 0 %}
          <span title="此单有备注" style="color: #d47d00; font-size:1.2em;">📝</span>
        {% endif %}
      </td>
      <td>
        {% if form.instance.pk %}
          {{ form.DELETE }} 删除
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-danger remove-row">移除</button>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
</tbody>
    </table>

    <button type="submit" class="btn btn-primary">💾 保存</button>
    <a href="{% url 'staffbook:driver_dailyreport_month' driver.id %}?month={{ report.date|date:'Y-m' }}" class="btn btn-secondary">← 返回</a>
  </form>

  <div class="text-center mt-3">
    <button id="add-row-btn" class="btn btn-outline-dark">➕ 增加一行</button>
  </div>
</div>

<script>
  // ➊ 自适应宽度
  document.querySelectorAll('.auto-width-input').forEach(function(input) {
    const span = document.createElement('span');
    span.className = 'mirror-span';
    document.body.appendChild(span);
    const sync = () => {
      span.style.font = window.getComputedStyle(input).font;
      span.textContent = input.value || input.placeholder || '';
      input.style.width = (span.offsetWidth + 20) + 'px';
    };
    sync();
    input.addEventListener('input', sync);
  });

  // ➋ 合计计算
  function updateTotals() {
    let sum = {meter:0, uber:0, cash:0, didi:0, credit:0, ticket:0, qr:0};
    document.querySelectorAll('tr.report-item-row').forEach(row => {
      const fee = parseFloat(row.querySelector('.meter-fee-input')?.value || 0);
      const pay = row.querySelector('.payment-method-select')?.value || '';
      sum.meter += fee;
      if (pay === 'uber') sum.uber += fee;
      else if (pay === 'cash') sum.cash += fee;
      else if (pay === 'didi') sum.didi += fee;
      else if (pay === 'credit') sum.credit += fee;
      else if (pay === 'ticket') sum.ticket += fee;
      else if (['barcode', 'wechat'].includes(pay)) sum.qr += fee;
    });
    document.getElementById('total_meter').value = sum.meter.toFixed(2);
    document.getElementById('total_uber').value = sum.uber.toFixed(2);
    document.getElementById('total_cash').value = sum.cash.toFixed(2);
    document.getElementById('total_didi').value = sum.didi.toFixed(2);
    document.getElementById('total_card').value = sum.credit.toFixed(2);
    document.getElementById('total_ticket').value = sum.ticket.toFixed(2);
    document.getElementById('total_qr').value = sum.qr.toFixed(2);
  }
  document.addEventListener('input', updateTotals);
  document.addEventListener('DOMContentLoaded', function(){
    flatpickr('.ride-time-input', {
      enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true
    });
    updateTotals();
  });

  // ➌ 增加一行
  document.getElementById('add-row-btn').onclick = () => {
    const total = document.querySelector('input[name$="-TOTAL_FORMS"]');
    if (parseInt(total.value) >= 40) return alert("最多 40 行");
    total.value = parseInt(total.value) + 1;
    document.forms[0].submit();
  };
</script>

{% endblock %}
