{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>车辆一周预约概览</h2>
<p>
  <a href="?offset={{ offset|add:"-1" }}">← 上一周</a> |
  <a href="?offset=0">本周</a> |
  <a href="?offset={{ offset|add:"1" }}">下一周 →</a>
</p>

<table border="1">
  <thead>
    <tr>
      <th>车牌号</th>
      {% for date in week_dates %}
        <th>{{ date|date:"m/d (D)" }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in vehicle_data %}
      <tr>
        <td>
          <a href="{% url 'vehicle_monthly_gantt' row.vehicle.id %}">
            {{ row.vehicle.license_plate }}
          </a>
        </td>
        {% for cell in row.days %}
          <td style="vertical-align: top; {% if cell.is_past %}color: #aaa;{% endif %}">
            {% if cell.reservations %}
              {# 已有人预约，列出所有 #}
              {% for res in cell.reservations %}
                <div>
                  <a href="{% url 'reservation_detail' res.id %}">
                    {{ res.start_time|time:"H:i" }}–{{ res.end_time|time:"H:i" }}
                    {{ res.driver.username }}
                  </a>
                </div>
              {% endfor %}
            {% else %}
              {# 空缺时才考虑能否显示“预约”按钮 #}
              {% if not cell.is_past %}
                {% if cell.date == now_dt|date:"Y-m-d"|date:"Y-m-d" %}
                  {# 今天这列，先看冷却时间 #}
                  {% if not cooldown_end or now_dt > cooldown_end %}
                    <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:"Y-m-d" }}">📝 空缺</a>
                  {% else %}
                    <span title="距离上次预约结束+10h 前仍不可再约">🔒 冷却中</span>
                  {% endif %}
                {% else %}
                  {# 非今天，直接允许预约 #}
                  <a href="{% url 'make_reservation' row.vehicle.id %}?date={{ cell.date|date:"Y-m-d" }}">📝 空缺</a>
                {% endif %}
              {% else %}
                空缺
              {% endif %}
            {% endif %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<p><a href="{% url 'vehicle_status' %}">← 返回状态页</a></p>
{% endblock %}
