
// ===== Driver DailyReport only: é¡µé¢é—¸é—¨ï¼ˆæ”¾åœ¨ dailyreport.js æœ€ä¸Šé¢ï¼‰=====
(function () {
  // ä»¥æ—¥æŠ¥è¡¨æ ¼æˆ–æ™ºèƒ½æç¤ºé¢æ¿ä¸ºâ€œæ ¹â€
  const DR_ROOT =
    document.querySelector("table.report-table") ||
    document.querySelector("#smart-hint-panel")?.closest("form");

  // ä¸æ˜¯æ—¥æŠ¥ç¼–è¾‘é¡µå°±ç›´æ¥é€€å‡º
  if (!DR_ROOT) {
    console.debug("dailyreport.js: not driver dailyreport page, abort.");
    return;
  }

  // è®©åé¢çš„ä»£ç èƒ½æ‹¿åˆ°æ ¹èŠ‚ç‚¹
  window.__DR_ROOT__ = DR_ROOT;
})();

// ============ å·¥å…·å‡½æ•°ï¼ˆå…¨å±€å¯ç”¨ï¼‰ ============
function getRow(el) { return el?.closest("tr.report-item-row"); }

// ============ ä¸»å—ï¼šå”¯ä¸€çš„ DOMContentLoaded ============
document.addEventListener('DOMContentLoaded', () => {
  // â€”â€” 1) flatpickr æ—¶é—´é€‰æ‹©å™¨ â€”â€”
  flatpickr(".time-input", {
    enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, locale: "ja"
  });

  // â€”â€” 2) å‹¤å‹™ / å®Ÿåƒ / æ®‹æ¥­æ—¶é—´ â€”â€” 
  function updateDuration() {
    const inEl = document.querySelector("input[name='clock_in']");
    const outEl = document.querySelector("input[name='clock_out']");
    const workDisplay = document.getElementById("work-duration");
    const actualDisplay = document.getElementById("actual-work-time");
    const overtimeDisplay = document.getElementById("overtime");
    const breakTimeDisplay = document.getElementById("break-time-display");
    const breakTimeHidden = document.getElementById("break-time-plus20");
    if (!inEl || !outEl) return;

    const [h1, m1] = (inEl.value || "00:00").split(":").map(Number);
    const [h2, m2] = (outEl.value || "00:00").split(":").map(Number);
    let d1 = new Date(0, 0, 0, h1, m1);
    let d2 = new Date(0, 0, 0, h2, m2);
    if (d2 <= d1) d2.setDate(d2.getDate() + 1);
    const workMin = Math.floor((d2 - d1) / 60000);

    let breakMin = 0;
    const breakEl = document.getElementById("break-time-input");
    if (breakEl && breakEl.value) {
      const [bh, bm] = breakEl.value.split(":").map(Number);
      breakMin = (bh || 0) * 60 + (bm || 0);
    }

    const realBreak = breakMin + 20;
    const actualMin = workMin - realBreak;
    const overtimeMin = actualMin - 480;

    const toHM = m => `${String(Math.floor(m / 60)).padStart(2,'0')}:${String(m % 60).padStart(2,'0')}`;
    workDisplay.textContent   = toHM(workMin);
    actualDisplay.textContent = toHM(actualMin);
    overtimeDisplay.textContent = (overtimeMin < 0 ? "-" : "") + toHM(Math.abs(overtimeMin));
    overtimeDisplay.style.color = overtimeMin >= 0 ? "red" : "blue";
    if (breakTimeDisplay) breakTimeDisplay.textContent = toHM(realBreak);
    if (breakTimeHidden)  breakTimeHidden.value = toHM(realBreak);
  }

  // â€”â€” 3) è¡Œå·ï¼ˆä»…æ˜¾ç¤ºï¼Œä¸æ”¹ name/indexï¼‰â€”â€”
  function updateRowNumbersAndIndexes() {
    const rows = Array.from(document.querySelectorAll("tr.report-item-row")).filter(r => r.style.display !== "none");
    rows.forEach((row, i) => { row.querySelector(".row-number")?.replaceChildren(document.createTextNode(i + 1)); });
  }

  // â€”â€” 4) å•è¡Œç»‘å®š â€”â€” 
  function bindRowEvents(row) {
    row.querySelectorAll(".time-input").forEach(el => {
      flatpickr(el, { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, locale: "ja" });
    });

    row.querySelectorAll(".delete-row").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!confirm("ç¡®å®šåˆ é™¤æ­¤è¡Œï¼Ÿ")) return;
        const cb = row.querySelector("input[name$='-DELETE']");
        if (cb) {
          cb.checked = true;
          row.style.display = "none";
          updateRowNumbersAndIndexes();
          updateTotals();
        }
      });
    });

    const checkbox = row.querySelector(".mark-checkbox");
    if (checkbox) {
      row.classList.toggle("has-note", checkbox.checked);
      checkbox.addEventListener("change", () => row.classList.toggle("has-note", checkbox.checked));
    }

    // åˆè®¡ä¸æ™ºèƒ½é¢æ¿ç»‘å®š
    const amountInput = row.querySelector("input[name$='-meter_fee']");
    const methodSelect = row.querySelector("select[name$='-payment_method']");
    const pendingCb    = row.querySelector("input[name$='-is_pending']") || row.querySelector(".pending-checkbox");
    const pendingHint  = row.querySelector(".pending-mini-hint");
    const charterAmountInput = row.querySelector(".charter-amount-input");
    const charterCheckbox    = row.querySelector("input[name$='-is_charter']");

    if (amountInput)  amountInput.addEventListener("input",  () => { updateTotals(); updateSmartHintPanel(); });
    if (methodSelect) methodSelect.addEventListener("change", () => { updateTotals(); updateSmartHintPanel(); });
    if (pendingCb) {
      pendingCb.addEventListener("change", () => {
        updateTotals();
        updateSmartHintPanel();
        if (pendingHint) pendingHint.classList.toggle("d-none", !pendingCb.checked);
      });
      if (pendingHint) pendingHint.classList.toggle("d-none", !pendingCb.checked); // é¦–å±å›æ˜¾
    }
    if (charterAmountInput) charterAmountInput.addEventListener("input", updateSmartHintPanel);
    if (charterCheckbox)    charterCheckbox.addEventListener("change", updateSmartHintPanel);
  }

  // â€”â€” 5) å…‹éš†æ¨¡æ¿ / æ’å…¥è¡Œ â€”â€” 
  function getDataTbody() {
  return document.querySelector("table.report-table > tbody#data-rows")
      || document.getElementById("data-rows")
      || null;
}
  function makeNewRowFromTemplate() {
    const totalEl  = document.querySelector("input[name$='-TOTAL_FORMS']");
    const template = document.getElementById("empty-form-template");
    if (!template || !totalEl) return null;
    const count = parseInt(totalEl.value, 10);
    const html = template.innerHTML.replace(/__prefix__/g, count).replace(/__num__/g, count + 1);
    const temp = document.createElement("tbody"); temp.innerHTML = html;
    return { tr: temp.querySelector("tr"), count };
  }
  document.getElementById("add-row-btn")?.addEventListener("click", () => {
    const tbody = getDataTbody(), totalEl = document.querySelector("input[name$='-TOTAL_FORMS']");
    if (!tbody || !totalEl) return;
    const created = makeNewRowFromTemplate(); if (!created) return;
    tbody.appendChild(created.tr);
    totalEl.value = String(parseInt(totalEl.value, 10) + 1);
    bindRowEvents(created.tr);
    updateRowNumbersAndIndexes();
    updateTotals(); updateSmartHintPanel();
  });
  document.querySelector("table.report-table")?.addEventListener("click", (e) => {
    if (!e.target.classList.contains("insert-below")) return;
    const tbody = getDataTbody(), totalEl = document.querySelector("input[name$='-TOTAL_FORMS']");
    if (!tbody || !totalEl) return;
    const created = makeNewRowFromTemplate(); if (!created) return;
    const currentRow = e.target.closest("tr");
    tbody.insertBefore(created.tr, currentRow.nextSibling);
    totalEl.value = String(parseInt(totalEl.value, 10) + 1);
    bindRowEvents(created.tr);
    updateRowNumbersAndIndexes();
    updateTotals(); updateSmartHintPanel();
  });

  // â€”â€” 6) è¯»å–/å†™å…¥å·¥å…· â€”â€” 
  function readIntById(id, fallback = 0) {
    const el = document.getElementById(id); if (!el) return fallback;
    const raw = el.value ?? el.textContent ?? `${fallback}`;
    const n = parseInt(raw, 10); return Number.isNaN(n) ? fallback : n;
  }

  // â€”â€” 7) ETC ç›¸å…³ â€”â€” 
  function updateEtcDifference() {
    const rideTotal = readIntById('id_etc_collected', 0);
    const hasNewEmpty = !!document.getElementById('id_etc_uncollected');
    let emptyAmount = hasNewEmpty ? readIntById('id_etc_uncollected', 0) : 0;
    const returnFee = hasNewEmpty ? readIntById('id_etc_return_fee_claimed', 0) : 0;
    const returnFeeMethod = hasNewEmpty ? (document.getElementById('id_etc_return_fee_method')?.value || 'none') : 'none';
    // è¯»å–ç©ºè»ŠETCç”¨å¡ï¼ˆæ¨¡æ¿é‡Œæ˜¯ id_etc_empty_cardï¼Œå€¼ä¸º company / ownï¼‰
    const emptyCardRaw = hasNewEmpty ? (document.getElementById('id_etc_empty_card')?.value || 'company') : 'company';
    // è§„èŒƒåŒ–åˆ°æ—§å£å¾„ï¼ˆcompany_card / personal_cardï¼‰
    const emptyCard = (emptyCardRaw === 'company') ? 'company_card' : 'personal_card';
    const coveredByCustomer = (returnFeeMethod === 'app_ticket') ? returnFee : 0;

    let etcUncollected = 0, etcDriverBurden = 0;
    if (hasNewEmpty) {
      if (emptyCard === 'company_card' || emptyCard === '') {
        etcUncollected  = Math.max(0, coveredByCustomer - emptyAmount);
        etcDriverBurden = Math.max(0, emptyAmount - coveredByCustomer);
      }
    } else {
      etcUncollected  = readIntById('id_etc_uncollected', 0);
      etcDriverBurden = readIntById('id_etc_shortage', 0);
    }

    const display = document.getElementById('etc-diff-display');
    if (display) {
      display.className = (etcDriverBurden > 0 || etcUncollected > 0) ? 'alert alert-warning' : 'alert alert-info';
      display.innerText = `æœªæ”¶ETCï¼š${etcUncollected.toLocaleString()} å††ï¼›å¸æœºè´Ÿæ‹…ï¼š${etcDriverBurden.toLocaleString()} å††`;
    }
    if (document.getElementById('id_etc_uncollected')) document.getElementById('id_etc_uncollected').value = etcUncollected;
    if (document.getElementById('id_etc_shortage')) {
      const el = document.getElementById('id_etc_shortage');
      el.value = etcDriverBurden;
      el.classList.toggle('text-danger', etcDriverBurden > 0);
      el.classList.toggle('fw-bold', etcDriverBurden > 0);
    }

    // åº”æ”¶åˆè®¡ï¼ˆæ˜¾ç¤ºï¼‰
    const etcExpected = (parseInt(document.getElementById('id_etc_collected')?.value || "0", 10) || 0)
                      + (parseInt(document.getElementById('id_etc_uncollected')?.value || "0", 10) || 0);
    const expectedDisplay = document.getElementById('etc-expected-output');
    if (expectedDisplay) expectedDisplay.value = etcExpected.toLocaleString();
    const hiddenExpected = document.getElementById('id_etc_expected');
    if (hiddenExpected) hiddenExpected.value = etcExpected;
  }
  function updateEtcShortage() { updateEtcDifference(); }
  function updateEtcInclusionWarning() {
    const deposit = readIntById('id_deposit_amount', readIntById('deposit-input', 0));
    const cashNagashi = readIntById('total_cash', 0);
    const charterCash = readIntById('charter-cash-total', 0);
    const etcRideCash = readIntById('id_etc_collected_cash', 0);
    const expected = cashNagashi + charterCash + etcRideCash;
    const diff = deposit - expected;
    const box = document.getElementById('etc-included-warning'); if (!box) return;
    if (Math.abs(diff) <= 100) {
      box.className = 'alert alert-success';
      box.innerText = `âœ… å…¥é‡‘é¡ãŒå¦¥å½“ã§ã™ã€‚åŸºæº–ï¼šç¾é‡‘(ãªãŒã—)+è²¸åˆ‡ç¾é‡‘+ä¹—è»ŠETCç¾é‡‘ = ${expected.toLocaleString()}å††`;
    } else if (diff > 100) {
      box.className = 'alert alert-warning';
      box.innerText = `âš ï¸ å…¥é‡‘é¡ãŒå¤šã„ã‚ˆã†ã§ã™ï¼ˆ+${diff.toLocaleString()}å††ï¼‰ã€‚ä¹—è»ŠETCç¾é‡‘ã‚„ç«¯æ•°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
    } else {
      box.className = 'alert alert-warning';
      box.innerText = `âš ï¸ å…¥é‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆ${diff.toLocaleString()}å††ï¼‰ã€‚ç¾é‡‘(ãªãŒã—)ãƒ»è²¸åˆ‡ç¾é‡‘ãƒ»ä¹—è»ŠETCç¾é‡‘ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚`;
    }
  }

  // â€”â€” 8) æ”¯ä»˜æ–¹å¼æ˜ å°„ â€”â€” 
  function resolveJsPaymentMethod(raw) {
    if (!raw) return "";
    const val = String(raw).trim();
    const exact = {
      cash:"cash", uber_cash:"cash", didi_cash:"cash", go_cash:"cash",
      uber:"uber", didi:"didi", go:"go",
      credit_card:"credit", kyokushin:"kyokushin", omron:"omron", kyotoshi:"kyotoshi", barcode:"qr", qr:"qr",
      "------":"", "--------":""
    };
    if (exact[val] !== undefined) return exact[val];
    const v = val.toLowerCase();
    if (val.includes("ç¾é‡‘")) return "cash";
    if (v.includes("uber")) return "uber";
    if (v.includes("didi") || v.includes("ï½„ï½‰ï½„ï½‰") || v.includes("di di")) return "didi";
    if (v === "go" || v === "ï½‡ï½" || /(^|\s)go(\s|$)/.test(v)) return "go";
    if (val.includes("ã‚¯ãƒ¬ã‚¸") || v.includes("credit")) return "credit";
    if (val.includes("äº¬äº¤ä¿¡")) return "kyokushin";
    if (val.includes("ã‚ªãƒ ãƒ­ãƒ³")) return "omron";
    if (val.includes("äº¬éƒ½å¸‚ä»–")) return "kyotoshi";
    if (val.includes("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰") || v.includes("paypay") || val.includes("å¾®ä¿¡") || val.includes("æ”¯ä»˜å®") || val.includes("æ‰«ç ") || v.includes("qr")) return "qr";
    return val;
  }

  // â€”â€” 9) åˆè®¡é€»è¾‘ï¼ˆä¸å¹¶ ETCï¼›è¿‡ä¸è¶³å«ä¹˜è½¦ ETC ç°é‡‘ï¼‰â€”â€”
  function updateTotals() {
    const totalMap = { cash:0, uber:0, didi:0, go:0, credit:0, kyokushin:0, omron:0, kyotoshi:0, qr:0 };
    let totalMeterOnly = 0, charterCashTotal = 0, charterUncollectedTotal = 0;

    document.querySelectorAll(".report-item-row").forEach(row => {
      const isPending = (row.querySelector("input[name$='-is_pending']") || row.querySelector(".pending-checkbox"))?.checked;
      if (isPending) return;

      const fee = parseInt(row.querySelector(".meter-fee-input")?.value || "0", 10);
      const payment = row.querySelector("select[name$='payment_method']")?.value || "";
      const isCharter = row.querySelector("input[name$='is_charter']")?.checked;
      const charterAmount = parseInt(row.querySelector(".charter-amount-input")?.value || "0", 10);
      const charterPayMethod = row.querySelector(".charter-payment-method-select")?.value || "";

      if (!isCharter) totalMeterOnly += fee;

      const method = resolveJsPaymentMethod(payment);
      if (!isCharter && fee > 0 && Object.prototype.hasOwnProperty.call(totalMap, method)) {
        totalMap[method] += fee;
      }

      const CASH = ['jpy_cash','rmb_cash','self_wechat','boss_wechat'];
      const UNCOLLECTED = ['to_company','bank_transfer',''];
      if (isCharter && charterAmount > 0) {
        if (CASH.includes(charterPayMethod)) charterCashTotal += charterAmount;
        else if (UNCOLLECTED.includes(charterPayMethod)) charterUncollectedTotal += charterAmount;
      }
    });

    // æ¸²æŸ“å„é¡¹
    const meterSum = Object.values(totalMap).reduce((a,b)=>a+b,0);
    const salesTotal = meterSum + charterCashTotal + charterUncollectedTotal;

    const idText = (id, n) => { const el = document.getElementById(id); if (el) el.textContent = Number(n||0).toLocaleString(); };
    idText("total_meter_only", meterSum);
    idText("total_meter", salesTotal);
    idText("sales-total", salesTotal);
    idText("total_cash", totalMap.cash);
    idText("total_credit", totalMap.credit);
    idText("charter-cash-total", charterCashTotal);
    idText("charter-uncollected-total", charterUncollectedTotal);
    Object.entries(totalMap).forEach(([k,v]) => idText(`total_${k}`, v));

    // æ‰‹æ•°æ–™/åˆ†æˆ
    const rateOf = (k) => (window.PAYMENT_RATES && window.PAYMENT_RATES[k] != null) ? Number(window.PAYMENT_RATES[k]) : 0;
    ['credit','qr','kyokushin','omron','kyotoshi','uber','didi','go'].forEach(k=>{
      const el = document.getElementById(`bonus_${k}`); if (!el) return;
      el.textContent = Math.round(Number(totalMap[k]||0) * rateOf(k)).toLocaleString();
    });
    const bonusCashEl = document.getElementById('bonus_cash'); if (bonusCashEl) bonusCashEl.textContent = '0';

    // è¿‡ä¸è¶³
    const depositInput = parseInt(document.getElementById("deposit-input")?.value || "0", 10);
    const shortage = depositInput - totalMap.cash - charterCashTotal;
    const diffEl = document.getElementById("difference-output")
      || document.getElementById("deposit-difference")
      || document.getElementById("shortage-diff");
    if (diffEl) diffEl.textContent = shortage.toLocaleString();
  }

  // â€”â€” 10) æ™ºèƒ½æç¤ºé¢æ¿ â€”â€” 
  function updateSmartHintPanel() {
    const panel = document.querySelector("#smart-hint-panel"); if (!panel) return;

    const cashTotal     = parseInt(document.querySelector("#total_cash")?.textContent || "0", 10);
    const etcCollected  = parseInt(document.querySelector("#id_etc_collected")?.value || "0", 10);
    const etcUncollected= parseInt(document.querySelector("#id_etc_uncollected")?.value || "0", 10);
    const totalSales    = parseInt(document.querySelector("#total_meter")?.textContent || "0", 10);
    const deposit       = parseInt(document.querySelector("#deposit-input")?.value || "0", 10);
    const totalCollected = cashTotal + etcCollected;

    // å¾…å…¥ç»Ÿè®¡
    const toInt = v => { const n = parseInt(String(v??"").replace(/[^\d-]/g,""),10); return Number.isFinite(n)?n:0; };
    const pendingRows = Array.from(document.querySelectorAll(
      ".report-item-row input[name$='-is_pending']:checked, .report-item-row .pending-checkbox:checked"
    )).map(cb => cb.closest("tr.report-item-row")).filter(Boolean);
    const pendingCount = pendingRows.length;
    let pendingSum = 0;
    pendingRows.forEach(row => {
      const isCharter = !!row.querySelector("input[name$='-is_charter']")?.checked;
      pendingSum += toInt(isCharter ? row.querySelector(".charter-amount-input")?.value : row.querySelector(".meter-fee-input")?.value);
    });

    let html = "";
    if (pendingCount > 0) {
      html += `
      <div class="alert alert-info py-1 px-2 small mb-2">
        â„¹ï¸ ç¾åœ¨æœ‰ <strong>${pendingCount}</strong> ç­†ã€Œå¾…å…¥ã€ï¼Œåˆè¨ˆ <strong>${pendingSum.toLocaleString()}å††</strong>ã€‚
        é€™äº›æ˜ç´°æš«ä¸è¨ˆå…¥å£²ä¸Šåˆè¨ˆï¼›å…¥å¸³å¾Œå–æ¶ˆå‹¾é¸å³å¯ç«‹å³ç´å…¥æ ¸ç®—ã€‚
      </div>`;
    }
    if (deposit < totalCollected) {
      html += `<div class="alert alert-danger py-1 px-2 small mb-2">
        âš ï¸ å…¥é‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è«‹æ±‚é¡ï¼ˆç¾é‡‘ + ETCï¼‰ã¯ <strong>${totalCollected.toLocaleString()}å††</strong>ï¼Œ
        å…¥é‡‘ã¯ <strong>${deposit.toLocaleString()}å††</strong> ã§ã™ã€‚
      </div>`;
    } else {
      html += `<div class="alert alert-success py-1 px-2 small mb-2">âœ”ï¸ å…¥é‡‘é¡ã¯ç¾é‡‘ + ETC ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã¾ã™ã€‚</div>`;
    }
    if (etcUncollected > 0) {
      html += `<div class="alert alert-info py-1 px-2 small mb-2">ğŸš§ ETC æœªæ”¶ï¼š<strong>${etcUncollected.toLocaleString()}å††</strong>ã€‚è¯·ç¡®è®¤å¸æœºæ˜¯å¦å·²è¡¥æ”¶ã€‚</div>`;
    }
    if (deposit < totalSales) {
      html += `<div class="alert alert-warning py-1 px-2 small mb-2">
        â„¹ï¸ å£²ä¸Šåˆè¨ˆ <strong>${totalSales.toLocaleString()}å††</strong> å¤§äºå…¥é‡‘ <strong>${deposit.toLocaleString()}å††</strong>ï¼Œå¯èƒ½åŒ…å«æœªæ”¶ ETCã€æˆ–å…¶ä»–å»¶è¿Ÿç»“ç®—é¡¹ã€‚
      </div>`;
    }
    panel.innerHTML = html;
  }

  // â€”â€” 11) è²¸åˆ‡ï¼šè¡ŒçŠ¶æ€æ§åˆ¶ & é¦–æ¬¡è¿›åœºåªè¯»æ€ â€”â€” 
  function applyCharterState(row, isCharter) {
    if (!row) return;
    const meterInput           = row.querySelector(".meter-fee-input");
    const charterAmountInput   = row.querySelector(".charter-amount-input");
    const charterPaymentSelect = row.querySelector(".charter-payment-method-select");
    if (meterInput) {
      meterInput.removeAttribute('disabled');
      if (!meterInput.dataset.originalValue) meterInput.dataset.originalValue = meterInput.value || "";
      if (isCharter) {
        meterInput.setAttribute('readonly','readonly');
        meterInput.classList.add('readonly');
        meterInput.value = meterInput.dataset.originalValue;
      } else {
        meterInput.removeAttribute('readonly');
        meterInput.classList.remove('readonly');
      }
    }
    if (!isCharter) {
      if (charterAmountInput) {
        charterAmountInput.value = "";
        charterAmountInput.dispatchEvent(new Event('input',  { bubbles: true }));
        charterAmountInput.dispatchEvent(new Event('change', { bubbles: true }));
      }
      if (charterPaymentSelect) {
        charterPaymentSelect.value = "";
        charterPaymentSelect.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }
    updateTotals();
  }
  function hydrateAllCharterRows() {
    document.querySelectorAll("input[type='checkbox'][name$='-is_charter']")
      .forEach(chk => applyCharterState(getRow(chk), chk.checked));
  }

  // â€”â€” 12)ã€æ”¾è¿™é‡Œã€‘ä¸¤ä¸ªâ€œå…¨å±€â€change ç›‘å¬å™¨ï¼ˆå¹¶å…¥åŒä¸€ä½œç”¨åŸŸï¼‰â€”â€”

  // 12-1 å‹¾é€‰ã€Œè²¸åˆ‡ã€ï¼šå¤åˆ¶é‡‘é¢/æ–¹å¼ + åŒæ­¥
  document.addEventListener("change", function (e) {
    const el = e.target;
    if (!el.matches("input[type='checkbox'][name$='-is_charter']")) return;

    const row = getRow(el); if (!row) return;
    const meterInput           = row.querySelector(".meter-fee-input");
    const paySelect            = row.querySelector(".payment-method-select");
    const charterAmountInput   = row.querySelector(".charter-amount-input");
    const charterPaymentSelect = row.querySelector(".charter-payment-method-select");

    const toInt = (v) => { const n = parseInt(String(v ?? "").replace(/[^\d-]/g, ""), 10); return Number.isFinite(n) ? n : 0; };
    const isCashLike = (v) => (v || "").toLowerCase().includes("cash") || /ç¾é‡‘/.test(v || "");

    if (el.checked) {
      const feeInt = toInt(meterInput ? meterInput.value : 0);
      if (charterAmountInput) charterAmountInput.value = String(feeInt);
      if (charterPaymentSelect) {
        const pm = paySelect?.value || "";
        charterPaymentSelect.value = isCashLike(pm) ? "jpy_cash" : "to_company";
      }
      applyCharterState(row, true);
      if (meterInput) {
        meterInput.readOnly = true;
        meterInput.classList.add("disabled");
        meterInput.value = String(feeInt);
      }
      if (paySelect && !isCashLike(paySelect.value)) {
        const cashOpt = Array.from(paySelect.options || []).find(
          (o) => isCashLike(o.value) || isCashLike(o.textContent)
        );
        if (cashOpt) {
          paySelect.value = cashOpt.value;
          paySelect.dispatchEvent(new Event("change", { bubbles: true }));
        }
      }
      if (!row.dataset.charterSyncBound) {
        row.dataset.charterSyncBound = "1";
        if (meterInput && charterAmountInput) {
          const syncAmount = () => { if (!el.checked) return; charterAmountInput.value = String(toInt(meterInput.value)); updateTotals(); };
          meterInput.addEventListener("input", syncAmount);
          meterInput.addEventListener("change", syncAmount);
        }
        if (paySelect && charterPaymentSelect) {
          const syncPM = () => { if (!el.checked) return; const pm2 = paySelect.value || ""; charterPaymentSelect.value = isCashLike(pm2) ? "jpy_cash" : "to_company"; updateTotals(); };
          paySelect.addEventListener("change", syncPM);
        }
      }
    } else {
      applyCharterState(row, false);
      if (meterInput) {
        meterInput.readOnly = false;
        meterInput.classList.remove("disabled");
        meterInput.value = String(toInt(meterInput.value));
      }
      if (charterAmountInput) charterAmountInput.value = String(toInt(charterAmountInput.value));
    }
    updateTotals();
    updateSmartHintPanel();
  });

  // 12-2 å¾…å…¥æç¤º + æ™ºèƒ½é¢æ¿å…œåº•
  document.addEventListener("change", (e) => {
    const t = e.target;
    if (t.matches("input[name$='-is_pending'], .pending-checkbox")) {
      const row  = getRow(t);
      const hint = row?.querySelector(".pending-mini-hint");
      if (hint) hint.classList.toggle("d-none", !t.checked);
      updateTotals();
    }
    if (
      t.matches("input[name$='-is_pending'], .pending-checkbox") ||
      t.matches("input[name$='-is_charter']") ||
      t.matches(".charter-amount-input") ||
      t.matches(".meter-fee-input")
    ) {
      updateSmartHintPanel();
    }
  });

  // â€”â€” 13) é¦–å±å›æ˜¾ï¼ˆä¸€æ¬¡ï¼‰â€”â€”
  document.querySelectorAll("tr.report-item-row").forEach((row) => {
    const cb   = row.querySelector("input[name$='-is_pending'], .pending-checkbox");
    const hint = row.querySelector(".pending-mini-hint");
    if (cb && hint) hint.classList.toggle("d-none", !cb.checked);
  });

  // â€”â€” 14) å…¶ä»–è¾“å…¥ç›‘å¬ â€”â€” 
  [
    ['id_etc_collected_cash', [updateEtcDifference, updateEtcShortage]],
    ['id_etc_uncollected',    [updateEtcDifference, updateEtcShortage]],
    ['id_etc_collected',      [updateEtcInclusionWarning, updateEtcShortage, updateTotals]],
    ['id_deposit_amount',     [updateEtcDifference, updateEtcInclusionWarning]],
    ['clock_in',              [updateDuration]],
    ['clock_out',             [updateDuration]],
    ['break-time-input',      [updateDuration]],
    ['id_etc_empty_card', [updateTotals]],
  ].forEach(([id, fns]) => {
    const el = document.getElementById(id);
    if (el) fns.forEach(fn => el.addEventListener("input", fn));
  });

  // â€”â€” 15) åˆå§‹æ‰§è¡Œ â€”â€” 
  updateDuration();
  updateEtcDifference();
  updateEtcShortage();
  updateEtcInclusionWarning();
  updateRowNumbersAndIndexes();
  updateTotals();
  updateSmartHintPanel();

  // â€”â€” 16) å¯¼å‡ºç»™å¤–éƒ¨ï¼ˆå…¶ä»–è„šæœ¬/æäº¤æ’åº IIFE ä¼šç”¨åˆ°ï¼‰â€”â€”
  window.updateTotals = updateTotals;
  window.updateSmartHintPanel = updateSmartHintPanel;
  window.updateRowNumbersAndIndexes = updateRowNumbersAndIndexes;
  window.hydrateAllCharterRows = hydrateAllCharterRows;

  // â€”â€” 17) è¿›åœºï¼šæŒ‰å½“å‰å‹¾é€‰çŠ¶æ€å¥—åªè¯»ç°æ€ â€”â€” 
  hydrateAllCharterRows();
});

// ============ å¤œç­æ’åºï¼ˆä¿æŒåŸæœ‰ IIFEï¼›æäº¤æ—¶æ’åº DOMï¼Œä¸æ”¹ name/indexï¼‰ ============
(function () {
  function parseHHMM(str) {
    if (!str) return null;
    const m = String(str).trim().match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    const h  = Math.min(23, Math.max(0, parseInt(m[1], 10)));
    const mm = Math.min(59, Math.max(0, parseInt(m[2], 10)));
    return h * 60 + mm;
  }
  function getAnchorMinutes() {
    const el = document.querySelector("input[name='clock_in']") || document.getElementById("id_clock_in");
    const v  = el && el.value ? el.value : "12:00";
    const m  = parseHHMM(v);
    return m == null ? 12 * 60 : m;
  }
  function sortRowsByTime() {
    const anchor = getAnchorMinutes();
    const tbody  = document.querySelector("table.report-table tbody:not(#empty-form-template)");
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll("tr.report-item-row"));
    const pairs = rows.map(row => {
      const t = (row.querySelector("input[name$='-ride_time']") || row.querySelector(".ride-time-input") || row.querySelector(".time-input"))?.value || "";
      let mins = parseHHMM(t);
      if (mins == null) mins = Number.POSITIVE_INFINITY;
      else if (mins < anchor) mins += 24 * 60;
      return { row, key: mins };
    });
    pairs.sort((a, b) => a.key - b.key).forEach(p => tbody.appendChild(p.row));
    let idx = 1; pairs.forEach(p => { const num = p.row.querySelector(".row-number"); if (num) num.textContent = idx++; });
  }
  window.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector('form[method="post"]'); if (!form) return;
    form.addEventListener('submit', () => {
      sortRowsByTime();
      if (typeof updateRowNumbersAndIndexes === 'function') updateRowNumbersAndIndexes();
    });
  });
})();

// ============ æäº¤å‰å…œåº•ï¼šé‡‘é¢ç©ºä¸²â†’"0" ============
(function () {
  const form = document.querySelector("form"); if (!form) return;
  form.addEventListener("submit", function () {
    const sel = [".meter-fee-input",".charter-amount-input",".deposit-input",".toll-input"].join(",");
    document.querySelectorAll(sel).forEach((inp) => {
      if (!inp) return;
      const v = inp.value;
      if (v === "" || v == null) { inp.value = "0"; }
      else {
        const n = parseInt(String(v).replace(/[^\d-]/g, ""), 10);
        inp.value = Number.isFinite(n) ? String(n) : "0";
      }
    });
  });
})();
// === æŒ‡å®šè¡Œã«æŒ¿å…¥ãƒœã‚¿ãƒ³ ===
// å…¥åŠ›ã•ã‚ŒãŸè¡Œç•ªå· Nï¼ˆ1 å§‹ã¾ã‚Šï¼‰ã®è¡Œã‚’è¦‹ã¤ã‘ã¦ã€ãã®è¡Œã®ã€Œ.insert-belowã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚
// æ—¢å­˜ã®æŒ¿å…¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ã™ã‚‹ã ã‘ãªã®ã§å‰¯ä½œç”¨ãŒãªã„ã€‚
document.addEventListener('DOMContentLoaded', function () {
  var goBtn    = document.getElementById('insert-at-btn');
  var idxInput = document.getElementById('insert-index-input');
  if (!goBtn || !idxInput) return;

  goBtn.addEventListener('click', function () {
    var v = parseInt(idxInput.value, 10);
    if (!v || v < 1) { alert('è¡Œç•ªå·ã¯ 1 ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    // ã€ŒæŒ¿å…¥å¯èƒ½ãªè¡Œã€ã‚’æŠ½å‡ºï¼ˆ.insert-below ãŒã‚ã‚‹è¡Œï¼‰
    var rows = Array.from(document.querySelectorAll('table tbody tr'))
      .filter(function (r) { return r.querySelector('.insert-below'); });

    if (!rows.length) { alert('æŒ¿å…¥å¯èƒ½ãªè¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    // ç¯„å›²å¤–ã¯æœ€å¾Œã®è¡Œã«ä¸¸ã‚ã‚‹
    var i = Math.min(v, rows.length);
    var target = rows[i - 1];
    var btn = target.querySelector('.insert-below');
    if (btn) btn.click(); else alert('å¯¾è±¡è¡Œã®æŒ¿å…¥ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  });
});

/* === æŒ‡å®šè¡Œã«æŒ¿å…¥ï¼šå³æ™‚ãƒã‚¤ãƒ³ãƒ‰ï¼ˆDOMContentLoaded æ¸ˆã¿ã§ã‚‚å‹•ãï¼‰ === */
(function () {
  function bindInsertAt() {
    var goBtn    = document.getElementById('insert-at-btn');
    var idxInput = document.getElementById('insert-index-input');
    if (!goBtn || !idxInput) return;

    // é‡å¤ç»‘å®šä¿æŠ¤
    if (goBtn.dataset.boundInsertAt === '1') return;
    goBtn.dataset.boundInsertAt = '1';

    goBtn.addEventListener('click', function () {
      var v = parseInt(idxInput.value, 10);
      if (!v || v < 1) { alert('è¡Œç•ªå·ã¯ 1 ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      // ä»…ç»Ÿè®¡çœŸæ­£çš„æ•°æ®è¡Œ
      var rows = Array.from(document.querySelectorAll('table.report-table tbody tr.report-item-row'));

      // è‹¥å½“å‰æ²¡æœ‰ä»»ä½•è¡Œï¼Œå…ˆç‚¹â€œæ–°å¢ä¸€è¡Œâ€
      if (rows.length === 0) {
        var addBtn = document.getElementById('add-row-btn');
        if (addBtn) addBtn.click();
        // å†å–ä¸€æ¬¡
        rows = Array.from(document.querySelectorAll('table.report-table tbody tr.report-item-row'));
      }

      if (!rows.length) { alert('æŒ¿å…¥å¯èƒ½ãªè¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      var i = Math.min(v, rows.length);
      var target = rows[i - 1];
      var btn = target.querySelector('.insert-below');

      if (btn) {
        btn.click();            // å¤ç”¨æ—¢æœ‰æ’å…¥é€»è¾‘
      } else {
        // æç«¯æƒ…å†µä¸‹è¯¥è¡Œæ²¡æœ‰æŒ‰é’®ï¼Œåˆ™é€€åŒ–ä¸ºâ€œæ–°å¢ä¸€è¡Œâ€ï¼ˆæ’åˆ°æœ«å°¾ï¼‰
        var addBtn2 = document.getElementById('add-row-btn');
        if (addBtn2) addBtn2.click();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindInsertAt);
  } else {
    // DOM å·²ç» readyï¼Œç«‹åˆ»ç»‘å®š
    bindInsertAt();
  }
})();

/* === å…œåº•ï¼šä» #empty-form-template å…‹éš†ä¸€è¡Œï¼Œå¹¶æ’å…¥åˆ°ç¬¬ N è¡Œä¹‹å === */
(function () {
  function getDataTbody() {
  return document.querySelector("table.report-table > tbody#data-rows")
      || document.getElementById("data-rows")
      || null;
}) || null;
  }
  function cloneRowFromTemplate() {
    var tpl = document.getElementById('empty-form-template');
    var total = document.querySelector("input[name$='-TOTAL_FORMS']");
    if (!tpl || !total) return null;
    var count = parseInt(total.value || '0', 10);
    var html  = tpl.innerHTML.replace(/__prefix__/g, count).replace(/__num__/g, count + 1);
    var tmp   = document.createElement('tbody');
    tmp.innerHTML = html;
    var tr = tmp.querySelector('tr');
    total.value = String(count + 1);
    return tr;
  }
  // æš´éœ²ç»™æŒ‰é’®å¤„ç†é€»è¾‘ä½¿ç”¨
  window.__DR_cloneRowAfter__ = function (n) {
    // n: 1 èµ·å§‹çš„â€œç›®æ ‡è¡Œå·â€ï¼Œåœ¨å®ƒä¹‹åæ’å…¥
    var rows = Array.from(document.querySelectorAll('table.report-table tbody tr.report-item-row'));
    var tb   = getDataTbody();
    if (!tb) return false;

    if (rows.length === 0) {
      // æ²¡æœ‰ä»»ä½•æ•°æ®è¡Œï¼šç›´æ¥åœ¨æœ«å°¾æ·»åŠ ä¸€è¡Œ
      var tr0 = cloneRowFromTemplate();
      if (tr0) { tb.appendChild(tr0); return true; }
      return false;
    }

    var i = Math.min(Math.max(1, n), rows.length); // clamp åˆ° [1, rows.length]
    var target = rows[i - 1];
    var newTr  = cloneRowFromTemplate();
    if (!newTr) return false;

    // æ’å…¥åˆ°ç›®æ ‡è¡Œã€Œä¹‹åã€
    (target.closest("tbody")||tb).insertBefore(newTr, target.nextSibling);
    if (typeof bindRowEvents === "function") bindRowEvents(newTr);
    if (window.updateRowNumbersAndIndexes) window.updateRowNumbersAndIndexes();
    if (window.updateTotals) window.updateTotals();
    if (window.updateSmartHintPanel) window.updateSmartHintPanel();
    return true;
  };
})();

/* === æŒ‡å®šè¡Œã«æŒ¿å…¥ï¼šä¼˜å…ˆè§¦å‘ .insert-belowï¼›æ²¡æœ‰åˆ™å…‹éš†æ¨¡æ¿æ’å…¥ === */
(function () {
  function bindInsertAtSmart() {
    var btn = document.getElementById('insert-at-btn');
    var input = document.getElementById('insert-index-input');
    if (!btn || !input) return;
    if (btn.dataset.boundSmart === '1') return;
    btn.dataset.boundSmart = '1';

    btn.addEventListener('click', function () {
      var v = parseInt(input.value, 10);
      if (!v || v < 1) { alert('è¡Œç•ªå·ã¯ 1 ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      // å…ˆå°è¯•ç°æœ‰è¡Œçš„ .insert-below
      var rows = Array.from(document.querySelectorAll('table.report-table tbody tr.report-item-row'));
      if (rows.length) {
        var i = Math.min(v, rows.length);
        var target = rows[i - 1];
        var belowBtn = target.querySelector('.insert-below');
        if (belowBtn) {
          belowBtn.click(); // å¤ç”¨ä½ å·²æœ‰çš„æ’å…¥é€»è¾‘
          return;
        }
      }

      // å…œåº•ï¼šæ²¡æœ‰ .insert-belowï¼Œå°±ç›´æ¥å…‹éš†æ¨¡æ¿æ’å…¥åˆ°ç¬¬ v è¡Œä¹‹å
      if (typeof window.__DR_cloneRowAfter__ === 'function') {
        var ok = window.__DR_cloneRowAfter__(v);
        if (!ok) alert('è¡Œã‚’æŒ¿å…¥ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ï¼‰');
      } else {
        alert('æŒ¿å…¥ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindInsertAtSmart);
  } else {
    bindInsertAtSmart();
  }
})();

// === æœ€ç»ˆå…œåº•ï¼šä¸€å¾‹åœ¨ç¬¬ 1 è¡Œåæ’å…¥ ===
(function () {
  function getDataTbody() {
  return document.querySelector("table.report-table > tbody#data-rows")
      || document.getElementById("data-rows")
      || null;
}) || null;
  }
  function cloneRowFromTemplateBare() {
    var tpl = document.getElementById('empty-form-template');
    var total = document.querySelector("input[name$='-TOTAL_FORMS']");
    if (!tpl || !total) return null;
    var count = parseInt(total.value || '0', 10);
    var html  = tpl.innerHTML.replace(/__prefix__/g, count).replace(/__num__/g, count + 1);
    var tmp   = document.createElement('tbody');
    tmp.innerHTML = html;
    var tr = tmp.querySelector('tr');
    total.value = String(count + 1);
    return tr;
  }
  function insertAfterFirstRow() {
    // ä¼˜å…ˆç”¨ä½ å·²æœ‰çš„å‡½æ•°
    if (typeof window.__DR_cloneRowAfter__ === 'function') {
      return !!window.__DR_cloneRowAfter__(1);
    }
    // å…œåº•ï¼šç›´æ¥å…‹éš†å¹¶æ’å…¥
    var tb   = getDataTbody();
    var rows = Array.from(document.querySelectorAll('table.report-table tbody tr.report-item-row'));
    if (!tb) return false;

    var newTr = cloneRowFromTemplateBare();
    if (!newTr) return false;

    if (rows.length > 0) {
      var target = rows[0];
      (target.parentNode || tb).insertBefore(newTr, target.nextSibling);
    } else {
      tb.appendChild(newTr);
    }
    // ç»‘å®šä¸åˆ·æ–°ï¼ˆè‹¥è¿™äº›å‡½æ•°å­˜åœ¨å°±è°ƒç”¨ï¼‰
    if (typeof bindRowEvents === "function") bindRowEvents(newTr);
    if (window.updateRowNumbersAndIndexes) window.updateRowNumbersAndIndexes();
    if (window.updateTotals) window.updateTotals();
    if (window.updateSmartHintPanel) window.updateSmartHintPanel();
    // ä½“éªŒï¼šæ»šåŠ¨å¹¶èšç„¦
    newTr.scrollIntoView({behavior:'smooth', block:'center'});
    (newTr.querySelector('.time-input') || newTr.querySelector('input,select'))?.focus?.();
    return true;
  }

  // ç”¨äº‹ä»¶ä»£ç†æ•è·ç‚¹å‡»ï¼›å³ä½¿æŒ‰é’®åæ¥è¢«é‡ç»˜ä¹Ÿæœ‰æ•ˆ
  document.addEventListener('click', function (e) {
    var btn = e.target && e.target.closest && e.target.closest('#insert-at-btn');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    insertAfterFirstRow();
  });
})();

// --- æœ€ç»ˆå…œåº•ï¼ˆæ•è·é˜¶æ®µï¼‰ï¼šä¸å¡«ä¹Ÿé»˜è®¤åœ¨ç¬¬1è¡Œåæ’å…¥ ---
document.addEventListener('click', function (e) {
  var btn = e.target && e.target.closest && e.target.closest('#insert-at-btn');
  if (!btn) return;

  // é»˜è®¤ç½® 1ï¼Œæ‹¦æˆªæ—§ç›‘å¬å™¨
  var idx = document.getElementById('insert-index-input');
  if (idx) idx.value = '1';
  e.preventDefault();
  e.stopPropagation();
  if (e.stopImmediatePropagation) e.stopImmediatePropagation();

  // ç›´æ¥åœ¨ç¬¬1è¡Œåæ’å…¥ï¼ˆå·²å­˜åœ¨çš„å…¨å±€å‡½æ•°ï¼‰
  if (typeof window.__DR_cloneRowAfter__ === 'function') {
    window.__DR_cloneRowAfter__(1);
  } else {
    console.warn('__DR_cloneRowAfter__ not found');
  }
}, true); // â˜… æ•è·é˜¶æ®µ

// --- æœ€ç»ˆå…œåº•ï¼ˆæ•è·é˜¶æ®µï¼Œç‹¬ç«‹å®ç°ï¼‰ï¼šä¸å¡«ä¹Ÿé»˜è®¤åœ¨ç¬¬1è¡Œåæ’å…¥ ---
document.addEventListener("click", function (e) {
  var btn = e.target && e.target.closest && e.target.closest("#insert-at-btn");
  if (!btn) return;

  // é»˜è®¤æŠŠè¾“å…¥æ¡†ç½®ä¸º '1'ï¼Œå¹¶æ‹¦æˆªå…¶å®ƒç›‘å¬å™¨
  var idx = document.getElementById("insert-index-input");
  if (idx) idx.value = "1";
  e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation();

  // å–æ•°æ® tbodyï¼ˆæ’é™¤ #empty-form-templateï¼‰
  var tb = document.querySelector("table.report-table > tbody:not(#empty-form-template)");
  if (!tb) {
    var bodies = Array.from(document.querySelectorAll("table.report-table > tbody"));
    tb = bodies.find(function(b){ return b.id !== "empty-form-template"; }) || null;
  }
  if (!tb) return;

  // å…‹éš†æ¨¡æ¿
  var tpl   = document.getElementById("empty-form-template");
  var total = document.querySelector("input[name$='-TOTAL_FORMS']");
  if (!tpl || !total) return;
  var count = parseInt(total.value || "0", 10) || 0;
  var html  = tpl.innerHTML.replace(/__prefix__/g, count).replace(/__num__/g, count + 1);
  var tmp   = document.createElement("tbody"); tmp.innerHTML = html;
  var newTr = tmp.querySelector("tr"); if (!newTr) return;
  total.value = String(count + 1);

  // åœ¨ç¬¬1è¡Œåæ’å…¥ï¼ˆè‹¥å½“å‰æ— è¡Œåˆ™ append åˆ°æœ«å°¾ï¼‰
  var rows = Array.from(document.querySelectorAll("table.report-table tbody tr.report-item-row"));
  if (rows.length > 0) {
    var target = rows[0];
    (target.parentNode || tb).insertBefore(newTr, target.nextSibling);
  } else {
    tb.appendChild(newTr);
  }

  // ç»‘å®šäº‹ä»¶ & åˆ·æ–°
  if (typeof bindRowEvents === "function") bindRowEvents(newTr);
  if (window.updateRowNumbersAndIndexes) window.updateRowNumbersAndIndexes();
  if (window.updateTotals) window.updateTotals();
  if (window.updateSmartHintPanel) window.updateSmartHintPanel();

  // ä½“éªŒï¼šæ»šåŠ¨å¹¶èšç„¦
  newTr.scrollIntoView({behavior:"smooth", block:"center"});
  (newTr.querySelector(".time-input") || newTr.querySelector("input,select"))?.focus?.();
}, true);

// --- è¿›åœºå¼ºåˆ¶æŠŠè¾“å…¥æ¡†é»˜è®¤å€¼è®¾ä¸º 1ï¼ˆé˜²æ­¢æ—§ä»£ç æ¸…ç©ºè§¦å‘æç¤ºï¼‰ ---
document.addEventListener("DOMContentLoaded", function(){
  var idx = document.getElementById("insert-index-input");
  if (idx && (!idx.value || parseInt(idx.value,10) < 1)) idx.value = "1";
});


// === [insert-at-btn PATCH v2 - scoped to current form] ===
// è¯´æ˜ï¼šæ‰€æœ‰èŠ‚ç‚¹åªåœ¨â€œå½“å‰æŒ‰é’®æ‰€åœ¨ formâ€é‡ŒæŸ¥æ‰¾ï¼Œé¿å…ä¸å…¶ä»–åŒºåŸŸ/æ¨¡æ¿å†²çªã€‚
// é€»è¾‘ï¼šæ‰¾åˆ°åŒä¸€ form ä¸‹çš„ table -> dataTbodyï¼ˆæ’é™¤ empty-form-templateï¼‰-> å…‹éš† empty_form -> åœ¨ç¬¬ N è¡Œåæ’å…¥ã€‚
(function () {
  function getScoped(root) {
    return {
      table: root.querySelector('table.report-table') || root.querySelector('table'),
      tplTbody: root.querySelector('#empty-form-template'),
      total: root.querySelector("input[name$='-TOTAL_FORMS']")
    };
  }
  function findDataTbody(table, tplTbody) {
    if (!table) return null;
    const bodies = Array.from(table.querySelectorAll('tbody'));
    if (!bodies.length) return null;
    if (tplTbody) {
      const data = bodies.find(b => b !== tplTbody);
      return data || bodies[0];
    }
    return bodies[0];
  }
  function cloneRow(root) {
    const { tplTbody, total } = getScoped(root);
    if (!tplTbody || !total) return null;

    const count = parseInt(total.value || '0', 10) || 0;
    const tmp = document.createElement('tbody');
    tmp.innerHTML = tplTbody.innerHTML
      .replace(/__prefix__/g, count)
      .replace(/__num__/g, count + 1);

    const tr = tmp.querySelector('tr');
    if (!tr) return null;

    // å¼ºåˆ¶å¯è§ + å¯ç”¨ï¼ˆé˜²æ­¢æ¨¡æ¿å¸¦éšè—/ç¦ç”¨ï¼‰
    tr.classList.remove('d-none','hidden','invisible','template-row');
    tr.style.removeProperty('display');
    tr.removeAttribute('aria-hidden');
    tr.querySelectorAll('input,select,textarea,button').forEach(el => {
      el.disabled = false; el.removeAttribute('disabled');
    });

    total.value = String(count + 1);
    return tr;
  }
  function insertAfterN(root, n) {
    const { table, tplTbody } = getScoped(root);
    const dataTbody = findDataTbody(table, tplTbody);
    const newTr = cloneRow(root);
    if (!dataTbody || !newTr) return false;

    const rows = Array.from(dataTbody.querySelectorAll('tr.report-item-row'));
    if (!rows.length) {
      dataTbody.appendChild(newTr);
    } else {
      const i = Math.min(Math.max(1, n), rows.length);
      const target = rows[i - 1];
      (target.closest('tbody') || dataTbody).insertBefore(newTr, target.nextSibling);
    }

    // ç»‘å®šäº‹ä»¶/åˆ·æ–°ï¼ˆè‹¥å­˜åœ¨åˆ™è°ƒç”¨ï¼‰
    if (typeof bindRowEvents === 'function') bindRowEvents(newTr);
    if (typeof updateRowNumbersAndIndexes === 'function') updateRowNumbersAndIndexes();
    if (typeof updateTotals === 'function') updateTotals();
    if (typeof updateSmartHintPanel === 'function') updateSmartHintPanel();

    try { newTr.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
    (newTr.querySelector('.time-input') || newTr.querySelector('input,select'))?.focus?.();
    return true;
  }

  // æ•è·é˜¶æ®µï¼Œç¡®ä¿å‹è¿‡å…¶å®ƒ click ç›‘å¬
  document.addEventListener('click', function (e) {
    const btn = e.target && e.target.closest && e.target.closest('#insert-at-btn');
    if (!btn) return;
    const form = btn.closest('form') || document;
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation && e.stopImmediatePropagation();

    const idxInput = form.querySelector('#insert-index-input');
    const n = parseInt((idxInput && idxInput.value) || '1', 10) || 1;

    const ok = insertAfterN(form, n);
    if (!ok) {
      // ä¸å†æŠ›çƒ¦äººçš„ alertï¼›ä»…åœ¨æ§åˆ¶å°æç¤º
      console.warn('insert-at: cannot locate template/data tbody within current form');
    }
  }, true);

  // åˆå§‹é»˜è®¤å€¼ï¼šä¸ºç©ºæ—¶é»˜è®¤ 1ï¼ˆä»…å‰ç«¯ï¼‰
  document.addEventListener('DOMContentLoaded', function(){
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      const idx = form.querySelector('#insert-index-input');
      if (idx && !idx.value) idx.value = '1';
    });
  });
})();
// === [END insert-at-btn PATCH v2] ===

// === [insert-at â€” formä½œç”¨åŸŸã€ç¨³å®šç‰ˆï¼Œä¸ä¾èµ–æ—§å‡½æ•°] ===
(function () {
  // å–æŒ‰é’®æ‰€åœ¨ form ä½œä¸ºä½œç”¨åŸŸ
  function getScope() {
    const btn  = document.getElementById('insert-at-btn');
    const form = btn ? (btn.closest('form') || document) : document;
    // table: ä¼˜å…ˆ .report-tableï¼Œå…¶æ¬¡ form å†…çš„ç¬¬ä¸€å¼ è¡¨
    const table = form.querySelector('table.report-table') || form.querySelector('table');
    // template tbody
    const tpl   = form.querySelector('#empty-form-template');
    // æ•°æ® tbodyï¼šä» table.tBodies/æ‰€æœ‰ tbody ä¸­æŒ‘ä¸æ˜¯æ¨¡æ¿çš„ï¼›å¦‚æœåªæœ‰ä¸€ä¸ªä¹Ÿç”¨å®ƒ
    let bodies = [];
    if (table) bodies = Array.from(table.tBodies || table.querySelectorAll('tbody'));
    const dataTb = bodies.find(b => b !== tpl) || bodies[0] || null;
    // TOTAL_FORMS
    const total = form.querySelector("input[name$='-TOTAL_FORMS']");
    return { form, table, tpl, dataTb, total };
  }

  // å…‹éš†1è¡Œï¼šæ›¿æ¢ __prefix__/__num__ï¼Œè§£é™¤éšè—/ç¦ç”¨
  function cloneOne(form, tpl, total) {
    if (!form || !tpl || !total) return null;
    const count = parseInt(total.value || '0', 10) || 0;
    const tmp = document.createElement('tbody');
    tmp.innerHTML = tpl.innerHTML
      .replace(/__prefix__/g, count)
      .replace(/__num__/g,    count + 1);
    const tr = tmp.querySelector('tr');
    if (!tr) return null;
    tr.classList.remove('d-none','hidden','invisible','template-row');
    tr.style.removeProperty('display');
    tr.removeAttribute('aria-hidden');
    tr.querySelectorAll('input,select,textarea,button').forEach(el => {
      el.disabled = false; el.removeAttribute('disabled');
    });
    total.value = String(count + 1);
    return tr;
  }

  // çœŸæ­£çš„æ’å…¥ï¼šé»˜è®¤åœ¨ç¬¬1è¡Œä¹‹åï¼ˆä½ æœ‰è¾“å…¥å°±ç”¨è¾“å…¥çš„è¡Œå·ï¼‰
  function insertAt(nWanted) {
    const { form, table, tpl, dataTb, total } = getScope();
    if (!form || !table || !tpl || !dataTb || !total) {
      console.warn('[insert-at] missing node(s)', {
        form: !!form, table: !!table, tpl: !!tpl, dataTb: !!dataTb, total: !!total
      });
      return false;
    }
    const tr = cloneOne(form, tpl, total);
    if (!tr) { console.warn('[insert-at] clone failed'); return false; }

    // ç°æœ‰æ•°æ®è¡Œï¼ˆä¼˜å…ˆæŒ‰ .report-item-row æ‰¾ï¼Œä¸è¡Œå°±æ‰€æœ‰ trï¼‰
    const rows = Array.from(dataTb.querySelectorAll('tr.report-item-row'));
    const all  = rows.length ? rows : Array.from(dataTb.querySelectorAll('tr'));

    if (all.length === 0) {
      dataTb.appendChild(tr);
    } else {
      const n = Math.min(Math.max(1, nWanted || 1), all.length);
      const anchor = all[n - 1];
      (anchor.parentNode || dataTb).insertBefore(tr, anchor.nextSibling);
    }

    // é‡æ–°ç»‘å®šäº‹ä»¶ & åˆ·æ€»è®¡/æç¤ºï¼ˆè‹¥è¿™äº›å‡½æ•°å­˜åœ¨ï¼‰
    if (typeof window.bindRowEvents === 'function') window.bindRowEvents(tr);
    if (typeof window.updateRowNumbersAndIndexes === 'function') window.updateRowNumbersAndIndexes();
    if (typeof window.updateTotals === 'function') window.updateTotals();
    if (typeof window.updateSmartHintPanel === 'function') window.updateSmartHintPanel();

    // è§†é‡å®šä½ & ç„¦ç‚¹
    try { tr.scrollIntoView({behavior:'smooth', block:'center'}); } catch (e) {}
    (tr.querySelector('.time-input') || tr.querySelector('input,select'))?.focus?.();
    return true;
  }

  // æ•è·é˜¶æ®µç»‘å®šæŒ‰é’®ç‚¹å‡»ï¼Œé˜»æ–­å…¶ä»–å†²çª handler
  document.addEventListener('click', function (ev) {
    const btn = ev.target && ev.target.closest && ev.target.closest('#insert-at-btn');
    if (!btn) return;
    ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation && ev.stopImmediatePropagation();
    const form  = btn.closest('form') || document;
    const input = form.querySelector('#insert-index-input');
    const n = parseInt((input && input.value) || '1', 10) || 1;
    insertAt(n);
  }, true);

  // ç»™æ§åˆ¶å°è°ƒè¯•ç”¨çš„ä¸€é”®å‡½æ•°
  window.__insertRowDebug__ = function(){ return insertAt(1); };
})();
