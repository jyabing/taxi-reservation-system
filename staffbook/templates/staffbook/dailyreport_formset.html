{% extends "staffbook/base_staffbook.html" %}
{% load time_filters %}
{% block extra_css %}
<style>
  .table tbody tr.has-note {
    background-color: #ffef9f !important;
  }
</style>
{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    .table tbody tr.has-note {
    background-color: #ffef9f !important;
  }

    td.has-note {
    background-color: #fff3cd;
    color: #000;
  }
  .auto-width-input {
    width: 2ch;
    min-width: 4ch;
    box-sizing: content-box;
    transition: width 0.2s;
  }
  .mirror-span {
    position: absolute;
    visibility: hidden;
    white-space: pre;
    font: inherit;
  }
</style>

<div class="container">
  <h4><strong>{{ report.driver.name }}</strong>ï¼ˆ{{ report.driver.driver_code }}ï¼‰- ç·¨é›†ä¹—å‹™æ—¥å ±</h4>
  <p class="text-muted">æ—¥ä»˜ï¼š{{ form.date.value }}</p>

  {% if report.pk %}
    {% if report.edited_by %}
      <div class="alert alert-light small mb-3">
        <strong>æœ€åç¼–è¾‘ï¼š</strong>
        {{ report.edited_by.get_full_name|default:report.edited_by.username }}
        äº {{ report.edited_at|date:"Yå¹´næœˆjæ—¥ H:i" }} ä¿å­˜
      </div>
    {% else %}
      <div class="alert alert-secondary small mb-3">å°šæœªè¢«ç¼–è¾‘è¿‡</div>
    {% endif %}
  {% endif %}


    <!-- å…ˆæŠŠé”™è¯¯æ¸²æŸ“å‡ºæ¥ -->
  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>è¡¨å•é”™è¯¯ï¼š</strong>
      <ul>
      {% for field, errs in form.errors.items %}
        <li>{{ field }}: {{ errs|join:", " }}</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>æ˜ç»†è¡¨å•é”™è¯¯ï¼š</strong>
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  <!-- ç„¶åæ­£å¸¸æ¸²æŸ“è¡¨å• -->
  <form method="post" autocomplete="off">
  {% csrf_token %}
  {{ form.status }}      {# éšè—å­—æ®µ #}
  {{ form.date.as_hidden }}


  <div class="col-md-3">
    <label>å¤‡æ³¨:</label>{{ form.note }}</div>

<table class="table table-bordered table-sm">
  <thead class="table-light">
    <tr>
      <th>å‡ºå‹¤æ—¶é—´</th>
      <th>é€€å‹¤æ—¶é—´</th>
      <th>æ€»æ—¶é•¿</th>
      <th>æ²¹é‡ (L)</th>
      <th>é‡Œç¨‹ (KM)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="time" name="clock_in" value="{{ form.initial.clock_in|default_if_none:'' }}" class="form-control" /></td>
      <td><input type="time" name="clock_out" value="{{ form.initial.clock_out|default_if_none:'' }}" class="form-control" /></td>
      <td>{{ duration|time_length }}</td>
      <td>{{ form.gas_volume }}</td>
      <td>{{ form.mileage }}</td>
    </tr>
  </tbody>

</table>

{# dailyreport_formset.html çš„åˆè®¡é¢æ¿éƒ¨åˆ† #}
<div class="d-flex flex-wrap mb-3" style="gap: 0.5rem;">
  {# ãƒ¡ãƒ¼ã‚¿ãƒ¼(æ°´æš) åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">ãƒ¡ãƒ¼ã‚¿ãƒ¼(æ°´æš)åˆè¨ˆ</div>
    <div>{{ totals.meter_raw|floatformat:0 }}ï¼ˆ{{ totals.meter_split|floatformat:0 }}ï¼‰</div>
  </div>

  {# ç¾é‡‘(ãªãŒã—) åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">ç¾é‡‘(ãªãŒã—)åˆè¨ˆ</div>
    <div>{{ totals.cash_raw|floatformat:0 }}ï¼ˆ{{ totals.cash_split|floatformat:0 }}ï¼‰</div>
  </div>

  {# Uber åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">Uber åˆè¨ˆ</div>
    <div>{{ totals.uber_raw|floatformat:0 }}ï¼ˆ{{ totals.uber_split|floatformat:0 }}ï¼‰</div>
  </div>

  {# Didi åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">Didi åˆè¨ˆ</div>
    <div>{{ totals.didi_raw|floatformat:0 }}ï¼ˆ{{ totals.didi_split|floatformat:0 }}ï¼‰</div>
  </div>

  {# ã‚¯ãƒ¬ã‚¸ åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">ã‚¯ãƒ¬ã‚¸ åˆè¨ˆ</div>
    <div>{{ totals.credit_raw|floatformat:0 }}ï¼ˆ{{ totals.credit_split|floatformat:0 }}ï¼‰</div>
  </div>

  {# ä¹—è»Šåˆ¸ åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">ä¹—è»Šåˆ¸ åˆè¨ˆ</div>
    <div>{{ totals.ticket_raw|floatformat:0 }}ï¼ˆ{{ totals.ticket_split|floatformat:0 }}ï¼‰</div>
  </div>

  {# æ‰«ç  åˆè¨ˆ #}
  <div class="border rounded px-3 py-2 text-center">
    <div class="small text-muted">æ‰«ç  åˆè¨ˆ</div>
    <div>{{ totals.qr_raw|floatformat:0 }}ï¼ˆ{{ totals.qr_split|floatformat:0 }}ï¼‰</div>
  </div>
</div>

    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>#</th><th>æ—¶é—´</th><th>ä¹—è»Šåœ°</th><th>çµŒç”±</th><th>é™è»Šåœ°</th>
          <th>ç”·</th><th>å¥³</th><th>æ–™é‡‘</th><th>æ”¯ä»˜</th><th>æ³¨é‡Š</th><th>æ“ä½œ</th>
        </tr>
      </thead>
     <tbody>
  {{ formset.management_form }}
  {% for form in formset.forms %}
    <tr class="report-item-row{% if form.note.value|stringformat:'s'|length > 0 %} has-note{% endif %}">
      {{ form.id }}
      <td>{{ forloop.counter }}</td>
      <td>{{ form.ride_time }}</td>
      <td>{{ form.ride_from }}</td>
      <td>{{ form.via }}</td>
      <td>{{ form.ride_to }}</td>
      <td>{{ form.num_male }}</td>
      <td>{{ form.num_female }}</td>
      <td>{{ form.meter_fee }}</td>
      <td>{{ form.payment_method }}</td>
      <td class="{% if form.note.value|stringformat:'s'|length > 0 %}has-note{% endif %}">
        {{ form.note }}
        {% if form.note.value|stringformat:'s'|length > 0 %}
          <span title="æ­¤å•æœ‰å¤‡æ³¨" style="color: #d47d00; font-size:1.2em;">ğŸ“</span>
        {% endif %}
      </td>
      <td>
        {% if form.instance.pk %}
          {{ form.DELETE }} åˆ é™¤
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-danger remove-row">ç§»é™¤</button>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
</tbody>
    </table>

    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
    
    
  </form>

  <div class="text-center mt-3">
    <button id="add-row-btn" class="btn btn-outline-dark">â• å¢åŠ ä¸€è¡Œ</button>
  </div>
</div>

<script>

  
// â€”â€” è®¡ç®—å¹¶æ›´æ–°æ€»æ—¶é•¿ â€”â€” //
function updateDuration() {
  const inEl  = document.querySelector('input[name="clock_in"]');
  const outEl = document.querySelector('input[name="clock_out"]');
  const display = document.getElementById('total-duration');
  const inVal  = inEl.value;
  const outVal = outEl.value;

  if (!inVal || !outVal) {
    display.textContent = '--:--';
    return;
  }

  // æ„é€ ä¸¤ä¸ª Date å¯¹è±¡ï¼ˆåŒä¸€å¤©ï¼‰ï¼Œç”¨äºç›¸å‡
  const [h1, m1] = inVal.split(':').map(Number);
  const [h2, m2] = outVal.split(':').map(Number);
  let d1 = new Date(0,0,0,h1,m1);
  let d2 = new Date(0,0,0,h2,m2);

  // å¦‚æœé€€å‹¤æ—¶é—´æ—©äºå‡ºå‹¤ï¼Œå°±è·¨å¤© +1 æ—¥
  if (d2 <= d1) {
    d2 = new Date(0,0,1,h2,m2);
  }

  const diffMs = d2 - d1;
  const diffH = Math.floor(diffMs / (1000*60*60));
  const diffM = Math.floor((diffMs % (1000*60*60)) / (1000*60));
  // ä¸¤ä½æ•°æ ¼å¼
  const hh = String(diffH).padStart(2,'0');
  const mm = String(diffM).padStart(2,'0');
  display.textContent = `${hh}:${mm}`;
}

// ç›‘å¬ä¸¤è¾“å…¥æ¡†çš„å˜åŒ–
document.addEventListener('DOMContentLoaded', () => {
  updateDuration();
  document.querySelector('input[name="clock_in"]').addEventListener('input', updateDuration);
  document.querySelector('input[name="clock_out"]').addEventListener('input', updateDuration);
});

  // âŠ è‡ªé€‚åº”å®½åº¦
  document.querySelectorAll('.auto-width-input').forEach(function(input) {
    const span = document.createElement('span');
    span.className = 'mirror-span';
    document.body.appendChild(span);
    const sync = () => {
      span.style.font = window.getComputedStyle(input).font;
      span.textContent = input.value || input.placeholder || '';
      input.style.width = (span.offsetWidth + 20) + 'px';
    };
    sync();
    input.addEventListener('input', sync);
  });

  // â‹ åˆè®¡è®¡ç®—
  function updateTotals() {
    let sum = {meter:0, uber:0, cash:0, didi:0, credit:0, ticket:0, qr:0};
    document.querySelectorAll('tr.report-item-row').forEach(row => {
      const fee = parseFloat(row.querySelector('.meter-fee-input')?.value || 0);
      const pay = row.querySelector('.payment-method-select')?.value || '';
      sum.meter += fee;
      if (pay === 'uber') sum.uber += fee;
      else if (pay === 'cash') sum.cash += fee;
      else if (pay === 'didi') sum.didi += fee;
      else if (pay === 'credit') sum.credit += fee;
      else if (pay === 'ticket') sum.ticket += fee;
      else if (['barcode', 'wechat'].includes(pay)) sum.qr += fee;
    });
    document.getElementById('total_meter').value = sum.meter.toFixed(2);
    document.getElementById('total_uber').value = sum.uber.toFixed(2);
    document.getElementById('total_cash').value = sum.cash.toFixed(2);
    document.getElementById('total_didi').value = sum.didi.toFixed(2);
    document.getElementById('total_card').value = sum.credit.toFixed(2);
    document.getElementById('total_ticket').value = sum.ticket.toFixed(2);
    document.getElementById('total_qr').value = sum.qr.toFixed(2);
  }
  document.addEventListener('input', updateTotals);
  document.addEventListener('DOMContentLoaded', function(){
    flatpickr('.ride-time-input', {
      enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true
    });
    updateTotals();
  });

  // âŒ å¢åŠ ä¸€è¡Œ
  document.getElementById('add-row-btn').onclick = () => {
    const total = document.querySelector('input[name$="-TOTAL_FORMS"]');
    if (parseInt(total.value) >= 40) return alert("æœ€å¤š 40 è¡Œ");
    total.value = parseInt(total.value) + 1;
    document.forms[0].submit();
  };
</script>

{% endblock %}
